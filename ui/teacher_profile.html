<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Teacher Profile</title>
    <!-- Corrected asset path (assets is sibling of ui) -->
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <!-- Removed line-clamp plugin (already bundled in v3.3+) to silence console warning -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script>
        tailwind.config = { darkMode: 'class', theme: { container: { center: true, padding: '1rem' }, extend: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] }, colors: { brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' }, brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' } }, backgroundImage: { 'hero-dark': 'radial-gradient(900px 600px at 50% -10%, rgba(158,75,138,.30), transparent 60%), linear-gradient(180deg,#1E1E2F,#201934 35%,#141321 100%)', 'hero-light': 'radial-gradient(900px 600px at 50% -10%, rgba(158,75,138,.20), transparent 60%), linear-gradient(180deg,#FFFFFF,#FBF8FC 45%,#F7F2F9 100%)' }, boxShadow: { card: '0 6px 24px rgba(0,0,0,.10)', glow: '0 8px 30px rgba(158,75,138,.35)' }, } } };
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px
        }

        .glass {
            background: rgba(255, 255, 255, .75);
            backdrop-filter: blur(14px)
        }

        .dark .glass {
            background: rgba(30, 30, 47, .55)
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, .06)25%, rgba(0, 0, 0, .12)37%, rgba(0, 0, 0, .06)63%);
            background-size: 1000px 100%
        }

        .dark .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, .06)25%, rgba(255, 255, 255, .12)37%, rgba(255, 255, 255, .06)63%)
        }

        .shimmer {
            animation: shimmer 1.4s infinite linear
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0
            }

            100% {
                background-position: 1000px 0
            }
        }

        .dark body {
            background-image: linear-gradient(to left top, #1e1e2f, #242138, #2b2440, #332649, #3d2850, #3f254a, #402244, #401f3e, #34182d, #26131e, #190b11, #000000);
            background-repeat: no-repeat;
            background-size: cover
        }
    </style>
    <script>(function () { const s = localStorage.getItem('px_theme'); const p = matchMedia('(prefers-color-scheme: dark)').matches; const m = s ? s : (p ? 'dark' : 'light'); if (m === 'dark') document.documentElement.classList.add('dark'); })();</script>
    <!-- Corrected script paths (were ./ui/... creating /ui/ui duplication) -->
    <script src="./config.js"></script>
    <script src="./auth.js" defer></script>
    <script>
        // Force API base to backend dev server; prevents accidental use of static server origin
        window.API_BASE = 'http://127.0.0.1:8000';
    </script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="./index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="assets/img/logo-light.svg" class="h-9 w-auto dark:hidden" alt="Paper X">
                <img src="assets/img/logo-dark.svg" class="h-9 w-auto hidden dark:block" alt="Paper X">
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="./index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white"
                    href="./teachers/notes/notes_marketplace.html">Marketplace</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="./help.html">Help</a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
                        class="material-symbols-rounded text-base">dark_mode</span></button>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
                        class="material-symbols-rounded">dark_mode</span></button>
            </div>
        </div>
    </header>

    <main class="container py-8 space-y-8">
        <!-- HERO / HEADER CARD -->
        <section id="heroCard"
            class="glass rounded-3xl p-6 md:p-8 ring-1 ring-black/5 dark:ring-white/10 shadow-card relative overflow-hidden">
            <div class="absolute inset-0 pointer-events-none opacity-40 dark:opacity-20" aria-hidden="true"
                style="background:radial-gradient(circle at 25% 15%,rgba(158,75,138,.35),transparent 60%)"></div>
            <div class="relative flex flex-col md:flex-row gap-6 md:gap-10">
                <div id="avatarWrap"
                    class="w-32 h-32 rounded-2xl overflow-hidden ring-2 ring-white/60 dark:ring-black/40 bg-gradient-to-br from-brand-500/30 to-brand-500/0 grid place-items-center text-3xl font-bold text-brand-700 dark:text-fuchsia-200 skeleton shimmer">
                </div>
                <div class="flex-1 min-w-0 space-y-4">
                    <div>
                        <div class="flex flex-wrap items-center gap-4">
                            <h1 id="tName"
                                class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2 flex items-center gap-3">
                                Loading… <span id="tBadge"
                                    class="hidden text-xs inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-500/15 text-emerald-700 dark:text-emerald-300 ring-1 ring-emerald-500/30"><span
                                        class="material-symbols-rounded text-sm">verified</span><span
                                        class="hidden sm:inline">Verified Teacher</span><span
                                        class="sm:hidden">Teacher</span></span></h1>
                            <div id="selfActions" class="hidden items-center gap-2 mb-2">
                                <a href="./teacher_profile_edit.html"
                                    class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full bg-brand-500 text-white hover:bg-brand-600 shadow"><span
                                        class="material-symbols-rounded text-base">edit</span>Edit Profile</a>
                                <a href="./teacher_classes_manage.html"
                                    class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 hover:bg-white/90 dark:hover:bg-white/20"><span
                                        class="material-symbols-rounded text-base">class</span>Classes</a>
                                <a href="./teacher_test_builder.html"
                                    class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full bg-brand-500/10 text-brand-700 dark:text-fuchsia-100 ring-1 ring-brand-500/30 hover:bg-brand-500/20">
                                    <span class="material-symbols-rounded text-base">quiz</span>Create Test</a>
                                <a href="./teacher_tests.html"
                                    class="inline-flex items-center gap-1.5 text-xs px-3 py-1.5 rounded-full bg-brand-500 text-white hover:bg-brand-600 shadow">
                                    <span class="material-symbols-rounded text-base">assignment</span>Tests</a>
                            </div>
                        </div>
                        <p id="tHeadline"
                            class="text-sm text-neutral-600 dark:text-white/70 max-w-prose leading-relaxed"> </p>
                    </div>
                    <div id="tMeta" class="flex flex-wrap gap-2 text-[11px] font-medium"> </div>
                    <div class="flex flex-wrap gap-2" id="statChips">
                        <!-- dynamic stats chips -->
                    </div>
                </div>
            </div>
        </section>

        <!-- CLASSES SECTION -->
        <section class="space-y-5">
            <div class="flex items-center gap-3">
                <h2 class="text-lg font-semibold tracking-tight">Handled Classes</h2>
                <span id="classesCount" class="text-xs text-neutral-500 dark:text-white/50"> </span>
                <div class="ml-auto flex items-center gap-2 text-xs">
                    <input id="filterSubject" type="text" placeholder="Filter by subject"
                        class="px-2 py-1 rounded-md bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500" />
                </div>
            </div>
            <div id="classesGroups" class="space-y-6"></div>
        </section>
    </main>

    <div class="fixed bottom-3 right-3 z-40">
        <button id="scrollTop"
            class="hidden size-10 rounded-full bg-brand-500 hover:bg-brand-600 text-white shadow-glow flex items-center justify-center"><span
                class="material-symbols-rounded">north</span></button>
    </div>

    <script>
        // Utility helpers
        const $ = (s, r = document) => r.querySelector(s);
        const $$ = (s, r = document) => [...r.querySelectorAll(s)];
        const esc = (s = '') => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const formatRange = (a, b) => (a && b) ? `${a}-${b}` : (a || b || '');
        (function theme() { const root = document.documentElement; const toggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]')); const set = (m) => { m === 'dark' ? root.classList.add('dark') : root.classList.remove('dark'); localStorage.setItem('px_theme', m); toggles().forEach(btn => { const ic = btn.querySelector('.material-symbols-rounded'); if (ic) ic.textContent = m === 'dark' ? 'light_mode' : 'dark_mode'; }); }; set(root.classList.contains('dark') ? 'dark' : 'light'); document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; set(root.classList.contains('dark') ? 'light' : 'dark'); }); })();

        let API_BASE = '';
        async function resolveApi() { if (API_BASE) return API_BASE; const b = (window.__API_BASE || window.API_BASE || '').replace(/\/$/, ''); if (b) { API_BASE = b; return b; } await new Promise(r => setTimeout(r, 80)); return resolveApi(); }
        function getToken() {
            // Known priority keys first
            const primary = ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token'];
            for (const k of primary) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } }
            // Fallback heuristic: scan all keys containing 'token'
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (/token/i.test(key || '')) {
                        const v = localStorage.getItem(key);
                        if (v && v.length > 10) return v;
                    }
                }
            } catch { }
            return '';
        }

        const params = new URLSearchParams(location.search);
        // Preserve original intent (dynamic self) if user=me or no user query
        const originalUserParam = params.get('user');
        let dynamicSelfMode = !originalUserParam || originalUserParam === 'me';
        let targetUser = originalUserParam || 'me';

        function noAuthForMe() {
            // Redirect immediately to teacher login with return URL
            const ret = encodeURIComponent(location.pathname + location.search);
            location.href = `./teachers/teacher_login.html?redirect=${ret}`;
        }

        async function resolveMeToId() {
            const token = getToken();
            if (!token) return null;
            try {
                const base = await resolveApi();
                // If teacher session, ask backend to resolve via teacher/me
                if (localStorage.getItem('teacherToken')) {
                    const r = await fetch(`${base}/api/teacher/profile/me`, { headers: { Authorization: 'Bearer ' + token } });
                    if (!r.ok) return null;
                    const j = await r.json();
                    return j?.auth_user_id || j?.teacher?.auth_user_id || j?.profile?.auth_user_id || null;
                }
                const r = await fetch(`${base}/api/me`, { headers: { Authorization: 'Bearer ' + token } });
                if (!r.ok) return null;
                const j = await r.json();
                const authId = j?.profile?.auth_user_id || j?.profile?.id; // prefer auth_user_id
                return authId || null;
            } catch (e) { return null; }
        }
        function decodeJwtUserId(token) {
            try {
                const parts = token.split('.'); if (parts.length < 2) return null;
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                return payload.sub || payload.user_id || payload.uid || null;
            } catch { return null; }
        }

        let resolvingMe = false;
        let selfUserId = null;
        let lastPayload = null; // cache to avoid refetch on client-only filters
        async function loadProfile() {
            const token = getToken();
            const base = await resolveApi();
            let res;
            // In dynamic self mode always hit /me variant so switching accounts (storage event) refreshes automatically
            const strictParam = 'strict=1'; // instruct backend to use only teacher_profiles (implement server-side if not present)
            async function fetchWithRetry(url, hdrs, attempts = 4, baseDelay = 180) {
                let lastErr; for (let i = 0; i < attempts; i++) {
                    try {
                        const r = await fetch(url, { headers: hdrs, cache: 'no-store' });
                        if (!r.ok && r.status >= 500 && r.status < 600) throw new Error('Server ' + r.status);
                        return r;
                    } catch (e) {
                        lastErr = e; const isLast = i === attempts - 1;
                        const jitter = Math.random() * 60;
                        await new Promise(r => setTimeout(r, baseDelay * (i + 1) + jitter));
                        if (isLast) throw e;
                    }
                }
                throw lastErr;
            }
            const makeUrl = dynamicSelfMode ? `${base}/api/teacher/profile/me?${strictParam}` : `${base}/api/teacher/profile/${encodeURIComponent(targetUser)}?${strictParam}`;
            const headers = dynamicSelfMode
                ? (token ? { Authorization: 'Bearer ' + token, 'X-TeacherProfile-Strict': 'true' } : { 'X-TeacherProfile-Strict': 'true' })
                : (token ? { Authorization: 'Bearer ' + token, 'X-TeacherProfile-Strict': 'true' } : { 'X-TeacherProfile-Strict': 'true' });
            if (dynamicSelfMode && !token) { noAuthForMe(); return; }
            try {
                res = await fetchWithRetry(makeUrl, headers);
            } catch (e) {
                console.error('Profile fetch retries exhausted', e);
                if (dynamicSelfMode) {
                    // Automatic sign-out (clear known tokens) and redirect to login
                    ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token'].forEach(k => { try { localStorage.removeItem(k); } catch { } });
                    noAuthForMe();
                    return;
                }
                renderError('Network error – please refresh');
                return;
            }
            let data = {}; try { data = await res.json(); } catch { }
            if (!res.ok) {
                if (dynamicSelfMode && res.status === 401) { noAuthForMe(); return; }
                renderError(data.detail || 'Failed to load'); return;
            }
            lastPayload = data;
            renderProfile(data);
            // Show self action buttons if this profile belongs to viewer
            if (dynamicSelfMode) {
                selfUserId = 'me';
            } else if (!selfUserId && token) {
                // decode token (fallback) to determine if same user
                const parts = token.split('.'); if (parts.length > 1) { try { const p = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/'))); selfUserId = p.sub || p.user_id || p.uid || null; } catch { } }
            }
            if ((dynamicSelfMode && token) || (selfUserId && selfUserId === targetUser)) { document.getElementById('selfActions').classList.remove('hidden'); document.getElementById('selfActions').classList.add('flex'); }
        }

        function renderError(msg) { $('#tName').textContent = 'Teacher'; $('#tHeadline').textContent = msg; $('#tMeta').innerHTML = ''; $('#classesGroups').innerHTML = `<div class='text-sm text-red-600 dark:text-red-400'>${esc(msg)}</div>`; }

        function chip(txt) { return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10 text-[11px]">${esc(txt)}</span>`; }

        function renderProfile(payload) {
            const { teacher = {}, stats = {}, classes = [], grouped_classes = {}, subjects = [] } = payload;
            $('#tName').childNodes[0].textContent = teacher.name || 'Unnamed Teacher';
            if (teacher.role === 'teacher' || teacher.status === 'approved' || teacher.role === 'admin') $('#tBadge').classList.remove('hidden');
            $('#tHeadline').textContent = teacher.headline || teacher.bio || 'No headline yet';
            const metaParts = []; if (teacher.college_name) metaParts.push(chip(teacher.college_name)); if (teacher.degree_name) metaParts.push(chip(teacher.degree_name)); if (teacher.department_name) metaParts.push(chip(teacher.department_name)); if (subjects.length) metaParts.push(chip(subjects.slice(0, 4).join(', ') + (subjects.length > 4 ? '…' : '')));
            $('#tMeta').innerHTML = metaParts.join('');
            // Stats chips
            const sc = $('#statChips'); sc.innerHTML = '';
            const statsMap = [['Notes', stats.notes_count], ['Classes', stats.classes_count], ['Subjects', stats.subjects_count]];
            statsMap.forEach(([label, val]) => { sc.insertAdjacentHTML('beforeend', `<div class='px-3 py-2 rounded-xl ring-1 ring-black/5 dark:ring-white/10 bg-white/60 dark:bg-white/5 flex flex-col text-center min-w-[88px]'> <span class='text-lg font-bold tracking-tight'>${val ?? 0}</span><span class='text-[11px] opacity-60 font-medium'>${esc(label)}</span></div>`); });
            // Avatar
            const av = $('#avatarWrap');
            av.classList.remove('skeleton', 'shimmer');
            if (teacher.avatar_url) { av.innerHTML = `<img src='${teacher.avatar_url}' alt='' class='w-full h-full object-cover'/>`; }
            else { av.innerHTML = `<div class='w-full h-full grid place-items-center bg-gradient-to-br from-brand-500/25 to-brand-700/20 text-5xl font-black'>${esc((teacher.name || 'T').charAt(0).toUpperCase())}</div>`; }

            // Classes grouped
            const container = $('#classesGroups'); container.innerHTML = '';
            const filterVal = $('#filterSubject').value.trim().toLowerCase();
            const yearLabelForSem = (semNum) => { const s = parseInt(semNum, 10); if (!s || s < 1) return ''; const year = Math.floor((s - 1) / 2) + 1; const ord = { 1: 'First', 2: 'Second', 3: 'Third', 4: 'Fourth', 5: 'Fifth', 6: 'Sixth' }; return ord[year] ? ord[year] + ' Year' : ''; };
            Object.entries(grouped_classes).forEach(([group, list]) => {
                const filt = list.filter(c => !filterVal || (c.subject || '').toLowerCase().includes(filterVal));
                if (!filt.length) return;
                // Derive semester number from group label like 'Semester 3'
                let semMatch = group.match(/Semester\s+(\d+)/i); let semNum = semMatch ? parseInt(semMatch[1], 10) : null; let yearLbl = semNum ? yearLabelForSem(semNum) : '';
                const cards = filt.map(c => classCard(c)).join('');
                container.insertAdjacentHTML('beforeend', `<div class='space-y-3'> <h3 class='text-sm font-semibold tracking-wide uppercase text-neutral-500 dark:text-white/50 flex flex-wrap items-center gap-2'>${esc(group)} ${yearLbl ? `<span class='text-[10px] px-1.5 py-0.5 rounded bg-brand-500/10 text-brand-700 dark:text-fuchsia-200 ring-1 ring-brand-500/20'>${esc(yearLbl)}</span>` : ''} <span class='text-[10px] px-1.5 py-0.5 rounded bg-black/5 dark:bg-white/10'>${filt.length}</span></h3> <div class='grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'>${cards}</div></div>`);
            });
            if (!classes.length) { container.innerHTML = `<div class='text-sm opacity-70'>No classes added yet.</div>`; }
            $('#classesCount').textContent = classes.length ? `${classes.length} classes` : '';
        }

        function classCard(c) {
            const tags = []; if (c.batch_range) tags.push(c.batch_range); if (c.section) tags.push('Sec ' + c.section);
            const params = new URLSearchParams();
            if (c.subject_id) params.set('course_id', c.subject_id);
            if (c.subject) params.set('subject', c.subject);
            if (c.id) params.set('class_id', c.id);
            if (c.batch_id) params.set('batch_id', c.batch_id);
            if (c.section) params.set('section', c.section);
            if (c.semester) params.set('semester', c.semester);
            const syllabusHref = c.subject_id ? `./teacher_class_syllabus.html?${params.toString()}` : '';
            const disabled = !syllabusHref;
            const baseCls = 'group relative rounded-2xl ring-1 ring-black/5 dark:ring-white/10 bg-white/70 dark:bg-white/5 p-4 transition-shadow block';
            const hoverCls = disabled ? 'opacity-70 cursor-not-allowed' : 'hover:shadow-card hover:-translate-y-0.5 cursor-pointer';
            const actionLabel = disabled ? 'No syllabus linked' : 'View syllabus';
            return `<a ${syllabusHref ? `href='${syllabusHref}'` : "role='button' aria-disabled='true'"} class='${baseCls} ${hoverCls}'>
            <div class='flex items-start gap-3'>
                <div class='w-10 h-10 rounded-lg bg-gradient-to-br from-brand-500/30 to-brand-700/20 grid place-items-center text-sm font-bold text-brand-700 dark:text-fuchsia-200'>${esc((c.subject || 'S').charAt(0).toUpperCase())}</div>
                <div class='flex-1 min-w-0'>
                    <h4 class='text-sm font-semibold leading-tight mb-0.5 line-clamp-2'>${esc(c.subject || 'Subject')}</h4>
                    <div class='text-[11px] text-neutral-600 dark:text-white/60 flex flex-wrap gap-1'>${tags.map(t => `<span class='px-1.5 py-0.5 rounded bg-black/5 dark:bg-white/10'>${esc(t)}</span>`).join('')}</div>
                </div>
            </div>
            <div class='mt-3 flex items-center justify-between text-[11px] text-neutral-500 dark:text-white/40'>
                <span>${c.degree_name ? esc(c.degree_name) : ''}</span>
                <span class='inline-flex items-center gap-1'>${c.department_name ? esc(c.department_name) : ''}${c.department_name ? '<span class="opacity-30">•</span>' : ''}<span class='text-brand-600 dark:text-brand-200'>${esc(actionLabel)}</span></span>
            </div>
        </a>`;
        }

        $('#filterSubject').addEventListener('input', () => { if (lastPayload) renderProfile(lastPayload); });

        // Scroll top button
        const st = $('#scrollTop'); window.addEventListener('scroll', () => { if (scrollY > 400) st.classList.remove('hidden'); else st.classList.add('hidden'); }); st.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        // React to token changes from other tabs / logins
        window.addEventListener('storage', (e) => {
            if (/token/i.test(e.key || '')) {
                if (dynamicSelfMode) {
                    // Slight debounce to allow localStorage write completion
                    setTimeout(() => loadProfile(), 120);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>
</body>

</html>