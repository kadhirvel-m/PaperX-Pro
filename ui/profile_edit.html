<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Edit Profile — Paper</title>
    <meta name="description" content="Edit your profile details, photo, and resume." />
    <script>
        (function () { try { var k = ['cx-theme', 'theme', 'px-theme']; var m = null; for (var i = 0; i < k.length; i++) { var v = localStorage.getItem(k[i]); if (v === 'dark' || v === 'light') { m = v; break; } } if (!m && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { m = 'dark'; } if (m) { document.documentElement.classList.toggle('dark', m === 'dark'); } } catch (e) { } })();
    </script>
    <!-- Tailwind CLI build: using local compiled stylesheet instead of CDN -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script src="./config.js"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" />
    <!-- Inline Tailwind runtime config removed: central config lives in tailwind.config.js -->
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>
    <style>
        #pageLoader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, visibility 0.4s;
        }

        .loaded #pageLoader {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .dark #pageLoader {
            background: rgba(30, 30, 47, 0.7);
        }

        /* Prevent horizontal overflow on small screens (inputs default to a fixed intrinsic width). */
        #detailsForm input,
        #detailsForm textarea,
        #detailsForm select,
        #imageForm input[type="file"],
        #resumeForm input[type="file"] {
            width: 100%;
            max-width: 100%;
            min-width: 0;
        }

        /* Long values (emails/urls) shouldn't stretch the layout. */
        #email,
        #name {
            overflow-wrap: anywhere;
            word-break: break-word;
        }
    </style>
</head>

<body class="font-display bg-white text-slate-900 dark:bg-night-900 dark:text-slate-200 min-h-screen">
    <!-- Loading Overlay -->
    <div id="pageLoader">
        <dotlottie-wc src="https://lottie.host/848055f4-11c7-4032-80e0-d51319c33bca/lF6845uqpU.lottie"
            style="width: 300px;height: 300px" autoplay loop></dotlottie-wc>
    </div>
    <div aria-hidden="true"
        class="fixed inset-0 -z-10 bg-gradient-to-b from-transparent to-brand-50/40 dark:to-night-700/20"></div>
    <header
        class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-night-900/50 border-b border-black/5 dark:border-white/5">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <a href="profile.html"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">
                    <span class="material-symbols-rounded">arrow_back</span> Back
                </a>
                <div class="flex items-center gap-3">
                    <button id="saveChangesBtn" type="button"
                        class="rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 px-4 py-2 text-white shadow-neon">Save
                        Changes</button>
                    <button id="signOutBtn" title="Sign out" aria-label="Sign out"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">
                        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 12H3" />
                            <path d="M15 12l-4-4" />
                            <path d="M15 12l-4 4" />
                            <path d="M21 7v10a2 2 0 0 1-2 2h-6" />
                        </svg>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="relative">
        <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-10 pb-20 grid gap-6">
            <h1 class="text-2xl font-semibold">Edit Profile</h1>

            <div class="grid lg:grid-cols-12 gap-6">
                <!-- Left: photo & resume -->
                <div class="lg:col-span-4">
                    <div
                        class="rounded-2xl p-6 border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 grid gap-5">
                        <div class="grid gap-3">
                            <div class="flex items-center gap-4">
                                <div id="avatar"
                                    class="relative overflow-hidden h-16 w-16 rounded-xl bg-gradient-to-br from-brand-400 via-brand-500 to-indigo-500 text-white grid place-items-center font-bold text-xl shadow-neon">
                                    <img id="avatarImg" alt="Profile photo"
                                        class="hidden absolute inset-0 h-full w-full object-cover" />
                                    <span id="avatarInitials" class="relative z-10">U</span>
                                </div>
                                <div class="text-sm min-w-0">
                                    <div id="email" class="text-slate-600 dark:text-slate-300 break-words">—</div>
                                    <div id="name" class="font-medium">—</div>
                                </div>
                            </div>
                            <form id="imageForm" class="grid gap-2">
                                <label class="text-xs text-slate-500">Profile image</label>
                                <input id="imageInput" type="file" accept="image/png,image/jpeg,image/webp"
                                    class="text-xs w-full" />
                                <div class="text-[11px] text-slate-500">Select an image, then click <span
                                        class="font-medium">Save Changes</span>.</div>
                                <button type="submit" class="hidden" aria-hidden="true" tabindex="-1">Upload
                                    image</button>
                                <a id="currentImage" href="#" target="_blank" class="text-xs text-brand-600 hidden">View
                                    current</a>
                            </form>
                        </div>
                        <div class="grid gap-2">
                            <form id="resumeForm" class="grid gap-2">
                                <label class="text-xs text-slate-500">Resume (PDF/DOC)</label>
                                <input id="resumeInput" type="file" accept="application/pdf,.doc,.docx"
                                    class="text-xs w-full" />
                                <div class="text-[11px] text-slate-500">Select a resume, then click <span
                                        class="font-medium">Save Changes</span>.</div>
                                <button type="submit" class="hidden" aria-hidden="true" tabindex="-1">Upload
                                    resume</button>
                                <a id="currentResume" href="#" target="_blank"
                                    class="text-xs text-brand-600 hidden">View current</a>
                            </form>
                            <div class="text-xs text-slate-500">Your email is used for account and contact; it may be
                                visible on your profile.</div>
                        </div>
                    </div>
                </div>

                <!-- Right: details form -->
                <div class="lg:col-span-8">
                    <form id="detailsForm"
                        class="rounded-2xl p-6 border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 grid gap-6">
                        <h2 class="text-lg font-semibold">Basic Info</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Full name</span>
                                <input id="f_name" type="text"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Phone</span>
                                <input id="f_phone" type="tel"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Headline</span>
                                <input id="f_headline" type="text" placeholder="e.g., ML Student • Full‑stack dev"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Location</span>
                                <input id="f_location" type="text" placeholder="City, Country"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Date of Birth</span>
                                <input id="f_dob" type="date"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Email</span>
                                <input id="f_email_ro" type="email" disabled
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/50 dark:bg-night-800/50 px-3 py-2" />
                            </label>
                        </div>

                        <h2 class="text-lg font-semibold">Links</h2>
                        <div class="grid md:grid-cols-3 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">LinkedIn</span>
                                <input id="f_linkedin" type="url" placeholder="https://linkedin.com/in/…"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">GitHub</span>
                                <input id="f_github" type="url" placeholder="https://github.com/…"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">LeetCode</span>
                                <input id="f_leetcode" type="url" placeholder="https://leetcode.com/u/…"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Portfolio</span>
                                <input id="f_portfolio" type="url" placeholder="https://your-portfolio.dev"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Website</span>
                                <input id="f_website" type="url" placeholder="https://yoursite.com"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Twitter</span>
                                <input id="f_twitter" type="url" placeholder="https://x.com/username"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Instagram</span>
                                <input id="f_instagram" type="url" placeholder="https://instagram.com/username"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Medium</span>
                                <input id="f_medium" type="url" placeholder="https://medium.com/@username"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                        </div>

                        <h2 class="text-lg font-semibold">About</h2>
                        <label class="grid gap-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">Bio</span>
                            <textarea id="f_bio" rows="3"
                                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></textarea>
                        </label>
                        <label class="grid gap-1">
                            <span class="text-sm text-slate-700 dark:text-slate-300">Specializations (comma
                                separated)</span>
                            <input id="f_specs" type="text" placeholder="AI, Full‑stack, Data viz"
                                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                        </label>
                        <div class="grid md:grid-cols-2 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Technologies (comma/space
                                    separated)</span>
                                <input id="f_technologies" type="text" placeholder="React, Django, PostgreSQL"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Skills (comma separated)</span>
                                <input id="f_skills" type="text" placeholder="Python, Public speaking, Leadership"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Certifications</span>
                                <input id="f_certifications" type="text" placeholder="AWS CCP; Google Data Analytics"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Languages</span>
                                <input id="f_languages" type="text" placeholder="English, Tamil"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                            <label class="grid gap-1 md:col-span-2">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Interests</span>
                                <input id="f_interests" type="text" placeholder="Open source, Robotics, Design"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
                            </label>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Achievements</span>
                                <textarea id="f_achievements" rows="3" placeholder="Hackathon wins, awards, etc."
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></textarea>
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Experience</span>
                                <textarea id="f_experience" rows="3" placeholder="Internships, roles, responsibilities"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></textarea>
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Publications</span>
                                <textarea id="f_publications" rows="3" placeholder="Papers, articles"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></textarea>
                            </label>
                            <label class="grid gap-1">
                                <span class="text-sm text-slate-700 dark:text-slate-300">Project Info</span>
                                <textarea id="f_project_info" rows="3" placeholder="Highlights of projects"
                                    class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></textarea>
                            </label>
                        </div>

                        <h2 class="text-lg font-semibold mt-8">Experience</h2>
                        <p class="text-xs text-slate-600 dark:text-slate-400">Chronicle roles, internships, research or
                            teaching engagements.</p>
                        <div id="experienceList" class="grid gap-3 mt-3"></div>
                        <button id="addExperienceBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-xs hover:border-brand-400/60 text-brand-600 dark:text-brand-300">
                            <span class="material-symbols-rounded text-[18px]">add_circle</span> Add experience
                        </button>
                        <template id="experienceTemplate">
                            <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 p-4 grid gap-3"
                                data-entry="experience">
                                <input type="hidden" name="exp_id" />
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Title *</span>
                                        <input name="exp_title" type="text" required placeholder="Software Engineer"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Employment type</span>
                                        <select name="exp_employment_type"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value=""></option>
                                            <option>Full-time</option>
                                            <option>Part-time</option>
                                            <option>Internship</option>
                                            <option>Freelance</option>
                                            <option>Contract</option>
                                            <option>Self-employed</option>
                                            <option>Apprenticeship</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Company /
                                            Organization</span>
                                        <input name="exp_company" type="text" placeholder="Company name"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Company logo URL</span>
                                        <input name="exp_company_logo" type="url" placeholder="https://logo.png"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Location</span>
                                        <input name="exp_location" type="text" placeholder="City, Country"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Location type</span>
                                        <select name="exp_location_type"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value=""></option>
                                            <option>Onsite</option>
                                            <option>Remote</option>
                                            <option>Hybrid</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-3 gap-3 items-end">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Start date *</span>
                                        <input name="exp_start_date" type="date" required
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">End date</span>
                                        <input name="exp_end_date" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label
                                        class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                        <input name="exp_current" type="checkbox"
                                            class="rounded border-slate-300 text-brand-500" />
                                        <span>Currently here</span>
                                    </label>
                                </div>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Description</span>
                                    <textarea name="exp_description" rows="3"
                                        placeholder="Impact, responsibilities, wins…"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2"></textarea>
                                </label>
                                <div class="grid gap-2" data-media-list></div>
                                <div class="flex flex-wrap items-center justify-between gap-2">
                                    <button type="button"
                                        class="addExperienceMedia inline-flex items-center gap-1 rounded-lg border border-slate-200/60 dark:border-white/15 px-2 py-1 text-xs hover:border-brand-400/60">
                                        <span class="material-symbols-rounded text-[18px]">attach_file_add</span>
                                        Attachment
                                    </button>
                                    <button type="button"
                                        class="removeEntry inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">
                                        <span class="material-symbols-rounded text-[18px]">delete</span> Remove
                                        experience
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template id="experienceMediaTemplate">
                            <div class="rounded-lg border border-slate-200/50 dark:border-white/15 bg-white dark:bg-night-900/50 p-3 grid md:grid-cols-2 gap-2"
                                data-media-item>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Title</span>
                                    <input name="media_title" type="text" placeholder="Slide deck"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white px-2 py-1.5" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">URL</span>
                                    <input name="media_url" type="url" placeholder="https://"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white px-2 py-1.5" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Type</span>
                                    <select name="media_kind"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white px-2 py-1.5">
                                        <option value="link">Link</option>
                                        <option value="document">Document</option>
                                        <option value="video">Video</option>
                                        <option value="image">Image</option>
                                        <option value="presentation">Presentation</option>
                                    </select>
                                </label>
                                <div class="flex items-end justify-end">
                                    <button type="button"
                                        class="removeMedia inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">Remove</button>
                                </div>
                            </div>
                        </template>

                        <h2 class="text-lg font-semibold mt-8">Education</h2>
                        <p class="text-xs text-slate-600 dark:text-slate-400">Capture formal education, bootcamps or
                            certifications earned through institutions.</p>
                        <div id="educationList" class="grid gap-3 mt-3"></div>
                        <button id="addEducationBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-xs hover:border-brand-400/60 text-brand-600 dark:text-brand-300">
                            <span class="material-symbols-rounded text-[18px]">add_circle</span> Add education
                        </button>

                        <template id="educationTemplate">
                            <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 p-4 grid gap-3"
                                data-entry="education">
                                <input type="hidden" name="edu_id" />
                                <input type="hidden" name="edu_school" />
                                <input type="hidden" name="edu_degree" />
                                <input type="hidden" name="edu_department" />
                                <input type="hidden" name="edu_batch_range" />
                                <!-- Newly added hidden FK id fields -->
                                <input type="hidden" name="edu_college_id" />
                                <input type="hidden" name="edu_degree_id" />
                                <input type="hidden" name="edu_department_id" />
                                <input type="hidden" name="edu_batch_id" />
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Institution *</span>
                                    <select data-role="edu-college" required
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                        <option value="">Select college</option>
                                    </select>
                                    <input data-role="edu-college-custom" type="text"
                                        placeholder="Enter institution manually"
                                        class="hidden rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2 mt-2" />
                                </label>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Degree</span>
                                        <select data-role="edu-degree" disabled
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value="">Select degree</option>
                                        </select>
                                        <input data-role="edu-degree-custom" type="text" placeholder="Enter degree"
                                            class="hidden rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2 mt-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Department</span>
                                        <select data-role="edu-department" disabled
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value="">Select department</option>
                                        </select>
                                        <input data-role="edu-department-custom" type="text"
                                            placeholder="Enter department"
                                            class="hidden rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2 mt-2" />
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Batch</span>
                                        <select data-role="edu-batch" disabled
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value="">Select batch</option>
                                        </select>
                                        <input data-role="edu-batch-custom" type="text" placeholder="e.g., 2022-2026"
                                            class="hidden rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2 mt-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Section</span>
                                        <select name="edu_section"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value="">Select section</option>
                                            <option value="A">A</option>
                                            <option value="B">B</option>
                                            <option value="C">C</option>
                                            <option value="D">D</option>
                                            <option value="E">E</option>
                                            <option value="F">F</option>
                                            <option value="G">G</option>
                                            <option value="H">H</option>
                                            <option value="I">I</option>
                                            <option value="J">J</option>
                                            <option value="K">K</option>
                                            <option value="L">L</option>
                                            <option value="M">M</option>
                                            <option value="N">N</option>
                                            <option value="O">O</option>
                                            <option value="P">P</option>
                                            <option value="Q">Q</option>
                                            <option value="R">R</option>
                                            <option value="S">S</option>
                                            <option value="T">T</option>
                                            <option value="U">U</option>
                                            <option value="V">V</option>
                                            <option value="W">W</option>
                                            <option value="X">X</option>
                                            <option value="Y">Y</option>
                                            <option value="Z">Z</option>
                                        </select>
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Current Semester</span>
                                        <input name="edu_current_semester" type="number" min="1" max="12"
                                            placeholder="5"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Registration No.</span>
                                        <input name="edu_regno" type="text" placeholder="22TN0049"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Grade / GPA</span>
                                        <input name="edu_grade" type="text" placeholder="9.1 CGPA"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Activities &
                                        societies</span>
                                    <input name="edu_activities" type="text" placeholder="Clubs, committees…"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Highlights</span>
                                    <textarea name="edu_description" rows="3"
                                        placeholder="Leadership, projects, honours…"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2"></textarea>
                                </label>
                                <div class="flex justify-end">
                                    <button type="button"
                                        class="removeEntry inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">Remove
                                        education</button>
                                </div>
                            </div>
                        </template>


                        <h2 class="text-lg font-semibold mt-8">Licenses & Certifications</h2>
                        <p class="text-xs text-slate-600 dark:text-slate-400">Add credentials so recruiters can verify
                            your expertise.</p>
                        <div id="certificationList" class="grid gap-3 mt-3"></div>
                        <button id="addCertificationBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-xs hover:border-brand-400/60 text-brand-600 dark:text-brand-300">
                            <span class="material-symbols-rounded text-[18px]">add_circle</span> Add certification
                        </button>
                        <template id="certificationTemplate">
                            <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 p-4 grid gap-3"
                                data-entry="certification">
                                <input type="hidden" name="cert_id" />
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Certification *</span>
                                        <input name="cert_name" type="text" required
                                            placeholder="AWS Certified Developer"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Issuing
                                            organization</span>
                                        <input name="cert_org" type="text" placeholder="AWS"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-3 gap-3 items-end">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Issue date</span>
                                        <input name="cert_issue" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Expiration date</span>
                                        <input name="cert_expiry" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label
                                        class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                        <input name="cert_no_expiry" type="checkbox"
                                            class="rounded border-slate-300 text-brand-500" /> Does not expire
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Credential ID</span>
                                        <input name="cert_credential_id" type="text"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Credential URL</span>
                                        <input name="cert_credential_url" type="url" placeholder="https://verify"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Notes</span>
                                    <textarea name="cert_description" rows="2"
                                        placeholder="Score, scope or coverage details"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2"></textarea>
                                </label>
                                <div class="flex justify-end">
                                    <button type="button"
                                        class="removeEntry inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">Remove
                                        certification</button>
                                </div>
                            </div>
                        </template>

                        <h2 class="text-lg font-semibold mt-8">Portfolio Projects</h2>
                        <p class="text-xs text-slate-600 dark:text-slate-400">Showcase academic, professional or
                            personal projects with outcomes.</p>
                        <div id="portfolioList" class="grid gap-3 mt-3"></div>
                        <button id="addPortfolioBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-xs hover:border-brand-400/60 text-brand-600 dark:text-brand-300">
                            <span class="material-symbols-rounded text-[18px]">add_circle</span> Add project
                        </button>
                        <template id="portfolioTemplate">
                            <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 p-4 grid gap-3"
                                data-entry="portfolio">
                                <input type="hidden" name="proj_id" />
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Project name *</span>
                                    <input name="proj_name" type="text" required placeholder="Build Week Platform"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Linked
                                            experience</span>
                                        <select name="proj_experience" data-associate="experience"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value=""></option>
                                        </select>
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Linked education</span>
                                        <select name="proj_education" data-associate="education"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2">
                                            <option value=""></option>
                                        </select>
                                    </label>
                                </div>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Start date</span>
                                        <input name="proj_start" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">End date</span>
                                        <input name="proj_end" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Project URL</span>
                                    <input name="proj_url" type="url" placeholder="https://demo"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Description</span>
                                    <textarea name="proj_description" rows="3" placeholder="Goals, tech and impact…"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2"></textarea>
                                </label>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Tech stack (comma
                                            separated)</span>
                                        <input name="proj_stack" type="text" placeholder="React, FastAPI, Supabase"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Team (comma
                                            separated)</span>
                                        <input name="proj_team" type="text" placeholder="Alice, Bob"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <div class="flex justify-end">
                                    <button type="button"
                                        class="removeEntry inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">Remove
                                        project</button>
                                </div>
                            </div>
                        </template>

                        <h2 class="text-lg font-semibold mt-8">Publications</h2>
                        <p class="text-xs text-slate-600 dark:text-slate-400">Include papers, talks or articles to
                            highlight thought leadership.</p>
                        <div id="publicationList" class="grid gap-3 mt-3"></div>
                        <button id="addPublicationBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-xs hover:border-brand-400/60 text-brand-600 dark:text-brand-300">
                            <span class="material-symbols-rounded text-[18px]">add_circle</span> Add publication
                        </button>
                        <template id="publicationTemplate">
                            <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-night-800/70 p-4 grid gap-3"
                                data-entry="publication">
                                <input type="hidden" name="pub_id" />
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Title *</span>
                                    <input name="pub_title" type="text" required placeholder="Paper title"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Publisher /
                                            Journal</span>
                                        <input name="pub_publisher" type="text" placeholder="ACM, Medium…"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                    <label class="grid gap-1">
                                        <span class="text-xs text-slate-600 dark:text-slate-300">Publication date</span>
                                        <input name="pub_date" type="date"
                                            class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                    </label>
                                </div>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Authors (comma
                                        separated)</span>
                                    <input name="pub_authors" type="text" placeholder="You, Collaborator"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Publication URL</span>
                                    <input name="pub_url" type="url" placeholder="https://doi.org/..."
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2" />
                                </label>
                                <label class="grid gap-1">
                                    <span class="text-xs text-slate-600 dark:text-slate-300">Abstract / Summary</span>
                                    <textarea name="pub_abstract" rows="3" placeholder="Key findings, impact, context"
                                        class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-900/50 px-3 py-2"></textarea>
                                </label>
                                <div class="flex justify-end">
                                    <button type="button"
                                        class="removeEntry inline-flex items-center gap-1 rounded-lg border border-rose-300/40 text-rose-500 px-2 py-1 text-xs hover:border-rose-400/60">Remove
                                        publication</button>
                                </div>
                            </div>
                        </template>
                        <div class="flex items-center justify-between">
                            <a href="profile.html"
                                class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-2 hover:border-brand-400/60">Cancel</a>
                        </div>
                        <div id="status"
                            class="hidden text-xs rounded border border-slate-200/60 dark:border-white/10 p-2"></div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <script>
        const apiBase = (window.API_BASE || 'http://localhost:8000').replace(/\/$/, '');
        function getToken() { try { return localStorage.getItem('px_token'); } catch { return null; } }
        function authHeaders() { const t = getToken(); return t ? { 'Authorization': `Bearer ${t}` } : {}; }
        function initials(name) { if (!name) return 'U'; const p = String(name).trim().split(/\s+/).slice(0, 2); return p.map(x => x[0]?.toUpperCase()).join('') || 'U'; }

        const experienceList = document.getElementById('experienceList');
        const educationList = document.getElementById('educationList');
        const certificationList = document.getElementById('certificationList');
        const portfolioList = document.getElementById('portfolioList');
        const publicationList = document.getElementById('publicationList');

        const experienceTemplate = document.getElementById('experienceTemplate');
        const experienceMediaTemplate = document.getElementById('experienceMediaTemplate');
        const educationTemplate = document.getElementById('educationTemplate');
        const certificationTemplate = document.getElementById('certificationTemplate');
        const portfolioTemplate = document.getElementById('portfolioTemplate');
        const publicationTemplate = document.getElementById('publicationTemplate');

        const EDUCATION_CUSTOM_VALUE = '__custom__';
        let collegesCache = [];
        let collegesLoadPromise = null;
        const collegeDetailCache = new Map();

        function setAvatar(initialsText, imageUrl) {
            const initialsEl = document.getElementById('avatarInitials');
            const imgEl = document.getElementById('avatarImg');
            if (initialsEl) initialsEl.textContent = initialsText || 'U';
            if (!imgEl) return;
            if (imageUrl) {
                imgEl.src = imageUrl;
                imgEl.classList.remove('hidden');
                if (initialsEl) initialsEl.classList.add('hidden');
            } else {
                imgEl.removeAttribute('src');
                imgEl.classList.add('hidden');
                if (initialsEl) initialsEl.classList.remove('hidden');
            }
        }

        async function uploadProfileAsset(kind, file) {
            const fd = new FormData();
            fd.append('kind', kind);
            fd.append('file', file);
            const res = await fetch(`${apiBase}/api/profile/upload`, {
                method: 'POST',
                headers: authHeaders(),
                body: fd,
            });
            const out = await res.json().catch(() => ({}));
            return { ok: res.ok, out };
        }

        async function loadCollegesList() {
            if (collegesCache.length) return collegesCache;
            if (!collegesLoadPromise) {
                collegesLoadPromise = fetch(`${apiBase}/api/colleges`, { headers: authHeaders() })
                    .then(res => (res.ok ? res.json() : []))
                    .catch(err => {
                        console.error('Failed to load colleges', err);
                        return [];
                    })
                    .then(items => {
                        collegesCache = Array.isArray(items)
                            ? items
                                .filter(col => col && col.id && col.name)
                                .map(col => ({ id: String(col.id), name: col.name }))
                            : [];
                        return collegesCache;
                    });
            }
            return collegesLoadPromise;
        }

        function getCollegeById(id) {
            if (!id) return null;
            return collegesCache.find(col => String(col.id) === String(id)) || null;
        }

        function findCollegeByName(name) {
            if (!name) return null;
            const target = String(name).trim().toLowerCase();
            if (!target) return null;
            return collegesCache.find(col => String(col?.name || '').trim().toLowerCase() === target) || null;
        }

        async function loadCollegeDetails(collegeId) {
            if (!collegeId) return null;
            const key = String(collegeId);
            if (collegeDetailCache.has(key)) {
                return collegeDetailCache.get(key);
            }
            try {
                const res = await fetch(`${apiBase}/api/colleges/${key}`, { headers: authHeaders() });
                if (!res.ok) throw new Error(`status ${res.status}`);
                const data = await res.json();
                collegeDetailCache.set(key, data);
                return data;
            } catch (err) {
                console.error('Failed to load college details', err);
                collegeDetailCache.set(key, null);
                return null;
            }
        }

        function findDegreeByName(degrees, name) {
            if (!Array.isArray(degrees) || !name) return null;
            const target = String(name).trim().toLowerCase();
            if (!target) return null;
            return degrees.find(deg => String(deg?.name || '').trim().toLowerCase() === target) || null;
        }

        function findDepartmentByName(departments, name) {
            if (!Array.isArray(departments) || !name) return null;
            const target = String(name).trim().toUpperCase();
            if (!target) return null;
            return departments.find(dep => String(dep?.name || '').trim().toUpperCase() === target) || null;
        }

        function formatBatchRange(batch) {
            if (!batch) return '';
            const from = Number(batch.from ?? batch.from_year);
            const to = Number(batch.to ?? batch.to_year);
            if (Number.isFinite(from) && Number.isFinite(to)) {
                return `${from}-${to}`;
            }
            return '';
        }

        function fillSelectOptions(select, options, { placeholder = 'Select...', includeCustom = false } = {}) {
            if (!select) return;
            select.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            select.appendChild(placeholderOption);
            (options || []).forEach(opt => {
                if (!opt) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                select.appendChild(option);
            });
            if (includeCustom) {
                const customOption = document.createElement('option');
                customOption.value = EDUCATION_CUSTOM_VALUE;
                customOption.textContent = 'Other / Not listed';
                select.appendChild(customOption);
            }
        }

        function toggleCustomInput(input, show) {
            if (!input) return;
            if (show) {
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
            }
        }


        const addExperienceBtn = document.getElementById('addExperienceBtn');
        const addEducationBtn = document.getElementById('addEducationBtn');
        const addCertificationBtn = document.getElementById('addCertificationBtn');
        const addPortfolioBtn = document.getElementById('addPortfolioBtn');
        const addPublicationBtn = document.getElementById('addPublicationBtn');


        const parseList = (value) => (value || '').split(',').map(s => s.trim()).filter(Boolean);

        const createFromTemplate = (template) => template ? template.content.firstElementChild.cloneNode(true) : null;

        const toggleDisabled = (input, disabled) => {
            if (!input) return;
            if (disabled) {
                input.value = '';
                input.disabled = true;
                input.classList.add('opacity-60');
            } else {
                input.disabled = false;
                input.classList.remove('opacity-60');
            }
        };

        const addExperienceMedia = (container, data = {}) => {
            if (!experienceMediaTemplate || !container) return;
            const node = createFromTemplate(experienceMediaTemplate);
            if (!node) return;
            node.querySelector('input[name="media_title"]').value = data.title || '';
            node.querySelector('input[name="media_url"]').value = data.url || '';
            node.querySelector('select[name="media_kind"]').value = data.kind || 'link';
            node.querySelector('.removeMedia')?.addEventListener('click', () => node.remove());
            container.appendChild(node);
        };

        const addExperienceRow = (data = {}) => {
            if (!experienceTemplate || !experienceList) return;
            const node = createFromTemplate(experienceTemplate);
            if (!node) return;
            node.querySelector('input[name="exp_id"]').value = data.id || '';
            node.querySelector('input[name="exp_title"]').value = data.title || '';
            node.querySelector('select[name="exp_employment_type"]').value = data.employment_type || '';
            node.querySelector('input[name="exp_company"]').value = data.company || '';
            node.querySelector('input[name="exp_company_logo"]').value = data.company_logo_url || '';
            node.querySelector('input[name="exp_location"]').value = data.location || '';
            node.querySelector('select[name="exp_location_type"]').value = data.location_type || '';
            node.querySelector('input[name="exp_start_date"]').value = data.start_date || '';
            node.querySelector('input[name="exp_end_date"]').value = data.end_date || '';
            node.querySelector('textarea[name="exp_description"]').value = data.description || '';
            const current = node.querySelector('input[name="exp_current"]');
            current.checked = Boolean(data.is_current);
            const endInput = node.querySelector('input[name="exp_end_date"]');
            const toggle = () => toggleDisabled(endInput, current.checked);
            current.addEventListener('change', toggle);
            toggle();
            const mediaWrap = node.querySelector('[data-media-list]');
            (Array.isArray(data.media) ? data.media : []).forEach(item => addExperienceMedia(mediaWrap, item));
            node.querySelector('.addExperienceMedia')?.addEventListener('click', () => addExperienceMedia(mediaWrap));
            node.querySelector('.removeEntry')?.addEventListener('click', () => { node.remove(); refreshAssociations(); });
            experienceList.appendChild(node);
        };


        const initializeEducationRow = async (row, data = {}) => {
            const hiddenSchool = row.querySelector('input[name="edu_school"]');
            const hiddenDegree = row.querySelector('input[name="edu_degree"]');
            const hiddenDepartment = row.querySelector('input[name="edu_department"]');
            const hiddenBatch = row.querySelector('input[name="edu_batch_range"]');
            const hiddenCollegeId = row.querySelector('input[name="edu_college_id"]');
            const hiddenDegreeId = row.querySelector('input[name="edu_degree_id"]');
            const hiddenDepartmentId = row.querySelector('input[name="edu_department_id"]');
            const hiddenBatchId = row.querySelector('input[name="edu_batch_id"]');
            const sectionSelect = row.querySelector('select[name="edu_section"]');

            const collegeSelect = row.querySelector('[data-role="edu-college"]');
            const collegeCustomInput = row.querySelector('[data-role="edu-college-custom"]');
            const degreeSelect = row.querySelector('[data-role="edu-degree"]');
            const degreeCustomInput = row.querySelector('[data-role="edu-degree-custom"]');
            const departmentSelect = row.querySelector('[data-role="edu-department"]');
            const departmentCustomInput = row.querySelector('[data-role="edu-department-custom"]');
            const batchSelect = row.querySelector('[data-role="edu-batch"]');
            const batchCustomInput = row.querySelector('[data-role="edu-batch-custom"]');

            if (!collegeSelect || !degreeSelect || !departmentSelect || !batchSelect) {
                return;
            }

            const state = { degrees: [] };
            let initialValues = {
                collegeName: data.school || '',
                degreeName: data.degree || '',
                departmentName: data.department || '',
                batchRange: data.batch_range || '',
            };

            if (hiddenSchool) hiddenSchool.value = initialValues.collegeName;
            if (hiddenDegree) hiddenDegree.value = initialValues.degreeName;
            if (hiddenDepartment) hiddenDepartment.value = initialValues.departmentName;
            if (hiddenBatch) hiddenBatch.value = initialValues.batchRange;

            const colleges = await loadCollegesList().catch(() => []);
            const collegeOptions = (colleges || []).map(col => ({ value: col.id, label: col.name }));
            fillSelectOptions(collegeSelect, collegeOptions, { placeholder: 'Select college', includeCustom: true });

            if (initialValues.collegeName) {
                const match = findCollegeByName(initialValues.collegeName);
                if (match) {
                    collegeSelect.value = match.id;
                } else {
                    collegeSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (collegeCustomInput) {
                        collegeCustomInput.value = initialValues.collegeName;
                        toggleCustomInput(collegeCustomInput, true);
                    }
                }
            } else if (!collegeOptions.length) {
                collegeSelect.value = EDUCATION_CUSTOM_VALUE;
                if (collegeCustomInput) toggleCustomInput(collegeCustomInput, true);
            }

            let collegeRequestId = 0;

            async function handleCollegeChange(isInitial = false) {
                const selected = collegeSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;

                if (isCustom) {
                    if (collegeCustomInput) toggleCustomInput(collegeCustomInput, true);
                    if (hiddenSchool) hiddenSchool.value = (collegeCustomInput?.value || '').trim();
                    if (hiddenCollegeId) hiddenCollegeId.value = '';

                    degreeSelect.disabled = false;
                    state.degrees = [];
                    fillSelectOptions(degreeSelect, [], { placeholder: 'Select degree', includeCustom: true });
                    degreeSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.degreeName && degreeCustomInput) {
                        degreeCustomInput.value = initialValues.degreeName;
                    }
                    if (degreeCustomInput) toggleCustomInput(degreeCustomInput, true);
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();

                    departmentSelect.disabled = false;
                    fillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.departmentName && departmentCustomInput) {
                        departmentCustomInput.value = initialValues.departmentName;
                    }
                    if (departmentCustomInput) toggleCustomInput(departmentCustomInput, true);
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();

                    batchSelect.disabled = false;
                    fillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    if (isInitial && initialValues?.batchRange) {
                        batchSelect.value = initialValues.batchRange;
                        if (hiddenBatch) hiddenBatch.value = initialValues.batchRange;
                        if (batchCustomInput) {
                            toggleCustomInput(batchCustomInput, false);
                            batchCustomInput.value = '';
                        }
                    } else {
                        batchSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (batchCustomInput) toggleCustomInput(batchCustomInput, true);
                        if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    }
                    refreshAssociations();
                    return;
                }

                if (collegeCustomInput) {
                    toggleCustomInput(collegeCustomInput, false);
                    collegeCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenSchool) hiddenSchool.value = '';
                    if (hiddenCollegeId) hiddenCollegeId.value = '';

                    degreeSelect.disabled = true;
                    fillSelectOptions(degreeSelect, [], { placeholder: 'Select degree', includeCustom: true });
                    degreeSelect.value = '';
                    if (degreeCustomInput) {
                        toggleCustomInput(degreeCustomInput, false);
                        degreeCustomInput.value = '';
                    }
                    if (hiddenDegree) hiddenDegree.value = '';

                    departmentSelect.disabled = true;
                    fillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = '';
                    if (departmentCustomInput) {
                        toggleCustomInput(departmentCustomInput, false);
                        departmentCustomInput.value = '';
                    }
                    if (hiddenDepartment) hiddenDepartment.value = '';

                    batchSelect.disabled = true;
                    fillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        toggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    refreshAssociations();
                    return;
                }

                const college = getCollegeById(selected);
                if (hiddenSchool) hiddenSchool.value = college?.name || '';
                if (hiddenCollegeId) hiddenCollegeId.value = selected;
                degreeSelect.disabled = false;

                const requestId = ++collegeRequestId;
                const details = await loadCollegeDetails(selected);
                if (collegeSelect.value !== selected || requestId !== collegeRequestId) {
                    return;
                }

                state.degrees = Array.isArray(details?.degrees) ? details.degrees : [];
                const degreeOptions = state.degrees.map(deg => ({ value: String(deg.id), label: deg.name }));
                fillSelectOptions(degreeSelect, degreeOptions, { placeholder: 'Select degree', includeCustom: true });

                let desiredDegree = '';
                if (isInitial && initialValues?.degreeName) {
                    const match = findDegreeByName(state.degrees, initialValues.degreeName);
                    if (match) {
                        desiredDegree = String(match.id);
                    } else {
                        desiredDegree = EDUCATION_CUSTOM_VALUE;
                        if (degreeCustomInput) degreeCustomInput.value = initialValues.degreeName;
                    }
                } else if (!degreeOptions.length) {
                    desiredDegree = EDUCATION_CUSTOM_VALUE;
                }

                degreeSelect.value = desiredDegree;
                await handleDegreeChange(isInitial);
                refreshAssociations();
            }

            function handleCollegeCustomInput() {
                if (collegeSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenSchool) hiddenSchool.value = (collegeCustomInput?.value || '').trim();
                    refreshAssociations();
                }
            }

            async function handleDegreeChange(isInitial = false) {
                const selected = degreeSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;

                if (isCustom) {
                    if (degreeCustomInput) toggleCustomInput(degreeCustomInput, true);
                    if (isInitial && initialValues?.degreeName && degreeCustomInput) {
                        degreeCustomInput.value = initialValues.degreeName;
                    }
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();
                    if (hiddenDegreeId) hiddenDegreeId.value = '';

                    departmentSelect.disabled = false;
                    fillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = EDUCATION_CUSTOM_VALUE;
                    await handleDepartmentChange(isInitial);
                    return;
                }

                if (degreeCustomInput) {
                    toggleCustomInput(degreeCustomInput, false);
                    degreeCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenDegree) hiddenDegree.value = '';
                    if (hiddenDegreeId) hiddenDegreeId.value = '';

                    departmentSelect.disabled = true;
                    fillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = '';
                    if (departmentCustomInput) {
                        toggleCustomInput(departmentCustomInput, false);
                        departmentCustomInput.value = '';
                    }
                    if (hiddenDepartment) hiddenDepartment.value = '';

                    batchSelect.disabled = true;
                    fillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        toggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    return;
                }

                const degree = state.degrees.find(d => String(d.id) === selected) || null;
                if (hiddenDegree) hiddenDegree.value = degree?.name || '';
                if (hiddenDegreeId) hiddenDegreeId.value = selected;

                const departments = Array.isArray(degree?.departments) ? degree.departments : [];
                const departmentOptions = departments.map(dep => ({ value: String(dep.id), label: dep.name }));
                departmentSelect.disabled = false;
                fillSelectOptions(departmentSelect, departmentOptions, { placeholder: 'Select department', includeCustom: true });

                let desiredDepartment = '';
                if (isInitial && initialValues?.departmentName) {
                    const match = findDepartmentByName(departments, initialValues.departmentName);
                    if (match) {
                        desiredDepartment = String(match.id);
                    } else {
                        desiredDepartment = EDUCATION_CUSTOM_VALUE;
                        if (departmentCustomInput) departmentCustomInput.value = initialValues.departmentName;
                    }
                } else if (!departmentOptions.length) {
                    desiredDepartment = EDUCATION_CUSTOM_VALUE;
                }

                departmentSelect.value = desiredDepartment;
                await handleDepartmentChange(isInitial);
            }

            function handleDegreeCustomInput() {
                if (degreeSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();
                }
            }

            async function handleDepartmentChange(isInitial = false) {
                const selected = departmentSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;

                if (isCustom) {
                    if (departmentCustomInput) toggleCustomInput(departmentCustomInput, true);
                    if (isInitial && initialValues?.departmentName && departmentCustomInput) {
                        departmentCustomInput.value = initialValues.departmentName;
                    }
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();
                    if (hiddenDepartmentId) hiddenDepartmentId.value = '';

                    batchSelect.disabled = false;
                    fillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    if (isInitial && initialValues?.batchRange) {
                        batchSelect.value = initialValues.batchRange;
                        if (hiddenBatch) hiddenBatch.value = initialValues.batchRange;
                        if (batchCustomInput) {
                            toggleCustomInput(batchCustomInput, false);
                            batchCustomInput.value = '';
                        }
                    } else {
                        batchSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (batchCustomInput) toggleCustomInput(batchCustomInput, true);
                        if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    }
                    return;
                }

                if (departmentCustomInput) {
                    toggleCustomInput(departmentCustomInput, false);
                    departmentCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenDepartment) hiddenDepartment.value = '';
                    if (hiddenDepartmentId) hiddenDepartmentId.value = '';

                    batchSelect.disabled = true;
                    fillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        toggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    return;
                }

                const degree = state.degrees.find(d => String(d.id) === (degreeSelect.value || '')) || null;
                const departments = Array.isArray(degree?.departments) ? degree.departments : [];
                const department = departments.find(dep => String(dep.id) === selected) || null;
                if (hiddenDepartment) hiddenDepartment.value = department?.name || '';
                if (hiddenDepartmentId) hiddenDepartmentId.value = selected;

                const batches = Array.isArray(department?.batches) ? department.batches : [];
                const batchOptions = batches
                    .map(batch => {
                        const label = formatBatchRange(batch);
                        return label ? { value: label, label } : null;
                    })
                    .filter(Boolean);

                batchSelect.disabled = false;
                fillSelectOptions(batchSelect, batchOptions, { placeholder: 'Select batch', includeCustom: true });

                let desiredBatch = '';
                if (isInitial && initialValues?.batchRange) {
                    if (batchOptions.some(opt => opt.value === initialValues.batchRange)) {
                        desiredBatch = initialValues.batchRange;
                    } else {
                        desiredBatch = EDUCATION_CUSTOM_VALUE;
                        if (batchCustomInput) batchCustomInput.value = initialValues.batchRange;
                    }
                }

                batchSelect.value = desiredBatch;
                handleBatchChange(isInitial);
            }

            function handleDepartmentCustomInput() {
                if (departmentSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();
                }
            }

            function handleBatchChange(isInitial = false) {
                const selected = batchSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;
                if (batchCustomInput) toggleCustomInput(batchCustomInput, isCustom);

                if (isCustom) {
                    if (isInitial && initialValues?.batchRange && batchCustomInput) {
                        batchCustomInput.value = initialValues.batchRange;
                    }
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                } else {
                    if (hiddenBatch) hiddenBatch.value = selected || '';
                    if (!selected && batchCustomInput) batchCustomInput.value = '';
                }
            }

            function handleBatchCustomInput() {
                if (batchSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                }
            }

            collegeSelect.addEventListener('change', () => { handleCollegeChange(false); });
            collegeCustomInput?.addEventListener('input', handleCollegeCustomInput);
            degreeSelect.addEventListener('change', () => { handleDegreeChange(false); });
            degreeCustomInput?.addEventListener('input', handleDegreeCustomInput);
            departmentSelect.addEventListener('change', () => { handleDepartmentChange(false); });
            departmentCustomInput?.addEventListener('input', handleDepartmentCustomInput);
            batchSelect.addEventListener('change', () => { handleBatchChange(false); });
            batchCustomInput?.addEventListener('input', handleBatchCustomInput);
            if (sectionSelect && data.section) {
                sectionSelect.value = String(data.section).trim().toUpperCase();
            }

            await handleCollegeChange(true);
            initialValues = null;
        };

        const addEducationRow = (data = {}) => {
            if (!educationTemplate || !educationList) return;
            const node = createFromTemplate(educationTemplate);
            if (!node) return;
            node.querySelector('input[name="edu_id"]').value = data.id || '';
            node.querySelector('input[name="edu_school"]').value = data.school || '';
            node.querySelector('input[name="edu_degree"]').value = data.degree || '';
            node.querySelector('input[name="edu_department"]').value = data.department || '';
            node.querySelector('input[name="edu_batch_range"]').value = data.batch_range || '';
            if (data.college_id) node.querySelector('input[name="edu_college_id"]').value = data.college_id;
            if (data.degree_id) node.querySelector('input[name="edu_degree_id"]').value = data.degree_id;
            if (data.department_id) node.querySelector('input[name="edu_department_id"]').value = data.department_id;
            if (data.batch_id) node.querySelector('input[name="edu_batch_id"]').value = data.batch_id;
            const sectionSelect = node.querySelector('select[name="edu_section"]');
            if (sectionSelect) sectionSelect.value = (data.section || '').toUpperCase();
            node.querySelector('input[name="edu_current_semester"]').value = (data.current_semester ?? '') || '';
            node.querySelector('input[name="edu_regno"]').value = data.regno || '';
            node.querySelector('input[name="edu_grade"]').value = data.grade || '';
            node.querySelector('input[name="edu_activities"]').value = data.activities || '';
            node.querySelector('textarea[name="edu_description"]').value = data.description || '';
            node.querySelector('.removeEntry')?.addEventListener('click', () => { node.remove(); refreshAssociations(); });
            educationList.appendChild(node);
            initializeEducationRow(node, data).catch(err => console.error('Failed to initialize education row', err));
        };

        const addCertificationRow = (data = {}) => {
            if (!certificationTemplate || !certificationList) return;
            const node = createFromTemplate(certificationTemplate);
            if (!node) return;
            node.querySelector('input[name="cert_id"]').value = data.id || '';
            node.querySelector('input[name="cert_name"]').value = data.name || '';
            node.querySelector('input[name="cert_org"]').value = data.issuing_org || '';
            node.querySelector('input[name="cert_issue"]').value = data.issue_date || '';
            node.querySelector('input[name="cert_expiry"]').value = data.expiration_date || '';
            const noExpiry = node.querySelector('input[name="cert_no_expiry"]');
            noExpiry.checked = Boolean(data.does_not_expire);
            const expiryInput = node.querySelector('input[name="cert_expiry"]');
            const toggle = () => toggleDisabled(expiryInput, noExpiry.checked);
            noExpiry.addEventListener('change', toggle);
            toggle();
            node.querySelector('input[name="cert_credential_id"]').value = data.credential_id || '';
            node.querySelector('input[name="cert_credential_url"]').value = data.credential_url || '';
            node.querySelector('textarea[name="cert_description"]').value = data.description || '';
            node.querySelector('.removeEntry')?.addEventListener('click', () => node.remove());
            certificationList.appendChild(node);
        };

        const getExperienceOptions = () => Array.from(experienceList?.querySelectorAll('[data-entry="experience"]') || [])
            .map(row => ({
                id: row.querySelector('input[name="exp_id"]').value,
                label: row.querySelector('input[name="exp_title"]').value || 'Experience'
            }))
            .filter(item => item.id);

        const getEducationOptions = () => Array.from(educationList?.querySelectorAll('[data-entry="education"]') || [])
            .map(row => ({
                id: row.querySelector('input[name="edu_id"]').value,
                label: row.querySelector('input[name="edu_school"]').value || 'Education'
            }))
            .filter(item => item.id);

        const fillAssociateOptions = (select, options, selected) => {
            if (!select) return;
            const current = selected ?? select.value ?? '';
            select.innerHTML = '';
            const blank = document.createElement('option');
            blank.value = '';
            blank.textContent = '';
            select.appendChild(blank);
            let hasMatch = false;
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.id;
                option.textContent = opt.label;
                if (opt.id === current) { option.selected = true; hasMatch = true; }
                select.appendChild(option);
            });
            if (!hasMatch) select.value = '';
        };

        const refreshAssociations = () => {
            const expOptions = getExperienceOptions();
            const eduOptions = getEducationOptions();
            Array.from(portfolioList?.querySelectorAll('[data-entry="portfolio"]') || []).forEach(row => {
                const expSelect = row.querySelector('select[name="proj_experience"]');
                const eduSelect = row.querySelector('select[name="proj_education"]');
                if (expSelect) fillAssociateOptions(expSelect, expOptions, expSelect.dataset.selected || expSelect.value);
                if (eduSelect) fillAssociateOptions(eduSelect, eduOptions, eduSelect.dataset.selected || eduSelect.value);
            });
        };

        const addPortfolioRow = (data = {}) => {
            if (!portfolioTemplate || !portfolioList) return;
            const node = createFromTemplate(portfolioTemplate);
            if (!node) return;
            node.querySelector('input[name="proj_id"]').value = data.id || '';
            node.querySelector('input[name="proj_name"]').value = data.name || '';
            const expSelect = node.querySelector('select[name="proj_experience"]');
            const eduSelect = node.querySelector('select[name="proj_education"]');
            if (expSelect) expSelect.dataset.selected = data.associated_experience_id || '';
            if (eduSelect) eduSelect.dataset.selected = data.associated_education_id || '';
            node.querySelector('input[name="proj_start"]').value = data.start_date || '';
            node.querySelector('input[name="proj_end"]').value = data.end_date || '';
            node.querySelector('input[name="proj_url"]').value = data.url || '';
            node.querySelector('textarea[name="proj_description"]').value = data.description || '';
            node.querySelector('input[name="proj_stack"]').value = Array.isArray(data.tech_stack) ? data.tech_stack.join(', ') : '';
            const teamNames = Array.isArray(data.team) ? data.team.map(member => typeof member === 'string' ? member : (member?.name || '')).filter(Boolean) : [];
            node.querySelector('input[name="proj_team"]').value = teamNames.join(', ');
            node.querySelector('.removeEntry')?.addEventListener('click', () => { node.remove(); });
            portfolioList.appendChild(node);
            refreshAssociations();
        };

        const addPublicationRow = (data = {}) => {
            if (!publicationTemplate || !publicationList) return;
            const node = createFromTemplate(publicationTemplate);
            if (!node) return;
            node.querySelector('input[name="pub_id"]').value = data.id || '';
            node.querySelector('input[name="pub_title"]').value = data.title || '';
            node.querySelector('input[name="pub_publisher"]').value = data.publisher || '';
            node.querySelector('input[name="pub_date"]').value = data.publication_date || '';
            const authors = Array.isArray(data.authors) ? data.authors.join(', ') : '';
            node.querySelector('input[name="pub_authors"]').value = authors;
            node.querySelector('input[name="pub_url"]').value = data.url || '';
            node.querySelector('textarea[name="pub_abstract"]').value = data.abstract || '';
            node.querySelector('.removeEntry')?.addEventListener('click', () => node.remove());
            publicationList.appendChild(node);
        };

        const collectExperienceData = () => Array.from(experienceList?.querySelectorAll('[data-entry="experience"]') || []).map(row => {
            const id = row.querySelector('input[name="exp_id"]').value || null;
            const title = row.querySelector('input[name="exp_title"]').value.trim();
            const start = row.querySelector('input[name="exp_start_date"]').value;
            if (!title || !start) return null;
            const media = Array.from(row.querySelectorAll('[data-media-item]')).map(item => {
                const url = item.querySelector('input[name="media_url"]').value.trim();
                if (!url) return null;
                return {
                    title: item.querySelector('input[name="media_title"]').value.trim() || null,
                    url,
                    kind: item.querySelector('select[name="media_kind"]').value || 'link',
                };
            }).filter(Boolean);
            const endInput = row.querySelector('input[name="exp_end_date"]');
            return {
                id,
                title,
                employment_type: row.querySelector('select[name="exp_employment_type"]').value || null,
                company: row.querySelector('input[name="exp_company"]').value.trim() || null,
                company_logo_url: row.querySelector('input[name="exp_company_logo"]').value.trim() || null,
                location: row.querySelector('input[name="exp_location"]').value.trim() || null,
                location_type: row.querySelector('select[name="exp_location_type"]').value || null,
                start_date: start || null,
                end_date: endInput && endInput.disabled ? null : (endInput?.value || null),
                is_current: row.querySelector('input[name="exp_current"]').checked,
                description: row.querySelector('textarea[name="exp_description"]').value.trim() || null,
                media,
            };
        }).filter(Boolean);

        const collectEducationData = () => Array.from(educationList?.querySelectorAll('[data-entry="education"]') || []).map(row => {
            const school = row.querySelector('input[name="edu_school"]').value.trim();
            if (!school) return null;
            const currentSemesterRaw = row.querySelector('input[name="edu_current_semester"]').value.trim();
            const current_semester = currentSemesterRaw ? parseInt(currentSemesterRaw, 10) : null;
            const college_id = row.querySelector('input[name="edu_college_id"]').value.trim() || null;
            const degree_id = row.querySelector('input[name="edu_degree_id"]').value.trim() || null;
            const department_id = row.querySelector('input[name="edu_department_id"]').value.trim() || null;
            const batch_id = row.querySelector('input[name="edu_batch_id"]').value.trim() || null;
            return {
                id: row.querySelector('input[name="edu_id"]').value || null,
                school,
                degree: row.querySelector('input[name="edu_degree"]').value.trim() || null,
                department: row.querySelector('input[name="edu_department"]').value.trim() || null,
                batch_range: row.querySelector('input[name="edu_batch_range"]').value || null,
                regno: row.querySelector('input[name="edu_regno"]').value.trim() || null,
                current_semester: (Number.isFinite(current_semester) && current_semester > 0) ? current_semester : null,
                grade: row.querySelector('input[name="edu_grade"]').value.trim() || null,
                activities: row.querySelector('input[name="edu_activities"]').value.trim() || null,
                description: row.querySelector('textarea[name="edu_description"]').value.trim() || null,
                college_id,
                degree_id,
                department_id,
                batch_id,
                section: (row.querySelector('select[name="edu_section"]').value || '').trim() || null,
            };
        }).filter(Boolean);

        const collectCertificationData = () => Array.from(certificationList?.querySelectorAll('[data-entry="certification"]') || []).map(row => {
            const name = row.querySelector('input[name="cert_name"]').value.trim();
            if (!name) return null;
            const noExpiry = row.querySelector('input[name="cert_no_expiry"]').checked;
            const expiryInput = row.querySelector('input[name="cert_expiry"]');
            return {
                id: row.querySelector('input[name="cert_id"]').value || null,
                name,
                issuing_org: row.querySelector('input[name="cert_org"]').value.trim() || null,
                issue_date: row.querySelector('input[name="cert_issue"]').value || null,
                expiration_date: noExpiry ? null : (expiryInput?.value || null),
                does_not_expire: noExpiry,
                credential_id: row.querySelector('input[name="cert_credential_id"]').value.trim() || null,
                credential_url: row.querySelector('input[name="cert_credential_url"]').value.trim() || null,
                description: row.querySelector('textarea[name="cert_description"]').value.trim() || null,
            };
        }).filter(Boolean);

        const collectPortfolioData = () => Array.from(portfolioList?.querySelectorAll('[data-entry="portfolio"]') || []).map(row => {
            const name = row.querySelector('input[name="proj_name"]').value.trim();
            if (!name) return null;
            const stack = parseList(row.querySelector('input[name="proj_stack"]').value);
            const team = parseList(row.querySelector('input[name="proj_team"]').value).map(member => ({ name: member }));
            return {
                id: row.querySelector('input[name="proj_id"]').value || null,
                name,
                associated_experience_id: row.querySelector('select[name="proj_experience"]').value || null,
                associated_education_id: row.querySelector('select[name="proj_education"]').value || null,
                start_date: row.querySelector('input[name="proj_start"]').value || null,
                end_date: row.querySelector('input[name="proj_end"]').value || null,
                url: row.querySelector('input[name="proj_url"]').value.trim() || null,
                description: row.querySelector('textarea[name="proj_description"]').value.trim() || null,
                tech_stack: stack,
                team,
            };
        }).filter(Boolean);

        const collectPublicationData = () => Array.from(publicationList?.querySelectorAll('[data-entry="publication"]') || []).map(row => {
            const title = row.querySelector('input[name="pub_title"]').value.trim();
            if (!title) return null;
            return {
                id: row.querySelector('input[name="pub_id"]').value || null,
                title,
                publisher: row.querySelector('input[name="pub_publisher"]').value.trim() || null,
                publication_date: row.querySelector('input[name="pub_date"]').value || null,
                authors: parseList(row.querySelector('input[name="pub_authors"]').value),
                url: row.querySelector('input[name="pub_url"]').value.trim() || null,
                abstract: row.querySelector('textarea[name="pub_abstract"]').value.trim() || null,
            };
        }).filter(Boolean);

        addExperienceBtn?.addEventListener('click', () => { addExperienceRow(); });
        addEducationBtn?.addEventListener('click', () => { addEducationRow(); });
        addCertificationBtn?.addEventListener('click', () => { addCertificationRow(); });
        addPortfolioBtn?.addEventListener('click', () => { addPortfolioRow(); });
        addPublicationBtn?.addEventListener('click', () => { addPublicationRow(); });

        async function fetchProfileData() {
            let res = await fetch(`${apiBase}/api/profile/me`, { headers: authHeaders() });
            if (res.status === 401) { window.location.href = 'login.html'; return null; }
            if (res.ok) { return await res.json(); }
            // Fallback to /api/me shape
            res = await fetch(`${apiBase}/api/me`, { headers: authHeaders() });
            if (res.status === 401) { window.location.href = 'login.html'; return null; }
            const d = await res.json().catch(() => null);
            return d && d.profile ? d.profile : d;
        }

        async function loadProfile() {
            try {
                const data = await fetchProfileData();
                if (!data) return;
                document.getElementById('name').textContent = data.name || '—';
                document.getElementById('email').textContent = data.email || '—';
                setAvatar(initials(data.name), data.profile_image_url || null);
                document.getElementById('f_name').value = data.name || '';
                document.getElementById('f_email_ro').value = data.email || '';
                document.getElementById('f_headline').value = data.headline || '';
                document.getElementById('f_location').value = data.location || '';
                document.getElementById('f_dob').value = data.dob || '';
                document.getElementById('f_phone').value = data.phone || '';
                document.getElementById('f_bio').value = data.bio || '';
                document.getElementById('f_linkedin').value = data.linkedin || '';
                document.getElementById('f_github').value = data.github || '';
                document.getElementById('f_portfolio').value = data.portfolio_url || '';
                document.getElementById('f_website').value = data.website || '';
                document.getElementById('f_twitter').value = data.twitter || '';
                document.getElementById('f_instagram').value = data.instagram || '';
                document.getElementById('f_medium').value = data.medium || '';
                document.getElementById('f_leetcode').value = data.leetcode || '';
                document.getElementById('f_technologies').value = data.technologies || '';
                document.getElementById('f_skills').value = data.skills || '';
                document.getElementById('f_certifications').value = data.certifications || '';
                document.getElementById('f_languages').value = data.languages || '';
                document.getElementById('f_interests').value = data.interests || '';
                document.getElementById('f_achievements').value = data.achievements || '';
                document.getElementById('f_experience').value = data.experience || '';
                document.getElementById('f_publications').value = data.publications || '';
                document.getElementById('f_project_info').value = data.project_info || '';
                document.getElementById('f_specs').value = Array.isArray(data.specializations) ? data.specializations.join(', ') : (data.specializations || '');

                if (experienceList) {
                    experienceList.innerHTML = '';
                    const experiences = Array.isArray(data.experiences) ? data.experiences : [];
                    experiences.forEach(exp => addExperienceRow(exp));
                }

                if (educationList) {
                    educationList.innerHTML = '';
                    const educationEntries = Array.isArray(data.education_entries) ? data.education_entries : [];
                    educationEntries.forEach(entry => addEducationRow(entry));
                }

                if (certificationList) {
                    certificationList.innerHTML = '';
                    const certEntries = Array.isArray(data.certification_entries) ? data.certification_entries : [];
                    certEntries.forEach(entry => addCertificationRow(entry));
                }

                if (portfolioList) {
                    portfolioList.innerHTML = '';
                    const portfolioEntries = Array.isArray(data.portfolio_projects) ? data.portfolio_projects : [];
                    portfolioEntries.forEach(entry => addPortfolioRow(entry));
                }

                if (publicationList) {
                    publicationList.innerHTML = '';
                    const publicationEntries = Array.isArray(data.publication_entries) ? data.publication_entries : [];
                    publicationEntries.forEach(entry => addPublicationRow(entry));
                }

                refreshAssociations();

                if (data.profile_image_url) {
                    const a = document.getElementById('currentImage'); a.href = data.profile_image_url; a.classList.remove('hidden');
                }
                if (data.resume_url) { const a = document.getElementById('currentResume'); a.href = data.resume_url; a.classList.remove('hidden'); }
            } finally {
                // Hide loader
                document.body.classList.add('loaded');
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    setTimeout(() => { loader.style.display = 'none'; }, 450);
                }
            }
        }

        document.getElementById('imageInput').addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                // Mirror preview into the avatar immediately.
                setAvatar(document.getElementById('avatarInitials')?.textContent || 'U', url);
            }
        });

        // Image is saved via the top "Save Changes" button (details form submit).
        document.getElementById('imageForm').addEventListener('submit', (e) => {
            e.preventDefault();
            document.getElementById('detailsForm')?.requestSubmit();
        });

        document.getElementById('resumeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('detailsForm')?.requestSubmit();
        });

        document.getElementById('saveChangesBtn')?.addEventListener('click', () => {
            document.getElementById('detailsForm')?.requestSubmit();
        });

        document.getElementById('detailsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Show loader manually
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.classList.remove('loaded');
                loader.style.display = 'flex';
                loader.style.opacity = '1';
                loader.style.visibility = 'visible';
            }

            try {
                const st = document.getElementById('status');
                st.classList.remove('hidden');

                // Upload profile image if user selected a new one.
                const imageFile = document.getElementById('imageInput')?.files?.[0] || null;
                if (imageFile) {
                    st.textContent = '⏳ Uploading profile image…';
                    const up = await uploadProfileAsset('image', imageFile);
                    if (!up.ok) {
                        st.textContent = `❌ ${up?.out?.detail || 'Image upload failed'}`;
                        return;
                    }
                }

                // Upload resume if user selected a new one.
                const resumeFile = document.getElementById('resumeInput')?.files?.[0] || null;
                if (resumeFile) {
                    st.textContent = '⏳ Uploading resume…';
                    const up = await uploadProfileAsset('resume', resumeFile);
                    if (!up.ok) {
                        st.textContent = `❌ ${up?.out?.detail || 'Resume upload failed'}`;
                        return;
                    }
                }

                const specs = document.getElementById('f_specs').value.split(',').map(s => s.trim()).filter(Boolean);
                const experiences = collectExperienceData();
                const educationEntries = collectEducationData();
                const certificationEntries = collectCertificationData();
                const portfolioEntries = collectPortfolioData();
                const publicationEntries = collectPublicationData();
                const payload = {
                    name: document.getElementById('f_name').value || null,
                    phone: document.getElementById('f_phone').value || null,
                    headline: document.getElementById('f_headline').value || null,
                    location: document.getElementById('f_location').value || null,
                    dob: document.getElementById('f_dob').value || null,
                    bio: document.getElementById('f_bio').value || null,
                    linkedin: document.getElementById('f_linkedin').value || null,
                    github: document.getElementById('f_github').value || null,
                    leetcode: document.getElementById('f_leetcode').value || null,
                    portfolio_url: document.getElementById('f_portfolio').value || null,
                    website: document.getElementById('f_website').value || null,
                    twitter: document.getElementById('f_twitter').value || null,
                    instagram: document.getElementById('f_instagram').value || null,
                    medium: document.getElementById('f_medium').value || null,
                    specializations: specs,
                    technologies: document.getElementById('f_technologies').value || null,
                    skills: document.getElementById('f_skills').value || null,
                    certifications: document.getElementById('f_certifications').value || null,
                    languages: document.getElementById('f_languages').value || null,
                    interests: document.getElementById('f_interests').value || null,
                    achievements: document.getElementById('f_achievements').value || null,
                    experience: document.getElementById('f_experience').value || null,
                    publications: document.getElementById('f_publications').value || null,
                    project_info: document.getElementById('f_project_info').value || null,
                    experiences: experiences,
                    education_entries: educationEntries,
                    certification_entries: certificationEntries,
                    portfolio_projects: portfolioEntries,
                    publication_entries: publicationEntries,
                };
                const res = await fetch(`${apiBase}/api/profile/me`, { method: 'PUT', headers: { ...authHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const out = await res.json().catch(() => ({}));
                st.textContent = res.ok ? '✔ Profile updated' : `❌ ${out?.detail || 'Update failed'}`;
                if (res.ok) {
                    window.location.href = 'academicas.html';
                }
            } catch (err) {
                console.error(err);
            } finally {
                // Ensure loader is hidden if loadProfile wasn't called or failed to hide it
                // We add a small delay or just wait for loadProfile's animation? 
                // loadProfile handles it. If this runs after loadProfile returns, we can just ensure it's hidden.
                document.body.classList.add('loaded');
                if (loader && loader.style.display !== 'none') {
                    setTimeout(() => { loader.style.display = 'none'; }, 450);
                }
            }
        });

        loadProfile();
        document.getElementById('signOutBtn')?.addEventListener('click', () => {
            try { localStorage.removeItem('px_token'); } catch { }
            window.location.href = 'login.html';
        });
    </script>
</body>

</html>