<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Class Students • Paper X</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }
                    },
                    boxShadow: {
                        card: '0 6px 24px rgba(0,0,0,.10)',
                        glow: '0 8px 30px rgba(158,75,138,.35)'
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .dark body {
            background-image: linear-gradient(to left top, #1e1e2f, #242138, #2b2440, #332649, #3d2850, #3f254a, #402244, #401f3e, #34182d, #26131e, #190b11, #000000);
            background-repeat: no-repeat;
            background-size: cover;
        }

        .student-card {
            max-width: 340px;
            width: 100%;
        }
    </style>
    <script>(function () { const s = localStorage.getItem('px_theme'); const p = matchMedia('(prefers-color-scheme: dark)').matches; const m = s ? s : (p ? 'dark' : 'light'); if (m === 'dark') document.documentElement.classList.add('dark'); })();</script>
    <script src="./config.js"></script>
    <script src="./auth.js" defer></script>
    <script>
        const __rawApiBase = window.API_BASE || 'http://127.0.0.1:8000';
        window.API_BASE = String(__rawApiBase || '').replace(/\/$/, '');
    </script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="./index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="assets/img/logo-light.svg" class="h-9 w-auto dark:hidden" alt="Paper X">
                <img src="assets/img/logo-dark.svg" class="h-9 w-auto hidden dark:block" alt="Paper X">
            </a>
            <div class="flex items-center gap-2">
                <button id="backBtn"
                    class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5">
                    <span class="material-symbols-rounded text-base">arrow_back</span>
                    Back
                </button>
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5">
                    <span class="material-symbols-rounded text-base">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container py-8 space-y-6">
        <section class="glass rounded-3xl p-6 md:p-8 ring-1 ring-black/5 dark:ring-white/10 shadow-card space-y-4">
            <div class="flex items-start gap-4 flex-wrap">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-brand-500/30 to-brand-700/20 grid place-items-center text-lg font-bold text-brand-700 dark:text-fuchsia-200"
                    id="subjectInitial">-</div>
                <div class="flex-1 min-w-0 space-y-1">
                    <p class="text-xs uppercase tracking-[0.1em] text-neutral-500 dark:text-white/60">Class roster</p>
                    <h1 id="subjectTitle" class="text-2xl md:text-3xl font-extrabold leading-tight">Loading…</h1>
                    <div class="flex flex-wrap gap-2 text-[11px] font-medium" id="subjectMeta"></div>
                </div>
            </div>
            <div id="actionRow" class="flex flex-wrap gap-2 hidden"></div>
            <div id="status" class="text-sm text-neutral-600 dark:text-white/70">Fetching students…</div>
        </section>

        <section class="space-y-4">
            <div class="flex flex-wrap items-center gap-3">
                <div class="flex flex-wrap items-center gap-2 text-sm font-semibold">
                    <span id="studentCount">0 students</span>
                    <div id="filtersWrap" class="flex flex-wrap gap-2 text-[11px] font-medium"></div>
                </div>
                <div class="ml-auto flex items-center gap-2">
                    <input id="studentSearch" type="search" placeholder="Search name, reg no, email"
                        class="px-3 py-2 rounded-full bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 text-sm focus:outline-none focus:ring-brand-500"
                        autocomplete="off" />
                </div>
            </div>
            <div id="studentsWrap" class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3 justify-items-center"></div>
            <div id="emptyState" class="hidden text-sm text-neutral-600 dark:text-white/70">No students match the
                current filters.</div>
        </section>
    </main>

    <div class="fixed bottom-3 right-3 z-40">
        <button id="scrollTop"
            class="hidden size-10 rounded-full bg-brand-500 hover:bg-brand-600 text-white shadow-glow flex items-center justify-center"><span
                class="material-symbols-rounded">north</span></button>
    </div>

    <script>
        const $ = (s, r = document) => r.querySelector(s);
        const esc = (s = '') => String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const params = new URLSearchParams(location.search);
        const classId = params.get('class_id') || '';
        const courseId = params.get('course_id') || '';
        const subjectQuery = params.get('subject') || '';
        const sectionParam = params.get('section') || '';
        const semesterParam = params.get('semester') || '';
        const batchParam = params.get('batch_id') || '';

        function getToken() {
            const primary = ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token'];
            for (const k of primary) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } }
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (/token/i.test(key || '')) {
                        const v = localStorage.getItem(key);
                        if (v && v.length > 10) return v;
                    }
                }
            } catch { }
            return '';
        }

        const themeRoot = document.documentElement;
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-theme-toggle]');
            if (!btn) return;
            const isDark = themeRoot.classList.toggle('dark');
            localStorage.setItem('px_theme', isDark ? 'dark' : 'light');
            const icon = btn.querySelector('.material-symbols-rounded');
            if (icon) icon.textContent = isDark ? 'light_mode' : 'dark_mode';
        });

        $('#backBtn').addEventListener('click', () => { history.back(); });
        const st = $('#scrollTop');
        window.addEventListener('scroll', () => { if (scrollY > 400) st.classList.remove('hidden'); else st.classList.add('hidden'); });
        st.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        let allStudents = [];
        let appliedFilters = {};

        function renderStatus(msg, isError = false) {
            const node = $('#status');
            if (node) {
                node.textContent = msg;
                node.className = 'text-sm ' + (isError ? 'text-red-600 dark:text-red-400' : 'text-neutral-600 dark:text-white/70');
            }
        }

        function renderClassInfo(cls = {}) {
            const title = cls.subject || subjectQuery || 'Class';
            $('#subjectTitle').textContent = `${title} — Students`;
            $('#subjectInitial').textContent = (title || 'C').charAt(0).toUpperCase();
            const meta = $('#subjectMeta');
            meta.innerHTML = '';
            if (cls.semester || semesterParam) meta.insertAdjacentHTML('beforeend', `<span class="px-2 py-1 rounded-full bg-brand-500/10 text-brand-700 dark:text-brandlt-200 text-[11px]">Sem ${esc(cls.semester || semesterParam)}</span>`);
            if (cls.section || sectionParam) meta.insertAdjacentHTML('beforeend', `<span class="px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 text-[11px]">Section ${esc(cls.section || sectionParam)}</span>`);
            if (appliedFilters.batch_label) meta.insertAdjacentHTML('beforeend', `<span class="px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 text-[11px]">Batch ${esc(appliedFilters.batch_label)}</span>`);
            else if (cls.batch_id || batchParam) meta.insertAdjacentHTML('beforeend', `<span class="px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 text-[11px]">Batch ${esc(cls.batch_id || batchParam)}</span>`);
        }

        function setupActions() {
            const wrap = $('#actionRow');
            if (!wrap) return;
            const items = [];
            if (courseId) {
                const qs = new URLSearchParams(location.search);
                items.push(`<a href="teacher_class_syllabus.html?${qs.toString()}" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10 hover:bg-white/90 dark:hover:bg-white/20"><span class="material-symbols-rounded text-base">menu_book</span>Syllabus</a>`);
            }
            if (!items.length) {
                wrap.classList.add('hidden');
                wrap.innerHTML = '';
                return;
            }
            wrap.classList.remove('hidden');
            wrap.innerHTML = items.join('');
        }

        function updateSummary(total = 0, filters = {}) {
            const countNode = $('#studentCount');
            if (countNode) countNode.textContent = total === 1 ? '1 student' : `${total} students`;
            const wrap = $('#filtersWrap');
            wrap.innerHTML = '';
            const chips = [];
            if (filters.batch_label) chips.push(`Batch ${esc(filters.batch_label)}`);
            if (filters.section) chips.push(`Section ${esc(filters.section)}`);
            if (filters.current_semester) chips.push(`Sem ${esc(filters.current_semester)}`);
            if (chips.length) {
                chips.forEach(txt => wrap.insertAdjacentHTML('beforeend', `<span class="px-2 py-0.5 rounded-full ring-1 ring-black/10 dark:ring-white/15">${txt}</span>`));
            } else {
                wrap.insertAdjacentHTML('beforeend', `<span class="text-[11px] text-neutral-500 dark:text-white/50">No filters found</span>`);
            }
            if (filters.missing_filters) {
                renderStatus('Add batch / section information to this class to generate the roster.', true);
                $('#emptyState').textContent = 'Missing class filters. Edit the class to include batch or section to see students.';
                $('#emptyState').classList.remove('hidden');
            }
        }

        function renderStudents(list) {
            const wrap = $('#studentsWrap');
            const empty = $('#emptyState');
            wrap.innerHTML = '';
            if (!list.length) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');
            list.forEach(s => {
                const avatar = s.avatar_url ? `<img src="${s.avatar_url}" alt="" class="w-full h-full object-cover"/>` : `<div class="w-full h-full grid place-items-center bg-gradient-to-br from-brand-500/25 to-brand-700/20 text-lg font-bold">${esc((s.name || 'S').charAt(0).toUpperCase())}</div>`;
                const reg = s.regno ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-black/5 dark:bg-white/10 text-neutral-700 dark:text-white">${esc(s.regno)}</span>` : '';
                const contact = [];
                if (s.email) contact.push(`<a href="mailto:${encodeURIComponent(s.email)}" class="hover:underline">${esc(s.email)}</a>`);
                if (s.phone) contact.push(`<a href="tel:${encodeURIComponent(s.phone)}" class="hover:underline">${esc(s.phone)}</a>`);
                const totalTopics = Number(s.total_topics || 0);
                const completedTopics = Number(s.completed_topics || 0);
                const rawPct = typeof s.progress_pct === 'number'
                    ? s.progress_pct
                    : (totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0);
                const pct = Math.max(0, Math.min(100, Math.round((rawPct + Number.EPSILON) * 10) / 10));
                const ratioLabel = totalTopics ? `${completedTopics}/${totalTopics}` : 'N/A';
                const pctLabel = totalTopics ? `${pct}%` : '—';
                const baseTrack = 'rgba(148,163,184,0.25)';
                const fillColor = totalTopics ? 'rgba(158,75,138,0.95)' : 'rgba(148,163,184,0.35)';
                const circleStyle = `background: conic-gradient(${fillColor} ${pct}%, ${baseTrack} ${pct}%);`;
                const progressCircle = `
                    <div class="flex flex-col items-center gap-1 ml-4 min-w-[4.5rem] text-[10px] text-neutral-500 dark:text-white/60">
                        <div class="relative w-14 h-14 rounded-full shadow-inner" style="${circleStyle}">
                            <div class="absolute inset-[3px] rounded-full bg-white/90 dark:bg-brand-950 flex items-center justify-center text-[11px] font-semibold text-brand-700 dark:text-brandlt-100">
                                ${pctLabel}
                            </div>
                        </div>
        	            <span class="text-[11px] font-semibold text-neutral-800 dark:text-white">${ratioLabel}</span>
                        ${totalTopics ? '<span class="text-[9px] uppercase tracking-wide text-neutral-400 dark:text-white/40">topics</span>' : '<span class="text-[9px] uppercase tracking-wide text-neutral-400 dark:text-white/40">link syllabus</span>'}
                    </div>`;
                const card = document.createElement('div');
                card.className = 'student-card rounded-2xl ring-1 ring-black/5 dark:ring-white/10 bg-white/70 dark:bg-white/5 p-4 flex gap-4 items-center justify-self-center';
                card.innerHTML = `
                    <div class="w-14 h-14 rounded-2xl overflow-hidden ring-1 ring-black/5 dark:ring-white/15 flex-shrink-0">${avatar}</div>
                    <div class="flex-1 min-w-0 space-y-1">
                        ${reg ? `<div class="flex justify-between items-center">${reg}</div>` : ''}
                        <div class="flex items-center justify-between gap-2">
                            <h3 class="text-base font-semibold leading-tight truncate">${esc(s.name || 'Student')}</h3>
                        </div>
                        <div class="text-[12px] text-neutral-500 dark:text-white/60 space-x-2 break-all">${contact.join('<span class="opacity-40">•</span>')}</div>
                    </div>
                    ${progressCircle}`;
                wrap.appendChild(card);
            });
        }

        async function loadRoster() {
            if (!classId) { renderStatus('Missing class identifier', true); return; }
            const token = getToken();
            if (!token) { renderStatus('Sign in as a teacher to view this class.', true); return; }
            try {
                const baseRaw = window.__API_BASE || window.API_BASE || 'http://127.0.0.1:8000';
                const base = String(baseRaw || '').replace(/\/$/, '');
                const headers = { Authorization: 'Bearer ' + token };
                const res = await fetch(`${base}/api/teacher/classes/${encodeURIComponent(classId)}/students`, { headers, cache: 'no-store' });
                if (res.status === 401) { throw new Error('Session expired – please sign in again.'); }
                if (!res.ok) { throw new Error(`Failed to load roster (${res.status})`); }
                const data = await res.json();
                appliedFilters = data.applied_filters || {};
                renderClassInfo(data.class_info || {});
                allStudents = Array.isArray(data.students) ? data.students : [];
                updateSummary(data.total ?? allStudents.length, appliedFilters);
                if (!appliedFilters.missing_filters) {
                    renderStatus(allStudents.length ? '' : 'No students found for the selected filters.');
                }
                renderStudents(allStudents);
            } catch (err) {
                console.error('[students] load failed', err);
                renderStatus(err.message || 'Unable to load students', true);
            }
        }

        $('#studentSearch').addEventListener('input', (e) => {
            const term = e.target.value.trim().toLowerCase();
            if (!term) { renderStudents(allStudents); return; }
            const filtered = allStudents.filter((s) => {
                const bag = [s.name, s.regno, s.email, s.section].map(v => String(v || '').toLowerCase());
                return bag.some(v => v.includes(term));
            });
            renderStudents(filtered);
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupActions();
            loadRoster();
        });
    </script>
</body>

</html>