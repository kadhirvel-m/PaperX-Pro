<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PaperX Learning Tracks — Analytics</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: {
                            900: '#1E1E2F',
                            700: '#4C2A59',
                            500: '#9E4B8A',
                            300: '#C88DBA'
                        },
                        surface: '#F6F7FB'
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script defer src="../config.js"></script>
    <script defer src="tracks.js"></script>
</head>

<body class="bg-surface text-brand-900">
    <header class="border-b border-brand-900/5 bg-white/70 backdrop-blur">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-5">
            <div>
                <a href="dashboard.html"
                    class="inline-flex items-center gap-2 text-sm font-semibold text-brand-700 hover:text-brand-900">
                    <span class="material-symbols-rounded text-base">arrow_back</span>
                    Back to dashboard
                </a>
                <h1 class="mt-2 text-3xl font-bold tracking-tight text-brand-900">Analytics & Insights</h1>
                <p class="text-sm text-brand-900/60">Powered by Gemini insights and your live SerpAPI content.</p>
            </div>
            <div id="planMeta" class="flex flex-col items-end text-xs uppercase tracking-wider text-brand-900/50"></div>
        </div>
    </header>

    <main class="mx-auto grid max-w-6xl gap-6 px-6 py-10 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.2fr)]">
        <section class="space-y-6">
            <article class="rounded-3xl bg-white p-6 shadow-lg shadow-brand-900/10">
                <h2 class="text-lg font-semibold text-brand-900">Progress summary</h2>
                <div class="mt-6 grid gap-5 md:grid-cols-3">
                    <div class="rounded-2xl border border-brand-900/10 bg-brand-500/5 p-4">
                        <p class="text-sm text-brand-900/70">Completion rate</p>
                        <p id="statCompletion" class="mt-2 text-3xl font-semibold text-brand-900">0%</p>
                        <div class="mt-3 h-2 rounded-full bg-brand-900/10">
                            <div id="completionBar" class="h-2 rounded-full bg-brand-500" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="rounded-2xl border border-brand-900/10 bg-brand-500/5 p-4">
                        <p class="text-sm text-brand-900/70">Modules</p>
                        <p id="statModules" class="mt-2 text-3xl font-semibold text-brand-900">0</p>
                        <p class="text-xs text-brand-900/50">Company-aware study blocks</p>
                    </div>
                    <div class="rounded-2xl border border-brand-900/10 bg-brand-500/5 p-4">
                        <p class="text-sm text-brand-900/70">Active streak</p>
                        <p id="statStreak" class="mt-2 text-3xl font-semibold text-brand-900">0 days</p>
                        <p class="text-xs text-brand-900/50">Calculated from topic updates</p>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-brand-900/60">Topic breakdown</h3>
                    <div id="topicBreakdown" class="mt-3 grid gap-3 md:grid-cols-2"></div>
                </div>
            </article>
            <article class="rounded-3xl bg-white p-6 shadow-lg shadow-brand-900/10">
                <div class="flex items-center justify-between gap-4">
                    <h2 class="text-lg font-semibold text-brand-900">AI insights</h2>
                    <button id="refreshInsights"
                        class="inline-flex items-center gap-2 rounded-full border border-brand-900/20 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-brand-700">
                        <span class="material-symbols-rounded text-base">refresh</span>
                        Refresh
                    </button>
                </div>
                <div id="insightSummary" class="mt-4 space-y-4 text-sm text-brand-900/70">
                    <p class="text-brand-900/60">Fetching insights…</p>
                </div>
            </article>
        </section>
        <aside class="space-y-6">
            <article class="rounded-3xl border border-brand-900/10 bg-white p-6 shadow-lg shadow-brand-900/10">
                <h2 class="text-lg font-semibold text-brand-900">Recommendations</h2>
                <ul id="recommendationList" class="mt-4 space-y-3 text-sm text-brand-900/70"></ul>
            </article>
            <article class="rounded-3xl border border-brand-900/10 bg-white p-6 shadow-lg shadow-brand-900/10">
                <h2 class="text-lg font-semibold text-brand-900">Risk watch</h2>
                <ul id="riskList" class="mt-4 space-y-3 text-sm text-rose-600"></ul>
            </article>
        </aside>
    </main>

    <template id="topicCardTemplate">
        <div class="rounded-2xl border border-brand-900/10 bg-brand-500/5 p-4">
            <p class="text-sm font-semibold text-brand-900">Topic</p>
            <p class="text-xs text-brand-900/60">Status</p>
            <div class="mt-2 h-1.5 rounded-full bg-brand-900/10">
                <div class="progress h-1.5 rounded-full bg-brand-500" style="width:0%"></div>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const plan = PaperXLearning.ensurePlan();
            const progress = PaperXLearning.getProgress();
            const metrics = PaperXLearning.computeProgressMetrics(plan, progress);
            const planMeta = document.getElementById('planMeta');
            planMeta.innerHTML = '';
            ['language', 'stack', 'goal'].forEach(function (key) {
                const span = document.createElement('span');
                span.textContent = key + ': ' + (plan[key] || '').toUpperCase();
                planMeta.appendChild(span);
            });
            const companySpan = document.createElement('span');
            companySpan.textContent = 'companies: ' + (plan.companies || []).map(c => c.toUpperCase()).join(', ');
            planMeta.appendChild(companySpan);

            document.getElementById('statCompletion').textContent = metrics.completionRate + '%';
            document.getElementById('completionBar').style.width = metrics.completionRate + '%';
            document.getElementById('statModules').textContent = (plan.modules || []).length;
            const streak = Math.max(metrics.completedTopics, metrics.inProgressTopics ? 1 : 0);
            document.getElementById('statStreak').textContent = streak + ' day' + (streak === 1 ? '' : 's');

            const topicTemplate = document.getElementById('topicCardTemplate');
            const topicBreakdown = document.getElementById('topicBreakdown');
            topicBreakdown.innerHTML = '';
            (plan.modules || []).forEach(function (module) {
                (module.topics || []).forEach(function (topic) {
                    const node = topicTemplate.content.firstElementChild.cloneNode(true);
                    node.querySelector('p.text-sm').textContent = topic.title;
                    const status = progress[topic.topic_id]?.status || 'not_started';
                    node.querySelector('p.text-xs').textContent = status.replace(/_/g, ' ').toUpperCase();
                    const percent = status === 'completed' ? 100 : status === 'in_progress' ? 50 : 10;
                    node.querySelector('.progress').style.width = percent + '%';
                    topicBreakdown.appendChild(node);
                });
            });

            async function loadInsights() {
                const highlights = [];
                const blockers = [];
                (plan.modules || []).forEach(function (module) {
                    (module.topics || []).forEach(function (topic) {
                        const status = progress[topic.topic_id]?.status || 'not_started';
                        if (status === 'completed') highlights.push(topic.title);
                        if (status === 'not_started') blockers.push(topic.title);
                    });
                });
                try {
                    const insights = await PaperXLearning.requestAnalytics({
                        language: plan.language,
                        stack: plan.stack,
                        goal: plan.goal,
                        companies: plan.companies,
                        metrics: {
                            completion_rate: metrics.completionRate,
                            completed_topics: metrics.completedTopics,
                            total_topics: metrics.totalTopics,
                            in_progress_topics: metrics.inProgressTopics,
                        },
                        highlights: highlights.slice(0, 5),
                        blockers: blockers.slice(0, 5)
                    });
                    renderInsights(insights);
                } catch (err) {
                    const summary = document.getElementById('insightSummary');
                    summary.innerHTML = '';
                    const warning = document.createElement('p');
                    warning.className = 'rounded-xl bg-rose-100 px-3 py-2 text-sm text-rose-700';
                    warning.textContent = 'Analytics unavailable: ' + err.message;
                    summary.appendChild(warning);
                }
            }

            function renderInsights(data) {
                const summary = document.getElementById('insightSummary');
                const recommendationList = document.getElementById('recommendationList');
                const riskList = document.getElementById('riskList');
                summary.innerHTML = '';
                recommendationList.innerHTML = '';
                riskList.innerHTML = '';

                const summaryText = document.createElement('p');
                summaryText.textContent = data.summary || 'Learning momentum looks healthy. Keep reviewing company question sets regularly.';
                summary.appendChild(summaryText);

                if (data.wins) {
                    const wins = document.createElement('ul');
                    wins.className = 'space-y-2 text-sm text-brand-900/70';
                    data.wins.forEach(function (win) {
                        const li = document.createElement('li');
                        li.textContent = '• ' + win;
                        wins.appendChild(li);
                    });
                    summary.appendChild(wins);
                }

                (data.recommendations || []).forEach(function (rec) {
                    const li = document.createElement('li');
                    li.textContent = '• ' + rec;
                    recommendationList.appendChild(li);
                });

                (data.risks || []).forEach(function (risk) {
                    const li = document.createElement('li');
                    li.textContent = '• ' + risk;
                    riskList.appendChild(li);
                });
            }

            document.getElementById('refreshInsights').addEventListener('click', function () {
                document.getElementById('insightSummary').innerHTML = '<p class="text-brand-900/60">Refreshing…</p>';
                loadInsights();
            });

            loadInsights();
        });
    </script>
</body>

</html>