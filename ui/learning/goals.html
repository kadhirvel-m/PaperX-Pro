<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PaperX Learning Tracks — Goals & Companies</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: {
                            900: '#1E1E2F',
                            700: '#4C2A59',
                            500: '#9E4B8A',
                            300: '#C88DBA'
                        },
                        surface: '#F7F2F9'
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script defer src="../config.js"></script>
    <script defer src="tracks.js"></script>
    <style>
        /* Provide clear state feedback for the selections */
        .stack-card.active {
            border-color: rgba(158, 75, 138, 0.7);
            background-color: rgba(200, 141, 186, 0.15);
            box-shadow: 0 12px 24px -18px rgba(30, 30, 47, 0.35);
        }

        .stack-card.active .material-symbols-rounded {
            color: #9E4B8A;
        }

        .goal-card.active {
            border-color: rgba(158, 75, 138, 0.7);
            background-color: #9E4B8A;
            color: #FFFFFF;
            box-shadow: 0 10px 20px -14px rgba(158, 75, 138, 0.6);
        }

        .company-chip.active {
            border-color: rgba(158, 75, 138, 0.7);
            background-color: #4C2A59;
            color: #FFFFFF;
            box-shadow: 0 8px 20px -14px rgba(76, 42, 89, 0.55);
        }
    </style>
</head>

<body class="bg-surface text-brand-900">
    <header class="border-b border-brand-900/5 bg-white/80 backdrop-blur">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
            <div class="flex items-center gap-3">
                <a href="../index.html"
                    class="rounded-full bg-brand-900 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-white">PaperX</a>
                <span class="text-lg font-semibold text-brand-900">Learning Tracks</span>
                <span id="languageBadge"
                    class="rounded-full bg-brand-500/10 px-3 py-1 text-xs font-medium text-brand-700"></span>
            </div>
            <nav class="hidden gap-6 text-sm font-medium md:flex">
                <a href="onboarding.html" class="text-brand-500 hover:text-brand-900">Onboarding</a>
                <a href="goals.html" class="text-brand-900">Goals</a>
                <a href="dashboard.html" class="text-brand-500 hover:text-brand-900">Dashboard</a>
            </nav>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-6 py-12">
        <section class="rounded-3xl bg-white p-10 shadow-xl shadow-brand-900/10">
            <div class="flex flex-col gap-2">
                <h1 class="text-3xl font-bold tracking-tight text-brand-900">Tell us your focus</h1>
                <p class="text-base text-brand-900/70">
                    Select the stack you want to master, the outcome you're targeting, and the companies PaperX should
                    tailor your preparation for. We will adapt every module, topic, and assessment accordingly.
                </p>
            </div>
            <form id="goalForm" class="mt-10 space-y-12">
                <div>
                    <div class="flex items-center justify-between gap-3">
                        <h2 class="text-sm font-semibold uppercase tracking-wider text-brand-900/60">Stacks</h2>
                        <span class="text-xs text-brand-900/50">Powered by Gemini planner model</span>
                    </div>
                    <div id="stackOptions" class="mt-4 grid gap-4 md:grid-cols-3"></div>
                    <p id="stackError" class="mt-2 hidden text-sm text-rose-600"></p>
                </div>
                <div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-semibold uppercase tracking-wider text-brand-900/60">Goals</h2>
                        <span class="text-xs text-brand-900/50">Pick one</span>
                    </div>
                    <div id="goalOptions" class="mt-4 grid gap-3 md:grid-cols-3"></div>
                    <p id="goalError" class="mt-2 hidden text-sm text-rose-600"></p>
                </div>
                <div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-sm font-semibold uppercase tracking-wider text-brand-900/60">Target companies
                        </h2>
                        <span class="text-xs text-brand-900/50">Choose up to 4</span>
                    </div>
                    <div id="companyOptions" class="mt-4 flex flex-wrap gap-3"></div>
                </div>
                <div class="rounded-2xl border border-brand-900/10 bg-brand-900/3 px-5 py-4 text-sm text-brand-900/70">
                    <p>PaperX will reuse your configured allowed domains (<span id="domainList"
                            class="font-medium text-brand-700"></span>) for SerpAPI fetching. Nothing is hardcoded —
                        update env values to control this list.</p>
                </div>
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                    <a href="onboarding.html"
                        class="inline-flex items-center gap-2 text-sm font-semibold text-brand-700 hover:text-brand-900">
                        <span class="material-symbols-rounded text-base align-middle">arrow_back</span>
                        Back to language selection
                    </a>
                    <div class="flex items-center gap-3">
                        <span id="planStatus" class="hidden text-sm text-brand-700"></span>
                        <button type="submit"
                            class="inline-flex items-center gap-2 rounded-full bg-brand-700 px-6 py-3 text-sm font-semibold text-white shadow-lg shadow-brand-700/30 transition hover:bg-brand-500">
                            Generate personalised path
                            <span class="material-symbols-rounded text-base align-middle">auto_fix_high</span>
                        </button>
                    </div>
                </div>
            </form>
        </section>
    </main>

    <div id="loadingOverlay"
        class="pointer-events-none fixed inset-0 hidden items-center justify-center bg-brand-900/70 backdrop-blur">
        <div
            class="flex flex-col items-center gap-4 rounded-2xl bg-white/5 px-10 py-8 text-white shadow-2xl shadow-black/40">
            <span class="material-symbols-rounded animate-spin text-4xl text-brand-300">progress_activity</span>
            <p class="text-center text-sm font-medium">Crafting your learning map with Gemini 2.5 Flash…</p>
        </div>
    </div>

    <template id="stackTemplate">
        <button type="button"
            class="stack-card group flex w-full flex-col rounded-2xl border border-brand-900/10 bg-brand-900/5 p-4 text-left transition hover:border-brand-700/40 hover:bg-brand-500/10">
            <div class="flex items-center justify-between gap-3">
                <span class="text-base font-semibold text-brand-900">Python</span>
                <span
                    class="material-symbols-rounded text-xl text-brand-500 group-[.active]:text-brand-700">check_circle</span>
            </div>
            <p class="mt-2 text-sm text-brand-900/60">AI-powered sprints, interview prep, and lab tasks curated for the
                selected stack.</p>
        </button>
    </template>

    <template id="goalTemplate">
        <button type="button"
            class="goal-card rounded-full border border-brand-900/15 bg-white px-4 py-2 text-sm font-semibold text-brand-700 transition hover:border-brand-500/50 hover:text-brand-900">Goal</button>
    </template>

    <template id="companyTemplate">
        <button type="button"
            class="company-chip rounded-full border border-brand-900/20 bg-brand-500/10 px-4 py-2 text-xs font-medium uppercase tracking-wide text-brand-700 hover:border-brand-500/40">Company</button>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const token = PaperXLearning.requireAuth({ redirectTo: '../login.html' });
            if (!token) {
                return;
            }
            if (!PaperXLearning.getPlan()) {
                try { await PaperXLearning.loadLatestPlan(); } catch (_) { }
            }
            const language = PaperXLearning.getLanguage();
            if (!language) {
                window.location.href = 'onboarding.html';
                return;
            }
            const languageBadge = document.getElementById('languageBadge');
            languageBadge.textContent = 'Language: ' + language.toUpperCase();

            const stackContainer = document.getElementById('stackOptions');
            const goalContainer = document.getElementById('goalOptions');
            const companyContainer = document.getElementById('companyOptions');
            const domainList = document.getElementById('domainList');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const statusEl = document.getElementById('planStatus');
            const stackError = document.getElementById('stackError');
            const goalError = document.getElementById('goalError');

            let selectedStack = null;
            let selectedGoal = null;
            const selectedCompanies = new Set();

            function resetErrors() {
                stackError.classList.add('hidden');
                goalError.classList.add('hidden');
            }

            function selectExclusive(container, node, setter) {
                Array.from(container.children).forEach(function (item) { item.classList.remove('active'); });
                node.classList.add('active');
                setter();
            }

            try {
                const config = await PaperXLearning.fetchLearningConfig();
                domainList.textContent = (config.allowed_domains || []).join(', ');

                const stackTemplate = document.getElementById('stackTemplate');
                (config.stacks || []).forEach(function (stack) {
                    const node = stackTemplate.content.firstElementChild.cloneNode(true);
                    node.querySelector('span.text-base').textContent = stack.toUpperCase();
                    node.addEventListener('click', function () {
                        selectExclusive(stackContainer, node, function () { selectedStack = stack; });
                        resetErrors();
                    });
                    stackContainer.appendChild(node);
                });

                const goalTemplate = document.getElementById('goalTemplate');
                (config.goals || []).forEach(function (goal) {
                    const node = goalTemplate.content.firstElementChild.cloneNode(true);
                    node.textContent = goal.replace(/_/g, ' ').toUpperCase();
                    node.addEventListener('click', function () {
                        selectExclusive(goalContainer, node, function () { selectedGoal = goal; });
                        resetErrors();
                    });
                    goalContainer.appendChild(node);
                });

                const companyTemplate = document.getElementById('companyTemplate');
                (config.companies || []).forEach(function (company) {
                    const node = companyTemplate.content.firstElementChild.cloneNode(true);
                    node.textContent = company.toUpperCase();
                    node.addEventListener('click', function () {
                        if (selectedCompanies.has(company)) {
                            selectedCompanies.delete(company);
                            node.classList.remove('active');
                        } else {
                            if (selectedCompanies.size >= 4) {
                                statusEl.textContent = 'You can track up to four companies at a time.';
                                statusEl.classList.remove('hidden');
                                setTimeout(() => statusEl.classList.add('hidden'), 2500);
                                return;
                            }
                            selectedCompanies.add(company);
                            node.classList.add('active');
                        }
                    });
                    companyContainer.appendChild(node);
                });

                const filters = PaperXLearning.getFilters();
                if (filters.stack) {
                    Array.from(stackContainer.children).forEach(function (item) {
                        if (item.querySelector('span.text-base').textContent.toLowerCase() === filters.stack.toLowerCase()) {
                            item.classList.add('active');
                            selectedStack = filters.stack;
                        }
                    });
                }
                if (filters.goal) {
                    Array.from(goalContainer.children).forEach(function (item) {
                        if (item.textContent.toLowerCase().replace(/\s+/g, '_') === filters.goal) {
                            item.classList.add('active');
                            selectedGoal = filters.goal;
                        }
                    });
                }
                if (filters.companies) {
                    filters.companies.forEach(function (company) {
                        Array.from(companyContainer.children).forEach(function (item) {
                            if (item.textContent.toLowerCase() === company.toLowerCase()) {
                                item.classList.add('active');
                                selectedCompanies.add(company);
                            }
                        });
                    });
                }
            } catch (err) {
                statusEl.textContent = 'Unable to load config: ' + err.message;
                statusEl.classList.remove('hidden');
            }

            document.getElementById('goalForm').addEventListener('submit', async function (event) {
                event.preventDefault();
                resetErrors();
                if (!selectedStack) {
                    stackError.textContent = 'Select a stack to continue.';
                    stackError.classList.remove('hidden');
                    return;
                }
                if (!selectedGoal) {
                    goalError.textContent = 'Select a goal to continue.';
                    goalError.classList.remove('hidden');
                    return;
                }
                loadingOverlay.classList.remove('hidden');
                statusEl.classList.add('hidden');
                try {
                    await PaperXLearning.requestLearningPath({
                        language: language,
                        stack: selectedStack,
                        goal: selectedGoal,
                        companies: Array.from(selectedCompanies),
                    });
                    PaperXLearning.storeFilters({
                        language: language,
                        stack: selectedStack,
                        goal: selectedGoal,
                        companies: Array.from(selectedCompanies)
                    });
                    window.location.href = 'dashboard.html';
                } catch (err) {
                    statusEl.textContent = 'Generation failed: ' + err.message;
                    statusEl.classList.remove('hidden');
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            });
        });
    </script>
</body>

</html>