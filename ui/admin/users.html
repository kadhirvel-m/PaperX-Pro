<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PaperX Admin — Users</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet">

    <script src="../config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            900: '#1E1E2F',
                            800: '#26263A',
                            700: '#4C2A59',
                            500: '#9E4B8A',
                            300: '#C88DBA'
                        }
                    }
                }
            }
        };
    </script>
</head>

<body class="bg-gray-900 text-white min-h-screen font-sans selection:bg-brand-500 selection:text-white">
    <nav class="border-b border-white/10 bg-brand-900/80 backdrop-blur sticky top-0 z-50">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="rounded-lg bg-brand-500/20 p-2 text-brand-300">
                        <span class="material-symbols-rounded">group</span>
                    </span>
                    <h1 class="text-lg font-bold tracking-tight">PaperX Users</h1>
                </div>
                <div class="flex items-center gap-3 text-sm text-gray-400">
                    <span id="statusPill"
                        class="inline-flex items-center gap-2 rounded-full bg-white/5 px-3 py-1 border border-white/10">
                        <span class="relative flex h-2 w-2">
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-gray-500" id="statusDot"></span>
                        </span>
                        <span id="statusText">Idle</span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8 space-y-6">
        <section class="rounded-3xl bg-white/5 p-6 border border-white/10">
            <div class="flex flex-col gap-4">
                <div class="flex items-start justify-between gap-4 flex-wrap">
                    <div>
                        <h2 class="text-base font-semibold">Users</h2>
                        <p class="text-sm text-gray-400">Search, filter, and review academic details.</p>
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="resultCount">0</span> shown
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-6">
                    <div class="lg:col-span-2">
                        <label class="text-xs text-gray-400">Search</label>
                        <input id="searchInput" type="text" placeholder="Name / Email / Reg No"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                    </div>

                    <div>
                        <label class="text-xs text-gray-400">Role</label>
                        <select id="roleFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">All</option>
                            <option value="admin">Admin</option>
                            <option value="employee">Employee</option>
                            <option value="teacher">Teacher</option>
                            <option value="moderator">Moderator</option>
                            <option value="student">Student</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400">Department</label>
                        <select id="deptFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">All</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400">Batch</label>
                        <select id="batchFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">All</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400">Semester</label>
                        <select id="semFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">All</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-6">
                    <div>
                        <label class="text-xs text-gray-400">Min Streak</label>
                        <input id="streakMin" type="number" min="0" placeholder="0"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Last Login</label>
                        <select id="lastLoginFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">Any</option>
                            <option value="1">Last 24h</option>
                            <option value="7">Last 7d</option>
                            <option value="30">Last 30d</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">Section</label>
                        <select id="sectionFilter"
                            class="mt-1 w-full rounded-xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="lg:col-span-3 flex items-end gap-3">
                        <button id="refreshBtn"
                            class="inline-flex items-center gap-2 rounded-xl bg-brand-500/20 text-brand-300 border border-brand-300/20 px-4 py-2 text-sm hover:bg-brand-500/30">
                            <span class="material-symbols-rounded text-base">refresh</span>
                            Refresh
                        </button>
                        <button id="clearBtn"
                            class="inline-flex items-center gap-2 rounded-xl bg-white/5 text-gray-200 border border-white/10 px-4 py-2 text-sm hover:bg-white/10">
                            <span class="material-symbols-rounded text-base">clear_all</span>
                            Clear Filters
                        </button>
                        <div class="text-xs text-gray-500">Uses server-side search on typing.</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="errorPanel" class="hidden rounded-3xl bg-red-500/10 p-6 border border-red-500/20">
            <div class="flex items-start gap-3">
                <span class="rounded-lg bg-red-500/20 p-2 text-red-300">
                    <span class="material-symbols-rounded">error</span>
                </span>
                <div>
                    <h3 class="font-semibold">Access denied / error</h3>
                    <p class="text-sm text-red-200" id="errorText">—</p>
                </div>
            </div>
        </section>

        <section class="rounded-3xl bg-white/5 border border-white/10 overflow-hidden">
            <div class="overflow-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-white/5 text-gray-300">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">User</th>
                            <th class="px-4 py-3 text-left font-semibold">Academic</th>
                            <th class="px-4 py-3 text-left font-semibold">Role</th>
                            <th class="px-4 py-3 text-left font-semibold">Streak</th>
                            <th class="px-4 py-3 text-left font-semibold">Last Login</th>
                        </tr>
                    </thead>
                    <tbody id="usersTbody" class="divide-y divide-white/10"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- User education modal (pattern similar to academicas.html) -->
    <div id="userEduModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70" data-edu-close></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-2xl rounded-3xl border border-white/10 bg-brand-900/95 text-white shadow-2xl backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6 overflow-y-auto"
                style="max-height: calc(100vh - 2rem); max-height: calc(100dvh - 2rem);">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-lg font-semibold">User academic details</h3>
                        <p class="text-xs text-gray-400 mt-1" id="userEduSubtitle">—</p>
                    </div>
                    <button type="button" class="rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 p-2"
                        data-edu-close aria-label="Close">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>

                <div id="userEduStatus" class="hidden mt-4 text-xs rounded-lg border border-white/10 px-3 py-2"></div>

                <div class="mt-4 grid grid-cols-1 gap-3">
                    <div class="grid sm:grid-cols-2 gap-3">
                        <label class="grid gap-1 min-w-0">
                            <span class="text-xs text-gray-400">College</span>
                            <select id="eduCollegeSelect"
                                class="w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                                <option value="">Select college</option>
                            </select>
                            <input id="eduCollegeCustom" type="text" placeholder="Enter college manually"
                                class="hidden mt-2 w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                        <label class="grid gap-1 min-w-0">
                            <span class="text-xs text-gray-400">Degree</span>
                            <select id="eduDegreeSelect" disabled
                                class="w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60 disabled:opacity-60">
                                <option value="">Select degree</option>
                            </select>
                            <input id="eduDegreeCustom" type="text" placeholder="Enter degree"
                                class="hidden mt-2 w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                    </div>

                    <div class="grid sm:grid-cols-2 gap-3">
                        <label class="grid gap-1 min-w-0">
                            <span class="text-xs text-gray-400">Department</span>
                            <select id="eduDeptSelect" disabled
                                class="w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60 disabled:opacity-60">
                                <option value="">Select department</option>
                            </select>
                            <input id="eduDeptCustom" type="text" placeholder="Enter department"
                                class="hidden mt-2 w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                        <label class="grid gap-1 min-w-0">
                            <span class="text-xs text-gray-400">Batch</span>
                            <select id="eduBatchSelect" disabled
                                class="w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60 disabled:opacity-60">
                                <option value="">Select batch</option>
                            </select>
                            <input id="eduBatchCustom" type="text" placeholder="e.g., 2022-2026"
                                class="hidden mt-2 w-full min-w-0 rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                    </div>

                    <div class="grid sm:grid-cols-3 gap-3">
                        <label class="grid gap-1">
                            <span class="text-xs text-gray-400">Section</span>
                            <select id="eduSectionSelect"
                                class="w-full rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60">
                                <option value="">Select section</option>
                            </select>
                        </label>
                        <label class="grid gap-1">
                            <span class="text-xs text-gray-400">Semester</span>
                            <input id="eduSemester" type="number" min="1" max="12" placeholder="5"
                                class="w-full rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                        <label class="grid gap-1">
                            <span class="text-xs text-gray-400">Reg No</span>
                            <input id="eduRegno" type="text" placeholder="22TN0049"
                                class="w-full rounded-2xl bg-gray-900/60 border border-white/10 px-3 py-2 text-sm outline-none focus:border-brand-500/60" />
                        </label>
                    </div>
                </div>

                <div class="mt-6 flex items-center justify-end gap-2">
                    <button id="userEduCancelBtn" type="button" data-edu-close
                        class="inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-3 text-sm font-semibold bg-white/5 text-gray-100 border border-white/10 hover:bg-white/10">
                        Cancel
                    </button>
                    <button id="userEduSaveBtn" type="button"
                        class="inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-3 text-sm font-semibold bg-brand-500/80 text-white hover:bg-brand-500">
                        <span class="material-symbols-rounded text-[18px]">save</span>
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getToken() {
            return (
                localStorage.getItem('px_token') ||
                localStorage.getItem('access_token') ||
                localStorage.getItem('token') ||
                localStorage.getItem('teacherToken') ||
                ''
            );
        }

        function setStatus(kind, text) {
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusText');
            label.textContent = text;
            dot.className = 'relative inline-flex rounded-full h-2 w-2 ' + (kind === 'ok' ? 'bg-green-500' : kind === 'busy' ? 'bg-brand-300' : kind === 'err' ? 'bg-red-400' : 'bg-gray-500');
        }

        function showError(msg) {
            const panel = document.getElementById('errorPanel');
            const txt = document.getElementById('errorText');
            txt.textContent = msg;
            panel.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorPanel').classList.add('hidden');
        }

        async function resolveApiBase() {
            // config.js sets window.API_BASE for local dev; prefer it.
            if (typeof window.API_BASE === 'string' && window.API_BASE.trim()) {
                return window.API_BASE.replace(/\/$/, '');
            }

            // Fallbacks: prefer FastAPI default, never prefer the current (Live Server) origin.
            const candidates = ['http://127.0.0.1:8000', 'http://localhost:8000'];

            async function probe(base) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 1000);
                try {
                    const r = await fetch(base + '/health', { signal: controller.signal });
                    return r.ok;
                } catch (_) {
                    return false;
                } finally {
                    clearTimeout(timeout);
                }
            }

            for (const base of candidates) {
                if (await probe(base)) return base;
            }

            return candidates[0];
        }

        function safeLower(v) {
            return (v == null ? '' : String(v)).toLowerCase();
        }

        function toBatchRange(u) {
            return u.batch_range || (u.batch_from && u.batch_to ? `${u.batch_from}-${u.batch_to}` : '—');
        }

        function formatLastSeen(iso) {
            if (!iso) return '—';
            try {
                const d = new Date(iso);
                if (Number.isNaN(d.getTime())) return String(iso);
                return d.toLocaleString();
            } catch (_) {
                return String(iso);
            }
        }

        function withinDays(iso, days) {
            if (!days) return true;
            if (!iso) return false;
            const d = new Date(iso);
            const ms = d.getTime();
            if (Number.isNaN(ms)) return false;
            const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
            return ms >= cutoff;
        }

        function buildOptionList(selectEl, values) {
            const existing = new Set(Array.from(selectEl.options).map(o => o.value));
            const sorted = Array.from(values).filter(Boolean).sort((a, b) => String(a).localeCompare(String(b)));
            for (const v of sorted) {
                if (!existing.has(v)) {
                    const opt = document.createElement('option');
                    opt.value = v;
                    opt.textContent = v;
                    selectEl.appendChild(opt);
                }
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTbody');
            tbody.innerHTML = '';

            for (const u of users) {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/5 cursor-pointer';

                const img = u.profile_image_url || '../assets/img/avatar.png';
                const name = u.name || '—';
                const email = u.email || '—';
                const regno = u.regno || '—';
                const college = u.college || '—';
                const dept = u.department || '—';
                const section = u.section || '—';
                const sem = (u.semester == null || u.semester === '') ? '—' : String(u.semester);
                const batch = toBatchRange(u);
                const role = u.role || 'student';
                const streak = (u.current_streak != null ? u.current_streak : (u.streak_current == null ? 0 : u.streak_current));
                const lastSeen = formatLastSeen(u.last_seen_at);

                tr.innerHTML = `
          <td class="px-4 py-3 align-top">
            <div class="flex items-start gap-3">
              <img src="${img}" alt="" class="h-10 w-10 rounded-xl object-cover border border-white/10" onerror="this.src='../assets/img/avatar.png'" />
              <div>
                <div class="font-semibold text-white">${name}</div>
                <div class="text-xs text-gray-400">${email}</div>
              </div>
            </div>
          </td>
          <td class="px-4 py-3 align-top">
            <div class="text-sm text-gray-200">${college}</div>
                        <div class="text-xs text-gray-400">Reg: ${regno} · Dept: ${dept} · Sec: ${section} · Sem: ${sem} · Batch: ${batch}</div>
          </td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full bg-white/5 border border-white/10 px-3 py-1 text-xs text-gray-200">${role}</span>
          </td>
          <td class="px-4 py-3 align-top">
            <span class="inline-flex items-center rounded-full bg-brand-500/15 border border-brand-300/20 px-3 py-1 text-xs text-brand-300">${streak}</span>
          </td>
          <td class="px-4 py-3 align-top text-gray-300">${lastSeen}</td>
        `;

                tr.addEventListener('click', () => {
                    try { openUserEduModal(u); } catch (_) { }
                });

                tbody.appendChild(tr);
            }

            document.getElementById('resultCount').textContent = String(users.length);
        }

        function getFilterState() {
            const role = document.getElementById('roleFilter').value;
            const dept = document.getElementById('deptFilter').value;
            const batch = document.getElementById('batchFilter').value;
            const sem = document.getElementById('semFilter').value;
            const streakMinRaw = document.getElementById('streakMin').value;
            const lastLoginDaysRaw = document.getElementById('lastLoginFilter').value;
            const section = document.getElementById('sectionFilter').value;

            return {
                q: (document.getElementById('searchInput').value || '').trim(),
                role: (role || '').trim(),
                department: (dept || '').trim(),
                section: (section || '').trim(),
                batch_range: (batch || '').trim(),
                semester: (sem || '').trim(),
                min_streak: (streakMinRaw || '').trim(),
                last_login_days: (lastLoginDaysRaw || '').trim(),
            };
        }

        let apiBase = '';
        let allUsers = [];
        let fetchTimer = null;

        // ---------- Education modal logic ----------
        const EDUCATION_CUSTOM_VALUE = '__custom__';
        let __selectedUser = null;
        let __adminEduCollegesCache = [];
        let __adminEduCollegesLoadPromise = null;
        const __adminEduCollegeDetailCache = new Map();
        const __eduModalState = { collegeId: '', collegeDetails: null };

        function __eduEls() {
            return {
                modal: document.getElementById('userEduModal'),
                subtitle: document.getElementById('userEduSubtitle'),
                status: document.getElementById('userEduStatus'),
                collegeSelect: document.getElementById('eduCollegeSelect'),
                collegeCustom: document.getElementById('eduCollegeCustom'),
                degreeSelect: document.getElementById('eduDegreeSelect'),
                degreeCustom: document.getElementById('eduDegreeCustom'),
                deptSelect: document.getElementById('eduDeptSelect'),
                deptCustom: document.getElementById('eduDeptCustom'),
                batchSelect: document.getElementById('eduBatchSelect'),
                batchCustom: document.getElementById('eduBatchCustom'),
                sectionSelect: document.getElementById('eduSectionSelect'),
                semester: document.getElementById('eduSemester'),
                regno: document.getElementById('eduRegno'),
                saveBtn: document.getElementById('userEduSaveBtn'),
            };
        }

        function __adminEduFillSelectOptions(select, options, { placeholder = 'Select...', includeCustom = false } = {}) {
            if (!select) return;
            select.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            select.appendChild(placeholderOption);
            (options || []).forEach(opt => {
                if (!opt) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                select.appendChild(option);
            });
            if (includeCustom) {
                const customOption = document.createElement('option');
                customOption.value = EDUCATION_CUSTOM_VALUE;
                customOption.textContent = 'Other / Not listed';
                select.appendChild(customOption);
            }
        }

        function __adminEduToggleCustomInput(input, show) {
            if (!input) return;
            input.classList.toggle('hidden', !show);
        }

        function __adminEduGetSelectedLabel(select) {
            try {
                const opt = select?.options?.[select.selectedIndex];
                return (opt && opt.textContent) ? opt.textContent : '';
            } catch (_) {
                return '';
            }
        }

        function __adminEduFormatBatchRange(batch) {
            if (!batch) return '';
            const from = Number(batch.from ?? batch.from_year);
            const to = Number(batch.to ?? batch.to_year);
            if (Number.isFinite(from) && Number.isFinite(to)) return `${from}-${to}`;
            return '';
        }

        function __adminEduFindByName(items, name, { key = 'name', normalize = s => String(s || '').trim().toLowerCase() } = {}) {
            if (!Array.isArray(items) || !name) return null;
            const target = normalize(name);
            if (!target) return null;
            return items.find(it => normalize(it?.[key]) === target) || null;
        }

        async function __adminEduLoadCollegesList() {
            if (__adminEduCollegesCache.length) return __adminEduCollegesCache;
            if (!__adminEduCollegesLoadPromise) {
                __adminEduCollegesLoadPromise = fetch(`${apiBase}/api/colleges`)
                    .then(res => (res.ok ? res.json() : []))
                    .catch(() => [])
                    .then(items => {
                        __adminEduCollegesCache = Array.isArray(items)
                            ? items
                                .filter(col => col && col.id && col.name)
                                .map(col => ({ id: String(col.id), name: col.name }))
                            : [];
                        return __adminEduCollegesCache;
                    });
            }
            return __adminEduCollegesLoadPromise;
        }

        async function __adminEduLoadCollegeDetails(collegeId) {
            if (!collegeId) return null;
            const key = String(collegeId);
            if (__adminEduCollegeDetailCache.has(key)) return __adminEduCollegeDetailCache.get(key);
            try {
                const res = await fetch(`${apiBase}/api/colleges/${key}`);
                if (!res.ok) throw new Error(`status ${res.status}`);
                const data = await res.json();
                __adminEduCollegeDetailCache.set(key, data);
                return data;
            } catch (_) {
                __adminEduCollegeDetailCache.set(key, null);
                return null;
            }
        }

        function __adminEduGetDepartmentsForDegree(details, degreeId) {
            if (!details) return [];
            const degrees = Array.isArray(details.degrees) ? details.degrees : [];
            const matchDeg = degrees.find(d => String(d?.id || '') === String(degreeId));
            if (matchDeg && Array.isArray(matchDeg.departments)) return matchDeg.departments;
            const deps = Array.isArray(details.departments) ? details.departments : [];
            if (!degreeId) return deps;
            return deps.filter(dep => String(dep?.degree_id || '') === String(degreeId));
        }

        function __adminEduGetBatchesForDepartment(details, departmentId) {
            if (!details) return [];
            const batches = Array.isArray(details.batches) ? details.batches : [];
            if (!departmentId) return batches;
            const anyHasDept = batches.some(b => b && (b.department_id || b.departmentId));
            if (!anyHasDept) return batches;
            return batches.filter(b => String(b?.department_id || b?.departmentId || '') === String(departmentId));
        }

        function __adminEduEnsureSections() {
            const { sectionSelect } = __eduEls();
            if (!sectionSelect) return;
            if (sectionSelect.options && sectionSelect.options.length > 1) return;
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(ch => {
                const opt = document.createElement('option');
                opt.value = ch;
                opt.textContent = ch;
                sectionSelect.appendChild(opt);
            });
        }

        async function __adminEduHandleCollegeChange(isInitial = false) {
            const els = __eduEls();
            if (!els.collegeSelect) return;
            const selected = els.collegeSelect.value;
            const isCustom = selected === EDUCATION_CUSTOM_VALUE;
            __eduModalState.collegeId = isCustom ? '' : selected;
            __eduModalState.collegeDetails = null;

            __adminEduToggleCustomInput(els.collegeCustom, isCustom);
            if (isCustom) {
                els.degreeSelect.disabled = false;
                els.deptSelect.disabled = false;
                els.batchSelect.disabled = false;
                __adminEduFillSelectOptions(els.degreeSelect, [], { placeholder: 'Select degree', includeCustom: true });
                __adminEduFillSelectOptions(els.deptSelect, [], { placeholder: 'Select department', includeCustom: true });
                __adminEduFillSelectOptions(els.batchSelect, [], { placeholder: 'Select batch', includeCustom: true });

                els.degreeSelect.value = EDUCATION_CUSTOM_VALUE;
                els.deptSelect.value = EDUCATION_CUSTOM_VALUE;
                els.batchSelect.value = EDUCATION_CUSTOM_VALUE;
                __adminEduToggleCustomInput(els.degreeCustom, true);
                __adminEduToggleCustomInput(els.deptCustom, true);
                __adminEduToggleCustomInput(els.batchCustom, true);
                if (isInitial && __selectedUser) {
                    if (__selectedUser.degree && els.degreeCustom) els.degreeCustom.value = __selectedUser.degree;
                    if (__selectedUser.department && els.deptCustom) els.deptCustom.value = __selectedUser.department;
                    if (__selectedUser.batch_range && els.batchCustom) els.batchCustom.value = __selectedUser.batch_range;
                }
                return;
            }

            __adminEduToggleCustomInput(els.degreeCustom, false);
            __adminEduToggleCustomInput(els.deptCustom, false);
            __adminEduToggleCustomInput(els.batchCustom, false);

            els.degreeSelect.disabled = true;
            els.deptSelect.disabled = true;
            els.batchSelect.disabled = true;
            __adminEduFillSelectOptions(els.degreeSelect, [], { placeholder: 'Loading…', includeCustom: true });
            __adminEduFillSelectOptions(els.deptSelect, [], { placeholder: 'Select department', includeCustom: true });
            __adminEduFillSelectOptions(els.batchSelect, [], { placeholder: 'Select batch', includeCustom: true });

            const details = await __adminEduLoadCollegeDetails(selected);
            __eduModalState.collegeDetails = details;
            const degrees = Array.isArray(details?.degrees) ? details.degrees : [];
            const degreeOptions = degrees
                .filter(d => d && d.id && d.name)
                .map(d => ({ value: String(d.id), label: d.name }));
            els.degreeSelect.disabled = false;
            __adminEduFillSelectOptions(els.degreeSelect, degreeOptions, { placeholder: 'Select degree', includeCustom: true });

            if (isInitial && __selectedUser?.degree) {
                const match = __adminEduFindByName(degrees, __selectedUser.degree, { normalize: s => String(s || '').trim().toLowerCase() });
                if (match) {
                    els.degreeSelect.value = String(match.id);
                } else {
                    els.degreeSelect.value = EDUCATION_CUSTOM_VALUE;
                    __adminEduToggleCustomInput(els.degreeCustom, true);
                    if (els.degreeCustom) els.degreeCustom.value = __selectedUser.degree;
                }
            }

            await __adminEduHandleDegreeChange(isInitial);
        }

        async function __adminEduHandleDegreeChange(isInitial = false) {
            const els = __eduEls();
            const details = __eduModalState.collegeDetails;
            if (!els.degreeSelect || !els.deptSelect) return;

            const selected = els.degreeSelect.value;
            const isCustom = selected === EDUCATION_CUSTOM_VALUE;
            __adminEduToggleCustomInput(els.degreeCustom, isCustom);
            if (isCustom) {
                els.deptSelect.disabled = false;
                __adminEduFillSelectOptions(els.deptSelect, [], { placeholder: 'Select department', includeCustom: true });
                els.deptSelect.value = EDUCATION_CUSTOM_VALUE;
                __adminEduToggleCustomInput(els.deptCustom, true);
                if (isInitial && __selectedUser?.department && els.deptCustom) els.deptCustom.value = __selectedUser.department;
                await __adminEduHandleDepartmentChange(isInitial);
                return;
            }

            __adminEduToggleCustomInput(els.deptCustom, false);
            const departments = __adminEduGetDepartmentsForDegree(details, selected);
            const deptOptions = (departments || [])
                .filter(d => d && d.id && d.name)
                .map(d => ({ value: String(d.id), label: d.name }));

            els.deptSelect.disabled = false;
            __adminEduFillSelectOptions(els.deptSelect, deptOptions, { placeholder: 'Select department', includeCustom: true });

            if (isInitial && __selectedUser?.department) {
                const match = __adminEduFindByName(departments, __selectedUser.department, { normalize: s => String(s || '').trim().toUpperCase() });
                if (match) {
                    els.deptSelect.value = String(match.id);
                } else {
                    els.deptSelect.value = EDUCATION_CUSTOM_VALUE;
                    __adminEduToggleCustomInput(els.deptCustom, true);
                    if (els.deptCustom) els.deptCustom.value = __selectedUser.department;
                }
            }

            await __adminEduHandleDepartmentChange(isInitial);
        }

        async function __adminEduHandleDepartmentChange(isInitial = false) {
            const els = __eduEls();
            const details = __eduModalState.collegeDetails;
            if (!els.batchSelect) return;

            const depSelected = els.deptSelect?.value || '';
            const depIsCustom = depSelected === EDUCATION_CUSTOM_VALUE;
            __adminEduToggleCustomInput(els.deptCustom, depIsCustom);

            const batches = __adminEduGetBatchesForDepartment(details, depIsCustom ? '' : depSelected);
            const batchOptions = (batches || [])
                .map(b => ({ value: __adminEduFormatBatchRange(b), label: __adminEduFormatBatchRange(b) }))
                .filter(opt => opt.value);

            els.batchSelect.disabled = false;
            __adminEduFillSelectOptions(els.batchSelect, batchOptions, { placeholder: 'Select batch', includeCustom: true });

            if (isInitial && __selectedUser) {
                const desired = (__selectedUser.batch_range || ((__selectedUser.batch_from && __selectedUser.batch_to) ? `${__selectedUser.batch_from}-${__selectedUser.batch_to}` : ''));
                if (desired && batchOptions.some(o => o.value === desired)) {
                    els.batchSelect.value = desired;
                    __adminEduToggleCustomInput(els.batchCustom, false);
                } else if (desired) {
                    els.batchSelect.value = EDUCATION_CUSTOM_VALUE;
                    __adminEduToggleCustomInput(els.batchCustom, true);
                    if (els.batchCustom) els.batchCustom.value = desired;
                }
            }

            __adminEduToggleCustomInput(els.batchCustom, els.batchSelect.value === EDUCATION_CUSTOM_VALUE);
        }

        function __adminEduHandleBatchChange() {
            const els = __eduEls();
            __adminEduToggleCustomInput(els.batchCustom, els.batchSelect?.value === EDUCATION_CUSTOM_VALUE);
        }

        function __eduShowStatus(msg, ok) {
            const { status } = __eduEls();
            if (!status) return;
            status.classList.remove('hidden');
            status.textContent = msg;
            status.classList.toggle('border-red-500/30', !ok);
            status.classList.toggle('text-red-200', !ok);
            status.classList.toggle('border-emerald-500/30', ok);
            status.classList.toggle('text-emerald-200', ok);
        }

        function __eduHideStatus() {
            const { status } = __eduEls();
            if (!status) return;
            status.classList.add('hidden');
        }

        function openUserEduModal(u) {
            const els = __eduEls();
            if (!els.modal) return;
            __selectedUser = u;
            __eduHideStatus();
            const name = u?.name || '—';
            const email = u?.email || '—';
            const uid = u?.user_id || u?.auth_user_id || '';
            if (els.subtitle) els.subtitle.textContent = `${name} · ${email}${uid ? ' · ' + uid : ''}`;

            __adminEduEnsureSections();
            if (els.sectionSelect) els.sectionSelect.value = u?.section || '';
            els.semester.value = (u?.semester == null ? '' : String(u.semester));
            els.regno.value = u?.regno || '';

            // Populate cascading selects (async)
            (async () => {
                try {
                    const colleges = await __adminEduLoadCollegesList().catch(() => []);
                    const collegeOptions = (colleges || []).map(col => ({ value: col.id, label: col.name }));
                    __adminEduFillSelectOptions(els.collegeSelect, collegeOptions, { placeholder: 'Select college', includeCustom: true });

                    if (u?.college) {
                        const match = __adminEduFindByName(colleges, u.college, { normalize: s => String(s || '').trim().toLowerCase() });
                        if (match) {
                            els.collegeSelect.value = String(match.id);
                            __adminEduToggleCustomInput(els.collegeCustom, false);
                        } else {
                            els.collegeSelect.value = EDUCATION_CUSTOM_VALUE;
                            __adminEduToggleCustomInput(els.collegeCustom, true);
                            if (els.collegeCustom) els.collegeCustom.value = u.college;
                        }
                    }

                    await __adminEduHandleCollegeChange(true);
                } catch (_) {
                    // Best effort; keep modal usable
                }
            })();

            els.modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeUserEduModal() {
            const { modal } = __eduEls();
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            __selectedUser = null;
            __eduHideStatus();
        }

        async function saveUserEduModal() {
            const els = __eduEls();
            const u = __selectedUser;
            if (!u) return;
            const authUserId = u.user_id || u.auth_user_id;
            if (!authUserId) {
                __eduShowStatus('Missing user id; cannot update.', false);
                return;
            }
            const token = getToken();
            if (!token) {
                __eduShowStatus('Missing token. Please login again.', false);
                return;
            }

            const collegeId = (els.collegeSelect?.value || '').trim();
            const collegeIsCustom = collegeId === EDUCATION_CUSTOM_VALUE;
            const collegeName = collegeIsCustom
                ? (els.collegeCustom?.value || '').trim()
                : (collegeId ? (__adminEduGetSelectedLabel(els.collegeSelect) || '').trim() : '');

            const degreeId = (els.degreeSelect?.value || '').trim();
            const degreeIsCustom = degreeId === EDUCATION_CUSTOM_VALUE;
            const degreeName = degreeIsCustom
                ? (els.degreeCustom?.value || '').trim()
                : (degreeId ? (__adminEduGetSelectedLabel(els.degreeSelect) || '').trim() : '');

            const deptId = (els.deptSelect?.value || '').trim();
            const deptIsCustom = deptId === EDUCATION_CUSTOM_VALUE;
            const deptName = deptIsCustom
                ? (els.deptCustom?.value || '').trim()
                : (deptId ? (__adminEduGetSelectedLabel(els.deptSelect) || '').trim() : '');

            const batchVal = (els.batchSelect?.value || '').trim();
            const batchIsCustom = batchVal === EDUCATION_CUSTOM_VALUE;
            const batchRange = batchIsCustom ? (els.batchCustom?.value || '').trim() : (batchVal || '');

            const section = (els.sectionSelect?.value || '').trim();
            const regno = (els.regno.value || '').trim();
            const semRaw = (els.semester.value || '').trim();

            const semester = semRaw ? parseInt(semRaw, 10) : null;
            let batch_from = null;
            let batch_to = null;
            if (batchRange && String(batchRange).includes('-')) {
                const parts = String(batchRange).split('-', 2);
                const bf = parseInt(parts[0], 10);
                const bt = parseInt(parts[1], 10);
                if (Number.isFinite(bf) && Number.isFinite(bt)) {
                    batch_from = bf;
                    batch_to = bt;
                }
            }

            if (semRaw && (!Number.isFinite(semester) || semester < 1 || semester > 12)) {
                __eduShowStatus('Semester must be between 1 and 12.', false);
                return;
            }
            if (batchRange && !(Number.isFinite(batch_from) && Number.isFinite(batch_to))) {
                __eduShowStatus('Batch must look like 2022-2026.', false);
                return;
            }

            const payload = {
                college_id: (!collegeIsCustom && collegeId && collegeId !== '') ? collegeId : null,
                college_name: collegeName || null,
                degree_id: (!degreeIsCustom && degreeId && degreeId !== '') ? degreeId : null,
                degree_name: degreeName || null,
                department_id: (!deptIsCustom && deptId && deptId !== '') ? deptId : null,
                department_name: deptName || null,
                section: section || null,
                semester: Number.isFinite(semester) ? semester : null,
                regno: regno || null,
                batch_range: batchRange || null,
                batch_from: Number.isFinite(batch_from) ? batch_from : null,
                batch_to: Number.isFinite(batch_to) ? batch_to : null,
            };

            els.saveBtn.disabled = true;
            els.saveBtn.classList.add('opacity-70');
            __eduShowStatus('Saving…', true);
            try {
                const res = await fetch(`${apiBase}/api/admin/users/${encodeURIComponent(authUserId)}/academic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });
                const out = await res.json().catch(() => ({}));
                if (!res.ok) {
                    __eduShowStatus(out?.detail || ('Failed to save (HTTP ' + res.status + ')'), false);
                    return;
                }

                // Update the cached row locally for immediate UI feedback
                u.college = collegeName || u.college;
                u.degree = degreeName || u.degree;
                u.department = deptName || u.department;
                u.section = section || u.section;
                u.semester = Number.isFinite(semester) ? semester : u.semester;
                u.regno = regno;
                u.batch_from = Number.isFinite(batch_from) ? batch_from : u.batch_from;
                u.batch_to = Number.isFinite(batch_to) ? batch_to : u.batch_to;
                u.batch_range = (Number.isFinite(batch_from) && Number.isFinite(batch_to)) ? `${batch_from}-${batch_to}` : (u.batch_range || '—');

                __eduShowStatus('Saved!', true);
                rerender();
                setTimeout(() => closeUserEduModal(), 350);
            } catch (e) {
                __eduShowStatus('Failed to save. Please try again.', false);
            } finally {
                els.saveBtn.disabled = false;
                els.saveBtn.classList.remove('opacity-70');
            }
        }

        async function adminSelfCheck() {
            const token = getToken();
            if (!token) {
                showError('Missing token. Please login first.');
                return false;
            }
            try {
                const r = await fetch(apiBase + '/api/admin/self-check', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (!r.ok) {
                    const t = await r.text();
                    showError('Not authorized to view this page. ' + (t || ''));
                    return false;
                }
                return true;
            } catch (e) {
                showError('Failed to contact server for admin check.');
                return false;
            }
        }

        async function fetchUsers() {
            hideError();
            setStatus('busy', 'Loading');

            const token = getToken();
            const st = getFilterState();
            const url = new URL(apiBase + '/api/admin/users');
            url.searchParams.set('limit', '2000');
            if (st.q) url.searchParams.set('q', st.q);
            if (st.role) url.searchParams.set('role', st.role);
            if (st.department) url.searchParams.set('department', st.department);
            if (st.section) url.searchParams.set('section', st.section);
            if (st.batch_range) url.searchParams.set('batch_range', st.batch_range);
            if (st.semester) url.searchParams.set('semester', st.semester);
            if (st.min_streak) url.searchParams.set('min_streak', st.min_streak);
            if (st.last_login_days) url.searchParams.set('last_login_days', st.last_login_days);

            const res = await fetch(url.toString(), {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) {
                const t = await res.text();
                throw new Error(t || ('HTTP ' + res.status));
            }
            const data = await res.json();
            return (data && data.users) ? data.users : [];
        }

        function rebuildFacetOptions(users) {
            const depts = new Set();
            const batches = new Set();
            const sections = new Set();
            for (const u of users || []) {
                if (u.department) depts.add(u.department);
                const br = toBatchRange(u);
                if (br && br !== '—') batches.add(br);
                if (u.section) sections.add(u.section);
            }
            buildOptionList(document.getElementById('deptFilter'), depts);
            buildOptionList(document.getElementById('batchFilter'), batches);
            buildOptionList(document.getElementById('sectionFilter'), sections);
        }

        function rerender() {
            renderUsers(allUsers);
            setStatus('ok', 'Ready');
        }

        function scheduleRefetch() {
            if (fetchTimer) clearTimeout(fetchTimer);
            fetchTimer = setTimeout(async () => {
                try {
                    allUsers = await fetchUsers();
                    rebuildFacetOptions(allUsers);
                    rerender();
                } catch (e) {
                    setStatus('err', 'Error');
                    showError('Failed to load users: ' + (e && e.message ? e.message : String(e)));
                }
            }, 300);
        }

        async function init() {
            apiBase = await resolveApiBase();
            const ok = await adminSelfCheck();
            if (!ok) return;

            try {
                allUsers = await fetchUsers();
                rebuildFacetOptions(allUsers);
                rerender();
            } catch (e) {
                setStatus('err', 'Error');
                showError('Failed to load users: ' + (e && e.message ? e.message : String(e)));
                return;
            }

            document.getElementById('searchInput').addEventListener('input', scheduleRefetch);
            document.getElementById('refreshBtn').addEventListener('click', () => scheduleRefetch());

            const filters = ['roleFilter', 'deptFilter', 'sectionFilter', 'batchFilter', 'semFilter', 'streakMin', 'lastLoginFilter'];
            for (const id of filters) {
                document.getElementById(id).addEventListener('change', scheduleRefetch);
                if (id === 'streakMin') document.getElementById(id).addEventListener('input', scheduleRefetch);
            }

            document.getElementById('clearBtn').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('roleFilter').value = '';
                document.getElementById('deptFilter').value = '';
                document.getElementById('sectionFilter').value = '';
                document.getElementById('batchFilter').value = '';
                document.getElementById('semFilter').value = '';
                document.getElementById('streakMin').value = '';
                document.getElementById('lastLoginFilter').value = '';
                scheduleRefetch();
            });

            // Modal bindings
            document.querySelectorAll('[data-edu-close]').forEach(el => el.addEventListener('click', closeUserEduModal));
            document.getElementById('userEduSaveBtn').addEventListener('click', saveUserEduModal);
            document.getElementById('eduCollegeSelect')?.addEventListener('change', () => __adminEduHandleCollegeChange(false));
            document.getElementById('eduDegreeSelect')?.addEventListener('change', () => __adminEduHandleDegreeChange(false));
            document.getElementById('eduDeptSelect')?.addEventListener('change', () => __adminEduHandleDepartmentChange(false));
            document.getElementById('eduBatchSelect')?.addEventListener('change', __adminEduHandleBatchChange);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeUserEduModal();
            });
        }

        init();
    </script>
</body>

</html>