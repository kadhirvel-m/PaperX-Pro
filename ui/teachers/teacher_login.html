<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher Login â€” Paper X</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/tailwind.css" />
  <script src="../../config.js"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { container: { center: true, padding: '1rem' }, extend: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] }, colors: { brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' }, brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }, ink: '#1E1E2F', plum: '#4C2A59', orchid: '#9E4B8A' }, boxShadow: { glow: '0 8px 30px rgba(158,75,138,0.35)', card: '0 24px 60px rgba(30,30,47,0.35)' }, backgroundImage: { 'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)', 'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)' } } } }
  </script>
  <style>
    .material-symbols-rounded {
      vertical-align: -6px
    }

    .gradient-hero-text {
      display: inline-block;
      background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
      background-size: 200% 200%;
      animation: gradient-shift 4s ease-in-out infinite;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      -webkit-box-decoration-break: clone;
      box-decoration-break: clone;
    }

    .dark .gradient-hero-text {
      background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }

    .glass-card {
      background: rgba(255, 255, 255, .82);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(158, 75, 138, .18);
    }

    .dark .glass-card {
      background: rgba(30, 30, 47, .72);
      border-color: rgba(255, 255, 255, .12);
      box-shadow: 0 20px 45px rgba(0, 0, 0, .45);
    }

    .dark body {
      background-image: linear-gradient(to left top, #1e1e2f, #242138, #2b2440, #332649, #3d2850, #3f254a, #402244, #401f3e, #34182d, #26131e, #190b11, #000000);
      background-repeat: no-repeat;
      background-size: cover;
    }
  </style>
  <script>(() => { const s = localStorage.getItem('px_theme'); const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches; const dark = s ? s === 'dark' : prefers; if (dark) document.documentElement.classList.add('dark'); })();</script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
  <header
    class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
    <div class="container flex items-center justify-between py-3">
      <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
        <img src="../assets/img/logo-light.svg" class="h-9 w-auto dark:hidden" alt="Paper X">
        <img src="../assets/img/logo-dark.svg" class="h-9 w-auto hidden dark:block" alt="Paper X">
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../index.html">Home</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../about.html">About</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../help.html">Help</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white font-medium" href="teacher_signup.html">Apply</a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <button data-theme-toggle
          class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
            class="material-symbols-rounded text-base">dark_mode</span></button>
      </div>
    </div>
  </header>

  <main>
    <section class="relative overflow-hidden pt-8 pb-16">
      <div
        class="pointer-events-none absolute inset-0 opacity-[0.35] bg-[radial-gradient(circle_at_20%_10%,rgba(158,75,138,0.25),transparent_60%),radial-gradient(circle_at_80%_85%,rgba(76,42,89,0.28),transparent_60%)]">
      </div>
      <div class="container relative z-10 grid gap-12 lg:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)] items-center">
        <div class="space-y-6">
          <span
            class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-[11px] font-medium ring-1 ring-brandlt-300 bg-brandlt-100/70 dark:bg-brand-700/25 text-brand-700 dark:text-white/85">Teacher
            Portal</span>
          <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight leading-tight">Sign in to <span
              class="gradient-hero-text">Teacher Connect</span></h1>
          <div
            class="rounded-3xl overflow-hidden bg-white/80 dark:bg-white/5 ring-1 ring-black/5 dark:ring-white/10 shadow-soft dark:shadow-glow aspect-[16/9] md:aspect-[21/10] max-w-xl md:max-w-lg mx-auto">
            <video class="w-full h-full object-cover" autoplay muted loop playsinline>
              <source src="../assets/video/signup.mp4" type="video/mp4" />
            </video>
          </div>
          <ul class="space-y-3 text-sm text-neutral-600 dark:text-white/65">
            <li class="flex items-start gap-3"><span
                class="mt-0.5 inline-flex size-6 items-center justify-center rounded-full bg-brand-500/15 text-brand-500"><span
                  class="material-symbols-rounded text-base">verified</span></span> Admin-approved teacher access.</li>
            <li class="flex items-start gap-3"><span
                class="mt-0.5 inline-flex size-6 items-center justify-center rounded-full bg-brand-700/15 text-brand-700"><span
                  class="material-symbols-rounded text-base">forum</span></span> Collaborate, share notes, message
              students.</li>
            <li class="flex items-start gap-3"><span
                class="mt-0.5 inline-flex size-6 items-center justify-center rounded-full bg-brand-500/15 text-brand-500"><span
                  class="material-symbols-rounded text-base">shield_person</span></span> Secure login backed by
              Supabase.</li>
          </ul>
        </div>

        <div class="relative">
          <div
            class="glass-card rounded-3xl p-6 sm:p-8 shadow-soft dark:shadow-glow ring-1 ring-black/5 dark:ring-white/10">
            <div class="mb-6 space-y-2 text-center">
              <h2 class="text-2xl font-semibold">Welcome back, Teacher</h2>
              <p class="text-sm text-neutral-500 dark:text-white/60">Use your registered email and password.</p>
            </div>
            <form id="loginForm" class="space-y-6" novalidate>
              <div>
                <label class="text-sm font-medium text-neutral-700 dark:text-white/85">Email</label>
                <input type="email" name="email" required autocomplete="email" placeholder="you@college.edu"
                  class="mt-2 block w-full rounded-2xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-white/5 px-4 py-3 text-sm text-neutral-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-brand-500/70 focus:border-transparent transition" />
              </div>
              <div class="relative">
                <label class="text-sm font-medium text-neutral-700 dark:text-white/85">Password</label>
                <input type="password" name="password" required minlength="6" placeholder="Minimum 6 characters"
                  class="mt-2 block w-full rounded-2xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-white/5 px-4 py-3 pr-12 text-sm text-neutral-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-brand-500/70 focus:border-transparent transition" />
              </div>
              <button type="submit"
                class="w-full inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] px-6 py-3 text-sm font-semibold text-white shadow-[0_10px_30px_rgba(158,75,138,0.28)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.35)] transition">
                <span class="material-symbols-rounded text-base">login</span>
                <span>Sign in</span>
              </button>
              <div id="status"
                class="hidden rounded-2xl border border-brand-500/25 bg-brand-500/10 px-4 py-3 text-xs text-brand-900 dark:text-white/80">
              </div>
              <p class="text-sm text-neutral-500 dark:text-white/60 text-center">New here? <a
                  class="font-semibold text-brand-500 hover:text-brand-700" href="teacher_signup.html">Apply as a
                  Teacher</a></p>
            </form>
          </div>
          <p class="mt-4 text-[11px] text-center text-neutral-500 dark:text-white/45">By continuing you agree to our <a
              href="#" class="underline">Terms</a> and <a href="#" class="underline">Privacy Policy</a>.</p>
        </div>
      </div>
    </section>
  </main>
  <script>
    // Dynamic API base detection similar to signup page
    let API_BASE = window.API_BASE || '';
    (function resolveApiBase() {
      if (API_BASE) return;
      const origin = location.origin;
      if (location.port === '8000') { API_BASE = origin; return; }
      const host = location.hostname;
      const candidates = [origin, `http://${host}:8000`, `https://${host}:8000`];
      (async () => {
        for (const c of candidates) {
          try { const r = await fetch(c + '/api/public/academic-meta', { method: 'GET' }); if (r.ok) { API_BASE = c.replace(/\/$/, ''); return; } } catch (_) { }
        }
        API_BASE = origin;
      })();
    })();

    const form = document.getElementById('loginForm');
    const statusEl = document.getElementById('status');
    function friendlyError(msg) { statusEl.classList.remove('hidden'); statusEl.textContent = msg; }
    async function safeJson(res) {
      const ct = res.headers.get('content-type') || '';
      let text = '';
      try { text = await res.text(); } catch (_) { return {}; }
      if (!text) { return {}; }
      if (!/json|javascript/i.test(ct)) {
        console.warn('[login] Non-JSON response', { status: res.status, ct, sample: text.slice(0, 120) });
        try { return JSON.parse(text); } catch { return { raw: text }; }
      }
      try { return JSON.parse(text); }
      catch (err) { console.warn('[login] JSON parse error', err, { sample: text.slice(0, 120) }); return {}; }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = 'Logging in...';
      const fd = new FormData(form);
      const body = { email: (fd.get('email') || '').trim(), password: fd.get('password') };
      if (!body.email || !body.password) { friendlyError('Email & password required'); return; }
      try {
        // Wait briefly if API_BASE resolving
        let tries = 0; while (!API_BASE && tries < 10) { await new Promise(r => setTimeout(r, 100)); tries++; }
        const base = (API_BASE || location.origin).replace(/\/$/, '');
        const res = await fetch(base + '/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await safeJson(res);
        if (!res.ok) { throw new Error(data.detail || data.error || 'Login failed (' + res.status + ')'); }
        if (!data.access_token) { throw new Error('No access token returned'); }
        // Enforce single active session (teacher wins here)
        localStorage.setItem('teacherToken', data.access_token || '');
        try { localStorage.removeItem('px_token'); } catch { }
        statusEl.classList.remove('hidden');
        statusEl.textContent = 'Signed in. Checking role...';
        const st = await fetch(base + '/api/teacher/me/status', { headers: { 'Authorization': 'Bearer ' + data.access_token } });
        if (!st.ok) {
          console.warn('[login] status check failed', st.status);
          friendlyError('Could not verify role (status ' + st.status + ').');
          return;
        }
        const sdata = await safeJson(st);
        const role = sdata.role; const tstatus = sdata.status;
        if (role === 'teacher' && tstatus === 'approved') {
          statusEl.textContent = 'Approved Teacher. Redirecting...';
          setTimeout(() => { location.href = '../teacher_profile.html'; }, 800);
        } else if (tstatus) {
          statusEl.textContent = 'Application status: ' + tstatus + '. Awaiting approval.';
        } else {
          statusEl.textContent = 'Logged in. Application not found / pending.';
        }
      } catch (err) { friendlyError(err.message || 'Unexpected error'); }
    });
  </script>
</body>

</html>