<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manage Notes — Paper X</title>
    <link rel="icon" type="image/x-icon" href="../../../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/tailwind.css" />
    <script src="../../config.js"></script>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: {
                            50: '#FAF5FB',
                            100: '#F3E7F2',
                            200: '#E7D0E4',
                            300: '#D9B4D3',
                            400: '#C88DBA',
                            500: '#9E4B8A',
                            700: '#4C2A59',
                            900: '#1E1E2F'
                        },
                        ink: '#1E1E2F',
                        plum: '#4C2A59',
                        orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        card: '0 24px 60px rgba(30,30,47,0.35)'
                    },
                    backgroundImage: {
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)',
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)'
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        #editModal.show {
            display: flex;
        }
    </style>
    <script>(() => {
            const s = localStorage.getItem('px_theme');
            const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const dark = s ? s === 'dark' : prefers;
            if (dark) document.documentElement.classList.add('dark');
        })();</script>
</head>

<body
    class="font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark min-h-screen flex flex-col overflow-x-hidden">
    <header class="bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <div class="flex items-center gap-3">
                <a href="../../index.html" class="flex items-center gap-2">
                    <img src="../../../assets/img/logo-light.svg" class="h-8 dark:hidden" alt="Paper X" />
                    <img src="../../../assets/img/logo-dark.svg" class="h-8 hidden dark:block" alt="Paper X" />
                </a>
                <h1 class="text-lg font-semibold tracking-tight hidden sm:block">Manage Notes</h1>
            </div>
            <nav class="hidden md:flex items-center gap-5 text-sm text-neutral-700 dark:text-white/80">
                <a href="../teacher_notes.html" class="hover:text-brandlt-900 dark:hover:text-white">Upload</a>
                <a href="../teacher_connect.html" class="hover:text-brandlt-900 dark:hover:text-white">Connect</a>
            </nav>
            <button data-theme-toggle
                class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-xs ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"
                aria-label="Toggle theme"><span class="material-symbols-rounded text-base">dark_mode</span><span
                    class="hidden sm:block">Theme</span></button>
        </div>
    </header>
    <main class="flex-1">
        <div class="container py-10">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-6">
                <div>
                    <p class="text-xs uppercase tracking-widest text-neutral-500 dark:text-white/40">Teacher Workspace</p>
                    <h2 class="text-2xl font-bold gradient-hero-text">All Uploaded Notes</h2>
                </div>
                <div class="flex items-center gap-3">
                    <a href="../teacher_notes.html"
                        class="inline-flex items-center gap-2 rounded-full bg-brand-500 text-white font-semibold px-5 py-2 text-sm hover:shadow-glow transition">
                        Upload New <span class="material-symbols-rounded text-base">add</span>
                    </a>
                </div>
            </div>
            <div class="rounded-2xl bg-white/80 dark:bg-brand-900/50 backdrop-blur ring-1 ring-black/10 dark:ring-white/10 p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-neutral-500 dark:text-white/50">My notes catalogue</h3>
                    <span id="notesStatus" class="text-xs font-medium text-neutral-500 dark:text-white/50"></span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="notesTable">
                        <thead class="text-[11px] uppercase tracking-wider text-neutral-500 dark:text-white/50">
                            <tr>
                                <th class="text-left py-2 px-3">Title</th>
                                <th class="text-left py-2 px-3">Subject</th>
                                <th class="text-left py-2 px-3">Semester</th>
                                <th class="text-left py-2 px-3">Updated</th>
                                <th class="text-left py-2 px-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notesTbody" class="divide-y divide-black/5 dark:divide-white/10">
                            <tr>
                                <td colspan="5" class="py-4 text-center text-sm text-neutral-500 dark:text-white/50">Loading …</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="editModal"
        class="fixed inset-0 hidden items-center justify-center bg-black/40 dark:bg-black/60 px-4">
        <div class="w-full max-w-xl rounded-2xl bg-white dark:bg-brand-900 ring-1 ring-black/10 dark:ring-white/15 p-6 space-y-5 relative">
            <button id="closeModalBtn" class="absolute top-3 right-3 text-neutral-400 hover:text-neutral-600 dark:hover:text-white"
                aria-label="Close edit dialog">
                <span class="material-symbols-rounded">close</span>
            </button>
            <div>
                <h3 class="text-lg font-semibold">Edit Note</h3>
                <p class="text-xs text-neutral-500 dark:text-white/50">Update metadata to keep your catalogue accurate.</p>
            </div>
            <form id="editForm" class="space-y-4">
                <input type="hidden" name="note_id" id="editNoteId" />
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Title</label>
                    <input type="text" id="editTitle" required
                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500" />
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Description</label>
                    <textarea id="editDescription"
                        class="w-full min-h-[80px] rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500"></textarea>
                </div>
                <div class="space-y-1">
                    <p class="text-[11px] uppercase tracking-wide text-neutral-500 dark:text-white/50">Current File</p>
                    <p id="currentFileName" class="text-xs font-medium text-neutral-700 dark:text-white/70"></p>
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Replace File (optional)</label>
                    <input type="file" id="editFile"
                        class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-brand-500 file:text-white hover:file:bg-brand-700"
                        accept=".pdf,.doc,.docx,.ppt,.pptx,.zip" />
                    <p class="text-[11px] text-neutral-500 dark:text-white/50 mt-1">Leave empty to keep the existing upload. Max size 25MB.</p>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelEditBtn"
                        class="px-4 py-2 text-sm font-semibold rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10">Cancel</button>
                    <button type="submit"
                        class="inline-flex items-center gap-2 rounded-full bg-brand-500 text-white font-semibold px-5 py-2 text-sm hover:shadow-glow transition">
                        Save Changes <span class="material-symbols-rounded text-base">save</span>
                    </button>
                </div>
                <div id="editFeedback" class="text-xs font-medium text-brand-500"></div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('teacherToken') || localStorage.getItem('px_auth_token');
        if (!token) {
            window.location.href = '../teacher_login.html';
        }
        const API_BASE = window.API_BASE || window.__API_BASE || location.origin;
        const notesTbody = document.getElementById('notesTbody');
        const notesStatus = document.getElementById('notesStatus');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editFeedback = document.getElementById('editFeedback');
        const editTitle = document.getElementById('editTitle');
        const editDescription = document.getElementById('editDescription');
        const editFile = document.getElementById('editFile');
        const currentFileName = document.getElementById('currentFileName');
        const editNoteId = document.getElementById('editNoteId');

        let notesCache = [];
        let currentEditingNote = null;

        async function fetchJSON(url, opts = {}) {
            const res = await fetch(url, opts);
            if (!res.ok) {
                let detail = `HTTP ${res.status}`;
                try {
                    const data = await res.json();
                    if (data && data.detail) detail = data.detail;
                } catch (err) {
                    /* ignore */
                }
                throw new Error(detail);
            }
            return res.json();
        }

        function renderNotes() {
            notesTbody.innerHTML = '';
            if (!notesCache.length) {
                notesTbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-sm text-neutral-500 dark:text-white/50">No notes uploaded yet.</td></tr>';
                return;
            }
            notesCache.forEach(note => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-black/5 dark:hover:bg-white/5 transition';
                const updatedAt = note.updated_at || note.created_at;
                tr.innerHTML = `
                    <td class="py-3 px-3 font-medium">${note.title || ''}</td>
                    <td class="py-3 px-3">${note.subject || ''}</td>
                    <td class="py-3 px-3">${note.semester || ''}</td>
                    <td class="py-3 px-3 text-xs text-neutral-500 dark:text-white/50">${updatedAt ? new Date(updatedAt).toLocaleString() : ''}</td>
                    <td class="py-3 px-3">
                        <div class="flex items-center gap-3">
                            <button class="inline-flex items-center gap-1 text-xs font-semibold text-brand-500 hover:text-brand-700"
                                data-action="edit" data-note-id="${note.id}">
                                <span class="material-symbols-rounded text-base">edit</span>Edit
                            </button>
                            <button class="inline-flex items-center gap-1 text-xs font-semibold text-red-500 hover:text-red-600"
                                data-action="delete" data-note-id="${note.id}">
                                <span class="material-symbols-rounded text-base">delete</span>Delete
                            </button>
                        </div>
                    </td>
                `;
                notesTbody.appendChild(tr);
            });
        }

        async function loadNotes() {
            try {
                notesStatus.textContent = 'Refreshing...';
                const data = await fetchJSON(API_BASE + '/api/teacher/notes/mine', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                notesCache = data.notes || [];
                renderNotes();
                notesStatus.textContent = `${notesCache.length} note${notesCache.length === 1 ? '' : 's'}`;
            } catch (err) {
                console.error('[ManageNotes] loadNotes failed', err);
                notesStatus.textContent = 'Failed to load notes';
                notesTbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-sm text-red-500">Unable to load notes.</td></tr>';
            }
        }

        function openEdit(note) {
            currentEditingNote = note;
            editNoteId.value = note.id;
            editTitle.value = note.title || '';
            editDescription.value = note.description || '';
            editFeedback.textContent = '';
            editFile.value = '';
            currentFileName.textContent = note.original_filename || 'No file uploaded yet.';
            editModal.classList.remove('hidden');
            editModal.classList.add('show');
        }

        function closeEdit() {
            editModal.classList.add('hidden');
            editModal.classList.remove('show');
            editFeedback.textContent = '';
            editFile.value = '';
            currentEditingNote = null;
        }

        notesTbody.addEventListener('click', async (event) => {
            const btn = event.target.closest('button[data-note-id]');
            if (!btn) return;
            const noteId = btn.dataset.noteId;
            const action = btn.dataset.action;
            const note = notesCache.find(n => n.id === noteId);
            if (!note) return;
            if (action === 'edit') {
                openEdit(note);
                return;
            }
            if (action === 'delete') {
                const confirmed = confirm(`Delete "${note.title || 'this note'}"? This cannot be undone.`);
                if (!confirmed) return;
                btn.disabled = true;
                btn.classList.add('opacity-50');
                try {
                    const res = await fetch(`${API_BASE}/api/marketplace/notes/${noteId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(data.detail || 'Delete failed');
                    await loadNotes();
                } catch (err) {
                    alert('Delete failed: ' + err.message);
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                }
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const noteId = editNoteId.value;
            if (!noteId) return;
            const file = editFile.files[0] || null;
            const title = editTitle.value.trim();
            if (!title) {
                editFeedback.textContent = 'Title is required.';
                return;
            }
            const description = editDescription.value.trim();
            const updates = {};
            const original = currentEditingNote || notesCache.find(n => n.id === noteId) || {};
            const originalTitle = (original.title || '').trim();
            const originalDescription = (original.description || '').trim();
            if (title !== originalTitle) {
                updates.title = title;
            }
            if (description !== originalDescription) {
                updates.description = description;
            }
            if (!Object.keys(updates).length && !file) {
                editFeedback.textContent = 'No changes to save.';
                return;
            }
            try {
                if (Object.keys(updates).length) {
                    editFeedback.textContent = 'Saving details...';
                    const res = await fetch(`${API_BASE}/api/marketplace/notes/${noteId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify(updates)
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(data.detail || 'Update failed');
                }
                if (file) {
                    editFeedback.textContent = 'Uploading new file...';
                    const fd = new FormData();
                    fd.append('file', file);
                    const fileRes = await fetch(`${API_BASE}/api/marketplace/notes/${noteId}/replace-file`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token },
                        body: fd
                    });
                    const fileData = await fileRes.json().catch(() => ({}));
                    if (!fileRes.ok) throw new Error(fileData.detail || 'File replace failed');
                    currentFileName.textContent = file.name;
                    editFile.value = '';
                }
                await loadNotes();
                currentEditingNote = notesCache.find(n => n.id === noteId) || null;
                if (currentEditingNote && !file) {
                    currentFileName.textContent = currentEditingNote.original_filename || currentFileName.textContent;
                }
                editFeedback.textContent = 'Changes saved.';
                setTimeout(() => closeEdit(), 400);
            } catch (err) {
                editFeedback.textContent = 'Error: ' + err.message;
            }
        });

        document.getElementById('cancelEditBtn').addEventListener('click', closeEdit);
        document.getElementById('closeModalBtn').addEventListener('click', closeEdit);
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeEdit();
        });

        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-theme-toggle]')) {
                const root = document.documentElement;
                const dark = root.classList.toggle('dark');
                localStorage.setItem('px_theme', dark ? 'dark' : 'light');
            }
        });

        loadNotes();
    </script>
</body>

</html>

