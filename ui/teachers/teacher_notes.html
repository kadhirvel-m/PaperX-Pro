<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher Notes — Paper X</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script src="../config.js"></script>
    <!-- Supabase client for Storage uploads -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Guard for environments without the CDN runtime (SES lockdown would otherwise throw)
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: {
                            50: '#FAF5FB',
                            100: '#F3E7F2',
                            200: '#E7D0E4',
                            300: '#D9B4D3',
                            400: '#C88DBA',
                            500: '#9E4B8A',
                            700: '#4C2A59',
                            900: '#1E1E2F'
                        },
                        ink: '#1E1E2F',
                        plum: '#4C2A59',
                        orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        card: '0 24px 60px rgba(30,30,47,0.35)'
                    },
                    backgroundImage: {
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)',
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)'
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px
        }
    </style>
    <script>(() => { const s = localStorage.getItem('px_theme'); const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches; const dark = s ? s === 'dark' : prefers; if (dark) document.documentElement.classList.add('dark'); })();</script>
</head>

<body
    class="font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark min-h-screen flex flex-col overflow-x-hidden">
    <header class="bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <div class="flex items-center gap-3">
                <a href="../index.html" class="flex items-center gap-2">
                    <img src="../assets/img/logo-light.svg" class="h-8 dark:hidden" alt="Paper X" />
                    <img src="../assets/img/logo-dark.svg" class="h-8 hidden dark:block" alt="Paper X" />
                </a>
                <h1 class="text-lg font-semibold tracking-tight hidden sm:block">Teacher Notes</h1>
            </div>
            <nav class="hidden md:flex items-center gap-5 text-sm text-neutral-700 dark:text-white/80">
                <a href="teacher_connect.html" class="hover:text-brandlt-900 dark:hover:text-white">Connect</a>
                <a href="teacher_signup.html" class="hover:text-brandlt-900 dark:hover:text-white">Signup</a>
                <a href="teacher_login.html" class="hover:text-brandlt-900 dark:hover:text-white">Login</a>
            </nav>
            <button data-theme-toggle
                class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-xs ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"
                aria-label="Toggle theme"><span class="material-symbols-rounded text-base">dark_mode</span><span
                    class="hidden sm:block">Theme</span></button>
        </div>
    </header>
    <main class="flex-1">
        <div class="container py-10">
            <div class="max-w-5xl mx-auto grid lg:grid-cols-5 gap-10">
                <div class="lg:col-span-3 space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold gradient-hero-text">Upload Notes</h2>
                        <p class="mt-2 text-sm text-neutral-600 dark:text-white/60">Associate academic metadata for
                            discoverability. Files stored via marketplace.</p>
                    </div>
                    <form id="uploadForm"
                        class="space-y-6 rounded-2xl bg-white/80 dark:bg-brand-900/50 backdrop-blur ring-1 ring-black/10 dark:ring-white/10 p-6 shadow-soft">
                        <div class="space-y-2" id="classPickerWrap">
                            <div class="flex items-center justify-between">
                                <label class="block text-xs font-semibold uppercase tracking-wide">Select Class
                                    (Handled)</label>
                                <button type="button" id="toggleManualBtn"
                                    class="text-[10px] font-medium px-2 py-1 rounded bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/15">Manual
                                    Mode</button>
                            </div>
                            <div id="classesList" class="grid gap-2 sm:grid-cols-2 lg:grid-cols-3"></div>
                            <div id="selectedClassInfo" class="text-[11px] mt-1 text-neutral-600 dark:text-white/60">
                            </div>
                            <div id="noClassesMsg" class="hidden text-[11px] text-neutral-500 dark:text-white/50">No
                                classes found. Use manual mode.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Title</label>
                            <input type="text" name="title" required
                                class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500" />
                        </div>
                        <div>
                            <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Description
                                (optional)</label>
                            <textarea name="description"
                                class="w-full min-h-[90px] resize-y rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500"
                                placeholder="Short description (optional)"></textarea>
                        </div>
                        <div id="manualFields" class="hidden">
                            <div class="grid sm:grid-cols-2 gap-5">
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">College</label>
                                    <select name="college_id" id="collegeSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">Degree</label>
                                    <select name="degree_id" id="degreeSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">Department</label>
                                    <select name="department_id" id="departmentSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">Batch</label>
                                    <select name="batch_id" id="batchSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">Semester</label>
                                    <select name="semester" id="semesterSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-semibold uppercase tracking-wide mb-1">Subject</label>
                                    <select name="subject" id="subjectSelect"
                                        class="w-full rounded-lg border-neutral-300 dark:border-white/15 bg-white/90 dark:bg-brand-900/40 focus:ring-brand-500 focus:border-brand-500">
                                        <option value="">--</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="college_id" id="hCollege" />
                        <input type="hidden" name="degree_id" id="hDegree" />
                        <input type="hidden" name="department_id" id="hDepartment" />
                        <input type="hidden" name="batch_id" id="hBatch" />
                        <input type="hidden" name="semester" id="hSemester" />
                        <input type="hidden" name="subject" id="hSubject" />
                        <input type="hidden" name="subject_id" id="hSubjectId" />
                        <div>
                            <label class="block text-xs font-semibold uppercase tracking-wide mb-1">Attach Files (PDF /
                                DOC / PPT / ZIP)</label>
                            <input type="file" name="files" multiple required
                                class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-brand-500 file:text-white hover:file:bg-brand-700" />
                        </div>
                        <div class="flex justify-end">
                            <button type="submit"
                                class="inline-flex items-center gap-2 rounded-full bg-brand-500 text-white font-semibold px-6 py-3 text-sm hover:shadow-glow transition">Upload<span
                                    class="material-symbols-rounded text-base">cloud_upload</span></button>
                        </div>
                        <div id="uploadStatus" class="text-xs font-medium"></div>
                    </form>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold uppercase tracking-wider text-neutral-500 dark:text-white/50">
                            My
                            Notes</h3>
                        <a href="notes/manage_notes.html"
                            class="inline-flex items-center gap-2 text-xs font-medium px-3 py-1.5 rounded-full bg-brand-500/10 text-brand-500 hover:bg-brand-500/20 transition">
                            View All <span class="material-symbols-rounded text-base">open_in_new</span>
                        </a>
                    </div>
                    <div
                        class="rounded-2xl bg-white/80 dark:bg-brand-900/50 backdrop-blur ring-1 ring-black/10 dark:ring-white/10 p-4 max-h-[70vh] overflow-y-auto">
                        <table class="w-full text-sm" id="notesTable">
                            <thead class="text-[10px] uppercase tracking-wider text-neutral-500 dark:text-white/50">
                                <tr>
                                    <th class="text-left py-2 pr-3 font-semibold">Title</th>
                                    <th class="text-left py-2 pr-3 font-semibold">Subject</th>
                                    <th class="text-left py-2 pr-3 font-semibold">Sem</th>
                                    <th class="text-left py-2 font-semibold">Created</th>
                                </tr>
                            </thead>
                            <tbody class="align-top"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        const API_BASE = (window.API_BASE || window.__API_BASE || location.origin);
        const token = localStorage.getItem('teacherToken') || localStorage.getItem('px_auth_token');
        if (!token) { alert('Login required'); location.href = 'teacher_login.html'; }
        const collegeSelect = document.getElementById('collegeSelect');
        const degreeSelect = document.getElementById('degreeSelect');
        const departmentSelect = document.getElementById('departmentSelect');
        const batchSelect = document.getElementById('batchSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        const hidden = {
            college: document.getElementById('hCollege'),
            degree: document.getElementById('hDegree'),
            department: document.getElementById('hDepartment'),
            batch: document.getElementById('hBatch'),
            semester: document.getElementById('hSemester'),
            subject: document.getElementById('hSubject'),
            subject_id: document.getElementById('hSubjectId')
        };
        let selectedClassId = null; let classCache = [];
        const notesTbody = document.querySelector('#notesTable tbody');
        const uploadStatus = document.getElementById('uploadStatus');

        async function fetchJSON(url, opts = {}) {
            const res = await fetch(url, opts);
            const ct = res.headers.get('content-type') || '';
            let data = null;
            try {
                const txt = await res.text();
                data = txt ? (/json|javascript/i.test(ct) ? JSON.parse(txt) : (function () { try { return JSON.parse(txt); } catch { return { detail: txt }; } })()) : {};
            } catch (_) { data = {}; }
            if (!res.ok) {
                const err = new Error((data && (data.detail || data.error)) || `Request failed (${res.status})`);
                err.status = res.status;
                err.data = data;
                throw err;
            }
            return data;
        }

        // ---------- Supabase helpers (for file uploads) ----------
        let supabaseClient = null;
        let SUPABASE_BUCKET = 'notes';
        async function ensureSupabase() {
            if (supabaseClient) return supabaseClient;
            const base = (API_BASE || '').replace(/\/$/, '');
            try {
                const cfg = await fetch(base + '/api/public/supabase').then(r => r.json());
                if (!cfg?.url || !cfg?.anonKey) throw new Error('Missing Supabase config');
                supabaseClient = window.supabase.createClient(cfg.url, cfg.anonKey);
                if (cfg.bucket) SUPABASE_BUCKET = cfg.bucket;
                return supabaseClient;
            } catch (e) {
                console.warn('[TeacherNotes] Supabase init failed', e);
                throw e;
            }
        }
        function safePath(name = '') {
            const base = (name || '').toString().split('\\').pop().split('/').pop();
            const clean = base.replace(/[^A-Za-z0-9._-]+/g, '-').replace(/-+/g, '-');
            return clean || ('file-' + Date.now());
        }
        async function uploadToSupabase(file, meta = {}) {
            const sb = await ensureSupabase();
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const rand = Math.random().toString(36).slice(2, 8);
            const prefix = `teacher-notes/${y}/${m}/${d}`;
            const path = `${prefix}/${rand}-${safePath(meta.originalName || file.name)}`;
            const opt = { cacheControl: '3600', upsert: false, contentType: file.type || 'application/octet-stream' };
            const { error } = await sb.storage.from(SUPABASE_BUCKET).upload(path, file, opt);
            if (error) throw error;
            const { data } = sb.storage.from(SUPABASE_BUCKET).getPublicUrl(path);
            const publicUrl = data?.publicUrl || '';
            return { path, publicUrl };
        }

        async function loadMeta() {
            try {
                const meta = await fetchJSON(API_BASE + '/api/teacher/notes/upload-meta', { headers: { 'Authorization': 'Bearer ' + token } });
                (meta.colleges || []).forEach(c => { const o = document.createElement('option'); o.value = String(c.id); o.textContent = c.name; collegeSelect.appendChild(o); });
                // degrees depend on selected college
                const populateDegrees = () => {
                    const selectedCollege = collegeSelect.value;
                    degreeSelect.innerHTML = '<option value="">--</option>';
                    (meta.degrees || [])
                        .filter(d => !selectedCollege || String(d.college_id) === String(selectedCollege))
                        .forEach(d => { const o = document.createElement('option'); o.value = String(d.id); o.textContent = d.name; degreeSelect.appendChild(o); });
                };
                populateDegrees();
                collegeSelect.onchange = () => { subjectSelect.innerHTML = '<option value="">--</option>'; populateDegrees(); populateDepartments(meta); };
                degreeSelect.onchange = () => { subjectSelect.innerHTML = '<option value="">--</option>'; populateDepartments(meta); };
                departmentSelect.onchange = () => { subjectSelect.innerHTML = '<option value="">--</option>'; populateBatches(meta); };
                populateDepartments(meta);
            } catch (e) {
                console.warn('meta failed', e);
                // Fallback to public meta (no batches)
                try {
                    const meta = await fetchJSON(API_BASE + '/api/public/academic-meta');
                    (meta.colleges || []).forEach(c => { const o = document.createElement('option'); o.value = String(c.id); o.textContent = c.name; collegeSelect.appendChild(o); });
                    const populateDegrees = () => {
                        const selectedCollege = collegeSelect.value;
                        degreeSelect.innerHTML = '<option value="">--</option>';
                        (meta.degrees || [])
                            .filter(d => !selectedCollege || String(d.college_id) === String(selectedCollege))
                            .forEach(d => { const o = document.createElement('option'); o.value = String(d.id); o.textContent = d.name; degreeSelect.appendChild(o); });
                    };
                    populateDegrees();
                    collegeSelect.onchange = () => { populateDegrees(); populateDepartments(meta); };
                    degreeSelect.onchange = () => populateDepartments(meta);
                    // batches missing in public meta; disable until auth available
                    batchSelect.innerHTML = '<option value="">Login as approved teacher to load batches</option>';
                    batchSelect.setAttribute('disabled', 'disabled');
                    subjectSelect.innerHTML = '<option value="">Select batch and semester</option>';
                    subjectSelect.setAttribute('disabled', 'disabled');
                    populateDepartments(meta);
                    const us = document.getElementById('uploadStatus');
                    if (us) us.textContent = 'Limited metadata loaded (not approved or not logged in).';
                } catch (e2) {
                    const us = document.getElementById('uploadStatus');
                    if (us) us.textContent = 'Failed to load academic metadata.';
                }
            }
        }
        function populateDepartments(meta) {
            departmentSelect.innerHTML = '<option value="">--</option>';
            const collegeId = collegeSelect.value; const degreeId = degreeSelect.value;
            (meta.departments || [])
                .filter(d => (!collegeId || String(d.college_id) === String(collegeId)) && (!degreeId || String(d.degree_id) === String(degreeId)))
                .forEach(d => { const o = document.createElement('option'); o.value = String(d.id); o.textContent = d.name; departmentSelect.appendChild(o); });
            populateBatches(meta);
        }
        function populateBatches(meta) {
            batchSelect.innerHTML = '<option value="">--</option>';
            const deptId = departmentSelect.value;
            (meta.batches || [])
                .filter(b => !deptId || String(b.department_id) === String(deptId))
                .forEach(b => { const o = document.createElement('option'); o.value = String(b.id); o.textContent = b.from_year + '-' + b.to_year; batchSelect.appendChild(o); });
            // when batches change, subjects depend on batch + semester
            if ((meta.batches || []).length) { batchSelect.removeAttribute('disabled'); }
            populateSubjects();
        }

        async function populateSubjects() {
            subjectSelect.innerHTML = '<option value="">--</option>';
            const batchId = batchSelect.value;
            const semester = document.getElementById('semesterSelect').value;
            if (!batchId || !semester) { subjectSelect.setAttribute('disabled', 'disabled'); return; }
            try {
                const subs = await fetchJSON(`${API_BASE}/api/batches/${encodeURIComponent(batchId)}/courses?semester=${encodeURIComponent(semester)}`);
                console.log('[TeacherNotes] Loaded subjects', subs);
                (subs || []).forEach(s => {
                    const o = document.createElement('option');
                    // store subject id as value; display code — title
                    o.value = s.id || '';
                    o.textContent = (s.course_code ? `${s.course_code} — ` : '') + (s.title || '');
                    subjectSelect.appendChild(o);
                });
                subjectSelect.removeAttribute('disabled');
            } catch (e) {
                console.warn('[TeacherNotes] Subjects fetch failed', { batchId, semester, error: e });
                subjectSelect.setAttribute('disabled', 'disabled');
            }
        }
        subjectSelect.addEventListener('change', () => {
            const opt = subjectSelect.selectedIndex >= 0 ? subjectSelect.options[subjectSelect.selectedIndex] : undefined;
            hidden.subject_id.value = subjectSelect.value || '';
            hidden.subject.value = opt ? (opt.textContent || '').trim() : '';
            console.log('[TeacherNotes] Subject dropdown change', {
                subjectId: hidden.subject_id.value,
                subjectLabel: hidden.subject.value,
            });
        });

        async function loadMyNotes() {
            try {
                const data = await fetchJSON(API_BASE + '/api/teacher/notes/mine', { headers: { 'Authorization': 'Bearer ' + token } });
                notesTbody.innerHTML = '';
                (data.notes || []).forEach(n => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${n.title}</td><td>${n.subject || ''}</td><td>${n.semester || ''}</td><td>${new Date(n.created_at).toLocaleDateString()}</td>`;
                    notesTbody.appendChild(tr);
                });
                if (!data.notes?.length) notesTbody.innerHTML = '<tr><td colspan="4" class="muted">No notes uploaded yet.</td></tr>';
            } catch (e) { notesTbody.innerHTML = '<tr><td colspan="4" class="muted">Load failed</td></tr>'; }
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            uploadStatus.textContent = 'Uploading...';
            const fd = new FormData(e.target);
            // If a class is selected, override with hidden academic fields
            if (selectedClassId) {
                fd.set('college_id', hidden.college.value || '');
                if (hidden.degree.value) fd.set('degree_id', hidden.degree.value);
                if (hidden.department.value) fd.set('department_id', hidden.department.value);
                if (hidden.batch.value) fd.set('batch_id', hidden.batch.value);
                if (hidden.semester.value) fd.set('semester', hidden.semester.value);
            }
            // Always align subject metadata with the cached selection
            const subjectOption = subjectSelect && subjectSelect.selectedIndex >= 0 ? subjectSelect.options[subjectSelect.selectedIndex] : undefined;
            const subjectSelectValue = subjectSelect ? subjectSelect.value : '';
            const subjectIdRaw = hidden.subject_id.value || subjectSelectValue || '';
            const subjectLabelRaw = hidden.subject.value || (subjectOption ? subjectOption.textContent : '');
            const subjectIdTrimmed = subjectIdRaw ? String(subjectIdRaw).trim() : '';
            const subjectLabelRawTrimmed = subjectLabelRaw ? subjectLabelRaw.trim() : '';
            const subjectLabel = (!subjectLabelRawTrimmed || subjectLabelRawTrimmed === '--') ? '' : subjectLabelRawTrimmed;
            const subjectId = (subjectIdTrimmed && subjectIdTrimmed.toLowerCase() !== 'undefined' && subjectIdTrimmed.toLowerCase() !== 'null') ? subjectIdTrimmed : '';
            fd.delete('subject');
            fd.delete('subject_id');
            if (subjectLabel) fd.set('subject', subjectLabel);
            if (subjectId) {
                fd.set('subject_id', subjectId);
                fd.set('subject_href', `/api/syllabus/courses/${subjectId}`);
            } else {
                fd.delete('subject_href');
            }
            console.log('[TeacherNotes] Preparing upload', {
                selectedClassId,
                hiddenSubjectId: hidden.subject_id.value,
                hiddenSubjectLabel: hidden.subject.value,
                subjectSelectValue,
                subjectId,
                subjectLabel,
                subjectHref: subjectId ? `/api/syllabus/courses/${subjectId}` : '',
            });
            if (!subjectId) {
                console.warn('[TeacherNotes] No subject ID resolved for submission', {
                    selectedClassId,
                    hiddenSubjectId: hidden.subject_id.value,
                    hiddenSubjectLabel: hidden.subject.value,
                    subjectSelectValue,
                    subjectLabel,
                });
            }
            try {
                const debugEntries = Array.from(fd.entries()).map(([key, value]) => [key, value instanceof File ? value.name : value]);
                console.log('[TeacherNotes] FormData entries', debugEntries);
            } catch (debugErr) {
                console.warn('[TeacherNotes] Failed to inspect FormData entries', debugErr);
            }
            // If a document file is present, upload to Supabase Storage first
            const file = fd.get('file');
            if (file instanceof File && file.size > 0) {
                try {
                    uploadStatus.textContent = 'Uploading to cloud storage...';
                    const up = await uploadToSupabase(file, { originalName: file.name });
                    // Include canonical URL for backend to persist in DB
                    fd.set('stored_path', up.publicUrl);
                    fd.set('url', up.publicUrl);
                    fd.set('original_filename', file.name);
                    fd.set('mime_type', file.type || 'application/octet-stream');
                    fd.set('file_size', String(file.size));
                    // Prevent backend from storing locally
                    fd.delete('file');
                    fd.delete('files');
                } catch (cloudErr) {
                    console.error('[TeacherNotes] Cloud upload failed', cloudErr);
                    uploadStatus.textContent = 'Cloud upload failed: ' + (cloudErr.message || cloudErr.error_description || '');
                    return;
                }
            }
            // convert to marketplace payload fields
            fd.append('price_cents', '0');
            try {
                const res = await fetch(API_BASE + '/api/marketplace/notes', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token }, body: fd });
                const data = await res.json();
                console.log('[TeacherNotes] Upload response', { status: res.status, ok: res.ok, body: data });
                if (!res.ok) throw new Error(data.detail || 'Upload failed');
                uploadStatus.textContent = 'Uploaded';
                e.target.reset();
                loadMyNotes();
            } catch (err) {
                console.error('[TeacherNotes] Upload failed', err);
                uploadStatus.textContent = 'Error: ' + err.message;
            }
        });
        // populate semester options (1..12)
        const semSel = document.getElementById('semesterSelect'); for (let i = 1; i <= 12; i++) { const o = document.createElement('option'); o.value = String(i); o.textContent = String(i); semSel.appendChild(o); }
        // change listeners to keep dependent dropdowns in sync
        document.addEventListener('change', (e) => {
            if (e.target === departmentSelect) {
                // departments -> batches -> subjects
                // subjects will be refreshed inside populateBatches
                // no-op here
            }
            if (e.target === batchSelect || e.target === semSel) {
                populateSubjects();
            }
        });
        function renderClasses() {
            const wrap = document.getElementById('classesList');
            const noMsg = document.getElementById('noClassesMsg');
            wrap.innerHTML = '';
            if (!classCache.length) { noMsg.classList.remove('hidden'); return; }
            noMsg.classList.add('hidden');
            classCache.forEach(c => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left p-3 rounded-xl ring-1 ring-black/5 dark:ring-white/10 bg-white/70 dark:bg-white/5 hover:bg-white dark:hover:bg-white/10 transition flex flex-col gap-1';
                btn.dataset.classId = c.id;
                btn.innerHTML = `<span class='text-[11px] font-medium uppercase tracking-wide text-neutral-500 dark:text-white/40'>Sem ${c.semester || '-'}${c.section ? ' • Sec ' + c.section : ''}</span><span class='text-sm font-semibold line-clamp-2'>${(c.subject || 'Untitled')}</span><span class='text-[10px] text-neutral-500 dark:text-white/40'>${c.batch_range || ''}</span>`;
                btn.addEventListener('click', () => selectClass(c.id));
                wrap.appendChild(btn);
            });
        }
        function selectClass(id) {
            selectedClassId = id; const cls = classCache.find(c => c.id === id);
            document.querySelectorAll('#classesList button').forEach(b => { if (b.dataset.classId === id) { b.classList.add('ring-brand-500', 'bg-brand-500/10'); } else { b.classList.remove('ring-brand-500', 'bg-brand-500/10'); } });
            if (!cls) return;
            // Fill hidden fields
            hidden.college.value = cls.college_id || '';
            hidden.degree.value = cls.degree_id || '';
            hidden.department.value = cls.department_id || '';
            hidden.batch.value = cls.batch_id || '';
            hidden.semester.value = cls.semester || '';
            hidden.subject.value = cls.subject || '';
            hidden.subject_id.value = cls.subject_id || '';
            console.log('[TeacherNotes] Class selected', {
                classId: id,
                subjectId: hidden.subject_id.value,
                subjectLabel: hidden.subject.value,
                collegeId: hidden.college.value,
                degreeId: hidden.degree.value,
                departmentId: hidden.department.value,
                batchId: hidden.batch.value,
                semester: hidden.semester.value,
            });
            // Clear manual selects for clarity (optional)
            collegeSelect.value = ''; degreeSelect.value = ''; departmentSelect.value = ''; batchSelect.value = ''; document.getElementById('semesterSelect').value = ''; subjectSelect.value = '';
            // Show selected class summary
            const info = document.getElementById('selectedClassInfo');
            if (info) {
                const parts = [];
                if (cls.subject) parts.push(cls.subject);
                if (cls.semester) parts.push('Sem ' + cls.semester);
                if (cls.section) parts.push('Sec ' + cls.section);
                info.textContent = parts.length ? ('Selected: ' + parts.join(' • ')) : 'Selected class';
            }
        }
        async function loadClasses() {
            try {
                const d = await fetchJSON(API_BASE + '/api/teacher/profile/me?strict=1', { headers: { 'Authorization': 'Bearer ' + token } });
                const payload = d.teacher ? d : { teacher: d.teacher, classes: d.classes };
                classCache = (d.classes || []).sort((a, b) => (a.semester || 0) - (b.semester || 0));
                console.log('[TeacherNotes] Classes loaded', classCache);
                renderClasses();
            } catch (e) { console.warn('classes load failed', e); }
        }
        // Manual mode toggle
        const toggleBtn = document.getElementById('toggleManualBtn');
        toggleBtn.addEventListener('click', () => {
            const manual = document.getElementById('manualFields');
            if (manual.classList.contains('hidden')) { manual.classList.remove('hidden'); toggleBtn.textContent = 'Class Mode'; }
            else { manual.classList.add('hidden'); toggleBtn.textContent = 'Manual Mode'; }
        });
        loadClasses();
        loadMeta();
        loadMyNotes();
        document.addEventListener('click', (e) => { if (e.target.matches('[data-theme-toggle]')) { const root = document.documentElement; const dark = root.classList.toggle('dark'); localStorage.setItem('px_theme', dark ? 'dark' : 'light'); } });
    </script>
</body>

</html>
