<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TuNe X — Collaboration</title>
  <meta name="description" content="Collaborate on an accepted project: chat, quick links, and coordination." />
  <link rel="stylesheet" href="assets/css/tailwind.css" />
  <script>
    tailwind.config = { darkMode: 'class', theme: { container: { center: true, padding: '1rem' }, extend: { fontFamily: { display: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Ubuntu', 'Cantarell', 'Noto Sans', 'sans-serif'] }, colors: { brand: { 50: '#eef4ff', 100: '#d9e6ff', 200: '#b3ccff', 300: '#88adff', 400: '#628fff', 500: '#3f6fff', 600: '#2f56e6', 700: '#2846bb', 800: '#223a95', 900: '#1c2f78' }, ink: { 50: '#f7f7f9', 900: '#0c0f14' } }, boxShadow: { 'brand-lg': '0 10px 30px rgba(63,111,255,.25)', 'soft': '0 6px 20px rgba(0,0,0,.08)' }, borderRadius: { '3xl': '1.5rem' } } } }
  </script>
  <script>
    const initTheme = () => { const stored = localStorage.getItem('cx-theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; if ((stored === 'dark') || (!stored && prefersDark)) document.documentElement.classList.add('dark'); }; initTheme();
    const toggleTheme = () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('cx-theme', isDark ? 'dark' : 'light'); };
  </script>
  <script src="config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600&display=swap"
    rel="stylesheet">
  <style>
    .icon {
      font-family: 'Material Symbols Outlined';
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
    }

    .lift {
      transition: transform .25s ease, box-shadow .25s ease
    }

    .bubble {
      max-width: 80%;
      padding: .5rem .75rem;
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, .08)
    }

    .mine {
      margin-left: auto;
      background: linear-gradient(135deg, #3f6fff, #628fff);
      color: white;
      border-color: transparent;
      box-shadow: 0 8px 24px rgba(63, 111, 255, .25)
    }

    .theirs {
      background: rgba(255, 255, 255, .8)
    }

    .dark .theirs {
      background: rgba(255, 255, 255, .08);
      border-color: rgba(255, 255, 255, .12)
    }

    .msglist {
      scroll-behavior: smooth
    }
  </style>
</head>

<body class="bg-ink-50 dark:bg-[#0a0d12] text-[#0d1117] dark:text-zinc-100">
  <header
    class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-black/30 border-b border-black/5 dark:border-white/10">
    <nav class="container flex items-center gap-3 py-3">
      <a href="index.html" class="flex items-center gap-2 font-semibold tracking-tight">
        <span
          class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-brand-600 text-white shadow-brand-lg">CX</span>
        <span class="hidden sm:inline">TuNe X</span>
      </a>
      <div class="ml-auto hidden md:flex items-center gap-6 text-sm">
        <a href="profile.html" class="hover:text-brand-600 dark:hover:text-brand-300">Profile</a>
        <a href="project_post.html" class="hover:text-brand-600 dark:hover:text-brand-300">Create Project</a>
        <a id="navProfile" href="profile.html" title="Profile"
          class="hidden inline-flex items-center justify-center w-9 h-9 rounded-full overflow-hidden border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/60">
          <img id="navProfileImg" alt="Profile" class="w-full h-full object-cover hidden" />
          <span id="navProfileInitial" class="text-xs font-semibold">Me</span>
        </a>
        <button onclick="toggleTheme()" class="rounded-xl border border-black/10 dark:border-white/10 px-3 py-2"><span
            class="icon">dark_mode</span></button>
        <div class="relative" id="navProjectsWrap">
          <button type="button" id="navProjectsBtn"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 transition">
            <span class="icon text-base leading-none">hub</span>
            <span>Project Portal</span>
            <span class="icon text-base leading-none">expand_more</span>
          </button>
          <div id="navProjectsMenu"
            class="absolute right-0 mt-2 w-60 rounded-xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-zinc-900/95 shadow-lg backdrop-blur hidden">
            <a href="postings.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 rounded-t-xl"><span
                class="icon text-base leading-none">folder_open</span>Project Postings</a>
            <a href="project_post.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">add_circle</span>Create Project</a>
            <a href="incoming_requests.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">inbox</span>Incoming Requests</a>
            <a href="my_applications.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">assignment_ind</span>My Applications</a>
            <a href="skill-test.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 rounded-b-xl"><span
                class="icon text-base leading-none">verified</span>Skill Test Portal</a>
          </div>
        </div>
        <a href="login.html" class="hover:text-brand-600 dark:hover:text-brand-300" id="signInLink">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="container py-8 md:py-12">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Collaboration</h1>
        <p class="text-sm opacity-70">Chat with your teammate after acceptance.</p>
      </div>
      <div class="text-sm">
        <a id="projectLink" class="text-brand-600 hover:underline" href="#">Open Project</a>
      </div>
    </div>

    <div id="status" class="text-sm mb-3"></div>

    <section class="grid lg:grid-cols-[1fr,320px] gap-4">
      <div
        class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/70 p-4 flex flex-col min-h-[60vh]">
        <div id="msgs" class="msglist flex-1 overflow-auto space-y-3 pr-2"></div>
        <form id="sendForm" class="mt-3 flex items-end gap-2">
          <textarea id="msgInput"
            class="flex-1 rounded-xl border border-black/10 dark:border-white/10 bg-white/90 dark:bg-zinc-900/60 p-3"
            rows="2" placeholder="Write a message…"></textarea>
          <button id="sendBtn" type="submit"
            class="inline-flex items-center gap-2 rounded-xl bg-brand-600 text-white px-4 py-2 shadow-brand-lg"><span
              class="icon">send</span>Send</button>
        </form>
      </div>
      <aside
        class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/70 p-4 space-y-3">
        <h3 class="font-semibold flex items-center gap-2"><span class="icon">info</span> Details</h3>
        <div id="appMeta" class="text-sm opacity-80">—</div>
        <div class="h-px bg-black/10 dark:bg-white/10"></div>
        <div class="space-y-2">
          <a id="profileApplicant" href="#" class="inline-flex items-center gap-2 text-sm text-brand-600"><span
              class="icon">person</span>Applicant Profile</a><br />
          <a id="profileOwner" href="#" class="inline-flex items-center gap-2 text-sm text-brand-600"><span
              class="icon">workspace_premium</span>Owner Profile</a>
        </div>
      </aside>
    </section>
  </main>

  <script>
    const API = ((window.API_BASE || window.__API_BASE || 'https://paperxapp.onrender.com')).replace(/\/$/, '');
    const token = localStorage.getItem('px_token');
    if (!token) { window.location.href = 'login.html'; }
    const qs = new URLSearchParams(location.search);
    const applicationId = qs.get('application_id');
    if (!applicationId) { document.getElementById('status').textContent = 'Missing application_id'; }

    const el = (id) => document.getElementById(id);
    const statusEl = el('status');
    const msgsEl = el('msgs');
    const form = el('sendForm');
    const input = el('msgInput');
    const sendBtn = el('sendBtn');

    const esc = (s) => (s ?? '').toString().replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));

    let appRow = null; let me = null;

    async function loadApp() {
      statusEl.textContent = 'Loading…';
      try {
        const [meRes, appRes] = await Promise.all([
          fetch(`${API}/api/profile`, { headers: { Authorization: `Bearer ${token}` } }),
          fetch(`${API}/api/applications/${encodeURIComponent(applicationId)}`, { headers: { Authorization: `Bearer ${token}` } }),
        ]);
        me = meRes.ok ? await meRes.json() : null;
        const appData = appRes.ok ? await appRes.json() : null;
        if (!appRes.ok) throw new Error((appData && appData.detail) || 'Failed to load application');
        appRow = appData;
        if (String((appRow.status || '')).toLowerCase() !== 'accepted') {
          statusEl.textContent = 'This application is not accepted yet. Collaboration opens after acceptance.'; return;
        }
        el('projectLink').href = `project.html?id=${encodeURIComponent(appRow.project_id)}`;
        el('appMeta').textContent = `Status: ${appRow.status} • Applied: ${String(appRow.created_at || '').replace('T', ' ').replace('Z', '')}`;
        el('profileApplicant').href = `public_profile.html?user_id=${encodeURIComponent(appRow.applicant_user_id)}`;
        // Fetch owner user id for link
        try {
          const p = await fetch(`${API}/api/projects/${encodeURIComponent(appRow.project_id)}`).then(r => r.json());
          if (p && p.user_id) { el('profileOwner').href = `public_profile.html?user_id=${encodeURIComponent(p.user_id)}`; }
        } catch (_) { }
        await loadMessages();
        statusEl.textContent = '';
      } catch (e) { statusEl.textContent = e.message || 'Failed to load.'; }
    }

    async function loadMessages() {
      try {
        const r = await fetch(`${API}/api/collab/${encodeURIComponent(applicationId)}/messages`, { headers: { Authorization: `Bearer ${token}` } });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.detail || 'Failed to load messages');
        const list = Array.isArray(j.messages) ? j.messages : [];
        renderMessages(list);
      } catch (e) { statusEl.textContent = e.message || 'Failed to load messages'; }
    }

    function renderMessages(list) {
      const myId = me && me.user_id;
      msgsEl.innerHTML = list.map(m => {
        const mine = m.sender_user_id === myId;
        const cls = mine ? 'bubble mine' : 'bubble theirs';
        const when = String(m.created_at || '').replace('T', ' ').replace('Z', '');
        return `<div class="${cls}">
          <div class="text-xs opacity-70 mb-0.5">${when}</div>
          <div class="text-sm whitespace-pre-wrap">${esc(m.content || '')}</div>
        </div>`;
      }).join('');
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = (input.value || '').trim();
      if (!text) return;
      sendBtn.disabled = true; input.disabled = true;
      try {
        const r = await fetch(`${API}/api/collab/${encodeURIComponent(applicationId)}/messages`, {
          method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ content: text })
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.detail || 'Failed to send');
        input.value = '';
        await loadMessages();
      } catch (e) { alert(e.message || 'Failed to send'); }
      finally { sendBtn.disabled = false; input.disabled = false; input.focus(); }
    });

    // Basic polling for new messages
    let pollTimer = null;
    function startPolling() {
      stopPolling();
      pollTimer = setInterval(loadMessages, 5000);
    }
    function stopPolling() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }
    window.addEventListener('focus', startPolling);
    window.addEventListener('blur', stopPolling);

    // Auth-aware navbar avatar
    (function () {
      const token = localStorage.getItem('px_token');
      if (!token) return;
      document.getElementById('signInLink')?.classList.add('hidden');
      const navProfile = document.getElementById('navProfile');
      const navProfileImg = document.getElementById('navProfileImg');
      const navProfileInitial = document.getElementById('navProfileInitial');
      if (navProfile) navProfile.classList.remove('hidden');
      const API = ((window.API_BASE || window.__API_BASE || 'https://paperxapp.onrender.com')).replace(/\/$/, '');
      fetch(`${API}/api/profile`, { headers: { Authorization: `Bearer ${token}` } })
        .then(r => r.ok ? r.json() : null)
        .then(p => {
          if (!p) return;
          let initials = 'ME';
          if (p.name) initials = p.name.split(' ').filter(Boolean).map(s => s[0]?.toUpperCase()).slice(0, 2).join('');
          if (navProfileInitial) navProfileInitial.textContent = initials;
          if (p.profile_image_url) {
            if (navProfileImg) { navProfileImg.src = p.profile_image_url; navProfileImg.classList.remove('hidden'); if (navProfileInitial) navProfileInitial.classList.add('hidden'); }
          }
        }).catch(() => { });
    })();

    loadApp().then(startPolling);
  </script>
</body>

</html>