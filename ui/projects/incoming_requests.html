<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TuNe X — Incoming Requests</title>
  <meta name="description" content="Review incoming requests from applicants across your projects." />
  <link rel="stylesheet" href="../assets/css/tailwind.css" />
  <script>
    tailwind.config = { darkMode: 'class', theme: { container: { center: true, padding: '1rem' }, extend: { fontFamily: { display: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Ubuntu', 'Cantarell', 'Noto Sans', 'sans-serif'] }, colors: { brand: { 50: '#eef4ff', 100: '#d9e6ff', 200: '#b3ccff', 300: '#88adff', 400: '#628fff', 500: '#3f6fff', 600: '#2f56e6', 700: '#2846bb', 800: '#223a95', 900: '#1c2f78' }, ink: { 50: '#f7f7f9', 900: '#0c0f14' } }, boxShadow: { 'brand-lg': '0 10px 30px rgba(63,111,255,.25)', 'soft': '0 6px 20px rgba(0,0,0,.08)' }, borderRadius: { '3xl': '1.5rem' } } } }
  </script>
  <script>
    const initTheme = () => { const stored = localStorage.getItem('cx-theme'); const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches; if ((stored === 'dark') || (!stored && prefersDark)) document.documentElement.classList.add('dark'); }; initTheme();
    const toggleTheme = () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('cx-theme', isDark ? 'dark' : 'light'); };
  </script>
  <script src="config.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600&display=swap"
    rel="stylesheet">
  <style>
    .icon {
      font-family: 'Material Symbols Outlined';
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
    }

    .lift {
      transition: transform .25s ease, box-shadow .25s ease
    }

    .lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 30px rgba(0, 0, 0, .12)
    }
  </style>
</head>

<body class="bg-ink-50 dark:bg-[#0a0d12] text-[#0d1117] dark:text-zinc-100">
  <header
    class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-black/30 border-b border-black/5 dark:border-white/10">
    <nav class="container flex items-center gap-3 py-3">
      <a href="index.html" class="flex items-center gap-2 font-semibold tracking-tight">
        <span
          class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-brand-600 text-white shadow-brand-lg">CX</span>
        <span class="hidden sm:inline">TuNe X</span>
      </a>
      <div class="ml-auto hidden md:flex items-center gap-6 text-sm">
        <a href="profile.html" class="hover:text-brand-600 dark:hover:text-brand-300">Profile</a>
        <a href="project_post.html" class="hover:text-brand-600 dark:hover:text-brand-300">Create Project</a>
        <!-- Profile avatar (shown when logged in) -->
        <a id="navProfile" href="profile.html" title="Profile"
          class="hidden inline-flex items-center justify-center w-9 h-9 rounded-full overflow-hidden border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/60">
          <img id="navProfileImg" alt="Profile" class="w-full h-full object-cover hidden" />
          <span id="navProfileInitial" class="text-xs font-semibold">Me</span>
        </a>
        <button onclick="toggleTheme()" class="rounded-xl border border-black/10 dark:border-white/10 px-3 py-2"><span
            class="icon">dark_mode</span></button>
        <div class="relative" id="navProjectsWrap">
          <button type="button" id="navProjectsBtn"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 transition">
            <span class="icon text-base leading-none">hub</span>
            <span>Project Portal</span>
            <span class="icon text-base leading-none">expand_more</span>
          </button>
          <div id="navProjectsMenu"
            class="absolute right-0 mt-2 w-60 rounded-xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-zinc-900/95 shadow-lg backdrop-blur hidden">
            <a href="postings.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 rounded-t-xl"><span
                class="icon text-base leading-none">folder_open</span>Project Postings</a>
            <a href="project_post.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">add_circle</span>Create Project</a>
            <a href="incoming_requests.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">inbox</span>Incoming Requests</a>
            <a href="my_applications.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10"><span
                class="icon text-base leading-none">assignment_ind</span>My Applications</a>
            <a href="skill-test.html"
              class="flex items-center gap-2 px-4 py-2 text-sm hover:bg-black/5 dark:hover:bg-white/10 rounded-b-xl"><span
                class="icon text-base leading-none">verified</span>Skill Test Portal</a>
          </div>
        </div>
        <a href="../login.html" class="hover:text-brand-600 dark:hover:text-brand-300" id="signInLink">Sign in</a>
      </div>
    </nav>
  </header>

  <main class="container py-10 md:py-14 space-y-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Incoming Requests</h1>
      <a class="text-sm text-brand-600 hover:underline" href="profile.html">Back to Profile</a>
    </div>

    <div id="status" class="text-sm"></div>

    <section id="cards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></section>
  </main>

  <script>
    const API = ((window.API_BASE || window.__API_BASE || 'http://127.0.0.1:8000')).replace(/\/$/, '');
    const token = localStorage.getItem('px_token');
    if (!token) { window.location.href = '../login.html'; }

    const el = (id) => document.getElementById(id);
    const status = el('status');
    const cards = el('cards');

    const esc = (s) => (s ?? '').toString().replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]));

    const fetchIncoming = async () => {
      status.textContent = 'Loading requests…';
      try {
        const res = await fetch(`${API}/api/applications/incoming`, { headers: { Authorization: `Bearer ${token}` } });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(payload.detail || 'Failed to load');
        const apps = Array.isArray(payload.applications) ? payload.applications : [];
        const projects = Array.isArray(payload.projects) ? payload.projects : [];
        if (apps.length === 0) {
          cards.innerHTML = '<div class="rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-zinc-900/70 p-6">No incoming requests yet.</div>';
          status.textContent = '';
          return;
        }
        const projMap = {}; (projects || []).forEach(p => { if (p?.id) projMap[p.id] = p; });
        // Fetch unique applicant profiles
        const uniqueIds = [...new Set(apps.map(a => a.applicant_user_id).filter(Boolean))];
        const profileMap = {};
        const profs = await Promise.all(uniqueIds.map(uid => fetch(`${API}/api/public/profiles/${encodeURIComponent(uid)}`).then(x => x.json()).catch(() => ({ user_id: uid }))));
        profs.forEach(p => { if (p?.user_id) profileMap[p.user_id] = p; });

        cards.innerHTML = apps.map(r => {
          const p = profileMap[r.applicant_user_id] || { user_id: r.applicant_user_id };
          const name = esc(p.name || 'Anonymous');
          const headline = esc(p.headline || '');
          const image = p.profile_image_url ? `<img src="${esc(p.profile_image_url)}" class="w-12 h-12 rounded-full object-cover" alt="avatar"/>` : `<div class="w-12 h-12 rounded-full bg-black/10 dark:bg:white/10 flex items-center justify-center">${name.charAt(0) || '?'}</div>`;
          const proj = projMap[r.project_id] || { id: r.project_id, title: 'Project' };
          const appId = r.id;
          const profileHref = `public_profile.html?user_id=${encodeURIComponent(r.applicant_user_id)}&project_id=${encodeURIComponent(r.project_id)}&application_id=${encodeURIComponent(appId)}`;
          const st = String(r.status || '').toLowerCase();
          const isPending = (st === 'pending');
          const isAccepted = (st === 'accepted');
          const actions = isPending ? `
            <div id="actions-${appId}" data-profile-href="${esc(profileHref)}" class="flex items-center justify-end gap-2 text-sm">
              <button class="rounded-lg px-3 py-1.5 border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg:white/10" onclick="updateAppStatus('${esc(r.project_id)}','${esc(appId)}','accepted')"><span class="icon text-sm">check</span> Accept</button>
              <button class="rounded-lg px-3 py-1.5 border border-black/10 dark:border-white/10 hover:bg-black/5 dark:hover:bg:white/10" onclick="updateAppStatus('${esc(r.project_id)}','${esc(appId)}','rejected')"><span class="icon text-sm">close</span> Reject</button>
              <a class="inline-flex items-center gap-1 text-brand-600" href="${profileHref}"><span class="icon text-sm">open_in_new</span>View Profile</a>
            </div>` : (isAccepted ? `
            <div id="actions-${appId}" data-profile-href="${esc(profileHref)}" class="flex items-center justify-end gap-2 text-sm">
              <a class="rounded-lg px-3 py-1.5 bg-brand-600 text-white shadow-brand-lg hover:brightness-110" href="collab.html?application_id=${encodeURIComponent(appId)}"><span class="icon text-sm">forum</span> Open Collaboration</a>
              <a class="inline-flex items-center gap-1 text-brand-600" href="${profileHref}"><span class="icon text-sm">open_in_new</span>View Profile</a>
            </div>` : `
            <div id="actions-${appId}" data-profile-href="${esc(profileHref)}" class="flex items-center justify-end gap-2 text-sm">
              <a class="inline-flex items-center gap-1 text-brand-600" href="${profileHref}"><span class="icon text-sm">open_in_new</span>View Profile</a>
            </div>`);
          return `
          <article class="lift rounded-2xl border border-black/10 dark:border-white/10 bg-white/80 dark:bg-zinc-900/70 p-5 space-y-3">
            <div class="flex items-center gap-3">
              ${image}
              <div class="min-w-0">
                <a class="font-semibold leading-tight truncate text-brand-700 dark:text-brand-300 hover:underline" href="${profileHref}">${name}</a>
                <div class="text-xs opacity-70 truncate">${headline}</div>
              </div>
            </div>
            ${r.message ? `<p class="text-sm opacity-80">${esc(r.message)}</p>` : ''}
            <div class="flex items-center justify-between text-xs opacity-70">
              <a class="inline-flex items-center gap-1 text-brand-600" href="project.html?id=${encodeURIComponent(r.project_id)}"><span class="icon text-sm">work</span>${esc(proj.title || 'Project')}</a>
              <span id="status-${appId}">Status: ${esc(r.status || 'pending')}</span>
            </div>
            ${actions}
          </article>`;
        }).join('');
        status.textContent = '';
      } catch (e) {
        status.textContent = e.message || 'Failed to load requests.';
      }
    };

    async function updateAppStatus(projectId, appId, newStatus) {
      try {
        const res = await fetch(`${API}/api/projects/${projectId}/applications/${appId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ status: newStatus }) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Failed to update');
        const updatedStatus = String(data?.application?.status || newStatus).toLowerCase();
        const span = document.getElementById(`status-${appId}`);
        if (span) span.textContent = `Status: ${data?.application?.status || newStatus}`;
        const wrap = document.getElementById(`actions-${appId}`);
        if (wrap) {
          const profileHref = wrap.getAttribute('data-profile-href') || '#';
          if (updatedStatus === 'accepted') {
            wrap.innerHTML = `
              <a class="rounded-lg px-3 py-1.5 bg-brand-600 text-white shadow-brand-lg hover:brightness-110" href="collab.html?application_id=${encodeURIComponent(appId)}"><span class="icon text-sm">forum</span> Open Collaboration</a>
              <a class="inline-flex items-center gap-1 text-brand-600" href="${profileHref}"><span class="icon text-sm">open_in_new</span>View Profile</a>
            `;
          } else {
            wrap.innerHTML = `
              <a class="inline-flex items-center gap-1 text-brand-600" href="${profileHref}"><span class="icon text-sm">open_in_new</span>View Profile</a>
            `;
          }
        }
      } catch (e) {
        alert(e.message || 'Could not update request');
      }
    }

    // Auth-aware navbar avatar
    (function () {
      const token = localStorage.getItem('px_token');
      if (!token) return;
      document.getElementById('signInLink')?.classList.add('hidden');
      const navProfile = document.getElementById('navProfile');
      const navProfileImg = document.getElementById('navProfileImg');
      const navProfileInitial = document.getElementById('navProfileInitial');
      if (navProfile) navProfile.classList.remove('hidden');
      const API = ((window.API_BASE || window.__API_BASE || 'http://127.0.0.1:8000')).replace(/\/$/, '');
      fetch(`${API}/api/profile`, { headers: { Authorization: `Bearer ${token}` } })
        .then(r => r.ok ? r.json() : null)
        .then(p => {
          if (!p) return;
          let initials = 'ME';
          if (p.name) initials = p.name.split(' ').filter(Boolean).map(s => s[0]?.toUpperCase()).slice(0, 2).join('');
          if (navProfileInitial) navProfileInitial.textContent = initials;
          if (p.profile_image_url) {
            if (navProfileImg) { navProfileImg.src = p.profile_image_url; navProfileImg.classList.remove('hidden'); if (navProfileInitial) navProfileInitial.classList.add('hidden'); }
          }
        }).catch(() => { });
    })();

    fetchIncoming();
  </script>
</body>

</html>