<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Allowed Domains</title>
    <link rel="icon" type="image/x-icon" href="./assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/tailwind.css" />
    <script>
        (() => {
            const s = localStorage.getItem('px_theme');
            const p = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const d = s ? s === 'dark' : p;
            if (d) document.documentElement.classList.add('dark');
        })();
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px
        }

        .gradient-hero-text {
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC)
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }
    </style>
    <script src="./config.js"></script>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
        <div class="container mx-auto px-4 flex items-center justify-between py-4">
            <a href="./index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="./assets/img/logo-light.svg" class="h-10 w-auto dark:hidden" alt="Paper X" />
                <img src="./assets/img/logo-dark.svg" class="h-10 w-auto hidden dark:block" alt="Paper X" />
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="./index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="./about.html">About</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="./contact.html">Contact</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="#"><span>Admin</span><span
                        class="material-symbols-rounded text-base">admin_panel_settings</span></a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme"><span class="material-symbols-rounded">dark_mode</span><span
                        class="hidden sm:block">Theme</span></button>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"><span
                        class="material-symbols-rounded">dark_mode</span></button>
            </div>
        </div>
    </header>

    <main>
        <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10">
            <div aria-hidden="true" class="absolute inset-0">
                <div class="absolute -top-36 right-10 h-80 w-80 rounded-full bg-brand-500/20 blur-3xl"></div>
                <div class="absolute bottom-[-8rem] left-10 h-72 w-72 rounded-full bg-brand-700/25 blur-3xl"></div>
            </div>
            <div class="relative container mx-auto max-w-6xl px-4 py-10">
                <div class="flex flex-col gap-3">
                    <h1 class="text-2xl md:text-4xl font-bold gradient-hero-text">Allowed Domains</h1>
                    <p class="text-neutral-600 dark:text-white/65">Manage degree-specific source domains for the Notes
                        generator. Searches prefer these sites with automatic fallback to the web.</p>
                </div>
            </div>
        </section>

        <section class="relative">
            <div class="container mx-auto max-w-6xl px-4 py-8">
                <div id="apiBanner" class="hidden mb-4">
                    <div
                        class="flex items-start gap-3 rounded-2xl border border-amber-300/60 bg-amber-50 text-amber-900 dark:bg-amber-500/10 dark:text-amber-200 px-4 py-3 text-sm">
                        <span class="material-symbols-rounded">warning</span>
                        <div>
                            <div class="font-semibold">API not reachable</div>
                            <div>We couldn't reach <span id="apiBaseTxt"></span>. Ensure your backend is running and
                                API_BASE is set correctly in localStorage.</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Editor Card -->
                    <div
                        class="lg:col-span-2 rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur p-6 shadow-soft">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <h2 class="text-lg font-semibold">Edit degree</h2>
                                <p id="status" class="text-sm text-neutral-600 dark:text-white/65">Load or create a
                                    degree, then add allowed domains.</p>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <label class="md:col-span-1 text-sm font-medium text-neutral-700 dark:text-white/85">Select
                                existing</label>
                            <div class="md:col-span-2">
                                <select id="degreeSelect"
                                    class="w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"></select>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <label class="md:col-span-1 text-sm font-medium text-neutral-700 dark:text-white/85">Degree
                                label</label>
                            <div class="md:col-span-2">
                                <input id="degreeInput" type="text" placeholder="e.g., B.Tech, M.Tech, MBBS"
                                    class="w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40" />
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
                            <label class="md:col-span-1 text-sm font-medium text-neutral-700 dark:text-white/85">Add
                                domain</label>
                            <div class="md:col-span-2 flex gap-2">
                                <input id="domainInput" type="text"
                                    placeholder="e.g., geeksforgeeks.org or https://geeksforgeeks.org"
                                    class="flex-1 rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40" />
                                <button id="addBtn" type="button"
                                    class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-4 py-2.5 text-sm font-semibold text-white shadow-[0_10px_28px_rgba(158,75,138,0.35)] hover:shadow-[0_14px_34px_rgba(158,75,138,0.45)] transition"><span
                                        class="material-symbols-rounded text-base">add</span>Add</button>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div id="domainsList" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="mt-6 flex justify-end gap-3">
                            <button id="exportBtn" type="button"
                                class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/10 px-4 py-2 text-sm font-medium hover:border-brand-500/50 transition"><span
                                    class="material-symbols-rounded text-base">ios_share</span>Export JSON</button>
                            <input id="importFile" type="file" accept="application/json" class="hidden" />
                            <button id="importBtn" type="button"
                                class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/10 px-4 py-2 text-sm font-medium hover:border-brand-500/50 transition"><span
                                    class="material-symbols-rounded text-base">file_upload</span>Import JSON</button>
                            <button id="saveBtn" type="button"
                                class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition"><span
                                    class="material-symbols-rounded text-base">save</span>Save</button>
                        </div>
                    </div>

                    <!-- Table Card -->
                    <div
                        class="rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur p-6 shadow-soft">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold">Configured degrees</h2>
                        </div>
                        <div class="mt-4 rounded-2xl border border-black/5 dark:border-white/10 overflow-hidden">
                            <div class="max-h-[360px] overflow-auto">
                                <table class="min-w-full text-sm">
                                    <thead class="bg-black/5 dark:bg-white/5 text-neutral-700 dark:text-white/80">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Degree</th>
                                            <th class="px-4 py-2 text-left">Domains</th>
                                            <th class="px-4 py-2 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="degTable" class="divide-y divide-black/5 dark:divide-white/10"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast -->
    <div id="toast" class="fixed right-4 bottom-4 z-50 hidden">
        <div
            class="flex items-center gap-2 rounded-2xl border border-black/10 dark:border-white/10 bg-white/90 dark:bg-brand-900/90 px-4 py-2 text-sm shadow-soft">
            <span class="material-symbols-rounded text-base" id="toastIcon">info</span>
            <span id="toastMsg">Saved</span>
        </div>
    </div>

    <script>
        // Theme control
        const root = document.documentElement;
        function updateThemeIcon() {
            document.querySelectorAll('[data-theme-toggle] .material-symbols-rounded').forEach(ic => {
                ic.textContent = root.classList.contains('dark') ? 'light_mode' : 'dark_mode';
            });
        }
        function setTheme(mode) {
            if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            localStorage.setItem('px_theme', mode); updateThemeIcon();
        }
        document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; const next = root.classList.contains('dark') ? 'light' : 'dark'; setTheme(next); });
        updateThemeIcon();

        // Tiny toast helper
        function showToast(msg, icon = 'check_circle') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastIcon').textContent = icon;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2000);
        }
    </script>

    <script>
        (function () {
            const API = (window.__API_BASE || window.API_BASE || ((typeof location !== 'undefined' && location.origin) ? location.origin : 'https://paperxapp.onrender.com')).replace(/\/$/, '');
            const sel = id => document.getElementById(id);
            const degreeSelect = sel('degreeSelect');
            const degreeInput = sel('degreeInput');
            const domainInput = sel('domainInput');
            const addBtn = sel('addBtn');
            const saveBtn = sel('saveBtn');
            const exportBtn = sel('exportBtn');
            const importBtn = sel('importBtn');
            const importFile = sel('importFile');
            const listEl = sel('domainsList');
            const tableBody = sel('degTable');
            const status = sel('status');
            const apiBanner = sel('apiBanner');
            const apiBaseTxt = sel('apiBaseTxt');

            const COMMON = ['B.Tech', 'M.Tech', 'MBBS', 'BSc', 'BBA', 'BCA', 'MSc', 'MBA', 'BE', 'ME'];
            const state = { degreeLabel: '', domains: [] };

            function setStatus(text) { status.textContent = text; }

            function getDegreeLabel() {
                return String((degreeInput.value || degreeSelect.value || state.degreeLabel || '')).trim();
            }

            function renderDomains() {
                listEl.innerHTML = '';
                if (!state.domains.length) {
                    listEl.innerHTML = '<p class="text-sm text-neutral-500 dark:text-white/60">No domains added yet.</p>';
                    return;
                }
                state.domains.forEach((d, idx) => {
                    const chip = document.createElement('span');
                    chip.className = 'inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/10 px-3 py-1.5 text-sm';
                    chip.innerHTML = '<span class="text-neutral-800 dark:text-white/90">' + d + '</span>';
                    const x = document.createElement('button');
                    x.className = 'inline-flex items-center justify-center rounded-full p-1 text-neutral-500 hover:text-brand-500';
                    x.innerHTML = '<span class="material-symbols-rounded text-sm">close</span>';
                    x.title = 'Remove';
                    x.onclick = function () {
                        const label = getDegreeLabel();
                        // Immediate persist if we have a degree label
                        if (label) {
                            fetch(API + '/api/notes/allowed-domains?degree=' + encodeURIComponent(label) + '&domain=' + encodeURIComponent(d), { method: 'DELETE' })
                                .then(r => r.ok ? r.json() : Promise.reject())
                                .then(() => { state.domains.splice(idx, 1); renderDomains(); showToast('Removed'); })
                                .catch(() => { showToast('Delete failed', 'error'); });
                        } else {
                            state.domains.splice(idx, 1); renderDomains();
                        }
                    };
                    chip.appendChild(x);
                    listEl.appendChild(chip);
                });
            }

            function renderDegreeSelect(list) {
                degreeSelect.innerHTML = '';
                const optNew = document.createElement('option'); optNew.value = ''; optNew.textContent = '— Select existing —';
                degreeSelect.appendChild(optNew);
                (list || []).forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.degree_label || d.degree_key;
                    opt.textContent = (d.degree_label || d.degree_key) + ' (' + (d.domains?.length || 0) + ')';
                    degreeSelect.appendChild(opt);
                });
                const grp = document.createElement('optgroup'); grp.label = 'Common';
                COMMON.forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; grp.appendChild(o); });
                degreeSelect.appendChild(grp);
            }

            function renderDegreesTable(list) {
                tableBody.innerHTML = '';
                (list || []).forEach(d => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-black/5 dark:hover:bg-white/5';
                    const td1 = document.createElement('td'); td1.className = 'px-4 py-2'; td1.textContent = d.degree_label || d.degree_key; tr.appendChild(td1);
                    const td2 = document.createElement('td'); td2.className = 'px-4 py-2'; td2.textContent = (d.domains || []).join(', '); tr.appendChild(td2);
                    const td3 = document.createElement('td'); td3.className = 'px-4 py-2 text-right';
                    const btn = document.createElement('button');
                    btn.className = 'inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/10 px-3 py-1.5 text-xs font-medium hover:border-brand-500/50';
                    btn.innerHTML = '<span class="material-symbols-rounded text-base">download</span>Load';
                    btn.onclick = function () { loadDegree(d.degree_label || d.degree_key); };
                    td3.appendChild(btn); tr.appendChild(td3);
                    tableBody.appendChild(tr);
                });
            }

            function normalizeHost(input) {
                let v = String(input || '').trim();
                if (!v) return '';
                try { if (v.includes('://')) v = new URL(v).host; } catch (_) { }
                v = v.replace(/^\*+/, '').toLowerCase();
                return v;
            }

            function syncDegree(label, domains) {
                state.degreeLabel = label || '';
                state.domains = (domains || []).slice();
                degreeInput.value = state.degreeLabel;
                renderDomains();
            }

            function loadDegree(label) {
                if (!label) return;
                setStatus('Loading …');
                fetch(API + '/api/notes/allowed-domains?degree=' + encodeURIComponent(label))
                    .then(r => r.json()).then(data => {
                        syncDegree(label, data.domains || []);
                        setStatus('Loaded. Edit and Save to update.');
                    }).catch(() => setStatus('Failed to load.'));
            }

            function refreshList() {
                if (apiBaseTxt) apiBaseTxt.textContent = API || '(unset)';
                fetch(API + '/api/notes/degrees')
                    .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                    .then(list => { apiBanner && apiBanner.classList.add('hidden'); renderDegreeSelect(list); renderDegreesTable(list); })
                    .catch(() => { apiBanner && apiBanner.classList.remove('hidden'); });
            }

            addBtn.onclick = function () {
                const v = normalizeHost(domainInput.value);
                if (!v) return;
                if (!state.domains.includes(v)) state.domains.push(v);
                domainInput.value = ''; renderDomains();
            };

            saveBtn.onclick = function () {
                const label = String(degreeInput.value || degreeSelect.value || '').trim();
                if (!label) { alert('Enter or select a degree label'); return; }
                setStatus('Saving …'); saveBtn.disabled = true;
                fetch(API + '/api/notes/allowed-domains', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ degree_label: label, domains: state.domains })
                }).then(r => r.json()).then(() => {
                    setStatus('Saved.'); saveBtn.disabled = false; refreshList(); showToast('Saved');
                }).catch(() => { setStatus('Failed to save.'); saveBtn.disabled = false; });
            };

            degreeSelect.onchange = function () { const label = degreeSelect.value; if (label) loadDegree(label); };

            // Export/import
            exportBtn.onclick = function () {
                fetch(API + '/api/notes/degrees')
                    .then(r => r.json())
                    .then(list => {
                        const blob = new Blob([JSON.stringify(list || [], null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url; a.download = 'paperx-allowed-domains.json'; a.click();
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    })
                    .catch(() => showToast('Export failed', 'error'));
            };

            importBtn.onclick = function () { importFile.click(); };
            importFile.addEventListener('change', function () {
                const f = importFile.files && importFile.files[0];
                if (!f) return;
                const reader = new FileReader();
                reader.onload = function () {
                    try {
                        const data = JSON.parse(String(reader.result || '[]'));
                        if (!Array.isArray(data)) throw new Error('Invalid format');
                        const tasks = data.map(entry => {
                            const label = String(entry.degree_label || entry.degree_key || '').trim();
                            const domains = Array.isArray(entry.domains) ? entry.domains : [];
                            if (!label || !domains.length) return Promise.resolve();
                            return fetch(API + '/api/notes/allowed-domains', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ degree_label: label, domains })
                            }).then(r => r.ok ? r.json() : Promise.reject());
                        });
                        Promise.all(tasks).then(() => { showToast('Import complete'); refreshList(); })
                            .catch(() => showToast('Import failed', 'error'));
                    } catch (_) {
                        showToast('Invalid JSON', 'error');
                    } finally {
                        importFile.value = '';
                    }
                };
                reader.readAsText(f);
            });

            // init
            renderDegreeSelect([]); renderDegreesTable([]); refreshList();
        })();
    </script>
</body>

</html>