<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Review Job at PaperX</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter + Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet">

  <!-- Runtime Tailwind config (PaperX palette) -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#F6F5FA', 100: '#EEEAF4', 200: '#D9CCE6', 300: '#C1A3D2',
              400: '#A574BD', 500: '#9E4B8A', 600: '#6E3868', 700: '#4C2A59',
              800: '#2C2240', 900: '#1E1E2F'
            }
          },
          boxShadow: {
            'elev-1': '0 1px 2px rgba(0,0,0,.06), 0 1px 1px rgba(0,0,0,.04)',
            'elev-2': '0 8px 24px rgba(0,0,0,.12)',
            'neon': '0 0 0 1px rgba(158,75,138,.25), 0 8px 32px rgba(158,75,138,.25)'
          },
          backgroundImage: {
            'glow': 'radial-gradient(1200px 600px at 10% -10%, rgba(158,75,138,.18), transparent), radial-gradient(900px 500px at 110% 10%, rgba(76,42,89,.25), transparent)'
          }
        }
      }
    }
  </script>

  <script src="../../config.js"></script>
  <script src="../../auth.js" defer></script>

  <style>
    .glass {
      background: rgba(255, 255, 255, .72);
      backdrop-filter: blur(12px)
    }

    .dark .glass {
      background: rgba(30, 30, 47, .55)
    }

    .material-symbols-rounded {
      vertical-align: -6px
    }

    .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .08)
    }

    .dark .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
    }

    .focus-ring:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(158, 75, 138, .35)
    }
  </style>
</head>

<body
  class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-glow dark:bg-[radial-gradient(1200px_600px_at_10%_-10%,rgba(158,75,138,.22),transparent),radial-gradient(900px_500px_at_110%_10%,rgba(30,30,47,.7),transparent)]">

  <!-- App Bar -->
  <header
    class="sticky top-0 z-50 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="#" onclick="history.back();return false;" class="inline-flex items-center gap-2">
        <span class="material-symbols-rounded">arrow_back</span><span class="font-semibold">Back</span>
      </a>

      <div class="text-lg font-bold">Review Job</div>

      <div class="flex items-center gap-3">
        <button id="themeToggle"
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full ring-soft hover:shadow-elev-1 transition">
          <span id="themeIcon" class="material-symbols-rounded text-base">dark_mode</span>
          <span class="text-sm">Theme</span>
        </button>
        <a href="../orders/index.html" class="text-sm hover:underline">My Prints</a>
      </div>
    </div>
  </header>

  <!-- Stepper -->
  <div class="max-w-6xl mx-auto px-4 mt-6">
    <ol class="grid grid-cols-3 gap-2 text-[12px]">
      <li class="flex items-center gap-2 rounded-lg px-3 py-2 bg-brand-500/10 ring-1 ring-brand-500/30">
        <span class="material-symbols-rounded text-base">tune</span> Settings
      </li>
      <li class="flex items-center gap-2 rounded-lg px-3 py-2 bg-brand-500/10 ring-1 ring-brand-500/30">
        <span class="material-symbols-rounded text-base">storefront</span> Shop
      </li>
      <li class="flex items-center gap-2 rounded-lg px-3 py-2 bg-brand-500 text-white">
        <span class="material-symbols-rounded text-base">check_circle</span> Review & Submit
      </li>
    </ol>
  </div>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left: Summary (sticky) -->
    <section class="lg:col-span-7">
      <div class="relative">
        <div class="absolute -inset-1 rounded-3xl blur-2xl bg-gradient-to-br from-brand-500/20 to-brand-700/20 -z-10">
        </div>
        <div
          class="glass rounded-3xl ring-1 ring-black/5 dark:ring-white/10 p-5 lg:p-6 shadow-neon lg:sticky lg:top-24">
          <div class="flex items-center justify-between mb-4">
            <div class="text-sm font-semibold">Summary</div>
            <span
              class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-full bg-brand-500/15 text-brand-600 dark:text-brand-200 ring-1 ring-brand-500/30">
              <span class="material-symbols-rounded text-sm">print</span> Print Job
            </span>
          </div>

          <!-- Shop -->
          <div id="shop" class="text-[13px] opacity-90 mb-3">
            <!-- Filled by JS -->
            <div class="animate-pulse h-10 rounded-md bg-white/50 dark:bg-white/10 ring-soft"></div>
          </div>

          <!-- Settings List -->
          <div id="settings" class="text-[13px]">
            <!-- Filled by JS -->
            <div class="space-y-2">
              <div class="animate-pulse h-5 rounded bg-white/50 dark:bg-white/10"></div>
              <div class="animate-pulse h-5 rounded bg-white/50 dark:bg-white/10 w-2/3"></div>
              <div class="animate-pulse h-5 rounded bg-white/50 dark:bg-white/10 w-1/2"></div>
            </div>
          </div>

          <hr class="my-5 border-black/10 dark:border-white/10">

          <!-- Live totals -->
          <div class="flex items-start justify-between gap-4">
            <div>
              <div id="est" class="text-[12px] opacity-80"></div>
              <div id="price" class="text-sm font-semibold mt-1"></div>
              <div id="priceNote" class="text-[11px] opacity-70 mt-1 hidden"></div>
            </div>
            <div class="text-right">
              <div class="text-xs opacity-70">Pickup</div>
              <div id="pickupPreview" class="text-sm font-semibold">-</div>
            </div>
          </div>

          <!-- Informational footer -->
          <div class="mt-4 text-[12px] opacity-75 flex items-start gap-2">
            <span class="material-symbols-rounded text-base">info</span>
            <p>You will receive an OTP after submission. Share it at pickup for a secure handover.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Form -->
    <section class="lg:col-span-5">
      <div class="glass rounded-3xl ring-1 ring-black/5 dark:ring-white/10 p-5 lg:p-6">
        <div class="flex items-center gap-2 mb-4">
          <span class="material-symbols-rounded">event_available</span>
          <h2 class="text-lg font-semibold">Pickup & Contact</h2>
        </div>

        <form id="reviewForm" class="grid grid-cols-1 gap-4 text-[13px]">
          <!-- Pickup Window -->
          <label class="block">
            <span class="text-xs opacity-80">Pickup Window</span>
            <select name="pickup_window" id="pickup_window"
              class="mt-1 w-full px-3 py-2 rounded-lg ring-soft bg-white/80 dark:bg-white/5 focus-ring">
              <option>Now</option>
              <option>Today</option>
              <option>Tomorrow</option>
              <option>Custom</option>
            </select>
          </label>

          <!-- Custom date/time (hidden until Custom) -->
          <div id="customWrap" class="grid grid-cols-2 gap-3 hidden">
            <label class="block col-span-1">
              <span class="text-xs opacity-80">Date</span>
              <input type="date" id="customDate"
                class="mt-1 w-full px-3 py-2 rounded-lg ring-soft bg-white/80 dark:bg-white/5 focus-ring">
            </label>
            <label class="block col-span-1">
              <span class="text-xs opacity-80">Time</span>
              <input type="time" id="customTime"
                class="mt-1 w-full px-3 py-2 rounded-lg ring-soft bg-white/80 dark:bg-white/5 focus-ring">
            </label>
          </div>

          <!-- Pickup For -->
          <div class="block">
            <span class="text-xs opacity-80">Pickup For</span>
            <div class="mt-1 flex items-center gap-6">
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="contact_for" id="for_me" value="me" checked>
                <span>For me</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="contact_for" id="for_others" value="other">
                <span>For others</span>
              </label>
            </div>
            <div id="meInfo" class="text-[11px] opacity-70 mt-1 hidden"></div>
          </div>

          <div id="contactFields" class="grid grid-cols-1 gap-4">
            <!-- Name -->
            <label class="block">
              <span class="text-xs opacity-80">Name</span>
              <input name="contact_name" id="contact_name" required
                class="mt-1 w-full px-3 py-2 rounded-lg ring-soft bg-white/80 dark:bg-white/5 focus-ring"
                placeholder="Your name">
            </label>

            <!-- Phone with lightweight mask -->
            <label class="block">
              <span class="text-xs opacity-80">Phone</span>
              <input name="contact_phone" id="contact_phone" inputmode="tel" maxlength="14"
                class="mt-1 w-full px-3 py-2 rounded-lg ring-soft bg-white/80 dark:bg-white/5 focus-ring"
                placeholder="+91 9XXXXXXXXX">
              <span class="text-[11px] opacity-70">We'll share status updates and OTP to this number.</span>
            </label>
          </div>

          <!-- Terms -->
          <label class="flex items-start gap-2">
            <input type="checkbox" id="terms" class="mt-0.5">
            <span>I confirm I won't print illegal/copyright content.</span>
          </label>

          <!-- CTA row -->
          <div class="flex items-center justify-between pt-1">
            <div id="status" class="text-[12px] opacity-80"></div>
            <button id="submit" type="button"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-brand-500 text-white hover:bg-brand-700 active:scale-[.99] transition shadow-elev-2">
              <span class="material-symbols-rounded text-base">send</span>
              <span>Submit Job</span>
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="px-4 py-2 rounded-xl bg-brand-500 text-white shadow-elev-2">
      <span id="toastMsg" class="text-sm"></span>
    </div>
  </div>

  <script>
    // ------ Theme toggle ------
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const saved = localStorage.getItem('px_theme');
    if ((saved === 'dark') || (!saved && prefersDark)) document.documentElement.classList.add('dark');
    const syncIcon = () => themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
    syncIcon();
    themeBtn?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('px_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      syncIcon();
    });

    // ------ Helpers ------
    function $(s) { return document.querySelector(s) }
    function escapeHtml(s) { return (s || '').toString().replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c])) }
    function toast(msg, ms = 1800) {
      const t = $('#toast'), m = $('#toastMsg');
      m.textContent = msg; t.classList.remove('hidden', 'opacity-0');
      t.classList.add('transition', 'duration-200');
      setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.classList.add('hidden'), 200); }, ms);
    }
    // Token + storage helpers (fallback if not provided globally)
    if (!window.getToken) {
      window.getToken = function () {
        const keys = ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token'];
        for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } }
        return '';
      };
    }
    function safeGet(k) { try { return localStorage.getItem(k); } catch { return null; } }
    function safeSet(k, v) { try { localStorage.setItem(k, v); } catch { } }
    const PX_PROFILE_LS_KEY = 'px_profile_cache';
    let __PROFILE_CACHE = null;
    let __PROFILE_PROMISE = null;
    function readCachedProfile() {
      try {
        const raw = safeGet(PX_PROFILE_LS_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts) return null;
        // 5 minutes TTL
        if (Date.now() - obj.ts > 5 * 60 * 1000) return null;
        return obj.profile || null;
      } catch { return null; }
    }
    function writeCachedProfile(p) {
      try { safeSet(PX_PROFILE_LS_KEY, JSON.stringify({ ts: Date.now(), profile: p || null })); } catch { }
    }
    async function loadProfileMe() {
      if (__PROFILE_CACHE) return __PROFILE_CACHE;
      if (__PROFILE_PROMISE) return __PROFILE_PROMISE;
      const tk = (window.getToken && window.getToken()) || '';
      if (!tk) return null;
      // Try local cache first for instant fill
      const cached = readCachedProfile();
      if (cached) { __PROFILE_CACHE = cached; return __PROFILE_CACHE; }
      // Network fetch with timeout and de-dupe
      __PROFILE_PROMISE = (async () => {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), 3500);
        try {
          const r = await fetch((window.API_BASE || '') + '/api/me', { headers: { Authorization: 'Bearer ' + tk }, signal: ctrl.signal });
          if (!r.ok) return null;
          const j = await r.json().catch(() => ({}));
          const prof = (j && (j.profile || j)) || null;
          if (prof) { __PROFILE_CACHE = prof; writeCachedProfile(prof); }
          return __PROFILE_CACHE;
        } catch { return null; }
        finally { clearTimeout(t); __PROFILE_PROMISE = null; }
      })();
      return __PROFILE_PROMISE;
    }
    function parseRange(input, totalPages) {
      const t = (input || '').trim();
      if (!t || t.toLowerCase() === 'all') return totalPages || null;
      let count = 0;
      const parts = t.split(',').map(seg => seg.trim()).filter(Boolean);
      for (const segment of parts) {
        if (/^\d+$/.test(segment)) {
          const v = parseInt(segment, 10);
          if (!totalPages || (v >= 1 && v <= totalPages)) { count += 1; } else { return null; }
        } else if (/^\d+\s*-\s*\d+$/.test(segment)) {
          const [aRaw, bRaw] = segment.split('-').map(s => parseInt(s.trim(), 10));
          if (aRaw > bRaw) return null;
          if (!totalPages || (aRaw >= 1 && bRaw <= totalPages)) { count += (bRaw - aRaw + 1); } else { return null; }
        } else {
          return null;
        }
      }
      return count;
    }
    function computeSelectedPages(settings, totalPages) {
      const allPages = Number.isFinite(totalPages) ? totalPages : 0;
      const mode = (settings.range_mode || 'all').toLowerCase();
      if (mode === 'range') {
        return parseRange(settings.page_range || '', allPages);
      }
      if (mode === 'single') {
        const sp = parseInt(settings.single_page || '', 10);
        if (Number.isFinite(sp) && sp >= 1 && (!allPages || sp <= allPages)) return 1;
        return null;
      }
      return allPages || null;
    }
    function formatCurrency(value) {
      if (!Number.isFinite(value)) return '';
      try {
        const fmt = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return fmt.format(value);
      } catch {
        return `â‚¹${value.toFixed(2)}`;
      }
    }
    function friendlyPricingKey(key) {
      const map = {
        bw_single: 'B/W single side',
        bw_duplex: 'B/W duplex',
        color_single: 'Color single side',
        color_duplex: 'Color duplex'
      };
      return map[key] || key;
    }
    function normalizePricing(pricing) {
      if (!pricing) return {};
      if (typeof pricing === 'string') {
        try { return JSON.parse(pricing); } catch { return {}; }
      }
      if (typeof pricing === 'object') return pricing;
      return {};
    }
    function selectPricingTier(tiers, quantity) {
      if (!Array.isArray(tiers) || !tiers.length) return null;
      const sorted = tiers.slice().sort((a, b) => ((a?.min ?? 0) - (b?.min ?? 0)));
      let match = sorted.find(t => {
        const min = Number(t?.min);
        const upto = Number(t?.upto);
        const minOk = !Number.isFinite(min) || quantity >= min;
        const uptoOk = !Number.isFinite(upto) || quantity <= upto;
        return minOk && uptoOk;
      });
      if (!match) {
        match = sorted.reduce((acc, curr) => {
          const min = Number(curr?.min);
          if (!Number.isFinite(min) || quantity < min) return acc;
          if (!acc) return curr;
          const accMin = Number(acc?.min);
          return (!Number.isFinite(accMin) || min > accMin) ? curr : acc;
        }, null);
      }
      return match || null;
    }
    function estimatePrice(shop, settings, totalPagesInput) {
      if (!shop) return { amount: null, reason: 'Shop not found.' };
      const copiesRaw = parseInt(settings.copies || '1', 10);
      const copies = Number.isFinite(copiesRaw) && copiesRaw > 0 ? copiesRaw : 1;
      const totalPagesNumber = Number(totalPagesInput);
      const selectableTotal = Number.isFinite(totalPagesNumber) ? totalPagesNumber : 0;
      const selected = computeSelectedPages(settings, selectableTotal);
      const fallbackPages = (Number.isFinite(totalPagesNumber) && totalPagesNumber > 0) ? totalPagesNumber : null;
      const pagesPerCopy = Number.isFinite(selected) && selected > 0 ? selected : fallbackPages;
      if (!Number.isFinite(pagesPerCopy) || pagesPerCopy <= 0) {
        return { amount: null, reason: 'Add page count to view an estimate.' };
      }
      const nupRaw = parseInt(settings.n_up || '1', 10);
      const nUp = Number.isFinite(nupRaw) && nupRaw > 0 ? nupRaw : 1;
      const sidesPerCopy = Math.max(1, Math.ceil(pagesPerCopy / nUp));
      const duplexOn = (settings.duplex || '').toLowerCase() !== 'off';
      const unitsPerCopy = duplexOn ? Math.max(1, Math.ceil(sidesPerCopy / 2)) : sidesPerCopy;
      const qty = unitsPerCopy * copies;
      if (!qty) {
        return { amount: null, reason: 'Page count is zero.' };
      }
      const colorMode = (settings.color_mode || 'bw').toLowerCase();
      const pricingKey = (colorMode === 'color' ? 'color' : 'bw') + '_' + (duplexOn ? 'duplex' : 'single');
      const pricing = normalizePricing(shop.pricing);
      const tiers = Array.isArray(pricing[pricingKey]) ? pricing[pricingKey] : [];
      if (!tiers.length) {
        return { amount: null, reason: `No rates for ${friendlyPricingKey(pricingKey)}.` };
      }
      const tier = selectPricingTier(tiers, qty);
      if (!tier) {
        const unitWord = duplexOn ? 'sheet' : 'side';
        return { amount: null, reason: `No rate matches ${qty} ${unitWord}${qty === 1 ? '' : 's'}.` };
      }
      const perPage = Number(tier.per_page);
      if (!Number.isFinite(perPage) || perPage <= 0) {
        return { amount: null, reason: 'Rate missing in selected tier.' };
      }
      const amount = Math.round(perPage * qty * 100) / 100;
      const perPageRounded = Math.round(perPage * 100) / 100;
      const unitWord = duplexOn ? 'sheet' : 'side';
      const unitLabel = qty === 1 ? unitWord : `${unitWord}s`;
      const breakdown = `${formatCurrency(perPageRounded)} per ${unitWord} x ${qty} ${unitLabel} (${friendlyPricingKey(pricingKey)})`;
      const logicalTotal = Math.round(pagesPerCopy * copies);
      return { amount, perPage: perPageRounded, qty, unit: unitLabel, breakdown, reason: null, logicalPages: logicalTotal };
    }

    // ------ Query / state ------
    const p = new URLSearchParams(location.search);
    const shopId = p.get('shopId') || '';
    const noteId = p.get('noteId') || '';
    let settings = {};
    try { settings = JSON.parse(decodeURIComponent(p.get('settings') || '{}')); } catch { }
    const pages = parseInt(p.get('pages') || '') || '';
    const size = parseInt(p.get('size') || '') || '';

    // ------ UI elements ------
    const estEl = $('#est');
    const priceEl = $('#price');
    const priceNoteEl = $('#priceNote');
    const pickupPreview = $('#pickupPreview');
    const pickupSel = $('#pickup_window');
    const customWrap = $('#customWrap');
    const customDate = $('#customDate');
    const customTime = $('#customTime');
    let latestEstimatedPrice = null;

    // Live pickup preview
    function updatePickupPreview() {
      const v = pickupSel.value;
      if (v === 'Custom') {
        const d = customDate.value || 'â€”';
        const t = customTime.value || 'â€”';
        pickupPreview.textContent = `${d} ${t}`.trim();
      } else {
        pickupPreview.textContent = v || 'â€”';
      }
    }
    pickupSel.addEventListener('change', () => {
      customWrap.classList.toggle('hidden', pickupSel.value !== 'Custom');
      updatePickupPreview();
    });
    customDate.addEventListener('input', updatePickupPreview);
    customTime.addEventListener('input', updatePickupPreview);

    // Phone input lightweight mask
    const phoneInput = $('#contact_phone');
    phoneInput.addEventListener('input', (e) => {
      let v = e.target.value.replace(/[^\d+]/g, '');
      // basic keep + and digits, trim spaces
      e.target.value = v;
    });

    // Contact: for me / for others (fast, non-blocking; refines asynchronously)
    function updateContactMode(fromAsync = false) {
      const mode = (document.querySelector('input[name="contact_for"]:checked')?.value || 'me');
      const fieldsWrap = document.getElementById('contactFields');
      const meInfo = document.getElementById('meInfo');
      const nameInput = document.getElementById('contact_name');
      const phoneInput = document.getElementById('contact_phone');
      if (mode === 'me') {
        const tk = (window.getToken && window.getToken()) || '';
        if (!tk) {
          // Not logged in: cannot auto-fill; keep fields visible
          fieldsWrap.classList.remove('hidden');
          nameInput.required = true; phoneInput.required = true;
          meInfo.classList.remove('hidden');
          meInfo.textContent = 'Login to auto-fill your details, or enter them below.';
          return;
        }
        // Immediate best-effort data (snapshot or LS cache) – no await to keep UI snappy
        const prof = window.__PX_PROFILE_SNAPSHOT || __PROFILE_CACHE || readCachedProfile();
        const nm = (prof && (prof.name || prof.full_name || prof.username)) || '';
        const ph = (prof && (prof.phone || prof.mobile || '')) || '';
        if (nm) nameInput.value = nm;
        if (ph) phoneInput.value = ph;
        if (nm && ph) {
          fieldsWrap.classList.add('hidden');
          nameInput.required = false; phoneInput.required = false;
          meInfo.classList.remove('hidden');
          meInfo.textContent = `Using your profile: ${nm} • ${ph}`;
        } else {
          fieldsWrap.classList.remove('hidden');
          nameInput.required = !nm; phoneInput.required = !ph;
          meInfo.classList.remove('hidden');
          meInfo.textContent = 'Complete missing details below. We will save with your user ID.';
          // If we haven't refined via async fetch yet, trigger once and re-apply
          if (!fromAsync) {
            loadProfileMe().then(p => { if (p) { updateContactMode(true); } });
          }
        }
      } else {
        fieldsWrap.classList.remove('hidden');
        nameInput.required = true; phoneInput.required = true;
        meInfo.classList.add('hidden');
        meInfo.textContent = '';
        nameInput.value = '';
        phoneInput.value = '';
      }
    }

    // ------ Load shop + settings summary ------
    async function loadShop() {
      const url = (window.API_BASE || '') + '/api/print/shops';
      let r; try { r = await fetch(url); } catch { }
      const list = r && r.ok ? ((await r.json()).shops || []) : [];
      const shop = list.find(s => String(s.id) === String(shopId));

      $('#shop').innerHTML = shop
        ? `<div class="font-semibold">${escapeHtml(shop.name || '')}</div>
           <div class="opacity-70">${escapeHtml(shop.address || '')}</div>`
        : '<div class="opacity-80">Shop selected</div>';

      const s = settings || {};
      $('#settings').innerHTML = `<ul class="space-y-1">
        <li>Copies: <b>${escapeHtml(s.copies || '1')}</b></li>
        <li>Color: <b>${escapeHtml(s.color_mode || 'auto')}</b> - Duplex: <b>${escapeHtml(s.duplex || 'off')}</b> - N-up: <b>${escapeHtml(s.n_up || '1')}</b></li>
        <li>Paper: <b>${escapeHtml(s.paper_size || 'A4')}</b>${s.paper_gsm ? (' - ' + escapeHtml(s.paper_gsm) + ' GSM') : ''} - Finish: <b>${escapeHtml(s.finishing || 'none')}</b></li>
        <li>Pages: <b>${pages || '?'}</b> x Copies <b>${escapeHtml(s.copies || '1')}</b></li>
        ${s.page_range ? ('<li>Range: <b>' + escapeHtml(s.page_range) + '</b></li>') : ''}
      </ul>`;

      const copiesParsed = parseInt(s.copies || '1', 10);
      const copiesCount = Number.isFinite(copiesParsed) && copiesParsed > 0 ? copiesParsed : 1;
      const totalPagesNumber = Number(pages);
      const selectableTotal = Number.isFinite(totalPagesNumber) ? totalPagesNumber : 0;
      const selectedPerCopy = computeSelectedPages(s, selectableTotal);
      const perCopyPages = Number.isFinite(selectedPerCopy) && selectedPerCopy > 0
        ? selectedPerCopy
        : (Number.isFinite(totalPagesNumber) && totalPagesNumber > 0 ? totalPagesNumber : null);
      const fallbackPageTotal = perCopyPages != null ? perCopyPages * copiesCount : null;

      const priceInfo = estimatePrice(shop, s, selectableTotal);
      latestEstimatedPrice = (priceInfo && priceInfo.amount != null) ? priceInfo.amount : null;
      const pageTotal = (priceInfo && Number.isFinite(priceInfo.logicalPages) && priceInfo.logicalPages > 0)
        ? priceInfo.logicalPages
        : fallbackPageTotal;
      estEl.textContent = pageTotal ? (`Estimated total pages: ${pageTotal}`) : '';

      if (priceEl) {
        if (priceInfo && priceInfo.amount != null) {
          priceEl.textContent = `Estimated price: ${formatCurrency(priceInfo.amount)}`;
          if (priceNoteEl) {
            if (priceInfo.breakdown) {
              priceNoteEl.textContent = priceInfo.breakdown;
              priceNoteEl.classList.remove('hidden');
            } else {
              priceNoteEl.textContent = '';
              priceNoteEl.classList.add('hidden');
            }
          }
        } else if (priceInfo && priceInfo.reason) {
          priceEl.textContent = 'Price unavailable';
          if (priceNoteEl) {
            priceNoteEl.textContent = priceInfo.reason;
            priceNoteEl.classList.remove('hidden');
          }
        } else {
          priceEl.textContent = '';
          if (priceNoteEl) {
            priceNoteEl.textContent = '';
            priceNoteEl.classList.add('hidden');
          }
        }
      }

      // Initialize pickup preview
      updatePickupPreview();
    }

    // ------ Submit ------
    async function submitJob() {
      const token = (window.getToken && window.getToken()) || '';
      const f = new FormData(document.getElementById('reviewForm'));

      // Resolve contact per selection
      const mode = (document.querySelector('input[name="contact_for"]:checked')?.value || 'me');
      let name = (document.getElementById('contact_name').value || '').trim();
      let phone = (document.getElementById('contact_phone').value || '').trim();
      if (mode === 'me' && token) {
        const prof = window.__PX_PROFILE_SNAPSHOT || await loadProfileMe();
        if (prof) {
          if (!name) name = (prof.name || prof.full_name || prof.username || '').trim();
          if (!phone) phone = (prof.phone || '').trim();
        }
      }
      // Client-side checks
      if (!name) { $('#status').textContent = 'Please enter your name.'; toast('Please enter your name.'); return; }
      if (!phone) { $('#status').textContent = 'Please enter a phone number.'; toast('Please enter a phone number.'); return; }
      if (!document.getElementById('terms').checked) { $('#status').textContent = 'Please accept the terms.'; toast('Please accept the terms.'); return; }

      // Build pickup_window (inline Custom value)
      let pickup_window = f.get('pickup_window') || null;
      if (pickup_window === 'Custom') {
        const d = customDate.value; const t = customTime.value;
        if (!d || !t) { $('#status').textContent = 'Choose a custom date & time.'; toast('Choose a custom date & time.'); return; }
        pickup_window = `${d} ${t}`;
      }

      const payload = {
        shop_id: shopId,
        marketplace_note_id: noteId || null,
        estimated_pages: pages || null,
        file_size: size || null,
        estimated_price: latestEstimatedPrice != null ? Number(latestEstimatedPrice) : null,
        settings: {
          copies: parseInt(settings.copies || '1') || 1,
          color_mode: settings.color_mode || 'auto',
          duplex: settings.duplex || 'off',
          n_up: parseInt(settings.n_up || '1') || 1,
          paper_size: settings.paper_size || 'A4',
          paper_gsm: settings.paper_gsm ? parseInt(settings.paper_gsm) : null,
          finishing: settings.finishing || 'none',
          page_range: settings.page_range || 'all',
          scale: settings.scale || 'fit',
          collate: !!(settings.collate === true || settings.collate === 'on'),
          notes_to_shop: settings.notes_to_shop || '',
          orientation: (settings.orientation === 'horizontal') ? 'horizontal' : 'vertical'
        },
        pickup_window,
        contact_name: name,
        contact_phone: phone
      };

      // Loading state
      const submitBtn = document.getElementById('submit');
      const statusEl = document.getElementById('status');
      const originalBtn = submitBtn.innerHTML;
      statusEl.textContent = 'Submittingâ€¦';
      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-70', 'pointer-events-none');
      submitBtn.innerHTML = `<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> <span>Submittingâ€¦</span>`;

      let r;
      try {
        r = await fetch((window.API_BASE || '') + '/api/print/jobs', {
          method: 'POST',
          headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { Authorization: 'Bearer ' + token } : {}),
          body: JSON.stringify(payload)
        });
      } catch {
        statusEl.textContent = 'Network error'; toast('Network error');
        submitBtn.disabled = false; submitBtn.classList.remove('opacity-70', 'pointer-events-none'); submitBtn.innerHTML = originalBtn;
        return;
      }

      const j = await r.json().catch(() => ({}));
      if (!r.ok) {
        statusEl.textContent = j.detail || 'Error';
        toast(j.detail || 'Error submitting job');
        submitBtn.disabled = false; submitBtn.classList.remove('opacity-70', 'pointer-events-none'); submitBtn.innerHTML = originalBtn;
        return;
      }

      statusEl.textContent = 'Submitted. Generating OTPâ€¦';
      toast('Job submitted!');

      const next = new URL('./success.html', location.href);
      next.searchParams.set('jobId', j.job_id);
      next.searchParams.set('otp', j.otp);
      location.href = next.toString();
    }

    // ------ Events ------
    document.addEventListener('DOMContentLoaded', () => {
      loadShop();
      // Init contact mode handlers
      document.getElementById('for_me')?.addEventListener('change', updateContactMode);
      document.getElementById('for_others')?.addEventListener('change', updateContactMode);
      updateContactMode();
      // If global auth fetch updates profile later, refine the UI without waiting
      try {
        const prevApply = window.__PX_NAV_APPLY;
        window.__PX_NAV_APPLY = function (profile) {
          try { if (prevApply) prevApply(profile); } catch { }
          try { if (profile) { __PROFILE_CACHE = profile; writeCachedProfile(profile); } } catch { }
          // Re-apply mode to hide fields if now complete
          try { updateContactMode(true); } catch { }
        };
      } catch { }
    });
    document.getElementById('submit').addEventListener('click', submitJob);
  </script>
</body>

</html>