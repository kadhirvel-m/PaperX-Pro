<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find a Print Shop — PaperX</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter + Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet">

  <!-- Runtime Tailwind config (PaperX palette) -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#F6F5FA', 100: '#EEEAF4', 200: '#D9CCE6', 300: '#C1A3D2',
              400: '#A574BD', 500: '#9E4B8A', 600: '#6E3868', 700: '#4C2A59',
              800: '#2C2240', 900: '#1E1E2F'
            }
          },
          boxShadow: {
            'elev-1': '0 1px 2px rgba(0,0,0,.06), 0 1px 1px rgba(0,0,0,.04)',
            'elev-2': '0 8px 24px rgba(0,0,0,.12)',
            'neon': '0 0 0 1px rgba(158,75,138,.25), 0 8px 32px rgba(158,75,138,.25)'
          }
        }
      }
    }
  </script>

  <script src="../../config.js"></script>
  <script src="../../auth.js" defer></script>

  <style>
    .material-symbols-rounded {
      vertical-align: -6px
    }

    .glass {
      background: rgba(255, 255, 255, .72);
      backdrop-filter: blur(12px)
    }

    .dark .glass {
      background: rgba(30, 30, 47, .55)
    }

    .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .08)
    }

    .dark .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
    }

    .focus-ring:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(158, 75, 138, .35)
    }

    /* Material-inspired surfaces and chips */
    .surface {
      background: rgba(255, 255, 255, .86);
      backdrop-filter: blur(14px)
    }

    .dark .surface {
      background: rgba(30, 30, 47, .66)
    }

    .surface-elev {
      box-shadow: 0 1px 2px rgba(0, 0, 0, .07), 0 8px 28px rgba(0, 0, 0, .18)
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .6rem;
      border-radius: 9999px;
      background: rgba(255, 255, 255, .7);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .08);
      font-size: 12px
    }

    .dark .chip {
      background: rgba(255, 255, 255, .08);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
    }
  </style>
</head>

<body
  class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-[radial-gradient(1200px_600px_at_10%_-10%,rgba(158,75,138,.18),transparent),radial-gradient(900px_500px_at_110%_10%,rgba(76,42,89,.25),transparent)] dark:bg-[radial-gradient(1200px_600px_at_10%_-10%,rgba(158,75,138,.2),transparent),radial-gradient(900px_500px_at_110%_10%,rgba(30,30,47,.7),transparent)]">

  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur border-b border-black/5 dark:border-white/10">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
        <img src="../../assets/img/logo-light.svg" alt="Paper X" class="h-8 w-auto dark:hidden">
        <img src="../../assets/img/logo-dark.svg" alt="Paper X" class="h-8 w-auto hidden dark:block">
      </a>
      <nav class="hidden md:flex text-sm opacity-80 items-center gap-4">
        <a class="hover:underline" href="../matketplace/notes/notes_marketplace.html">Notes</a>
        <a class="hover:underline" href="../orders/index.html">My Prints</a>
      </nav>
      <button id="themeToggle"
        class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full ring-soft hover:shadow-elev-1 transition">
        <span id="themeIcon" class="material-symbols-rounded text-base">dark_mode</span>
        <span class="text-sm">Theme</span>
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Hero / Title row -->
    <section class="rounded-3xl surface surface-elev ring-1 ring-black/5 dark:ring-white/10 overflow-hidden">
      <div class="relative p-5 md:p-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3 text-sm">
            <a href="#" onclick="history.back();return false;"
              class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full chip hover:bg-black/10 dark:hover:bg-white/10">
              <span class="material-symbols-rounded text-sm">arrow_back</span>Back
            </a>
            <span class="hidden sm:inline opacity-60">/</span>
            <h1 class="text-xl md:text-2xl font-extrabold tracking-tight">Find a Print Shop</h1>
          </div>
          <div class="hidden md:flex items-center gap-2 opacity-80 text-[12px]">
            <span class="chip"><span class="material-symbols-rounded text-sm">shield</span>Trusted partners</span>
            <span class="chip"><span class="material-symbols-rounded text-sm">bolt</span>Fast turnaround</span>
          </div>
        </div>
        <p class="mt-2 text-sm opacity-80 max-w-2xl">Search nearby print partners, filter by size, color, and binding,
          and configure your print in a few clicks.</p>
      </div>
    </section>

    <!-- Layout: Filters (left) + Results (right) -->
    <section class="grid grid-cols-1 md:grid-cols-12 gap-6">
      <!-- Filters panel -->
      <aside class="md:col-span-4 lg:col-span-3">
        <div class="rounded-3xl surface surface-elev ring-1 ring-black/5 dark:ring-white/10 sticky top-20">
          <div class="p-4 border-b border-black/5 dark:border-white/10 flex items-center justify-between">
            <h2 class="font-semibold">Filters</h2>
            <span id="status" class="text-[12px] opacity-70"></span>
          </div>
          <form id="filters" class="p-4 grid grid-cols-1 gap-3 text-[13px]">
            <!-- Search / location -->
            <div class="flex gap-2">
              <div class="flex-1 relative">
                <span
                  class="material-symbols-rounded absolute left-2 top-1/2 -translate-y-1/2 opacity-60 text-base">search</span>
                <input type="text" id="q" placeholder="Pin/Area or College name"
                  class="w-full pl-8 pr-3 py-2 rounded-md ring-soft bg-white/80 dark:bg-white/5 focus-ring" />
              </div>
              <button type="button" id="useLoc"
                class="inline-flex items-center gap-1 px-3 py-2 rounded-md ring-soft hover:shadow-elev-1">
                <span class="material-symbols-rounded text-base">my_location</span><span
                  class="hidden sm:inline">Use</span>
              </button>
            </div>

            <!-- Radius -->
            <label class="text-[12px] opacity-70">Radius</label>
            <select id="radius" class="w-full px-3 py-2 rounded-md ring-soft bg-white/80 dark:bg-white/5 focus-ring">
              <option value="2">2 km</option>
              <option value="5" selected>5 km</option>
              <option value="10">10 km</option>
              <option value="20">20 km</option>
            </select>

            <!-- Size -->
            <label class="text-[12px] opacity-70 mt-2">Paper Size</label>
            <select id="size" class="w-full px-3 py-2 rounded-md ring-soft bg-white/80 dark:bg-white/5 focus-ring">
              <option value="">Any size</option>
              <option>A4</option>
              <option>A3</option>
              <option>Letter</option>
            </select>

            <!-- Binding -->
            <label class="text-[12px] opacity-70 mt-2">Binding</label>
            <select id="binding" class="w-full px-3 py-2 rounded-md ring-soft bg-white/80 dark:bg-white/5 focus-ring">
              <option value="">Any</option>
              <option>staple</option>
              <option>spiral</option>
            </select>

            <!-- Toggles -->
            <div class="flex flex-col gap-2 pt-1">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="open_now"> Open now
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="color"> Color
              </label>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 pt-2">
              <button type="submit"
                class="inline-flex items-center gap-2 px-3 py-2 rounded-md bg-brand-500 text-white hover:bg-brand-700 shadow-elev-1">
                <span class="material-symbols-rounded text-base">tune</span>Apply
              </button>
              <button type="button" id="clearFilters"
                class="inline-flex items-center gap-1 px-3 py-2 rounded-md ring-soft hover:bg-black/5 dark:hover:bg-white/5">
                <span class="material-symbols-rounded text-base">close</span>Clear
              </button>
            </div>

            <!-- Active filter chips -->
            <div id="chips" class="hidden flex-wrap gap-2 pt-2"></div>
          </form>
        </div>
      </aside>

      <!-- Results area -->
      <section id="resultsWrap" class="md:col-span-8 lg:col-span-9 space-y-4">
        <!-- Results toolbar -->
        <div
          class="rounded-2xl surface ring-1 ring-black/5 dark:ring-white/10 p-3 flex flex-wrap items-center gap-3 justify-between">
          <div class="flex items-center gap-2 text-[12px] opacity-80">
            <span class="chip"><span class="material-symbols-rounded text-sm">map</span>Nearby</span>
            <span class="chip"><span class="material-symbols-rounded text-sm">layers</span>All partners</span>
          </div>
          <div class="flex items-center gap-2">
            <label for="sort" class="text-[12px] opacity-70">Sort</label>
            <select id="sort" title="Sort"
              class="px-3 py-2 rounded-md ring-soft bg-white/80 dark:bg-white/5 focus-ring">
              <option value="">Default</option>
              <option value="distance">Nearest</option>
              <option value="price">Lowest Price</option>
              <option value="rating">Top Rated</option>
            </select>
          </div>
        </div>

        <!-- Results grid -->
        <div id="skeletonGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4">
          <!-- Skeleton cards -->
          <div class="rounded-3xl surface ring-1 ring-black/5 dark:ring-white/10 p-5 animate-pulse h-36"></div>
          <div class="rounded-3xl surface ring-1 ring-black/5 dark:ring-white/10 p-5 animate-pulse h-36"></div>
          <div class="rounded-3xl surface ring-1 ring-black/5 dark:ring-white/10 p-5 animate-pulse h-36"></div>
        </div>

        <div id="shopList" class="hidden grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4"></div>

        <div id="emptyState" class="hidden">
          <div class="rounded-3xl p-10 text-center surface ring-1 ring-black/5 dark:ring-white/10">
            <div class="mx-auto w-12 h-12 rounded-full bg-white/60 dark:bg-white/10 grid place-items-center mb-3">
              <span class="material-symbols-rounded">travel_explore</span>
            </div>
            <h3 class="font-semibold">No shops matched your filters</h3>
            <p class="text-sm opacity-75">Try expanding the radius or clearing a filter.</p>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden">
    <div class="px-4 py-2 rounded-xl bg-brand-500 text-white shadow-elev-2">
      <span id="toastMsg" class="text-sm"></span>
    </div>
  </div>

  <script>
    // ---------- Theme ----------
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const saved = localStorage.getItem('px_theme');
    if ((saved === 'dark') || (!saved && prefersDark)) document.documentElement.classList.add('dark');
    const syncIcon = () => themeIcon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
    syncIcon();
    themeBtn?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('px_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      syncIcon();
    });

    // ---------- Helpers ----------
    const params = new URLSearchParams(location.search);
    const noteId = params.get('noteId') || '';
    const qpPages = params.get('pages');
    const qpSize = params.get('size');

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toast = (msg, ms = 1600) => {
      const t = $('#toast'), m = $('#toastMsg');
      m.textContent = msg; t.classList.remove('hidden', 'opacity-0');
      t.classList.add('transition', 'duration-200');
      setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.classList.add('hidden'), 200); }, ms);
    };
    const km = (m) => (m / 1000).toFixed(1);

    // Haversine distance (meters)
    function distMeters(lat1, lon1, lat2, lon2) {
      if ([lat1, lon1, lat2, lon2].some(v => typeof v !== 'number' || isNaN(v))) return null;
      const R = 6371e3, toRad = (d) => d * Math.PI / 180;
      const dlat = toRad(lat2 - lat1), dlon = toRad(lon2 - lon1);
      const a = Math.sin(dlat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dlon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // Active filter chips
    function renderChips() {
      const chips = $('#chips');
      chips.innerHTML = '';
      const items = [];
      const radius = $('#radius').value;
      const size = $('#size').value;
      const binding = $('#binding').value;
      if ($('#open_now').checked) items.push(['Open now', 'open_now']);
      if ($('#color').checked) items.push(['Color', 'color']);
      if (size) items.push([`Size: ${size}`, 'size']);
      if (binding) items.push([`Binding: ${binding}`, 'binding']);
      if (radius) items.push([`${radius} km radius`, 'radius']);

      if (!items.length) { chips.classList.add('hidden'); return; }
      items.forEach(([label, id]) => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'inline-flex items-center gap-1 px-2 py-1 rounded-full text-[12px] ring-soft hover:bg-black/5 dark:hover:bg-white/5';
        b.innerHTML = `<span>${label}</span><span class="material-symbols-rounded text-xs">close</span>`;
        b.addEventListener('click', () => {
          if (id === 'open_now') $('#open_now').checked = false;
          else if (id === 'color') $('#color').checked = false;
          else if (id === 'size') $('#size').value = '';
          else if (id === 'binding') $('#binding').value = '';
          else if (id === 'radius') $('#radius').value = '5';
          fetchShops();
        });
        chips.appendChild(b);
      });
      chips.classList.remove('hidden');
    }

    // ---------- Cards ----------
    function card(shop, userPos) {
      const caps = shop.capabilities || {};
      const open = shop.is_open && !shop.paused;
      const priceHint = shop.price_hint || '';
      const color = caps.color ? 'Color' : 'B/W only';
      const sizes = (caps.sizes || []).join(', ') || 'A4';
      const rating = (shop.rating && Number(shop.rating).toFixed(1)) || null;
      // Try multiple common fields for logo URL from API/db
      const rawLogo = shop.logo_url || shop.logoUrl || shop.logo || shop.image_url || shop.imageUrl || null;
      const logoUrl = (typeof rawLogo === 'string' && rawLogo.trim()) ? rawLogo.trim() : null;

      let distanceLabel = '';
      if (userPos && typeof shop.lat === 'number' && typeof shop.lng === 'number') {
        const d = distMeters(userPos.lat, userPos.lng, shop.lat, shop.lng);
        if (d != null) distanceLabel = `${km(d)} km`;
      }

      const a = document.createElement('a');
      const url = new URL('./configure.html', location.href);
      url.searchParams.set('shopId', shop.id);
      if (noteId) url.searchParams.set('noteId', noteId);
      if (qpPages) url.searchParams.set('pages', qpPages);
      if (qpSize) url.searchParams.set('size', qpSize);
      a.href = url.toString();

      a.className = 'group block rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4 hover:shadow-neon transition';

      a.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="shrink-0 w-10 h-10 rounded-full bg-brand-500/15 grid place-items-center">
            <span class="material-symbols-rounded">local_printshop</span>
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold truncate">${shop.name || 'Print Shop'}</h3>
              ${open
          ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/15 text-emerald-600 ring-1 ring-emerald-500/30">Open</span>'
          : '<span class="text-[10px] px-2 py-0.5 rounded-full bg-neutral-500/10 text-neutral-600 ring-1 ring-black/10">Closed</span>'}
              ${rating ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/15 text-yellow-700 ring-1 ring-yellow-500/30">★ ${rating}</span>` : ''}
              ${distanceLabel ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-white/60 dark:bg-white/10 ring-soft">${distanceLabel}</span>` : ''}
            </div>
            <div class="text-[12px] opacity-70 truncate">${shop.address || ''}</div>
            <div class="text-[12px] mt-1">${color} • Sizes: ${sizes}</div>
            ${priceHint ? `<div class="text-[11px] opacity-80 mt-1">${priceHint}</div>` : ''}
          </div>
          <span class="material-symbols-rounded opacity-40 group-hover:opacity-80 transition">chevron_right</span>
        </div>`;
      // Override to upgraded Material-style card
      a.className = 'group block rounded-3xl surface ring-1 ring-black/5 dark:ring-white/10 p-4 hover:shadow-neon transition';
      a.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="shrink-0 w-10 h-10 rounded-full bg-brand-500/15 overflow-hidden grid place-items-center">
            ${logoUrl
          ? `<img src="${logoUrl}" alt="${(shop.name || 'Print Shop').replace(/"/g, '&quot;')} logo" class="w-full h-full object-cover" loading="lazy">`
          : `<span class="material-symbols-rounded">local_printshop</span>`}
          </div>
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold truncate">${shop.name || 'Print Shop'}</h3>
              ${open
          ? '<span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/15 text-emerald-600 ring-1 ring-emerald-500/30">Open</span>'
          : '<span class="text-[10px] px-2 py-0.5 rounded-full bg-neutral-500/10 text-neutral-600 ring-1 ring-black/10">Closed</span>'}
              ${rating ? `<span class=\"text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/15 text-yellow-700 ring-1 ring-yellow-500/30\">★ ${rating}</span>` : ''}
              ${distanceLabel ? `<span class=\"text-[10px] px-1.5 py-0.5 rounded bg-white/60 dark:bg-white/10 ring-soft\">${distanceLabel}</span>` : ''}
            </div>
            <div class="text-[12px] opacity-70 truncate">${shop.address || ''}</div>
            <div class="mt-2 flex flex-wrap items-center gap-2">
              <span class="chip">${color}</span>
              <span class="chip">Sizes: ${sizes}</span>
              ${priceHint ? `<span class=\"chip\">${priceHint}</span>` : ''}
            </div>
          </div>
          <span class="material-symbols-rounded opacity-40 group-hover:opacity-80 transition">chevron_right</span>
        </div>`;
      return a;
    }

    // ---------- Fetch ----------
    let userPos = null;

    async function fetchShops() {
      renderChips();
      $('#status').textContent = 'Searching…';
      $('#skeletonGrid').classList.remove('hidden');
      $('#shopList').classList.add('hidden');
      $('#emptyState').classList.add('hidden');

      const base = (window.API_BASE || '') + '/api/print/shops';
      const url = new URL(base, location.origin);

      const q = $('#q').value.trim();
      if (q) url.searchParams.set('q', q);

      const radius = $('#radius').value;
      if (radius) url.searchParams.set('radius', radius);

      if ($('#open_now').checked) url.searchParams.set('open_now', 'true');
      if ($('#color').checked) url.searchParams.set('color', 'true');
      if ($('#size').value) url.searchParams.set('size', $('#size').value);
      if ($('#binding').value) url.searchParams.set('binding', $('#binding').value);

      // Add optional geocoords & sort
      if (userPos) {
        url.searchParams.set('lat', userPos.lat);
        url.searchParams.set('lng', userPos.lng);
      }
      const sort = $('#sort').value;
      if (sort) url.searchParams.set('sort', sort);

      let r;
      try { r = await fetch(url.toString()); }
      catch { $('#status').textContent = 'Network error'; return; }

      let data = {};
      try { data = await r.json(); } catch { }
      $('#status').textContent = '';

      const list = (data.shops || []);
      const wrap = $('#shopList');
      wrap.innerHTML = '';

      if (!list.length) {
        $('#emptyState').classList.remove('hidden');
        $('#skeletonGrid').classList.add('hidden');
        return;
      }

      list.forEach(s => wrap.appendChild(card(s, userPos)));
      $('#skeletonGrid').classList.add('hidden');
      wrap.classList.remove('hidden');
    }

    // ---------- Geolocation ----------
    $('#useLoc').addEventListener('click', () => {
      if (!navigator.geolocation) { toast('Geolocation not supported'); return; }
      $('#status').textContent = 'Locating…';
      navigator.geolocation.getCurrentPosition(pos => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        $('#status').textContent = 'Location set';
        fetchShops();
      }, () => {
        $('#status').textContent = 'Location denied';
      }, { enableHighAccuracy: true, timeout: 10000 });
    });

    // ---------- Form events ----------
    $('#filters').addEventListener('submit', (e) => { e.preventDefault(); fetchShops(); });
    $('#clearFilters').addEventListener('click', () => {
      $('#q').value = '';
      $('#radius').value = '5';
      $('#open_now').checked = false;
      $('#color').checked = false;
      $('#size').value = '';
      $('#binding').value = '';
      $('#sort').value = '';
      renderChips();
      fetchShops();
    });

    // Quick interactions trigger live refresh
    ['radius', 'size', 'binding', 'sort'].forEach(id => {
      $('#' + id).addEventListener('change', fetchShops);
    });
    ['open_now', 'color'].forEach(id => {
      $('#' + id).addEventListener('click', fetchShops);
    });

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      renderChips();
      fetchShops();
    });
  </script>
</body>

</html>