<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Shop Dashboard</title>
    <link rel="icon" type="image/x-icon" href="../../assets/img/favicon.svg">

    <!-- Fonts / Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">

    <!-- Tailwind build -->
    <link rel="stylesheet" href="../../assets/css/tailwind.css" />

    <style>
        .material-symbols-rounded {
            vertical-align: -6px
        }

        .glass {
            background: rgba(255, 255, 255, .72);
            backdrop-filter: blur(12px)
        }

        .dark .glass {
            background: rgba(30, 30, 47, .55)
        }

        .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .08)
        }

        .dark .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
        }

        .sidebar {
            width: 280px
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 84px
            }

            .sidebar [data-label] {
                display: none
            }
        }

        /* subtle backdrop in hero cards */
        .bg-grid {
            background-image: linear-gradient(rgba(0, 0, 0, .04) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, .04) 1px, transparent 1px);
            background-size: 14px 14px;
        }

        /* dark gradient canvas */
        .dark body {
            background-image: linear-gradient(135deg, #1E1E2F 0%, #201934 40%, #141321 100%);
            background-attachment: fixed
        }
    </style>

    <!-- Theme boot (no flash) -->
    <script>
        (() => {
            const stored = localStorage.getItem('px_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored ? stored === 'dark' : prefersDark;
            if (isDark) document.documentElement.classList.add('dark');
        })();
    </script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white">
    <!-- Top bar -->
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Print Home">
                <img src="../../assets/img/logo-light.svg" alt="Paper X" class="h-8 w-auto dark:hidden">
                <img src="../../assets/img/logo-dark.svg" alt="Paper X" class="h-8 w-auto hidden dark:block">
            </a>

            <div class="hidden md:flex items-center gap-2">
                <a href="jobs.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10 text-sm">
                    <span class="material-symbols-rounded text-base">assignment</span> Jobs
                </a>
                <a href="payments.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10 text-sm">
                    <span class="material-symbols-rounded text-base">payments</span> Payments
                </a>
                <a href="profile.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10 text-sm">
                    <span class="material-symbols-rounded text-base">account_circle</span> Profile
                </a>
                <button id="themeToggle"
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
            </div>

            <div class="md:hidden flex items-center gap-2">
                <a href="jobs.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Jobs">
                    <span class="material-symbols-rounded">assignment</span>
                </a>
                <a href="payments.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Payments">
                    <span class="material-symbols-rounded">payments</span>
                </a>
                <a href="profile.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Profile">
                    <span class="material-symbols-rounded">account_circle</span>
                </a>
                <button id="themeToggleSm"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Layout -->
    <div class="container py-6 md:py-8 grid lg:grid-cols-[280px,1fr] gap-6">
        <!-- Sidebar -->
        <aside
            class="sidebar glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-3 md:p-4 self-start sticky top-24">
            <nav class="flex flex-col gap-1 text-sm">
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 bg-brand-500/10 text-brand-700 dark:text-brand-200 ring-1 ring-brand-500/30"
                    href="#overview">
                    <span class="material-symbols-rounded">dashboard</span>
                    <span data-label>Overview</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#orders">
                    <span class="material-symbols-rounded">receipt_long</span><span data-label>Orders</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#payments">
                    <span class="material-symbols-rounded">payments</span><span data-label>Payments</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#customers">
                    <span class="material-symbols-rounded">groups</span><span data-label>Customers</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#inventory">
                    <span class="material-symbols-rounded">inventory_2</span><span data-label>Inventory</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#usp">
                    <span class="material-symbols-rounded">auto_awesome</span><span data-label>USP</span>
                </a>
                <a class="flex items-center gap-3 rounded-xl px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"
                    href="#settings">
                    <span class="material-symbols-rounded">settings</span><span data-label>Settings</span>
                </a>
            </nav>
            <div class="mt-4 rounded-xl p-3 bg-white/80 dark:bg-white/10 ring-1 ring-black/5 dark:ring-white/10">
                <div class="text-[11px] uppercase tracking-wider opacity-70 mb-1">Shop status</div>
                <div class="flex items-center justify-between">
                    <div id="shopStatusLabel" class="flex items-center gap-2 text-sm">
                        <span id="shopStatusIcon" class="material-symbols-rounded text-emerald-500">circle</span>
                        <span id="shopStatusText">Open</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="btnToggleOpen"
                            class="text-xs rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10">Close</button>
                        <button id="btnTogglePause"
                            class="text-xs rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10">Pause</button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="space-y-6">
            <!-- Info bar -->
            <section class="flex flex-wrap items-center justify-between gap-3">
                <div class="text-[12px] opacity-75">Last updated: <span id="lastUpdated">—</span> • Auto‑refresh 30s
                </div>
                <div id="fetchError" class="hidden text-[12px] text-rose-600">Couldn’t load data. Retrying…</div>
            </section>
            <!-- Filters + Search -->
            <section class="glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4 md:p-5">
                <div class="flex flex-col md:flex-row md:items-end gap-3 md:gap-4">
                    <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 flex-1">
                        <label class="block text-xs font-semibold opacity-70">Date range
                            <input id="fltRange" type="date"
                                class="mt-1 w-full rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10" />
                        </label>
                        <label class="block text-xs font-semibold opacity-70">Status
                            <select id="fltStatus"
                                class="mt-1 w-full rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10">
                                <option value="all">All</option>
                                <option value="new">New</option>
                                <option value="processing">Processing</option>
                                <option value="ready">Ready</option>
                                <option value="picked">Picked</option>
                            </select>
                        </label>
                        <label class="block text-xs font-semibold opacity-70">Channel
                            <select id="fltChannel"
                                class="mt-1 w-full rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10">
                                <option value="all">All</option>
                                <option>Walk-in</option>
                                <option>Student app</option>
                                <option>WhatsApp</option>
                            </select>
                        </label>
                        <label class="block text-xs font-semibold opacity-70">Payment
                            <select id="fltPayment"
                                class="mt-1 w-full rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10">
                                <option value="all">All</option>
                                <option>Cash</option>
                                <option>UPI</option>
                                <option>Card</option>
                            </select>
                        </label>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <span
                                class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">search</span>
                            <input id="fltSearch" placeholder="Search orders, customers"
                                class="pl-10 w-64 rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10" />
                        </div>
                        <button id="fltReset"
                            class="rounded-xl px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 text-sm">Reset</button>
                    </div>
                </div>
            </section>

            <!-- KPI cards -->
            <section id="overview" class="grid sm:grid-cols-2 xl:grid-cols-4 gap-4">
                <article class="rounded-2xl p-4 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="flex items-center justify-between">
                        <div class="text-xs uppercase tracking-wider opacity-70">Revenue</div>
                        <span class="material-symbols-rounded text-emerald-500">trending_up</span>
                    </div>
                    <div id="kpiRevenue" class="mt-2 text-2xl font-extrabold">₹0</div>
                    <div id="kpiRevenueDelta" class="text-[12px] opacity-70">—</div>
                </article>
                <article class="rounded-2xl p-4 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="flex items-center justify-between">
                        <div class="text-xs uppercase tracking-wider opacity-70">Orders</div>
                        <span class="material-symbols-rounded text-sky-500">inbox</span>
                    </div>
                    <div id="kpiOrders" class="mt-2 text-2xl font-extrabold">0</div>
                    <div id="kpiOrdersDelta" class="text-[12px] opacity-70">—</div>
                </article>
                <article class="rounded-2xl p-4 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="flex items-center justify-between">
                        <div class="text-xs uppercase tracking-wider opacity-70">Avg Order Value</div>
                        <span class="material-symbols-rounded text-violet-500">payments</span>
                    </div>
                    <div id="kpiAOV" class="mt-2 text-2xl font-extrabold">₹0</div>
                    <div id="kpiAOVDelta" class="text-[12px] opacity-70">—</div>
                </article>
                <article class="rounded-2xl p-4 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="flex items-center justify-between">
                        <div class="text-xs uppercase tracking-wider opacity-70">Pending Payouts</div>
                        <span class="material-symbols-rounded text-amber-500">account_balance_wallet</span>
                    </div>
                    <div id="kpiPayouts" class="mt-2 text-2xl font-extrabold">₹0</div>
                    <div id="kpiPayoutsNote" class="text-[12px] opacity-70">Counter payments</div>
                </article>
            </section>

            <!-- Charts -->
            <section class="grid lg:grid-cols-3 gap-4">
                <div class="lg:col-span-2 rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold">Revenue trend</h3>
                        <div class="text-[12px] opacity-70">Last 14 days</div>
                    </div>
                    <div class="mt-3 h-64">
                        <canvas id="chartRevenue" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div class="rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <h3 class="text-sm font-semibold">Orders by status</h3>
                    <div class="mt-3 h-56">
                        <canvas id="chartStatus" class="w-full h-full"></canvas>
                    </div>
                </div>
            </section>

            <section class="grid lg:grid-cols-3 gap-4">
                <div class="rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <h3 class="text-sm font-semibold">Payment status</h3>
                    <div class="mt-3 h-56">
                        <canvas id="chartPayments" class="w-full h-full"></canvas>
                    </div>
                </div>
                <div class="lg:col-span-2 rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <h3 class="text-sm font-semibold">Capacity & load</h3>
                    <div class="mt-3 grid sm:grid-cols-2 gap-4">
                        <div class="rounded-xl p-3 bg-white/70 dark:bg-white/10 ring-1 ring-black/5 dark:ring-white/10">
                            <div class="flex items-center justify-between text-sm"><span>B&W queue</span><span
                                    class="opacity-70">12 jobs</span></div>
                            <div class="mt-2 h-2 rounded-full bg-black/10 dark:bg-white/10">
                                <div class="h-full w-[62%] rounded-full bg-neutral-900 dark:bg-white"></div>
                            </div>
                        </div>
                        <div class="rounded-xl p-3 bg-white/70 dark:bg-white/10 ring-1 ring-black/5 dark:ring-white/10">
                            <div class="flex items-center justify-between text-sm"><span>Color queue</span><span
                                    class="opacity-70">7 jobs</span></div>
                            <div class="mt-2 h-2 rounded-full bg-black/10 dark:bg-white/10">
                                <div class="h-full w-[38%] rounded-full bg-fuchsia-500"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders table -->
            <section id="orders" class="glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4">
                <div class="flex items-center justify-between gap-2">
                    <h3 class="text-sm font-semibold">Recent orders</h3>
                    <a href="jobs.html"
                        class="text-sm inline-flex items-center gap-1 rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10">
                        Go to Jobs <span class="material-symbols-rounded text-base">chevron_right</span>
                    </a>
                </div>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-[12px] uppercase tracking-wide opacity-70">
                            <tr>
                                <th class="px-2 py-2">Order</th>
                                <th class="px-2 py-2">Customer</th>
                                <th class="px-2 py-2">Pages</th>
                                <th class="px-2 py-2">Amount</th>
                                <th class="px-2 py-2">Status</th>
                                <th class="px-2 py-2">Payment</th>
                                <th class="px-2 py-2">Created</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTbody" class="divide-y divide-black/5 dark:divide-white/10">
                            <!-- rows via JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Payments table -->
            <section id="payments" class="glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Payouts</h3>
                    <button
                        class="text-sm rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10">Export
                        CSV</button>
                </div>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-[12px] uppercase tracking-wide opacity-70">
                            <tr>
                                <th class="px-2 py-2">Payout</th>
                                <th class="px-2 py-2">Period</th>
                                <th class="px-2 py-2">Orders</th>
                                <th class="px-2 py-2">Total</th>
                                <th class="px-2 py-2">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-black/5 dark:divide-white/10">
                            <tr>
                                <td class="px-2 py-2 font-medium">#P-1042</td>
                                <td class="px-2 py-2">Oct 01 → Oct 07</td>
                                <td class="px-2 py-2">126</td>
                                <td class="px-2 py-2">₹27,940</td>
                                <td class="px-2 py-2"><span
                                        class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] bg-emerald-500/15 text-emerald-700 ring-1 ring-emerald-500/30">Paid</span>
                                </td>
                            </tr>
                            <tr>
                                <td class="px-2 py-2 font-medium">#P-1043</td>
                                <td class="px-2 py-2">Oct 08 → Oct 14</td>
                                <td class="px-2 py-2">132</td>
                                <td class="px-2 py-2">₹29,210</td>
                                <td class="px-2 py-2"><span
                                        class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] bg-amber-500/15 text-amber-700 ring-1 ring-amber-500/30">Scheduled</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Customers quick list -->
            <section id="customers" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
                <article class="rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <div class="flex items-center gap-3">
                        <img class="size-10 rounded-full object-cover" src="https://i.pravatar.cc/100?img=11"
                            alt="Customer" loading="lazy">
                        <div>
                            <div class="text-sm font-semibold">Arun Kumar</div>
                            <div class="text-[12px] opacity-70">5 orders · ₹1,340</div>
                        </div>
                    </div>
                </article>
                <article class="rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <div class="flex items-center gap-3">
                        <img class="size-10 rounded-full object-cover" src="https://i.pravatar.cc/100?img=15"
                            alt="Customer" loading="lazy">
                        <div>
                            <div class="text-sm font-semibold">Sneha Iyer</div>
                            <div class="text-[12px] opacity-70">3 orders · ₹890</div>
                        </div>
                    </div>
                </article>
                <article class="rounded-2xl glass ring-1 ring-black/5 dark:ring-white/10 p-4">
                    <div class="flex items-center gap-3">
                        <img class="size-10 rounded-full object-cover" src="https://i.pravatar.cc/100?img=32"
                            alt="Customer" loading="lazy">
                        <div>
                            <div class="text-sm font-semibold">Faizan Ali</div>
                            <div class="text-[12px] opacity-70">7 orders · ₹2,040</div>
                        </div>
                    </div>
                </article>
            </section>

            <!-- USP highlights -->
            <section id="usp" class="grid md:grid-cols-3 gap-4">
                <article class="rounded-2xl p-5 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="size-10 grid place-content-center rounded-xl bg-brand-500/15 text-brand-600 mb-2"><span
                            class="material-symbols-rounded">qr_code_2</span></div>
                    <h3 class="font-semibold">OTP + QR pickup</h3>
                    <p class="text-[13px] opacity-90 mt-1">No mix‑ups at counter. Verify in one tap.</p>
                </article>
                <article class="rounded-2xl p-5 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="size-10 grid place-content-center rounded-xl bg-brand-500/15 text-brand-600 mb-2"><span
                            class="material-symbols-rounded">home_iot_device</span></div>
                    <h3 class="font-semibold">No new hardware</h3>
                    <p class="text-[13px] opacity-90 mt-1">Works with the printers and software you already use.</p>
                </article>
                <article class="rounded-2xl p-5 glass ring-1 ring-black/5 dark:ring-white/10">
                    <div class="size-10 grid place-content-center rounded-xl bg-brand-500/15 text-brand-600 mb-2"><span
                            class="material-symbols-rounded">tune</span></div>
                    <h3 class="font-semibold">Crystal‑clear tickets</h3>
                    <p class="text-[13px] opacity-90 mt-1">Copies, duplex, GSM, N‑up, finishing — zero confusion.</p>
                </article>
            </section>

            <!-- Settings CTA -->
            <section id="settings"
                class="glass rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-5 flex items-center justify-between">
                <div>
                    <h3 class="text-sm font-semibold">Tune your shop</h3>
                    <p class="text-[13px] opacity-80">Update pricing hints, timings, and capabilities.</p>
                </div>
                <a href="profile.html"
                    class="inline-flex items-center gap-2 rounded-xl px-4 py-2 bg-brand-500 text-white text-sm font-semibold hover:bg-brand-700">
                    <span class="material-symbols-rounded text-base">settings</span> Open settings
                </a>
            </section>
        </main>
    </div>

    <!-- Footer mini -->
    <footer class="border-t border-black/5 dark:border-white/10">
        <div class="container py-8 text-[13px] flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="opacity-80">© <span id="y"></span> Paper X • Shop Dashboard</div>
            <div class="flex items-center gap-3">
                <a href="../index.html" class="hover:underline">Print Home</a>
                <a href="jobs.html" class="hover:underline">Jobs</a>
                <a href="profile.html" class="hover:underline">Settings</a>
            </div>
        </div>
    </footer>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Config/Auth if needed later -->
    <script src="../../config.js"></script>
    <script src="../../auth.js" defer></script>

    <script>
        // Year + Theme toggles
        const yEl = document.getElementById('y'); if (yEl) yEl.textContent = new Date().getFullYear();
        const toggles = [document.getElementById('themeToggle'), document.getElementById('themeToggleSm')].filter(Boolean);
        function syncThemeIcon() {
            const dark = document.documentElement.classList.contains('dark');
            toggles.forEach(btn => { const i = btn.querySelector('.material-symbols-rounded'); if (i) i.textContent = dark ? 'light_mode' : 'dark_mode'; });
        }
        toggles.forEach(btn => btn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('px_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            syncThemeIcon();
        }));
        syncThemeIcon();
    </script>

    <script>
        // Live data wiring with real backend (FastAPI)
        const API = (window.API_BASE || window.__API_BASE || '').replace(/\/$/, '');
        const getToken = () => { try { return localStorage.getItem('px_token'); } catch (_) { return null; } };

        // Badges
        const badge = (txt, tone) => `<span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] ${tone.bg} ${tone.text} ring-1 ${tone.ring}">${txt}</span>`;
        const tones = {
            submitted: { bg: 'bg-sky-500/15', text: 'text-sky-700', ring: 'ring-sky-500/30' },
            accepted: { bg: 'bg-indigo-500/15', text: 'text-indigo-700', ring: 'ring-indigo-500/30' },
            printing: { bg: 'bg-amber-500/15', text: 'text-amber-700', ring: 'ring-amber-500/30' },
            ready: { bg: 'bg-emerald-500/15', text: 'text-emerald-700', ring: 'ring-emerald-500/30' },
            completed: { bg: 'bg-neutral-500/15', text: 'text-neutral-700', ring: 'ring-neutral-500/30' },
            cancelled: { bg: 'bg-rose-500/15', text: 'text-rose-700', ring: 'ring-rose-500/30' },
            new: { bg: 'bg-sky-500/15', text: 'text-sky-700', ring: 'ring-sky-500/30' },
            processing: { bg: 'bg-amber-500/15', text: 'text-amber-700', ring: 'ring-amber-500/30' },
            picked: { bg: 'bg-neutral-500/15', text: 'text-neutral-700', ring: 'ring-neutral-500/30' },
        };

        // State
        let JOBS = [];
        let chartRev = null, chartSt = null, chartPay = null;

        // Utils
        const Rs = n => typeof n === 'number' && isFinite(n) ? `₹${n.toFixed(0)}` : '₹0';
        const fmtTime = s => { try { const d = new Date(s); return d.toLocaleString([], { hour: '2-digit', minute: '2-digit' }); } catch (_) { return s || ''; } };
        const fmtDate = s => { try { const d = new Date(s); return d.toLocaleDateString(); } catch (_) { return s || ''; } };
        const clamp14 = () => {
            const days = []; const labels = [];
            const now = new Date();
            for (let i = 13; i >= 0; i--) { const d = new Date(now); d.setDate(now.getDate() - i); const key = d.toISOString().slice(0, 10); days.push(key); labels.push(d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })); }
            return { days, labels };
        };

        // Render Orders table
        function renderOrders(list) {
            const tbody = document.getElementById('ordersTbody');
            if (!tbody) return;
            tbody.innerHTML = (list || []).map(o => {
                const status = o.status || 'submitted';
                const tone = tones[status] || tones.submitted;
                const pages = (o.estimated_pages != null ? o.estimated_pages : (o.settings && (o.settings.pages || o.settings.page_count))) || '-';
                const amt = (o.estimated_price != null ? o.estimated_price : null);
                const cust = o.contact_name || o.customer_name || '—';
                return `
          <tr>
            <td class="px-2 py-2 font-medium">${o.id || '—'}</td>
            <td class="px-2 py-2">${cust}</td>
            <td class="px-2 py-2">${pages}</td>
            <td class="px-2 py-2">${amt == null ? '—' : Rs(amt)}</td>
            <td class="px-2 py-2">${badge(status, tone)}</td>
            <td class="px-2 py-2">Counter</td>
            <td class="px-2 py-2">${fmtDate(o.created_at) || '—'}</td>
          </tr>`;
            }).join('');
        }

        // Filters
        const fRange = document.getElementById('fltRange');
        const fStatus = document.getElementById('fltStatus');
        const fChannel = document.getElementById('fltChannel');
        const fPayment = document.getElementById('fltPayment');
        const fSearch = document.getElementById('fltSearch');
        const fReset = document.getElementById('fltReset');
        function applyFilters() {
            const sTxt = (fSearch.value || '').toLowerCase();
            const sSt = fStatus.value;
            const sPay = fPayment.value;
            const filtered = (JOBS || []).filter(o =>
                (sSt === 'all' || (o.status || '') === sSt) &&
                (sPay === 'all' || sPay === 'Counter') &&
                (sTxt === '' || `${o.id || ''} ${o.contact_name || ''} ${(o.estimated_pages || '')}`.toLowerCase().includes(sTxt))
            );
            renderOrders(filtered);
        }
        ;[fStatus, fPayment].forEach(el => el && el.addEventListener('change', applyFilters));
        if (fSearch) fSearch.addEventListener('input', applyFilters);
        if (fReset) fReset.addEventListener('click', () => { if (fRange) fRange.value = ''; if (fStatus) fStatus.value = 'all'; if (fChannel) fChannel.value = 'all'; if (fPayment) fPayment.value = 'all'; if (fSearch) fSearch.value = ''; renderOrders(JOBS); });

        // KPIs
        function updateKPIs(jobs) {
            const revEl = document.getElementById('kpiRevenue');
            const ordEl = document.getElementById('kpiOrders');
            const aovEl = document.getElementById('kpiAOV');
            const payEl = document.getElementById('kpiPayouts');
            const revDeltaEl = document.getElementById('kpiRevenueDelta');
            const ordDeltaEl = document.getElementById('kpiOrdersDelta');
            const aovDeltaEl = document.getElementById('kpiAOVDelta');

            const completed = (jobs || []).filter(j => (j.status || '') === 'completed');
            const revenue = completed.reduce((acc, j) => acc + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            const orders = (jobs || []).length;
            const aov = (completed.length ? (revenue / completed.length) : 0);

            // 14-day delta calculations (last 7 vs previous 7)
            const { days } = clamp14();
            const dailyRev = days.map(key => (jobs || []).filter(j => (j.status || '') === 'completed' && (j.created_at || '').slice(0, 10) === key).reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0));
            const dailyOrd = days.map(key => (jobs || []).filter(j => (j.created_at || '').slice(0, 10) === key).length);
            const sum = (arr, a, b) => arr.slice(a, b).reduce((x, y) => x + y, 0);
            const revLast = sum(dailyRev, 7, 14), revPrev = sum(dailyRev, 0, 7);
            const ordLast = sum(dailyOrd, 7, 14), ordPrev = sum(dailyOrd, 0, 7);
            const pct = (now, prev) => {
                if (!prev && !now) return 0; if (!prev) return 100; return ((now - prev) / prev) * 100;
            };
            const revPct = pct(revLast, revPrev);
            const ordPct = pct(ordLast, ordPrev);
            const aovLast = (ordLast ? (revLast / Math.max(1, (jobs || []).filter(j => (j.status || '') === 'completed' && days.slice(7, 14).includes((j.created_at || '').slice(0, 10))).length)) : 0);
            const aovPrev = (ordPrev ? (revPrev / Math.max(1, (jobs || []).filter(j => (j.status || '') === 'completed' && days.slice(0, 7).includes((j.created_at || '').slice(0, 10))).length)) : 0);
            const aovPct = pct(aovLast, aovPrev);

            if (revEl) revEl.textContent = Rs(revenue);
            if (ordEl) ordEl.textContent = String(orders);
            if (aovEl) aovEl.textContent = Rs(aov);
            if (payEl) payEl.textContent = Rs(0); // No online payouts yet
            if (revDeltaEl) revDeltaEl.textContent = `${revPct >= 0 ? '+' : ''}${revPct.toFixed(1)}% vs last 7d`;
            if (ordDeltaEl) ordDeltaEl.textContent = `${ordPct >= 0 ? '+' : ''}${ordPct.toFixed(1)}% vs last 7d`;
            if (aovDeltaEl) aovDeltaEl.textContent = `${aovPct >= 0 ? '+' : ''}${aovPct.toFixed(1)}% vs last 7d`;
        }

        // Charts init + update
        function initCharts() {
            const ctxRev = document.getElementById('chartRevenue');
            const ctxSt = document.getElementById('chartStatus');
            const ctxPay = document.getElementById('chartPayments');
            if (ctxRev && !chartRev) {
                chartRev = new Chart(ctxRev, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Revenue', data: [], borderColor: '#9E4B8A',
                            backgroundColor: 'rgba(158,75,138,0.15)', fill: true, tension: .35, pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.06)' } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            if (ctxSt && !chartSt) {
                chartSt = new Chart(ctxSt, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Orders', data: [], backgroundColor: ['#4C2A59', '#9E4B8A', '#B06AB3', '#7E57C2', '#26A69A', '#EF5350'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }
            if (ctxPay && !chartPay) {
                chartPay = new Chart(ctxPay, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#1E1E2F', '#9E4B8A'] }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } }
                });
            }
        }

        function updateCharts(jobs) {
            const { days, labels } = clamp14();
            // Revenue series: sum completed revenue per day
            const daily = days.map(key => (jobs || []).filter(j => (j.status || '') === 'completed' && (j.created_at || '').slice(0, 10) === key).reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0));
            if (chartRev) { chartRev.data.labels = labels; chartRev.data.datasets[0].data = daily; chartRev.update(); }
            // Order status distribution
            const total = (jobs || []).length;
            const sts = ['submitted', 'accepted', 'printing', 'ready', 'completed', 'cancelled'];
            const counts = sts.map(s => (jobs || []).filter(j => (j.status || '') === s).length);
            if (chartSt) { chartSt.data.labels = sts.map(s => s[0].toUpperCase() + s.slice(1)); chartSt.data.datasets[0].data = counts; chartSt.update(); }
            // Payment status: Counter (completed) vs Pending (not completed)
            const completed = (jobs || []).filter(j => (j.status || '') === 'completed').length;
            const pending = total - completed;
            if (chartPay) { chartPay.data.labels = ['Counter (Completed)', 'Pending']; chartPay.data.datasets[0].data = [completed, pending]; chartPay.update(); }
        }

        // Load data
        async function fetchJSON(url, token) {
            const res = await fetch(url, { headers: token ? { Authorization: `Bearer ${token}` } : {} });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        async function loadData() {
            try {
                initCharts();
                const token = getToken();
                if (!API) { console.warn('API_BASE not set'); return; }
                if (!token) { console.warn('No auth token; showing placeholders'); return; }
                // Ensure shop resolved (also populates nav avatar via auth.js)
                const shop = await fetchJSON(`${API}/api/shop/me`, token).catch(() => null);
                if (shop) applyShopState(shop);
                const data = await fetchJSON(`${API}/api/shop/jobs`, token);
                const jobs = (data && data.jobs) || [];
                // Normalize date strings
                jobs.forEach(j => { if (!j.created_at && j.createdAt) j.created_at = j.createdAt; if (typeof j.settings === 'string') { try { j.settings = JSON.parse(j.settings); } catch (_) { } } });
                JOBS = jobs.sort((a, b) => String(b.created_at || '').localeCompare(String(a.created_at || '')));
                updateKPIs(JOBS);
                updateCharts(JOBS);
                renderOrders(JOBS);
                setLastUpdated();
                setFetchError(false);
            } catch (e) {
                console.warn('Failed to load dashboard data:', e);
                setFetchError(true);
            }
        }

        // Last updated + error
        function setLastUpdated() { try { const el = document.getElementById('lastUpdated'); if (el) el.textContent = new Date().toLocaleTimeString(); } catch (_) { } }
        function setFetchError(v) { const b = document.getElementById('fetchError'); if (b) b.classList.toggle('hidden', !v); }

        // Shop status controls
        function applyShopState(shop) {
            try {
                const isOpen = !!shop.is_open;
                const paused = !!shop.paused;
                const icon = document.getElementById('shopStatusIcon');
                const text = document.getElementById('shopStatusText');
                const btnOpen = document.getElementById('btnToggleOpen');
                const btnPause = document.getElementById('btnTogglePause');
                if (icon) icon.classList.toggle('text-emerald-500', isOpen && !paused);
                if (icon) icon.classList.toggle('text-rose-500', !isOpen || paused);
                if (text) text.textContent = paused ? 'Paused' : (isOpen ? 'Open' : 'Closed');
                if (btnOpen) btnOpen.textContent = (isOpen ? 'Close' : 'Open');
                if (btnPause) btnPause.textContent = (paused ? 'Resume' : 'Pause');
                if (btnOpen && !btnOpen.__bound) { btnOpen.__bound = true; btnOpen.addEventListener('click', async () => { await patchShop({ is_open: !isOpen }); loadData(); }); }
                if (btnPause && !btnPause.__bound) { btnPause.__bound = true; btnPause.addEventListener('click', async () => { await patchShop({ paused: !paused }); loadData(); }); }
            } catch (_) { }
        }
        async function patchShop(payload) {
            try {
                const token = getToken(); if (!token) return;
                await fetch(`${API}/api/shop/me`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify(payload || {}) });
            } catch (_) { }
        }

        // Kickoff + poll
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', loadData, { once: true });
        else loadData();
        setInterval(loadData, 30000); // refresh every 30s
    </script>
</body>

</html>