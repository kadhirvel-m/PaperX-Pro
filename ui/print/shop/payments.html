<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payments — Paper X</title>
    <link rel="icon" type="image/x-icon" href="../../assets/img/favicon.svg">
    <!-- Fonts / Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <!-- Tailwind build -->
    <link rel="stylesheet" href="../../assets/css/tailwind.css" />
    <style>
        :root {
            --px-accent: #9E4B8A;
            --px-accent-700: #4C2A59;
            --px-bg-dark: #1E1E2F;
            --px-panel: rgba(255, 255, 255, 0.02);
        }

        .material-symbols-rounded {
            vertical-align: -6px
        }

        /* enhanced visual tokens (matching root index theme) */
        .glass-card {
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(158, 75, 138, 0.12);
        }

        .dark .glass-card {
            background: rgba(30, 30, 47, 0.72);
            border-color: rgba(255, 255, 255, 0.06);
            box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
        }

        .shadow-glow {
            box-shadow: 0 12px 34px rgba(158, 75, 138, 0.14);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: inline-grid;
            place-items: center;
            color: #fff
        }

        .stat-accent {
            background: linear-gradient(90deg, var(--px-accent), var(--px-accent-700));
        }

        .stat-accent-blue {
            background: linear-gradient(90deg, #60A5FA, #3B82F6);
        }

        .stat-accent-amber {
            background: linear-gradient(90deg, #F59E0B, #D97706);
        }

        .stat-accent-violet {
            background: linear-gradient(90deg, #A78BFA, #7C3AED);
        }

        .glass {
            background: rgba(255, 255, 255, .72);
            backdrop-filter: blur(12px)
        }

        .dark .glass {
            background: rgba(30, 30, 47, .55)
        }

        .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .08)
        }

        .dark .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
        }

        /* ambient blobs for subtle background depth */
        .ambient-wrap {
            pointer-events: none;
            position: fixed;
            inset: 0;
            z-index: -10;
        }

        .ambient-blob {
            position: absolute;
            border-radius: 9999px;
            filter: blur(80px);
            opacity: .6;
            transform: translateZ(0);
        }

        .ambient-blob.b1 {
            width: 420px;
            height: 420px;
            left: -6rem;
            top: -6rem;
            background: rgba(158, 75, 138, 0.18);
        }

        .ambient-blob.b2 {
            width: 360px;
            height: 360px;
            right: -5rem;
            top: 35%;
            background: rgba(76, 42, 89, 0.14);
        }

        /* text gradient helper (uses safe background-clip values) */
        .gradient-hero-text {
            display: inline-block;
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, var(--px-accent), #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 5s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .dark body {
            background-image: linear-gradient(135deg, #1E1E2F 0%, #201934 40%, #141321 100%);
            background-attachment: fixed
        }

        body {
            background-image: linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%);
            background-attachment: fixed
        }

        /* Hero title */
        .hero-title {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em
        }
    </style>
    <style>
        /* Non-boxy payments UI enhancements */
        .payments-hero {
            gap: 1rem;
            align-items: stretch;
        }

        .kpi-card {
            border-radius: 14px;
            padding: 1rem;
            transition: transform .22s ease, box-shadow .22s ease;
            transform: translateZ(0);
            overflow: hidden;
        }

        .kpi-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 40px rgba(16, 16, 24, 0.12);
        }

        .kpi-card .text-2xl {
            letter-spacing: -0.01em;
        }

        .kpi-meta {
            color: rgba(30, 30, 47, 0.6);
        }

        .dark .kpi-meta {
            color: rgba(255, 255, 255, 0.72);
        }

        /* Floating panels for charts */
        .panel-floating {
            border-radius: 16px;
            padding: 1rem;
            transition: transform .22s ease, box-shadow .22s ease;
        }

        .panel-floating:hover {
            transform: translateY(-6px);
            box-shadow: 0 22px 48px rgba(16, 16, 24, 0.14);
        }

        /* Tables: softer list-like rows */
        .table-card {
            border-radius: 14px;
            padding: .75rem;
        }

        .table-card table thead th {
            border-bottom: none;
        }

        .table-card table tbody tr {
            background: transparent;
            transition: background .12s ease, transform .12s ease;
        }

        .table-card table tbody tr:hover {
            background: rgba(0, 0, 0, 0.03);
            transform: translateY(-2px);
        }

        .dark .table-card table tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .table-card .px-2 {
            padding-left: .75rem;
            padding-right: .75rem;
        }

        /* Reduce strong borders and use soft separators */
        .glass-card {
            border: none;
        }

        .ring-soft {
            box-shadow: none;
        }

        /* Compact filters section to reduce height */
        .filters-compact {
            padding-top: .45rem;
            padding-bottom: .45rem;
        }

        .filters-compact .mt-1 {
            margin-top: .25rem;
        }
    </style>
    <script>
        // Theme boot (no flash) + auth guard
        (function () {
            try {
                var stored = localStorage.getItem('px_theme');
                var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var isDark = stored ? stored === 'dark' : !!prefersDark;
                if (isDark) document.documentElement.classList.add('dark');
            } catch (_) { }
            try {
                var t = localStorage.getItem('px_token');
                if (!t) { var next = encodeURIComponent(location.pathname + (location.search || '')); location.replace('login.html?next=' + next); }
            } catch (_) { location.replace('login.html'); }
        })();
    </script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white">
    <!-- Ambient gradients -->
    <div aria-hidden="true" class="ambient-wrap">
        <div class="ambient-blob b1"></div>
        <div class="ambient-blob b2"></div>
    </div>
    <!-- App Bar -->
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Print Home">
                <img src="../../assets/img/logo-light.svg" alt="Paper X" class="h-8 w-auto dark:hidden">
                <img src="../../assets/img/logo-dark.svg" alt="Paper X" class="h-8 w-auto hidden dark:block">
            </a>
            <nav class="hidden md:flex items-center gap-2 text-sm">
                <a href="dashboard.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"><span
                        class="material-symbols-rounded text-base">dashboard</span> Dashboard</a>
                <a href="jobs.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"><span
                        class="material-symbols-rounded text-base">assignment</span> Jobs</a>
                <a href="payments.html"
                    class="rounded-full px-3 py-2 bg-brand-500/10 text-brand-700 dark:text-brand-200 ring-1 ring-brand-500/30"><span
                        class="material-symbols-rounded text-base">payments</span> Payments</a>
                <a href="profile.html" class="rounded-full px-3 py-2 hover:bg-black/5 dark:hover:bg-white/10"><span
                        class="material-symbols-rounded text-base">storefront</span> Shop Profile</a>
                <button id="themeToggle"
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Toggle theme"><span class="material-symbols-rounded">dark_mode</span><span
                        class="hidden sm:block">Theme</span></button>
            </nav>
            <div class="md:hidden flex items-center gap-2">
                <a href="dashboard.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Dashboard"><span class="material-symbols-rounded">dashboard</span></a>
                <a href="jobs.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Jobs"><span class="material-symbols-rounded">assignment</span></a>
                <a href="payments.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft bg-brand-500/10 text-brand-600 dark:text-brand-200"
                    title="Payments"><span class="material-symbols-rounded">payments</span></a>
                <a href="profile.html"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    title="Profile"><span class="material-symbols-rounded">storefront</span></a>
                <button id="themeToggleSm"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-soft hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Toggle theme"><span class="material-symbols-rounded">dark_mode</span></button>
            </div>
        </div>
    </header>

    <main class="container max-w-6xl py-6 space-y-6">
        <!-- Info bar -->
        <section class="flex flex-wrap items-center justify-between gap-3">
            <div class="text-[12px] opacity-75">Last updated: <span id="lastUpdated">—</span> • Auto‑refresh 30s</div>
            <div id="fetchError" class="hidden text-[12px] text-rose-600">Couldn’t load payments. Retrying…</div>
        </section>

        <!-- Filters -->
        <section class="glass-card rounded-2xl ring-soft p-3 md:p-4 filters-compact">
            <div class="flex flex-col md:flex-row md:items-end gap-3 md:gap-4">
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3 flex-1">
                    <label class="block text-xs font-semibold opacity-70">Date
                        <input id="fltDate" type="date"
                            class="mt-1 w-full rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10" />
                    </label>
                    <label class="block text-xs font-semibold opacity-70">Status
                        <select id="fltStatus"
                            class="mt-1 w-full rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10">
                            <option value="all">All</option>
                            <option value="collected">Collected</option>
                            <option value="pending">Pending</option>
                        </select>
                    </label>
                    <label class="block text-xs font-semibold opacity-70">Amount (>=)
                        <input id="fltMin" type="number" min="0" placeholder="₹"
                            class="mt-1 w-full rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10" />
                    </label>
                    <label class="block text-xs font-semibold opacity-70">Search
                        <input id="fltSearch" placeholder="Search id or customer"
                            class="mt-1 w-full rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 bg-white/80 dark:bg-white/10" />
                    </label>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btnExport"
                        class="rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 text-sm"><span
                            class="material-symbols-rounded text-base">file_save</span> Export CSV</button>
                    <button id="fltReset"
                        class="rounded-xl px-3 py-1.5 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 text-sm">Reset</button>
                </div>
            </div>
        </section>

        <!-- KPIs -->
        <section class="payments-hero grid sm:grid-cols-2 xl:grid-cols-4 gap-4">
            <article class="rounded-2xl p-4 glass-card ring-soft shadow-glow">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="stat-icon stat-accent"><span class="material-symbols-rounded">payments</span></div>
                        <div>
                            <div class="text-xs uppercase tracking-wider opacity-70">Collected today</div>
                            <div id="kCollectedToday" class="mt-1 text-2xl font-extrabold">₹0</div>
                        </div>
                    </div>
                    <div id="kCollectedTodayDelta" class="text-[12px] opacity-70">—</div>
                </div>
            </article>
            <article class="rounded-2xl p-4 glass-card ring-soft shadow-glow kpi-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="stat-icon stat-accent-blue"><span
                                class="material-symbols-rounded">calendar_month</span></div>
                        <div>
                            <div class="text-xs uppercase tracking-wider opacity-70">This week</div>
                            <div id="kWeek" class="mt-1 text-2xl font-extrabold">₹0</div>
                        </div>
                    </div>
                    <div id="kWeekDelta" class="text-[12px] opacity-70">—</div>
                </div>
            </article>
            <article class="rounded-2xl p-4 glass-card ring-soft shadow-glow kpi-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="stat-icon stat-accent-amber"><span class="material-symbols-rounded">hourglass</span>
                        </div>
                        <div>
                            <div class="text-xs uppercase tracking-wider opacity-70">Pending</div>
                            <div id="kPending" class="mt-1 text-2xl font-extrabold">₹0</div>
                        </div>
                    </div>
                    <div class="text-[12px] opacity-70">Across open jobs</div>
                </div>
            </article>
            <article class="rounded-2xl p-4 glass-card ring-soft shadow-glow kpi-card">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="stat-icon stat-accent-violet"><span
                                class="material-symbols-rounded">monitoring</span></div>
                        <div>
                            <div class="text-xs uppercase tracking-wider opacity-70">Avg ticket</div>
                            <div id="kAOV" class="mt-1 text-2xl font-extrabold">₹0</div>
                        </div>
                    </div>
                    <div id="kAOVDelta" class="text-[12px] opacity-70">—</div>
                </div>
            </article>
        </section>

        <!-- Charts -->
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2 rounded-2xl glass-card ring-soft p-4 panel-floating">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold">Collected trend</h3>
                    <div class="text-[12px] opacity-70">Last 14 days</div>
                </div>
                <div class="mt-3 h-64"><canvas id="chartTrend" class="w-full h-full"></canvas></div>
            </div>
            <div class="rounded-2xl glass-card ring-soft p-4 panel-floating">
                <h3 class="text-sm font-semibold">Status</h3>
                <div class="mt-3 h-56"><canvas id="chartStatus" class="w-full h-full"></canvas></div>
            </div>
        </section>
        <section class="grid lg:grid-cols-3 gap-4">
            <div class="rounded-2xl glass-card ring-soft p-4 panel-floating">
                <h3 class="text-sm font-semibold">Collected vs Pending</h3>
                <div class="mt-3 h-56"><canvas id="chartSplit" class="w-full h-full"></canvas></div>
            </div>
            <div class="lg:col-span-2 rounded-2xl glass-card ring-soft p-4 table-card">
                <h3 class="text-sm font-semibold">Weekly summaries</h3>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-[12px] uppercase tracking-wide opacity-70">
                            <tr>
                                <th class="px-2 py-2">Week</th>
                                <th class="px-2 py-2">Orders</th>
                                <th class="px-2 py-2">Collected</th>
                                <th class="px-2 py-2">Pending</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyTbody" class="divide-y divide-black/5 dark:divide-white/10"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tables -->
        <section class="grid lg:grid-cols-2 gap-4">
            <div class="rounded-2xl glass-card ring-soft p-4 table-card">
                <div class="flex items-center justify-between gap-2">
                    <h3 class="text-sm font-semibold">Collected</h3>
                </div>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-[12px] uppercase tracking-wide opacity-70">
                            <tr>
                                <th class="px-2 py-2">Order</th>
                                <th class="px-2 py-2">Customer</th>
                                <th class="px-2 py-2">Amount</th>
                                <th class="px-2 py-2">Date</th>
                                <th class="px-2 py-2">Action</th>
                            </tr>
                        </thead>
                        <tbody id="collectedTbody" class="divide-y divide-black/5 dark:divide-white/10"></tbody>
                    </table>
                </div>
            </div>
            <div class="rounded-2xl glass-card ring-soft p-4 table-card">
                <div class="flex items-center justify-between gap-2">
                    <h3 class="text-sm font-semibold">Pending</h3>
                </div>
                <div class="mt-3 overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-left text-[12px] uppercase tracking-wide opacity-70">
                            <tr>
                                <th class="px-2 py-2">Order</th>
                                <th class="px-2 py-2">Customer</th>
                                <th class="px-2 py-2">Est. Amount</th>
                                <th class="px-2 py-2">Status</th>
                                <th class="px-2 py-2">Created</th>
                                <th class="px-2 py-2">Action</th>
                            </tr>
                        </thead>
                        <tbody id="pendingTbody" class="divide-y divide-black/5 dark:divide-white/10"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Conversations (modal) -->
        <div id="convModal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-close></div>
            <div class="relative z-10 flex items-center justify-center min-h-full p-4">
                <div
                    class="w-full max-w-2xl rounded-2xl ring-1 ring-black/5 dark:ring-white/10 shadow-2xl p-4 bg-white/95 dark:bg-brand-900/95">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold">Conversation</div>
                        <button class="px-2 py-1 rounded-md text-[12px] ring-1 ring-black/10 dark:ring-white/15"
                            data-close>Close</button>
                    </div>
                    <div id="convContent" class="text-[13px] space-y-3 max-h-[60vh] overflow-auto"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-t border-black/5 dark:border-white/10">
        <div class="container py-8 text-[13px] flex flex-col md:flex-row items-center justify-between gap-3">
            <div class="opacity-80">© <span id="y"></span> Paper X • Payments</div>
            <div class="flex items-center gap-3">
                <a href="dashboard.html" class="hover:underline">Dashboard</a>
                <a href="jobs.html" class="hover:underline">Jobs</a>
                <a href="profile.html" class="hover:underline">Settings</a>
            </div>
        </div>
    </footer>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="../../config.js"></script>
    <script src="../../auth.js" defer></script>
    <script>
        const Rs = n => typeof n === 'number' && isFinite(n) ? '₹' + n.toFixed(0) : '₹0';
        const API = (window.API_BASE || window.__API_BASE || '').replace(/\/$/, '');
        const getToken = () => { try { return localStorage.getItem('px_token'); } catch (_) { return null; } };
        const yEl = document.getElementById('y'); if (yEl) yEl.textContent = new Date().getFullYear();
        const toggles = [document.getElementById('themeToggle'), document.getElementById('themeToggleSm')].filter(Boolean);
        function syncThemeIcon() { const dark = document.documentElement.classList.contains('dark'); toggles.forEach(btn => { const i = btn.querySelector('.material-symbols-rounded'); if (i) i.textContent = dark ? 'light_mode' : 'dark_mode'; }); }
        toggles.forEach(btn => btn.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.setItem('px_theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); syncThemeIcon(); })); syncThemeIcon();

        // ACCENT color from CSS - charts and accents should follow the CSS variable
        const ACCENT = (getComputedStyle(document.documentElement).getPropertyValue('--px-accent') || '#9E4B8A').trim();
        function hexToRgba(hex, a) { try { hex = (hex || '').replace('#', ''); if (hex.length === 3) hex = hex.split('').map(c => c + c).join(''); const r = parseInt(hex.slice(0, 2), 16), g = parseInt(hex.slice(2, 4), 16), b = parseInt(hex.slice(4, 6), 16); return `rgba(${r},${g},${b},${a})`; } catch (_) { return `rgba(158,75,138,${a})`; } }

        let JOBS = []; let chartTrend = null, chartStatus = null, chartSplit = null;
        // Helper: determine a completion timestamp for a job (prefer explicit completed/released, fall back to updated_at, then created_at)
        function completionTs(j) {
            return (j && (j.completed_at || j.released_at || j.updated_at || j.completedAt || j.releasedAt || j.updatedAt || j.created_at || j.createdAt)) || '';
        }
        function completionDateKey(j) { const ts = completionTs(j); return ts ? String(ts).slice(0, 10) : ''; }
        const tones = { submitted: ['bg-sky-500/15', 'text-sky-700', 'ring-sky-500/30'], accepted: ['bg-indigo-500/15', 'text-indigo-700', 'ring-indigo-500/30'], printing: ['bg-amber-500/15', 'text-amber-700', 'ring-amber-500/30'], ready: ['bg-emerald-500/15', 'text-emerald-700', 'ring-emerald-500/30'], completed: ['bg-neutral-500/15', 'text-neutral-700', 'ring-neutral-500/30'], cancelled: ['bg-rose-500/15', 'text-rose-700', 'ring-rose-500/30'] };
        const badge = (txt, t) => `<span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[11px] ${t[0]} ${t[1]} ring-1 ${t[2]}">${txt}</span>`;

        function clamp14() { const days = [], labels = []; const now = new Date(); for (let i = 13; i >= 0; i--) { const d = new Date(now); d.setDate(now.getDate() - i); const key = d.toISOString().slice(0, 10); days.push(key); labels.push(d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })); } return { days, labels }; }

        function setFetchError(v) { const b = document.getElementById('fetchError'); if (b) b.classList.toggle('hidden', !v); }
        function setLastUpdated() { const el = document.getElementById('lastUpdated'); if (el) el.textContent = new Date().toLocaleTimeString(); }

        function renderTables() {
            const collected = (JOBS || []).filter(j => (j.status || '') === 'completed');
            const pending = (JOBS || []).filter(j => (j.status || '') !== 'completed');
            const cT = document.getElementById('collectedTbody');
            const pT = document.getElementById('pendingTbody');
            cT.innerHTML = collected.map(j => {
                const amt = typeof j.estimated_price === 'number' ? j.estimated_price : 0;
                const cust = j.contact_name || j.customer_name || '—';
                const dateDisplay = completionTs(j) ? String(completionTs(j)).replace('T', ' ').slice(0, 16) : ((j.created_at || '').replace('T', ' ').slice(0, 16));
                return `<tr>
                    <td class="px-2 py-2 font-medium">${(j.id || '').slice(0, 8)}</td>
                    <td class="px-2 py-2">${cust}</td>
                    <td class="px-2 py-2">${Rs(amt)}</td>
                    <td class="px-2 py-2">${dateDisplay}</td>
                    <td class="px-2 py-2"><button class="text-sm rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10" data-conv="${j.id}">View</button></td>
                </tr>`;
            }).join('');
            pT.innerHTML = pending.map(j => {
                const amt = typeof j.estimated_price === 'number' ? j.estimated_price : null;
                const cust = j.contact_name || j.customer_name || '—';
                const st = String(j.status || ''); const t = tones[st] || tones.submitted;
                return `<tr>
          <td class="px-2 py-2 font-medium">${(j.id || '').slice(0, 8)}</td>
          <td class="px-2 py-2">${cust}</td>
          <td class="px-2 py-2">${amt == null ? '—' : Rs(amt)}</td>
          <td class="px-2 py-2">${badge(st[0].toUpperCase() + st.slice(1), t)}</td>
                    <td class="px-2 py-2">${(j.created_at || '').replace('T', ' ').slice(0, 16)}</td>
          <td class="px-2 py-2"><button class="text-sm rounded-full px-3 py-1 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10" data-conv="${j.id}">View</button></td>
        </tr>`;
            }).join('');
            // bind
            document.querySelectorAll('[data-conv]').forEach(btn => btn.addEventListener('click', () => openConversation(btn.getAttribute('data-conv'))));
        }

        function updateKPIs() {
            const todayKey = new Date().toISOString().slice(0, 10);
            const isToday = j => completionDateKey(j) === todayKey && (j.status || '') === 'completed';
            const todayJobs = (JOBS || []).filter(isToday);
            const collectedToday = todayJobs.reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            const completed = (JOBS || []).filter(j => (j.status || '') === 'completed');
            const revenue = completed.reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            const aov = completed.length ? (revenue / completed.length) : 0;
            // week
            const now = new Date(); const day = now.getDay(); const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday
            const weekStart = new Date(now.setDate(diff)); const ws = weekStart.toISOString().slice(0, 10);
            const thisWeek = (JOBS || []).filter(j => (j.status || '') === 'completed' && completionDateKey(j) >= ws);
            const weekAmt = thisWeek.reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            const pendingAmt = (JOBS || []).filter(j => (j.status || '') !== 'completed').reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            // deltas (today vs yesterday, this week vs last week)
            const y = new Date(); y.setDate(y.getDate() - 1); const yKey = y.toISOString().slice(0, 10);
            const yAmt = (JOBS || []).filter(j => (j.status || '') === 'completed' && completionDateKey(j) === yKey).reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);
            const lastWeekStart = new Date(weekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7); const lws = lastWeekStart.toISOString().slice(0, 10);
            const lastWeekEnd = new Date(weekStart); lastWeekEnd.setDate(lastWeekEnd.getDate() - 1); const lwe = lastWeekEnd.toISOString().slice(0, 10);
            const lwAmt = (JOBS || []).filter(j => (j.status || '') === 'completed' && completionDateKey(j) >= lws && completionDateKey(j) <= lwe).reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0);

            const pct = (now, prev) => { if (!prev && !now) return 0; if (!prev) return 100; return ((now - prev) / prev) * 100; };
            const todayPct = pct(collectedToday, yAmt);
            const weekPct = pct(weekAmt, lwAmt);

            document.getElementById('kCollectedToday').textContent = Rs(collectedToday);
            document.getElementById('kWeek').textContent = Rs(weekAmt);
            document.getElementById('kPending').textContent = Rs(pendingAmt);
            document.getElementById('kAOV').textContent = Rs(aov);
            document.getElementById('kCollectedTodayDelta').textContent = `${todayPct >= 0 ? '+' : ''}${todayPct.toFixed(1)}% vs yesterday`;
            document.getElementById('kWeekDelta').textContent = `${weekPct >= 0 ? '+' : ''}${weekPct.toFixed(1)}% vs last week`;
            document.getElementById('kAOVDelta').textContent = 'Based on completed';
        }

        function updateCharts() {
            const { days, labels } = clamp14();
            const series = days.map(key => (JOBS || []).filter(j => (j.status || '') === 'completed' && completionDateKey(j) === key).reduce((a, j) => a + (typeof j.estimated_price === 'number' ? j.estimated_price : 0), 0));
            if (!chartTrend) {
                chartTrend = new Chart(document.getElementById('chartTrend'), { type: 'line', data: { labels, datasets: [{ label: 'Collected', data: series, borderColor: ACCENT, backgroundColor: hexToRgba(ACCENT, 0.15), fill: true, tension: .35, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,.06)' } } } } });
            } else { chartTrend.data.labels = labels; chartTrend.data.datasets[0].data = series; chartTrend.update(); }
            const sts = ['submitted', 'accepted', 'printing', 'ready', 'completed', 'cancelled'];
            const counts = sts.map(s => (JOBS || []).filter(j => (j.status || '') === s).length);
            if (!chartStatus) { chartStatus = new Chart(document.getElementById('chartStatus'), { type: 'bar', data: { labels: sts.map(s => s[0].toUpperCase() + s.slice(1)), datasets: [{ label: 'Orders', data: counts, backgroundColor: ['#4C2A59', '#9E4B8A', '#B06AB3', '#7E57C2', '#26A69A', '#EF5350'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
            else { chartStatus.data.datasets[0].data = counts; chartStatus.update(); }
            const total = (JOBS || []).length; const done = (JOBS || []).filter(j => (j.status || '') === 'completed').length; const pend = total - done;
            if (!chartSplit) { chartSplit = new Chart(document.getElementById('chartSplit'), { type: 'doughnut', data: { labels: ['Collected', 'Pending'], datasets: [{ data: [done, pend], backgroundColor: ['var(--px-bg-dark)', 'var(--px-accent)'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } }); }
            else { chartSplit.data.datasets[0].data = [done, pend]; chartSplit.update(); }
        }

        function isoWeek(d) { d = new Date(d); d.setHours(0, 0, 0, 0); d.setDate(d.getDate() + 4 - (d.getDay() || 7)); const yearStart = new Date(d.getFullYear(), 0, 1); const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return d.getFullYear() + "-W" + String(week).padStart(2, '0'); }
        function updateWeekly() {
            const map = {}; (JOBS || []).forEach(j => { const k = isoWeek(completionTs(j) || (j.created_at || new Date())); if (!map[k]) map[k] = { orders: 0, collected: 0, pending: 0 }; map[k].orders++; if ((j.status || '') === 'completed') map[k].collected += (typeof j.estimated_price === 'number' ? j.estimated_price : 0); else map[k].pending += (typeof j.estimated_price === 'number' ? j.estimated_price : 0); });
            const rows = Object.keys(map).sort().slice(-8).map(k => `<tr><td class="px-2 py-2 font-medium">${k}</td><td class="px-2 py-2">${map[k].orders}</td><td class="px-2 py-2">${Rs(map[k].collected)}</td><td class="px-2 py-2">${Rs(map[k].pending)}</td></tr>`).join('');
            document.getElementById('weeklyTbody').innerHTML = rows;
        }

        function applyFilters() {
            const s = document.getElementById('fltStatus').value;
            const min = Number(document.getElementById('fltMin').value || 0) || 0;
            const txt = (document.getElementById('fltSearch').value || '').toLowerCase();
            const date = document.getElementById('fltDate').value || '';
            let list = (JOBS || []).slice();
            list = list.filter(j => (!date || (j.created_at || '').slice(0, 10) === date) && (!txt || (`${j.id || ''} ${j.contact_name || ''} ${j.customer_name || ''}`).toLowerCase().includes(txt)) && (min <= 0 || (typeof j.estimated_price === 'number' && j.estimated_price >= min)));
            if (s === 'collected') list = list.filter(j => (j.status || '') === 'completed');
            if (s === 'pending') list = list.filter(j => (j.status || '') !== 'completed');
            // re-render tables from filtered projection
            const orig = JOBS; JOBS = list; renderTables(); JOBS = orig;
        }

        function toCSV(rows) { return rows.map(r => r.map(v => '"' + String(v).replaceAll('"', '""') + '"').join(',')).join('\r\n'); }
        function exportCSV() {
            const head = ['Order', 'Customer', 'Amount', 'Status', 'Created'];
            const rows = (JOBS || []).map(j => [j.id || '', j.contact_name || j.customer_name || '', (typeof j.estimated_price === 'number' ? j.estimated_price : ''), (j.status || ''), (j.created_at || '')]);
            const csv = toCSV([head].concat(rows));
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'payments.csv'; a.click(); setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        async function openConversation(jobId) {
            try {
                const token = getToken(); const hdr = token ? { Authorization: 'Bearer ' + token } : {};
                const r = await fetch(`${API}/api/orders/${encodeURIComponent(jobId)}`, { headers: hdr });
                if (!r.ok) throw new Error('fetch-failed');
                const data = await r.json();
                const evs = (data && data.events) || [];
                const wrap = document.getElementById('convContent');
                wrap.innerHTML = evs.map(e => `<div class="rounded-xl p-3 ring-1 ring-black/5 dark:ring-white/10 bg-white/80 dark:bg-white/10"><div class="text-[12px] opacity-70">${(e.created_at || '').replace('T', ' ').slice(0, 16)}</div><div class="mt-1 text-sm font-medium">${e.status || ''}</div><div class="text-[13px]">${e.note || ''}</div></div>`).join('') || '<div class="text-[13px] opacity-70">No conversation yet.</div>';
                document.getElementById('convModal').classList.remove('hidden');
            } catch (_) { document.getElementById('convContent').innerHTML = '<div class="text-[13px] text-rose-600">Could not load conversation.</div>'; document.getElementById('convModal').classList.remove('hidden'); }
        }

        async function load() {
            try {
                const token = getToken(); if (!API || !token) return;
                const r = await fetch(`${API}/api/shop/jobs`, { headers: { Authorization: 'Bearer ' + token } });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const data = await r.json();
                let jobs = (data && data.jobs) || [];
                jobs.forEach(j => { if (!j.created_at && j.createdAt) j.created_at = j.createdAt; if (typeof j.settings === 'string') { try { j.settings = JSON.parse(j.settings); } catch (_) { } } });
                JOBS = jobs.sort((a, b) => String(b.created_at || '').localeCompare(String(a.created_at || '')));
                updateKPIs(); updateCharts(); updateWeekly(); renderTables(); setLastUpdated(); setFetchError(false);
                applyFilters();
            } catch (e) { setFetchError(true); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            load(); setInterval(load, 30000);
            document.querySelectorAll('[data-close]').forEach(n => n.addEventListener('click', () => document.getElementById('convModal').classList.add('hidden')));
            document.getElementById('fltStatus').addEventListener('change', applyFilters);
            document.getElementById('fltMin').addEventListener('input', applyFilters);
            document.getElementById('fltSearch').addEventListener('input', applyFilters);
            document.getElementById('fltDate').addEventListener('change', applyFilters);
            document.getElementById('fltReset').addEventListener('click', () => { ['fltDate', 'fltStatus', 'fltMin', 'fltSearch'].forEach(id => { const el = document.getElementById(id); if (!el) return; if (el.tagName === 'SELECT') el.value = 'all'; else el.value = ''; }); renderTables(); });
            document.getElementById('btnExport').addEventListener('click', exportCSV);
        });
    </script>
</body>

</html>