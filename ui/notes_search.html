<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaperX — Notes Search</title>

    <link rel="icon" type="image/svg+xml" href="assets/img/favicon.svg" />

    <script>
        // Persist theme before paint (keeps UI consistent across pages)
        (function () {
            try {
                var keys = ['cx-theme', 'theme', 'px-theme', 'px_theme'];
                var mode = null;
                for (var i = 0; i < keys.length; i++) {
                    var v = localStorage.getItem(keys[i]);
                    if (v === 'dark' || v === 'light') { mode = v; break; }
                }
                if (!mode && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    mode = 'dark';
                }
                if (mode) {
                    document.documentElement.classList.toggle('dark', mode === 'dark');
                    document.documentElement.setAttribute('data-theme', mode);
                    try { document.documentElement.style.colorScheme = mode; } catch (_) { }
                }
            } catch (e) { }
        })();
    </script>

    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script defer src="assets/js/analytics-tracker.js"></script>

    <script src="./config.js"></script>
    <script src="./auth.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <style>
        html,
        body {
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .material-symbols-rounded {
            vertical-align: -6px;
        }

        :root {
            --brand: #9E4B8A;
            --brand-strong: #4C2A59;
            --nav-border-light: rgba(0, 0, 0, 0.06);
            --nav-border-dark: rgba(255, 255, 255, 0.10);
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.72);
            border-bottom: 1px solid var(--nav-border-light);
            backdrop-filter: blur(18px) saturate(160%);
            -webkit-backdrop-filter: blur(18px) saturate(160%);
        }

        .dark .nav-glass {
            background: linear-gradient(180deg, rgba(30, 30, 47, 0.88), rgba(30, 30, 47, 0.62));
            border-bottom-color: var(--nav-border-dark);
        }

        .btn-brand {
            background: var(--brand);
            color: #fff;
            box-shadow: 0 10px 26px rgba(158, 75, 138, 0.20);
        }

        .btn-brand:hover {
            filter: brightness(0.98);
            box-shadow: 0 12px 32px rgba(158, 75, 138, 0.28);
        }

        /* Ensure text never overlaps the leading icon (works even if tailwind utility is missing) */
        #topicSearch {
            padding-left: 3rem !important;
            padding-right: 3.25rem !important;
            border: 1px solid rgba(0, 0, 0, 0.14) !important;
            box-shadow: none !important;
        }

        .dark #topicSearch {
            border-color: rgba(255, 255, 255, 0.16) !important;
        }

        /* Purple focus ring (override default blue highlight) */
        #topicSearch:focus,
        #topicSearch:focus-visible {
            outline: none !important;
            border-color: rgba(158, 75, 138, 0.65) !important;
            box-shadow: 0 0 0 4px rgba(158, 75, 138, 0.22) !important;
        }

        /* Futuristic MUI-inspired background (matches academicas/index vibe) */
        .page-bg {
            background:
                radial-gradient(1000px 560px at 50% -18%, rgba(158, 75, 138, 0.18), transparent 62%),
                radial-gradient(900px 520px at 10% 20%, rgba(76, 42, 89, 0.10), transparent 60%),
                linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 55%, #F7F2F9 100%);
        }

        .dark .page-bg {
            background:
                radial-gradient(900px 520px at 50% -15%, rgba(158, 75, 138, 0.35), transparent 65%),
                radial-gradient(900px 520px at 10% 20%, rgba(76, 42, 89, 0.30), transparent 60%),
                linear-gradient(180deg, #1E1E2F 0%, #201934 55%, #141321 100%);
        }

        .glass-panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, .82), rgba(255, 255, 255, .66));
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
            box-shadow: 0 24px 64px -20px rgba(30, 30, 47, 0.28);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dark .glass-panel {
            background: linear-gradient(180deg, rgba(30, 30, 47, .78), rgba(30, 30, 47, .58));
            box-shadow: 0 24px 80px -24px rgba(0, 0, 0, .62);
            border-color: rgba(255, 255, 255, 0.10);
        }

        .gradient-hero-text {
            display: inline-block;
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Dropdown selection */
        .suggestion-item[aria-selected="true"] {
            background: rgba(158, 75, 138, 0.10);
        }

        .dark .suggestion-item[aria-selected="true"] {
            background: rgba(158, 75, 138, 0.18);
        }

        /* Scrollbar polish (WebKit) */
        #suggestions::-webkit-scrollbar {
            width: 10px;
        }

        #suggestions::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.12);
            border-radius: 999px;
            border: 3px solid transparent;
            background-clip: content-box;
        }

        .dark #suggestions::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.16);
            border: 3px solid transparent;
            background-clip: content-box;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>

<body class="min-h-screen page-bg font-sans antialiased text-neutral-900 dark:text-white">
    <!-- NAVBAR (academicas-style) -->
    <header class="sticky top-0 z-50 nav-glass">
        <div class="mx-auto max-w-6xl px-4 py-3.5 flex items-center justify-between gap-3">
            <a href="index.html" class="flex items-center gap-3 shrink-0" aria-label="Paper X Home">
                <img src="assets/img/logo-light.svg" class="h-9 w-auto dark:hidden" alt="Paper X" />
                <img src="assets/img/logo-dark.svg" class="h-9 w-auto hidden dark:block" alt="Paper X" />
            </a>

            <div class="flex items-center gap-2">
                <a href="notes_generator.html"
                    class="hidden sm:inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded text-[18px]">auto_stories</span>
                    Notes Generator
                </a>
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span id="themeIcon" class="material-symbols-rounded text-[18px]">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-10">
        <!-- HERO -->
        <section class="relative overflow-hidden">
            <div class="pointer-events-none absolute inset-0 opacity-[.06] dark:opacity-[.12]"
                style="background-image: radial-gradient(40% 50% at 20% 0%, rgba(158,75,138,0.18), transparent 60%), radial-gradient(40% 60% at 100% 0%, rgba(76,42,89,0.35), transparent 60%);">
            </div>

            <div class="grid lg:grid-cols-[1.05fr_0.95fr] gap-10 items-start">
                <div>
                    <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight">
                        Find your <span class="gradient-hero-text">next topic</span>
                    </h1>
                    <p class="mt-3 text-sm md:text-base text-neutral-600 dark:text-white/70 max-w-xl">
                        Start typing — suggestions come from your AI notes library. Click a suggestion to open it in
                        Notes Generator in a new tab.
                    </p>

                    <div class="mt-6 flex flex-wrap gap-2">
                        <span
                            class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs ring-1 ring-black/10 dark:ring-white/15 bg-white/60 dark:bg-white/5 text-neutral-700 dark:text-white/80">
                            <span class="material-symbols-rounded text-[16px]">keyboard</span>
                            <span>↑/↓ to navigate</span>
                        </span>
                        <span
                            class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs ring-1 ring-black/10 dark:ring-white/15 bg-white/60 dark:bg-white/5 text-neutral-700 dark:text-white/80">
                            <span class="material-symbols-rounded text-[16px]">subdirectory_arrow_right</span>
                            <span>Enter to select</span>
                        </span>
                        <span
                            class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs ring-1 ring-black/10 dark:ring-white/15 bg-white/60 dark:bg-white/5 text-neutral-700 dark:text-white/80">
                            <span class="material-symbols-rounded text-[16px]">open_in_new</span>
                            <span>Click to open</span>
                        </span>
                    </div>
                </div>

                <!-- SEARCH CARD -->
                <div class="glass-panel rounded-3xl p-5 md:p-6">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-base md:text-lg font-semibold">Search topics</h2>
                            <p class="mt-1 text-sm text-neutral-600 dark:text-white/70">Autocomplete powered by your
                                stored notes</p>
                        </div>
                        <a href="notes_generator.html"
                            class="btn-brand inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition">
                            <span class="material-symbols-rounded text-[18px]">auto_awesome</span>
                            Generate
                        </a>
                    </div>

                    <form id="searchForm" class="mt-5" autocomplete="off">
                        <label for="topicSearch"
                            class="block text-xs font-semibold tracking-wide text-neutral-600 dark:text-white/70">TOPIC</label>

                        <div class="relative mt-2">
                            <span
                                class="material-symbols-rounded pointer-events-none select-none absolute left-4 top-1/2 -translate-y-1/2 text-[20px] text-neutral-500 dark:text-white/55">search</span>
                            <input id="topicSearch" type="text" placeholder="e.g., Support Vector Machine"
                                class="w-full rounded-2xl pl-16 pr-12 py-3.5 outline-none bg-white/80 dark:bg-white/5 text-neutral-900 dark:text-white placeholder:text-neutral-400 dark:placeholder:text-white/40 transition" />
                            <button id="clearBtn" type="button" aria-label="Clear"
                                class="hidden absolute right-3 top-1/2 -translate-y-1/2 size-9 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition flex items-center justify-center">
                                <span
                                    class="material-symbols-rounded text-[20px] text-neutral-500 dark:text-white/55">close</span>
                            </button>

                            <!-- Suggestions dropdown -->
                            <div id="suggestionsWrap"
                                class="hidden absolute left-0 right-0 mt-2 rounded-2xl overflow-hidden ring-1 ring-black/10 dark:ring-white/15 bg-white/90 dark:bg-[#1E1E2F]/90 backdrop-blur-xl shadow-[0_22px_60px_-24px_rgba(30,30,47,0.35)] dark:shadow-[0_24px_80px_-24px_rgba(0,0,0,0.6)]">
                                <ul id="suggestions" class="max-h-72 overflow-auto"></ul>
                            </div>
                        </div>

                        <div class="mt-4 flex items-center justify-between gap-3 flex-wrap">
                            <div id="status" class="text-sm text-neutral-600 dark:text-white/70"></div>
                        </div>

                        <div
                            class="mt-5 rounded-2xl ring-1 ring-black/10 dark:ring-white/15 bg-white/60 dark:bg-white/5 p-4">
                            <h3 class="text-sm font-semibold">Tip</h3>
                            <p class="mt-1 text-sm text-neutral-600 dark:text-white/70">
                                Click any suggestion to open it in a new tab. Or use ↑/↓ then <span
                                    class="inline-flex items-center px-2 py-0.5 rounded-lg bg-black/5 dark:bg-white/10">Enter</span>
                                to select, and press <span
                                    class="inline-flex items-center px-2 py-0.5 rounded-lg bg-black/5 dark:bg-white/10">Enter</span>
                                again to open.
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <script>
        (function () {
            var apiBase = (window.API_BASE || window.__API_BASE || 'http://127.0.0.1:8000').replace(/\/$/, '');

            var $input = document.getElementById('topicSearch');
            var $wrap = document.getElementById('suggestionsWrap');
            var $list = document.getElementById('suggestions');
            var $status = document.getElementById('status');
            var $form = document.getElementById('searchForm');
            var $clearBtn = document.getElementById('clearBtn');
            var $themeIcon = document.getElementById('themeIcon');

            var aborter = null;
            var activeIndex = -1;
            var currentItems = [];

            function escapeHtml(s) {
                return String(s || '').replace(/[&<>"']/g, function (c) {
                    return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c] || c;
                });
            }

            function debounce(fn, ms) {
                var t = null;
                return function () {
                    var args = arguments;
                    clearTimeout(t);
                    t = setTimeout(function () { fn.apply(null, args); }, ms);
                };
            }

            function hideSuggestions() {
                $wrap.classList.add('hidden');
                activeIndex = -1;
            }

            function syncThemeIcon() {
                if (!$themeIcon) return;
                var isDark = document.documentElement.classList.contains('dark');
                $themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
            }

            // Theme toggle (keeps this page consistent with academicas/index)
            document.addEventListener('click', function (e) {
                var btn = e && e.target && e.target.closest ? e.target.closest('[data-theme-toggle]') : null;
                if (!btn) return;
                e.preventDefault();
                if (window.Theme && typeof window.Theme.toggle === 'function') {
                    window.Theme.toggle();
                } else if (typeof window.toggleTheme === 'function') {
                    window.toggleTheme();
                }
                syncThemeIcon();
            });

            function openNotesGenerator(topic, newWindow) {
                var url = 'notes_generator.html?topic=' + encodeURIComponent(topic);
                if (newWindow) {
                    // Browser may open a new tab depending on user settings.
                    window.open(url, '_blank', 'noopener,noreferrer');
                } else {
                    window.location.href = url;
                }
            }

            function showSuggestions() {
                if (currentItems.length) $wrap.classList.remove('hidden');
            }

            function setStatus(text) {
                $status.textContent = text || '';
            }

            function syncClearBtn() {
                if (!$clearBtn) return;
                var has = !!(($input.value || '').trim());
                $clearBtn.classList.toggle('hidden', !has);
            }

            function renderSuggestions(items) {
                currentItems = Array.isArray(items) ? items : [];
                activeIndex = -1;
                $list.innerHTML = '';

                if (!currentItems.length) {
                    hideSuggestions();
                    return;
                }

                currentItems.forEach(function (item, idx) {
                    var topic = (item && item.topic) ? item.topic : '';
                    var li = document.createElement('li');
                    li.className = 'suggestion-item px-4 py-3 cursor-pointer flex items-center justify-between gap-3 hover:bg-black/5 dark:hover:bg-white/5 transition';
                    li.setAttribute('role', 'option');
                    li.setAttribute('data-idx', String(idx));
                    li.innerHTML = '<div class="min-w-0 flex-1">' +
                        '<div class="text-sm md:text-base font-medium text-neutral-900 dark:text-white truncate">' + escapeHtml(topic) + '</div>' +
                        '<div class="mt-0.5 text-[11px] text-neutral-500 dark:text-white/50">AI notes</div>' +
                        '</div>' +
                        '<span class="material-symbols-rounded text-[18px] text-neutral-500 dark:text-white/55">open_in_new</span>';

                    li.addEventListener('mousedown', function (e) {
                        // mousedown so it triggers before input blur
                        e.preventDefault();
                        if (!topic) return;
                        hideSuggestions();
                        setStatus('Opening: ' + topic);
                        openNotesGenerator(topic, true);
                    });

                    $list.appendChild(li);
                });

                showSuggestions();
            }

            function chooseIndex(idx) {
                if (idx < 0 || idx >= currentItems.length) return;
                var topic = (currentItems[idx] && currentItems[idx].topic) ? currentItems[idx].topic : '';
                if (!topic) return;
                $input.value = topic;
                hideSuggestions();
                setStatus('Selected: ' + topic);
            }

            function updateActive(nextIndex) {
                var children = $list.querySelectorAll('.suggestion-item');
                if (!children.length) return;

                if (activeIndex >= 0 && activeIndex < children.length) {
                    children[activeIndex].setAttribute('aria-selected', 'false');
                }

                activeIndex = nextIndex;
                if (activeIndex < 0) activeIndex = 0;
                if (activeIndex >= children.length) activeIndex = children.length - 1;

                children[activeIndex].setAttribute('aria-selected', 'true');
                try { children[activeIndex].scrollIntoView({ block: 'nearest' }); } catch (_) { }
            }

            async function fetchSuggestions(q) {
                if (aborter) aborter.abort();
                aborter = new AbortController();

                var url = apiBase + '/api/notes/topics/search?q=' + encodeURIComponent(q) + '&limit=12';
                setStatus('Searching…');

                var res = await fetch(url, { signal: aborter.signal });
                if (!res.ok) {
                    var txt = '';
                    try { txt = await res.text(); } catch (_) { }
                    throw new Error('Search failed: ' + res.status + (txt ? (' — ' + txt) : ''));
                }
                var data = await res.json();
                return (data && data.items) ? data.items : [];
            }

            var onInput = debounce(async function () {
                var q = ($input.value || '').trim();
                if (!q) {
                    setStatus('');
                    renderSuggestions([]);
                    return;
                }

                try {
                    var items = await fetchSuggestions(q);
                    renderSuggestions(items);
                    setStatus(items.length ? ('Found ' + items.length + ' matches') : 'No matches');
                } catch (e) {
                    if (String(e && e.name) === 'AbortError') return;
                    console.error(e);
                    setStatus('Could not fetch topics.');
                    renderSuggestions([]);
                }
            }, 150);

            $input.addEventListener('input', onInput);

            $input.addEventListener('input', syncClearBtn);
            syncClearBtn();
            syncThemeIcon();

            if ($clearBtn) {
                $clearBtn.addEventListener('click', function () {
                    $input.value = '';
                    syncClearBtn();
                    setStatus('');
                    renderSuggestions([]);
                    $input.focus();
                });
            }

            $input.addEventListener('keydown', function (e) {
                if ($wrap.classList.contains('hidden')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    updateActive(activeIndex + 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    updateActive(activeIndex - 1);
                } else if (e.key === 'Enter') {
                    if (activeIndex >= 0 && currentItems.length) {
                        e.preventDefault();
                        chooseIndex(activeIndex);
                    }
                } else if (e.key === 'Escape') {
                    hideSuggestions();
                }
            });

            $input.addEventListener('blur', function () {
                // delay to allow click selection
                setTimeout(function () { hideSuggestions(); }, 120);
            });

            document.addEventListener('click', function (e) {
                if (!e.target) return;
                if (!$wrap.contains(e.target) && e.target !== $input) hideSuggestions();
            });

            $form.addEventListener('submit', function (e) {
                e.preventDefault();
                var topic = ($input.value || '').trim();
                if (!topic) {
                    $input.focus();
                    return;
                }
                openNotesGenerator(topic, false);
            });

            // Prefill from querystring if present
            try {
                var params = new URLSearchParams(location.search || '');
                var q0 = (params.get('q') || '').trim();
                if (q0) {
                    $input.value = q0;
                    onInput();
                    $input.focus();
                }
            } catch (_) { }
        })();
    </script>
</body>

</html>