<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Edit Teacher Profile — Paper X</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script>tailwind.config = { darkMode: 'class', theme: { container: { center: true, padding: '1rem' }, extend: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] }, colors: { brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' } } } } };</script>
    <script>(() => { const s = localStorage.getItem('px_theme'); const p = matchMedia('(prefers-color-scheme: dark)').matches; const m = s ? s : (p ? 'dark' : 'light'); if (m === 'dark') document.documentElement.classList.add('dark'); })();</script>
    <script src="./config.js"></script>
    <script>// Hard-set API base to deployed server
        window.API_BASE = 'https://paperxapp.onrender.com';
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -5px
        }
    </style>
</head>

<body class="min-h-screen font-sans antialiased bg-white dark:bg-[#12121a] text-neutral-900 dark:text-white">
    <header class="bg-white/70 dark:bg-[#1E1E2F]/70 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="./teacher_profile.html?user=me" class="flex items-center gap-2">
                <img src="../assets/img/logo-light.svg" class="h-9 dark:hidden" alt="Paper X">
                <img src="../assets/img/logo-dark.svg" class="h-9 hidden dark:block" alt="Paper X">
            </a>
            <div class="flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
                        class="material-symbols-rounded text-base">dark_mode</span></button>
            </div>
        </div>
    </header>
    <main class="container py-8 max-w-4xl">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold tracking-tight">Edit Teacher Profile</h1>
            <a href="./teacher_profile.html?user=me" class="text-sm text-brand-500 hover:underline">View Profile</a>
        </div>
        <form id="profileForm" class="space-y-8">
            <section
                class="rounded-2xl bg-white/80 dark:bg-white/5 backdrop-blur ring-1 ring-black/10 dark:ring-white/10 p-6 space-y-6">
                <div class="flex flex-col md:flex-row gap-6 items-start">
                    <div class="w-32 h-32 rounded-2xl overflow-hidden ring-2 ring-black/10 dark:ring-white/15 bg-black/5 dark:bg-white/10 flex items-center justify-center relative"
                        id="avatarPreview">
                        <span class="text-xs opacity-60">No Avatar</span>
                        <img id="avatarImg" class="hidden w-full h-full object-cover" alt="Avatar" />
                        <button type="button" id="changeAvatarBtn"
                            class="absolute bottom-1 right-1 px-2 py-0.5 text-[10px] rounded bg-brand-500 text-white shadow hover:bg-brand-600">Change</button>
                        <input type="file" id="avatarFile" accept="image/*" class="hidden" />
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 flex-1 w-full">
                        <div>
                            <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Name</label>
                            <input name="name" type="text" disabled readonly
                                class="w-full rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 px-3 py-2 opacity-80 cursor-not-allowed"
                                placeholder="Display name" />
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Email</label>
                            <input name="email" type="email" disabled readonly
                                class="w-full rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 px-3 py-2 opacity-80 cursor-not-allowed"
                                placeholder="teacher@example.com" />
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">College</label>
                            <input id="collegeNameRO" type="text" disabled readonly
                                class="w-full rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 px-3 py-2 opacity-80 cursor-not-allowed"
                                placeholder="—" />
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Department</label>
                            <input id="departmentNameRO" type="text" disabled readonly
                                class="w-full rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 px-3 py-2 opacity-80 cursor-not-allowed"
                                placeholder="—" />
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Headline</label>
                        <input name="headline" type="text"
                            class="w-full rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                            placeholder="Short intro line" />
                    </div>
                    <div>
                        <label
                            class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Qualification</label>
                        <input name="qualification" type="text"
                            class="w-full rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                            placeholder="e.g. M.Tech, PhD" />
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Semester</label>
                        <input name="semester" type="number" min="1" max="12" disabled
                            class="w-full rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none px-3 py-2 opacity-75 cursor-not-allowed"
                            placeholder="--" />
                        <div id="semesterYearLabel"
                            class="mt-1 text-[11px] font-medium text-neutral-500 dark:text-white/50"></div>
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Batch (From /
                            To)</label>
                        <div class="flex gap-2">
                            <input name="batch_from" type="number" disabled
                                class="w-1/2 rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none px-3 py-2 font-mono text-xs opacity-75 cursor-not-allowed"
                                placeholder="From" />
                            <input name="batch_to" type="number" disabled
                                class="w-1/2 rounded-lg bg-white/60 dark:bg-white/5 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none px-3 py-2 font-mono text-xs opacity-75 cursor-not-allowed"
                                placeholder="To" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Years
                            Experience</label>
                        <input name="years_experience" type="number" min="0" max="80"
                            class="w-full rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2" />
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Specialization
                            (comma separated)</label>
                        <input name="specialization" type="text"
                            class="w-full rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                            placeholder="Mathematics, Data Structures" />
                    </div>
                </div>
                <div>
                    <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Bio</label>
                    <textarea name="bio" rows="4"
                        class="w-full rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                        placeholder="Tell students about your teaching approach..."></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Availability
                            (JSON)</label>
                        <textarea name="availability" rows="3"
                            class="w-full font-mono text-xs rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                            placeholder='{"mon":"9-11","wed":"14-16"}'></textarea>
                    </div>
                    <div>
                        <label class="block text-[11px] font-semibold uppercase tracking-wide mb-1">Social
                            (JSON)</label>
                        <textarea name="social" rows="3"
                            class="w-full font-mono text-xs rounded-lg bg-white/90 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 focus:outline-none focus:ring-brand-500 px-3 py-2"
                            placeholder='{"linkedin":"","github":""}'></textarea>
                    </div>
                </div>
            </section>
            <div class="flex items-center justify-between">
                <button type="button" id="resetBtn"
                    class="text-sm px-4 py-2 rounded-lg bg-black/5 dark:bg-white/10 hover:bg-black/10 dark:hover:bg-white/15">Reset</button>
                <button type="submit"
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-brand-500 text-white font-semibold shadow hover:bg-brand-600 transition">
                    <span class="material-symbols-rounded text-base">save</span>Save Changes
                </button>
            </div>
            <div id="status" class="text-sm font-medium mt-4"></div>
        </form>
    </main>
    <script>
        const API_BASE = (window.API_BASE || 'https://paperxapp.onrender.com').replace(/\/$/, '');
        function getToken() { const keys = ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token']; for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } } return '' }
        function decodeJwtUserId(t) { try { const p = t.split('.')[1]; if (!p) return null; return JSON.parse(atob(p.replace(/-/g, '+').replace(/_/g, '/'))).sub || null; } catch { return null } }
        async function fetchMe() {
            // If we are in a teacher session, skip /api/me entirely (teacher tokens are not Supabase JWTs)
            try { if (localStorage.getItem('teacherToken')) return null; } catch {}
            const tk = getToken(); if (!tk) { return null; }
            try {
                const r = await fetch(API_BASE + '/api/me', { headers: { Authorization: 'Bearer ' + tk } });
                if (!r.ok) return null;
                const j = await r.json();
                return j?.profile || null;
            } catch { return null }
        }
        function setThemeToggle() { document.addEventListener('click', e => { if (e.target.closest('[data-theme-toggle]')) { const root = document.documentElement; const d = root.classList.toggle('dark'); localStorage.setItem('px_theme', d ? 'dark' : 'light') } }) }
        function fillForm(p) { if (!p) return; const f = document.getElementById('profileForm'); f.headline.value = p.headline || ''; f.bio.value = p.bio || ''; f.qualification.value = p.qualification || ''; f.years_experience.value = p.years_experience || ''; f.specialization.value = (p.specialization || []).join(', '); f.availability.value = p.availability ? JSON.stringify(p.availability, null, 2) : ''; f.social.value = p.social ? JSON.stringify(p.social, null, 2) : ''; }
        function fillIdentity(p) { const f = document.getElementById('profileForm'); f.name.value = p.name || ''; f.email.value = p.email || ''; const c = document.getElementById('collegeNameRO'); const d = document.getElementById('departmentNameRO'); if (c) c.value = p.college_name || p.college_id || ''; if (d) d.value = p.department_name || p.department_id || ''; if (p.avatar_url || p.profile_image_url) { const img = document.getElementById('avatarImg'); img.src = p.avatar_url || p.profile_image_url; img.classList.remove('hidden'); document.querySelector('#avatarPreview span')?.classList.add('hidden'); } }
        function semesterToYearLabel(sem) { if (!sem || sem < 1) return ''; const year = Math.floor((sem - 1) / 2) + 1; const ordMap = { 1: 'First', 2: 'Second', 3: 'Third', 4: 'Fourth', 5: 'Fifth', 6: 'Sixth' }; return (ordMap[year] || (`Year ${year}`)) + ' Year'; }
        function updateSemesterYearLabel() { const f = document.getElementById('profileForm'); const semVal = parseInt(f.semester?.value || ''); const lbl = document.getElementById('semesterYearLabel'); if (!semVal) { lbl.textContent = ''; return; } lbl.textContent = semesterToYearLabel(semVal); }
        function fillAcademic(p) { const f = document.getElementById('profileForm'); if (f.semester) { f.semester.value = p.semester || ''; } if (f.batch_from) { f.batch_from.value = p.batch_from || ''; } if (f.batch_to) { f.batch_to.value = p.batch_to || ''; } updateSemesterYearLabel(); }
        async function fetchProfileDirect() {
            const tk = getToken();
            if (!tk) return null;
            try {
                const r = await fetch(`${API_BASE}/api/teacher/profile/me`, { headers: { Authorization: 'Bearer ' + tk } });
                if (!r.ok) return null;
                const j = await r.json();
                // Support both possible response shapes: { teacher: {...} } or direct profile
                return j.teacher || j.profile || j || null;
            } catch (err) {
                console.debug('[EDIT_PROFILE] fetchProfileDirect error', err);
                return null;
            }
        }
        async function load() {
            setThemeToggle();
            const statusEl = document.getElementById('status');
            const token = getToken();
            if (!token) {
                statusEl.textContent = 'Login required (no token found)';
                return;
            }
            // Try direct secure fetch first
            let prof = await fetchProfileDirect();
            if (!prof) {
                // Fallback: attempt legacy /api/me only if not a teacher session
                const me = await fetchMe();
                if (me?.auth_user_id) {
                    try {
                        const r = await fetch(`${API_BASE}/api/teacher/profile/${encodeURIComponent(me.auth_user_id)}`, { headers: { Authorization: 'Bearer ' + token } });
                        if (r.ok) {
                            const j = await r.json();
                            prof = j.teacher || j.profile || j || null;
                        }
                    } catch (e) { console.debug('[EDIT_PROFILE] secondary fetch error', e); }
                }
            }
            if (!prof) {
                statusEl.textContent = 'Login required (profile not accessible)';
                return;
            }
            fillForm(prof);
            fillIdentity(prof);
            fillAcademic(prof);
            statusEl.textContent = 'Profile loaded';
        }
        document.getElementById('resetBtn').addEventListener('click', async () => { document.getElementById('status').textContent = 'Resetting...'; await load(); document.getElementById('status').textContent = 'Reset to loaded values.' });
        document.getElementById('profileForm').addEventListener('submit', async e => { e.preventDefault(); const f = e.target; const tk = getToken(); if (!tk) { alert('Login required'); return; } const statusEl = document.getElementById('status'); statusEl.textContent = 'Saving...'; let availability = null, social = null; try { availability = f.availability.value ? JSON.parse(f.availability.value) : null; } catch { statusEl.textContent = 'Invalid JSON in availability'; return; } try { social = f.social.value ? JSON.parse(f.social.value) : null; } catch { statusEl.textContent = 'Invalid JSON in social'; return; } const body = { headline: f.headline.value || null, bio: f.bio.value || null, qualification: f.qualification.value || null, years_experience: f.years_experience.value ? Number(f.years_experience.value) : null, specialization: f.specialization.value ? f.specialization.value.split(',').map(s => s.trim()).filter(Boolean) : null, availability, social }; try { const r = await fetch(API_BASE + '/api/teacher/profile/me', { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + tk }, body: JSON.stringify(body) }); const j = await r.json(); if (!r.ok) throw new Error(j.detail || 'Save failed'); statusEl.textContent = 'Saved ✔'; } catch (err) { statusEl.textContent = 'Error: ' + err.message; } });
        // Avatar change
        document.getElementById('changeAvatarBtn').addEventListener('click', () => document.getElementById('avatarFile').click());
        document.getElementById('avatarFile').addEventListener('change', async e => {
            const file = e.target.files[0]; if (!file) return;
            const tk = getToken(); if (!tk) { alert('Login required'); return; }
            const statusEl = document.getElementById('status'); statusEl.textContent = 'Uploading avatar...';
            const form = new FormData(); form.append('file', file);
            // Try primary alt endpoint first, fallback to original if 405/404
            const endpoints = ['/api/teacher/profile/me/avatar', '/api/teacher/profile/avatar'];
            let success = false, lastErr = null;
            for (const ep of endpoints) {
                try {
                    const r = await fetch(API_BASE + ep, { method: 'POST', headers: { Authorization: 'Bearer ' + tk }, body: form });
                    console.debug('[AVATAR_UPLOAD] attempt', ep, r.status);
                    const j = await r.json().catch(() => ({}));
                    if (!r.ok) { throw new Error(j.detail || ('Upload failed ' + r.status)); }
                    const img = document.getElementById('avatarImg');
                    img.src = j.profile_image_url; img.classList.remove('hidden');
                    document.querySelector('#avatarPreview span')?.classList.add('hidden');
                    statusEl.textContent = 'Avatar updated ✔';
                    success = true; break;
                } catch (err) { lastErr = err; statusEl.textContent = 'Trying fallback...'; }
            }
            if (!success) { statusEl.textContent = 'Avatar error: ' + (lastErr ? lastErr.message : 'Unknown'); }
        });
        load();
    </script>
</body>

</html>
