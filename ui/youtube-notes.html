<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PaperX ? YouTube Notes</title>
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
    <style>
        :root {
            color-scheme: light;
            /* Will be updated at runtime to match the fixed header height */
            --header-h: 80px;
            --header-gap: 16px;
            --sticky-top: calc(var(--header-h) + var(--header-gap));
        }

        body {
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #f7f4fb 0%, #ffffff 30%, #eff1ff 100%);
            transition: background .3s ease, color .3s ease;
        }

        body[data-theme="dark"] {
            color-scheme: dark;
            background: radial-gradient(900px 600px at 65% -150px, rgba(87, 232, 255, .18), transparent 70%), linear-gradient(180deg, #05070f 0%, #10152b 55%, #0b0e1d 100%);
        }

        .notes-grid {
            display: grid;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .notes-grid {
                grid-template-columns: 1fr 4fr;
            }

            .notes-sidebar {
                position: sticky;
                top: var(--sticky-top, 8.5rem);
                align-self: flex-start;
            }
        }

        .surface {
            background: rgba(255, 255, 255, 0.88);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.12);
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
            backdrop-filter: blur(18px);
        }

        body[data-theme="dark"] .surface {
            background: rgba(12, 19, 35, 0.78);
            border: 1px solid rgba(94, 234, 212, 0.14);
            box-shadow: 0 32px 80px rgba(2, 6, 23, 0.55);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            padding: .35rem .8rem;
            border-radius: 999px;
            font-size: .75rem;
            font-weight: 600;
            background: rgba(148, 163, 184, 0.16);
            color: rgba(30, 41, 59, 0.68);
        }

        body[data-theme="dark"] .pill {
            background: rgba(148, 163, 184, 0.12);
            color: rgba(226, 232, 240, 0.78);
        }

        .notes-scroll {
            max-height: calc(100vh - 12rem);
            overflow-y: auto;
        }

        .notes-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .notes-scroll::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 999px;
        }

        body[data-theme="dark"] .notes-scroll::-webkit-scrollbar-thumb {
            background: rgba(94, 234, 212, 0.35);
        }

        /* Ensure loader has room inside the answer box while loading */
        .notes-scroll.loading {
            min-height: 360px;
        }

        /* Shared loader box to keep the animation square and responsive */
        .px-loader-box {
            width: clamp(180px, 45vw, 360px);
            aspect-ratio: 1 / 1;
        }

        .px-loader-box>dotlottie-wc {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>

<body data-theme="dark" class="text-slate-900 dark:text-slate-100">
    <header
        class="fixed inset-x-0 top-0 z-40 bg-white/95 dark:bg-slate-950 border-b border-slate-200/60 dark:border-slate-800/60 shadow-sm dark:shadow-slate-900/40">
        <div class="mx-auto flex max-w-7xl items-center justify-between px-5 py-4">
            <a href="index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="assets/img/logo-light.svg" alt="Paper X" class="h-10 w-auto dark:hidden">
                <img src="assets/img/logo-dark.svg" alt="Paper X" class="h-10 w-auto hidden dark:block">
            </a>
            <nav class="hidden items-center gap-6 text-sm font-medium text-slate-600 dark:text-slate-200 lg:flex">
                <a href="index.html" class="transition hover:text-slate-900 dark:hover:text-white">Home</a>
                <a href="about.html" class="transition hover:text-slate-900 dark:hover:text-white">About</a>
                <a href="contact.html" class="transition hover:text-slate-900 dark:hover:text-white">Contact</a>
                <a href="help.html" class="transition hover:text-slate-900 dark:hover:text-white">Help</a>
                <a href="index.html#pricing" class="transition hover:text-slate-900 dark:hover:text-white">Pricing</a>
            </nav>
            <div class="flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full border border-slate-200/70 px-3 py-2 text-sm font-medium text-slate-600 transition hover:border-slate-400 hover:text-slate-900 dark:border-slate-700 dark:text-slate-200 dark:hover:border-slate-500 dark:hover:text-white">
                    <span class="material-symbols-rounded text-base">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
                <a href="login.html"
                    class="hidden rounded-full px-3 py-2 text-sm font-medium text-slate-600 transition hover:text-slate-900 dark:text-slate-200 dark:hover:text-white md:inline-flex">Log
                    in</a>
                <a href="signup.html"
                    class="hidden rounded-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-purple-500/30 transition hover:shadow-purple-500/50 md:inline-flex">Sign
                    up</a>
            </div>
        </div>
    </header>

    <main class="relative mx-auto max-w-7xl px-5 pt-36 sm:pt-40 lg:pt-44 pb-16">
        <div class="notes-grid mt-6 lg:mt-10">
            <aside class="notes-sidebar space-y-5">
                <div class="surface overflow-hidden">
                    <div class="aspect-video bg-black">
                        <iframe id="videoEmbed" title="YouTube video player" class="h-full w-full"
                            allowfullscreen></iframe>
                    </div>
                </div>
                <div class="surface p-6 space-y-5">
                    <div class="flex items-center gap-4">
                        <span
                            class="grid h-14 w-14 place-items-center rounded-2xl bg-white text-lg font-semibold text-slate-900 shadow-inner dark:bg-slate-900 dark:text-slate-100">
                            <img id="channelAvatar" alt="Channel avatar" referrerpolicy="no-referrer"
                                class="hidden h-full w-full rounded-2xl object-cover ring-1 ring-white/80 dark:ring-slate-800"
                                loading="lazy">
                            <span id="channelAvatarFallback" class="text-base font-semibold">P</span>
                        </span>
                        <div class="space-y-1">
                            <p id="channelName" class="text-base font-semibold">N/A</p>
                            <p class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-300">
                                <span class="material-symbols-rounded text-base opacity-70">calendar_today</span>
                                <span id="uploadDate">N/A</span>
                            </p>
                            <p class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-300">
                                <span class="material-symbols-rounded text-base opacity-70">visibility</span>
                                <span id="viewCount">N/A</span>
                            </p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <p
                                class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-400 dark:text-slate-500">
                                Source</p>
                            <a id="openOnYoutube" href="#" target="_blank" rel="noopener noreferrer"
                                class="mt-2 inline-flex items-center gap-2 rounded-full border border-slate-200/70 px-3 py-2 text-xs font-semibold text-slate-600 transition hover:border-slate-400 hover:text-slate-900 dark:border-slate-600 dark:text-slate-200 dark:hover:border-slate-400 dark:hover:text-white">
                                <span class="material-symbols-rounded text-base">open_in_new</span>
                                Watch on YouTube
                            </a>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span class="pill">
                                <span class="material-symbols-rounded text-base opacity-60">robot</span>
                                TuneAI summary
                            </span>
                            <span class="pill">
                                <span class="material-symbols-rounded text-base opacity-60">subtitles</span>
                                Smart transcript
                            </span>
                        </div>
                    </div>
                </div>
            </aside>

            <section class="surface p-6 lg:p-8 space-y-6">
                <header class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold tracking-tight lg:text-3xl">Structured Notes</h1>
                        <p id="notesStatus" class="text-sm font-medium text-slate-500 dark:text-slate-300"
                            role="status">Preparing workspace...</p>
                    </div>
                    <button id="notesCopyBtn"
                        class="inline-flex items-center gap-2 rounded-full border border-slate-200/70 px-4 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-400 hover:text-slate-900 dark:border-slate-600 dark:text-slate-200 dark:hover:border-slate-400 dark:hover:text-white">
                        <span class="material-symbols-rounded text-base">content_copy</span>
                        Copy notes
                    </button>
                </header>
                <div id="notesScroll"
                    class="notes-scroll relative space-y-4 text-base leading-relaxed text-slate-700 dark:text-slate-100">
                    <div id="notesLoader" class="absolute inset-0 flex items-center justify-center pointer-events-none"
                        style="display: none;">
                        <div class="px-loader-box">
                            <dotlottie-wc
                                src="https://lottie.host/848055f4-11c7-4032-80e0-d51319c33bca/lF6845uqpU.lottie"
                                autoplay loop></dotlottie-wc>
                        </div>
                    </div>
                    <div id="notesRendered"
                        class="prose max-w-none prose-headings:mt-6 prose-headings:font-semibold prose-p:mb-4 prose-ul:mb-5 prose-li:marker:text-slate-400 dark:prose-invert">
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="px-5 pb-10 text-center text-sm text-slate-400 dark:text-slate-500">
        Crafted with PaperX ? yt-dlp ? YouTube Transcript API ? TuneAI
    </footer>

    <script>
        const root = document.documentElement;
        const themeKey = 'px-theme';
        const statusPalette = {
            dark: { info: '#94a3b8', success: '#67e8f9', error: '#fb7185' },
            light: { info: '#475569', success: '#0f766e', error: '#dc2626' }
        };

        // Ensure content never hides under the fixed header
        function applyHeaderOffset() {
            const headerEl = document.querySelector('header');
            const mainEl = document.querySelector('main');
            if (!headerEl || !mainEl) return;
            const h = headerEl.offsetHeight || 80;
            root.style.setProperty('--header-h', `${h}px`);
            root.style.setProperty('--sticky-top', `calc(${h}px + var(--header-gap))`);
            // Use margin-top to push content below fixed header
            mainEl.style.marginTop = `calc(${h}px + var(--header-gap))`;
        }
        window.addEventListener('load', applyHeaderOffset);
        window.addEventListener('resize', () => { requestAnimationFrame(applyHeaderOffset); });

        const apiBase = (() => {
            const manual = document.body.dataset.apiBase ? document.body.dataset.apiBase.trim() : '';
            if (manual) return manual.replace(/\/$/, '');
            if (location.protocol === 'file:') return 'https://paperxapp.onrender.com';
            if (/:(5500|5501)$/i.test(location.origin)) return location.origin.replace(/:(5500|5501)$/i, ':8000');
            return location.origin;
        })();

        function resolveMediaUrl(url) {
            if (!url) return '';
            if (/^https?:\/\//i.test(url)) return url;
            if (url.startsWith('//')) return `${location.protocol}${url}`;
            const base = apiBase.replace(/\/$/, '');
            return `${base}/${url.replace(/^\/+/, '')}`;
        }

        const params = new URLSearchParams(location.search);
        const videoUrl = params.get('video') || params.get('url') || '';

        const embedEl = document.getElementById('videoEmbed');
        const channelAvatarImg = document.getElementById('channelAvatar');
        const channelAvatarFallback = document.getElementById('channelAvatarFallback');
        const channelNameEl = document.getElementById('channelName');
        const uploadDateEl = document.getElementById('uploadDate');
        const viewCountEl = document.getElementById('viewCount');
        const notesRenderedEl = document.getElementById('notesRendered');
        const notesLoaderEl = document.getElementById('notesLoader');
        const notesScrollEl = document.getElementById('notesScroll');
        const notesCopyBtn = document.getElementById('notesCopyBtn');
        const notesStatusEl = document.getElementById('notesStatus');
        const openOnYoutubeEl = document.getElementById('openOnYoutube');

        let lastStatus = { message: '', tone: 'info' };
        let notesAbortController = null;

        const themeButtons = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));

        function applyTheme(mode) {
            const resolved = mode === 'light' ? 'light' : 'dark';
            document.body.dataset.theme = resolved;
            root.classList.toggle('dark', resolved === 'dark');
            try { localStorage.setItem(themeKey, resolved); } catch { }
            themeButtons().forEach(btn => {
                const icon = btn.querySelector('.material-symbols-rounded');
                if (icon) icon.textContent = resolved === 'dark' ? 'light_mode' : 'dark_mode';
            });
            if (lastStatus.message) setStatus(lastStatus.message, lastStatus.tone, true);
        }

        function initTheme() {
            let start = 'dark';
            try {
                const stored = localStorage.getItem(themeKey);
                if (stored === 'light' || stored === 'dark') start = stored;
                else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) start = 'light';
            } catch { }
            applyTheme(start);
        }

        themeButtons().forEach(btn => btn.addEventListener('click', () => applyTheme(document.body.dataset.theme === 'dark' ? 'light' : 'dark')));
        initTheme();

        function toneColor(tone) {
            const theme = document.body.dataset.theme === 'light' ? 'light' : 'dark';
            return (statusPalette[theme] && statusPalette[theme][tone]) || statusPalette[theme].info;
        }

        function setStatus(message, tone = 'info', skipStore = false) {
            if (!notesStatusEl) return;
            notesStatusEl.textContent = message;
            notesStatusEl.style.color = toneColor(tone);
            if (!skipStore) lastStatus = { message, tone };
        }

        function showLoader() {
            if (notesLoaderEl) notesLoaderEl.style.display = 'flex';
            if (notesScrollEl) notesScrollEl.classList.add('loading');
        }

        function hideLoader() {
            if (notesLoaderEl) notesLoaderEl.style.display = 'none';
            if (notesScrollEl) notesScrollEl.classList.remove('loading');
        }

        function formatViews(n) {
            if (typeof n !== 'number' || !isFinite(n)) return 'N/A';
            if (n >= 1_000_000) return (n / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (n >= 1_000) return (n / 1_000).toFixed(1).replace(/\.0$/, '') + 'K';
            return n.toLocaleString();
        }

        async function fetchJson(url, options) {
            const response = await fetch(url, options);
            if (!response.ok) {
                let text = response.statusText || 'Request failed';
                try {
                    const detail = await response.json();
                    text = detail.detail || detail.error || text;
                } catch { }
                throw new Error(text);
            }
            return response.json();
        }

        async function fetchMeta(video) {
            return fetchJson(`${apiBase}/api/transcripts/meta`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: video })
            });
        }

        async function fetchSavedNotes(videoId) {
            if (!videoId) return null;
            try {
                const res = await fetch(`${apiBase}/api/transcripts/saved/${encodeURIComponent(videoId)}`);
                if (res.status === 404) return null;
                if (!res.ok) {
                    let msg = res.statusText || 'Failed to load saved notes';
                    try {
                        const detail = await res.json();
                        msg = detail.detail || detail.error || msg;
                    } catch { }
                    throw new Error(msg);
                }
                return res.json();
            } catch (err) {
                console.warn('Saved notes lookup failed:', err);
                return null;
            }
        }

        function renderMarkdown(content) {
            const html = (window.marked && window.DOMPurify) ? DOMPurify.sanitize(marked.parse(content)) : (content || '').replace(/\\n/g, '<br/>');
            notesRenderedEl.innerHTML = html;
        }

        async function generateNotes(video) {
            try { if (notesAbortController) notesAbortController.abort(); } catch { }
            notesAbortController = new AbortController();
            setStatus('Composing structured notes with TuneAI...', 'info');
            notesRenderedEl.innerHTML = '';
            showLoader();
            const data = await fetchJson(`${apiBase}/api/transcripts/notes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: video, lang: 'en', fallback_ytdlp: true, clean: true }),
                signal: notesAbortController.signal
            });
            const md = data.notes_markdown || '';
            if (!md.trim()) {
                setStatus('TuneAI returned empty notes. Try again later.', 'error');
                hideLoader();
                return;
            }
            renderMarkdown(md);
            const origin = data.model ? 'Notes crafted with TuneAI.' : 'Notes crafted with TuneAI.';
            setStatus(data.truncated ? `${origin} Transcript was partially processed.` : origin, 'success');
            hideLoader();
            notesAbortController = null;
        }

        async function boot() {
            if (!videoUrl) {
                setStatus('No URL provided. Please go back and choose a video.', 'error');
                return;
            }

            if (openOnYoutubeEl) openOnYoutubeEl.href = videoUrl;

            try {
                showLoader();
                setStatus('Fetching video details...', 'info');
                const meta = await fetchMeta(videoUrl);

                if (embedEl) {
                    const embed = meta.embed_url || '';
                    embedEl.src = embed ? `${embed}?rel=0&modestbranding=1` : '';
                }
                if (channelNameEl) channelNameEl.textContent = meta.channel_name || 'YouTube';
                if (uploadDateEl) {
                    const d = meta.upload_date ? new Date(meta.upload_date) : null;
                    uploadDateEl.textContent = d ? d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
                }
                if (viewCountEl) viewCountEl.textContent = meta.views != null ? `${formatViews(meta.views)} views` : 'N/A';

                const initial = (meta.channel_name || 'Y').trim().charAt(0).toUpperCase();
                if (channelAvatarFallback) channelAvatarFallback.textContent = initial || 'Y';

                const avatarRaw = meta.channel_logo || meta.channel_thumbnail || meta.channel_avatar || meta.channel_image || '';
                const avatar = resolveMediaUrl(avatarRaw);
                if (avatar && channelAvatarImg) {
                    const showAvatar = () => {
                        channelAvatarImg.classList.remove('hidden');
                        channelAvatarFallback?.classList.add('hidden');
                    };
                    const showFallback = () => {
                        channelAvatarImg.classList.add('hidden');
                        channelAvatarImg.removeAttribute('src');
                        channelAvatarFallback?.classList.remove('hidden');
                    };
                    channelAvatarImg.onload = null;
                    channelAvatarImg.onerror = null;
                    channelAvatarImg.onload = showAvatar;
                    channelAvatarImg.onerror = showFallback;
                    channelAvatarImg.src = avatar;
                    // If the image is cached, onload may not fire
                    if (channelAvatarImg.complete && channelAvatarImg.naturalWidth > 0) {
                        showAvatar();
                    }
                } else if (channelAvatarImg) {
                    channelAvatarImg.classList.add('hidden');
                    channelAvatarImg.removeAttribute('src');
                    channelAvatarFallback.classList.remove('hidden');
                }

                if (meta.video_id) {
                    setStatus('Checking for saved notes...', 'info');
                    const saved = await fetchSavedNotes(meta.video_id);
                    if (saved && saved.notes_markdown && saved.notes_markdown.trim()) {
                        renderMarkdown(saved.notes_markdown);
                        const msg = saved.model ? `Loaded saved notes.` : 'Loaded saved notes.';
                        setStatus(msg, 'success');
                        hideLoader();
                        return;
                    }
                }
            } catch (err) {
                setStatus(`Video details failed: ${err.message || err}`, 'error');
            }

            try {
                await generateNotes(videoUrl);
            } catch (err) {
                setStatus(err.message || String(err), 'error');
                hideLoader();
            }
        }

        notesCopyBtn?.addEventListener('click', async () => {
            const text = notesRenderedEl?.innerText?.trim() || '';
            if (!text) {
                setStatus('Nothing to copy yet.', 'info');
                return;
            }
            try {
                await navigator.clipboard.writeText(text);
                setStatus('Structured notes copied to clipboard.', 'success');
            } catch {
                setStatus('Clipboard is unavailable in this browser.', 'error');
            }
        });

        boot();
    </script>

    <script src="auth.js"></script>
</body>

</html>