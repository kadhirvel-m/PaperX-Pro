<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Sections | Tunex</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/tailwind.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script>
        // Theme boot (runs before paint to avoid flash)
        (() => {
            const stored = localStorage.getItem('px_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored ? stored === 'dark' : prefersDark;
            if (isDark) document.documentElement.classList.add('dark');
        })();
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .gradient-hero-text {
            display: inline-block;
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dark .glass-header {
            background: rgba(19, 19, 31, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Light theme: soften GateX cards/inputs so the page doesn't look like dark blocks on a light hero background */
        html:not(.dark) .bg-gatex-card {
            background-color: rgba(255, 255, 255, 0.72) !important;
        }

        html:not(.dark) .bg-gatex-bg {
            background-color: rgba(255, 255, 255, 0.75) !important;
        }

        html:not(.dark) .hover\:bg-gatex-cardHover:hover {
            background-color: rgba(255, 255, 255, 0.9) !important;
        }

        #mobileNavBackdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }

        #mobileNavPanel {
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease;
        }

        #mobileNavBackdrop[data-open="true"],
        #mobileNavBackdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        #mobileNavPanel[data-open="true"],
        #mobileNavPanel.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
    </style>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-gray-100 bg-hero-light dark:bg-hero-dark transition-colors"
    x-data="levelApp()">

    <!-- Navbar (PaperX layout) -->
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10 relative">
        <div class="container flex items-center justify-between py-4">
            <a href="../dashboard.html" class="flex items-center gap-3" aria-label="Dashboard">
                <img src="../assets/img/tunex/tunex-logo-light.svg" alt="TuneX" class="h-8 w-auto dark:hidden">
                <img src="../assets/img/tunex/tunex-logo-dark.svg" alt="TuneX" class="h-8 w-auto hidden dark:block">
            </a>

            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brand-700 dark:hover:text-white transition" href="../dashboard.html">Dashboard</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="index.html">
                    <span>Coding Tracks</span>
                    <span class="material-symbols-rounded text-base">auto_awesome</span>
                </a>
                <a class="hover:text-brand-700 dark:hover:text-white transition" href="notebook.html">Notebook</a>
                <a class="hover:text-brand-700 dark:hover:text-white transition" href="compiler.html">Compiler</a>
            </nav>

            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
            </div>

            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <button id="mobileNavToggle" type="button" aria-expanded="false" aria-controls="mobileNavPanel"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="material-symbols-rounded" data-icon>menu</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile navigation (drawer) -->
    <div id="mobileNavBackdrop" aria-hidden="true"
        class="md:hidden fixed inset-0 z-40 bg-black/60 dark:bg-black/80 backdrop-blur-sm"></div>
    <nav id="mobileNavPanel" aria-hidden="true"
        class="md:hidden fixed inset-x-4 top-24 z-50 flex flex-col gap-5 max-h-[calc(100vh-6.5rem)] overflow-y-auto rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_1.5rem_4rem_-1.5rem_rgba(30,30,47,0.75)] backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6">
        <div class="flex flex-col gap-2 text-sm text-neutral-700 dark:text-white/80">
            <a href="../dashboard.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Dashboard</a>
            <a href="index.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 bg-brandlt-200/70 dark:bg-white/10 text-brand-700 dark:text-white transition">Coding
                Tracks</a>
            <a href="notebook.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Notebook</a>
            <a href="compiler.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Compiler</a>
        </div>
        <div class="flex flex-col gap-3 border-t border-black/5 dark:border-white/10 pt-4">
            <button @click="showAddModal = true" data-close-mobile-nav type="button"
                class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-3 text-sm font-semibold text-white shadow-[0_4px_18px_-6px_rgba(158,75,138,0.6)] hover:shadow-[0_6px_24px_-8px_rgba(158,75,138,0.7)] transition">
                <span class="material-symbols-rounded text-base">add</span>
                Add Section
            </button>
        </div>
    </nav>

    <main class="p-6 max-w-7xl mx-auto">

        <div class="grid grid-cols-1 lg:grid-cols-[320px_1fr] gap-8 items-start">
            <!-- Left portrait box -->
            <aside class="lg:sticky lg:top-24">
                <div class="bg-gatex-card border border-white/10 rounded-2xl overflow-hidden">
                    <div class="aspect-[3/4] bg-gatex-bg/40 relative overflow-hidden">
                        <!-- Python: cover the entire portrait area (crop allowed) -->
                        <img x-show="logoUrl() && isPython()" :src="logoUrl()" alt="Language"
                            class="absolute inset-0 w-full h-full object-cover" />

                        <!-- Other languages: keep logo centered/contained -->
                        <div x-show="logoUrl() && !isPython()"
                            class="absolute inset-0 flex items-center justify-center">
                            <img :src="logoUrl()" alt="Language" class="w-40 h-40 object-contain drop-shadow" />
                        </div>

                        <div x-show="!logoUrl()" class="absolute inset-0 flex items-center justify-center">
                            <div
                                class="w-40 h-40 rounded-2xl bg-white/5 flex items-center justify-center text-6xl text-gatex-accent">
                                <i class="ri-code-s-slash-line"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right content -->
            <section>
                <!-- Header & Add Button -->
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h3 class="text-2xl md:text-3xl font-extrabold gradient-hero-text">Sections</h3>
                        <p class="text-sm text-neutral-600 dark:text-gray-400">Manage sections for this level.</p>
                    </div>

                    <button @click="showAddModal = true"
                        class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-4 py-2 text-sm font-medium text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">
                        <span class="material-symbols-rounded text-base">add</span>
                        Add Section
                    </button>
                </div>

                <!-- Sections List -->
                <div class="space-y-4">
                    <template x-for="(section, index) in sections" :key="section.id">
                        <div
                            class="bg-gatex-card border border-white/5 rounded-xl p-5 hover:border-gatex-primary/50 transition group">
                            <div class="flex items-center justify-between">
                                <button type="button" @click="toggleSection(section)"
                                    class="flex-grow flex items-center text-left">
                                    <div class="flex items-center gap-4">
                                        <span
                                            class="w-8 h-8 rounded-lg bg-gatex-primary hover:bg-gatex-secondary text-white flex items-center justify-center text-sm font-mono shadow shadow-gatex-primary/20 transition"
                                            x-text="index + 1"></span>
                                        <div>
                                            <h3 class="font-bold text-lg group-hover:text-gatex-primary transition"
                                                x-text="section.title"></h3>
                                            <p class="text-xs text-gray-500 mt-1">Order Index: <span
                                                    x-text="section.order_index"></span></p>
                                        </div>
                                    </div>
                                </button>

                                <div class="flex items-center gap-2 pl-3">
                                    <a :href="'section.html?id=' + section.id + '&langName=' + langName"
                                        class="inline-flex items-center justify-center size-9 rounded-lg ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 transition"
                                        aria-label="Edit section">
                                        <i class="ri-edit-line text-lg"></i>
                                    </a>
                                    <i class="ri-arrow-down-s-line text-xl text-gray-600 group-hover:text-gatex-primary transition"
                                        :class="sectionOpen[section.id] ? 'rotate-180' : ''"></i>
                                </div>
                            </div>

                            <div x-show="sectionOpen[section.id]" class="mt-4 space-y-3" x-transition>
                                <div x-show="sectionLoading[section.id]"
                                    class="text-xs text-gray-500 flex items-center gap-2">
                                    <i class="ri-loader-4-line animate-spin"></i>
                                    Loading topics...
                                </div>
                                <template x-if="!sectionLoading[section.id]">
                                    <div>
                                        <template x-if="(sectionTopics[section.id] || []).length === 0">
                                            <p class="text-xs text-gray-500">No topics yet.</p>
                                        </template>
                                        <div class="space-y-2">
                                            <template x-for="(topic, tIndex) in (sectionTopics[section.id] || [])"
                                                :key="topic.id">
                                                <button type="button" @click="goToTopic(section, topic)"
                                                    class="w-full flex items-center justify-between rounded-lg border border-white/5 bg-black/5 dark:bg-white/5 px-4 py-3 text-left hover:border-gatex-primary/40 transition">
                                                    <div class="flex items-center gap-3">
                                                        <span
                                                            class="w-6 h-6 rounded-md bg-gatex-primary/20 text-gatex-primary flex items-center justify-center text-xs font-mono"
                                                            x-text="tIndex + 1"></span>
                                                        <span class="font-medium" x-text="topic.title"></span>
                                                    </div>
                                                    <i class="ri-arrow-right-s-line text-lg text-gray-500"></i>
                                                </button>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="sections.length === 0 && !loading"
                    class="text-center py-20 bg-gatex-card/50 rounded-2xl border border-white/5 border-dashed">
                    <i class="ri-layout-row-line text-4xl mb-3 block opacity-30"></i>
                    <p class="text-gray-500">No sections yet.</p>
                </div>

                <!-- Add Modal -->
                <div x-show="showAddModal" class="fixed inset-0 z-50 flex items-center justify-center px-4"
                    style="display: none;">
                    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showAddModal = false"></div>
                    <div
                        class="bg-gatex-card border border-white/10 rounded-2xl p-6 w-full max-w-md relative z-10 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Add Section</h3>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Title</label>
                                <input type="text" x-model="newSection.title"
                                    class="w-full bg-gatex-bg border border-white/10 rounded-lg px-4 py-2 focus:border-gatex-primary outline-none transition"
                                    placeholder="e.g., Introduction">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">Order Index</label>
                                <input type="number" x-model="newSection.order_index"
                                    class="w-full bg-gatex-bg border border-white/10 rounded-lg px-4 py-2 focus:border-gatex-primary outline-none transition">
                            </div>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button @click="showAddModal = false"
                                class="px-4 py-2 rounded-lg hover:bg-white/5 text-sm">Cancel</button>
                            <button @click="createSection()"
                                class="bg-gatex-primary hover:bg-gatex-secondary text-white px-4 py-2 rounded-lg text-sm font-medium transition">Create</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </main>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';

        function levelApp() {
            return {
                levelId: null,
                langName: '',
                level: null,
                language: null,
                sections: [],
                sectionTopics: {},
                sectionOpen: {},
                sectionLoading: {},
                loading: true,
                showAddModal: false,
                newSection: { title: '', order_index: 0 },

                init() {
                    const params = new URLSearchParams(window.location.search);
                    this.levelId = params.get('id');
                    this.langName = params.get('langName') || 'Language';

                    if (!this.levelId) {
                        alert("No level ID provided");
                        window.history.back();
                        return;
                    }
                    this.fetchData();
                },

                goBack() {
                    window.history.back();
                },

                async fetchData() {
                    this.loading = true;
                    try {
                        const [levelRes, secRes] = await Promise.all([
                            fetch(`${API_BASE}/api/lcoding/levels/${this.levelId}`),
                            fetch(`${API_BASE}/api/lcoding/levels/${this.levelId}/sections`)
                        ]);

                        if (levelRes.ok) this.level = await levelRes.json();
                        if (secRes.ok) this.sections = await secRes.json();

                        const languageId = this.level?.language_id || this.level?.languageId || this.level?.language?.id;
                        if (languageId) {
                            try {
                                const langRes = await fetch(`${API_BASE}/api/lcoding/languages/${languageId}`);
                                if (langRes.ok) this.language = await langRes.json();
                            } catch (e) {
                                console.warn('Failed to fetch language', e);
                            }
                        }

                        if (this.sections.length > 0) {
                            const maxOrder = Math.max(...this.sections.map(s => s.order_index));
                            this.newSection.order_index = maxOrder + 10;
                        }

                    } catch (e) {
                        console.error("Failed to fetch data", e);
                    } finally {
                        this.loading = false;
                    }
                },

                async toggleSection(section) {
                    const id = section.id;
                    this.sectionOpen[id] = !this.sectionOpen[id];
                    if (this.sectionOpen[id] && !this.sectionTopics[id]) {
                        await this.loadSectionTopics(id);
                    }
                },

                async loadSectionTopics(sectionId) {
                    this.sectionLoading[sectionId] = true;
                    try {
                        const res = await fetch(`${API_BASE}/api/lcoding/sections/${sectionId}/topics`);
                        if (res.ok) {
                            this.sectionTopics[sectionId] = await res.json();
                        } else {
                            this.sectionTopics[sectionId] = [];
                        }
                    } catch (e) {
                        console.error('Failed to fetch topics', e);
                        this.sectionTopics[sectionId] = [];
                    } finally {
                        this.sectionLoading[sectionId] = false;
                    }
                },

                goToTopic(section, topic) {
                    const params = new URLSearchParams({
                        id: topic.id,
                        title: topic.title,
                        sectionId: section.id,
                        langName: this.langName
                    });
                    window.location.href = `topic.html?${params.toString()}`;
                },

                async createSection() {
                    if (!this.newSection.title) return alert("Title is required");

                    try {
                        const res = await fetch(`${API_BASE}/api/lcoding/levels/${this.levelId}/sections`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newSection)
                        });

                        if (res.ok) {
                            this.showAddModal = false;
                            this.newSection = { title: '', order_index: 0 };
                            this.fetchData();
                        } else {
                            alert("Failed to create section");
                        }
                    } catch (e) {
                        console.error("Error creating section", e);
                        alert("Error creating section");
                    }
                }

                ,

                logoUrl() {
                    if (this.isPython()) return '../assets/img/Gemini_Generated_Image_gaxquhgaxquhgaxq.png';
                    return this.language?.logo_url || '';
                },

                isPython() {
                    return (this.langName || '').trim().toLowerCase() === 'python'
                        || (this.language?.name || '').trim().toLowerCase() === 'python';
                }
            }
        }
    </script>

    <script>
        // Mobile nav (drawer)
        (() => {
            const toggle = document.getElementById('mobileNavToggle');
            const backdrop = document.getElementById('mobileNavBackdrop');
            const panel = document.getElementById('mobileNavPanel');
            if (!toggle || !backdrop || !panel) return;

            const setOpen = (open) => {
                toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
                panel.setAttribute('aria-hidden', open ? 'false' : 'true');
                backdrop.setAttribute('aria-hidden', open ? 'false' : 'true');
                backdrop.dataset.open = open ? 'true' : 'false';
                panel.dataset.open = open ? 'true' : 'false';
            };

            const isOpen = () => panel.dataset.open === 'true';

            toggle.addEventListener('click', () => setOpen(!isOpen()));
            backdrop.addEventListener('click', () => setOpen(false));
            document.addEventListener('click', (e) => {
                if (e.target.closest('[data-close-mobile-nav]')) setOpen(false);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') setOpen(false);
            });
        })();
    </script>

    <script>
        const root = document.documentElement;
        const themeToggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
        const updateToggleIcons = (mode) => {
            themeToggles().forEach(btn => {
                const icon = btn.querySelector('.material-symbols-rounded');
                if (icon) icon.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode';
            });
        };
        const setTheme = (mode) => {
            if (mode === 'dark') root.classList.add('dark');
            else root.classList.remove('dark');
            localStorage.setItem('px_theme', mode);
            updateToggleIcons(mode);
        };
        setTheme(root.classList.contains('dark') ? 'dark' : 'light');
        document.addEventListener('click', (e) => {
            const trigger = e.target.closest('[data-theme-toggle]');
            if (!trigger) return;
            const next = root.classList.contains('dark') ? 'light' : 'dark';
            setTheme(next);
        });
    </script>
</body>

</html>