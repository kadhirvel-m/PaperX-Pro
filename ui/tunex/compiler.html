<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Compiler | Tunex</title>
    <link rel="stylesheet" href="../assets/css/tailwind.css">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script>
        // Theme initialization
        (function () {
            const stored = localStorage.getItem('tunex-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored === 'dark' || (!stored && prefersDark);
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        })();
        const Theme = {
            toggle() {
                const html = document.documentElement;
                html.classList.toggle('dark');
                localStorage.setItem('tunex-theme', html.classList.contains('dark') ? 'dark' : 'light');
            }
        };
    </script>
    <script>
        window.tailwind = window.tailwind || {};
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gatex: {
                            bg: '#13131F',
                            card: '#1E1E2F',
                            cardHover: '#27293d',
                            primary: '#9E4B8A',
                            secondary: '#4C2A59',
                            accent: '#FF7F50',
                            success: '#00F090',
                            info: '#3B82F6',
                            console: '#0b1020'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'Consolas', 'Monaco', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');

        .glass-header {
            background: rgba(19, 19, 31, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        textarea {
            tab-size: 4;
            -moz-tab-size: 4;
        }

        /* Custom scrollbar for editors */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #13131F;
        }

        ::-webkit-scrollbar-thumb {
            background: #27293d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3B82F6;
        }
    </style>
</head>

<body class="bg-gatex-bg text-gray-100 font-sans antialiased flex flex-col h-screen" x-data="compilerApp()">

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-6 sticky top-0 z-30 glass-header flex-shrink-0">
        <div class="flex items-center gap-4">
            <a href="index.html" class="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/10">
                <i class="ri-arrow-left-line text-xl"></i>
            </a>
            <div class="flex items-center gap-2">
                <i class="ri-terminal-box-line text-gatex-success text-xl"></i>
                <h1 class="text-lg font-bold">Python Compiler</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <button @click="runCode()" :disabled="isRunning"
                class="bg-gatex-success hover:bg-green-600 text-black font-bold px-6 py-2 rounded-lg flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="ri-play-fill" x-show="!isRunning"></i>
                <i class="ri-loader-4-line animate-spin" x-show="isRunning"></i>
                <span x-text="isRunning ? 'Running...' : 'Run Code'"></span>
            </button>
            <button @click="Theme.toggle()" class="p-2 text-gray-400 hover:text-white transition">
                <i class="ri-moon-line dark:hidden"></i>
                <i class="ri-sun-line hidden dark:block"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row h-[calc(100vh-4rem)] p-4 gap-4 overflow-hidden">

        <!-- Code Editor -->
        <div class="flex-1 flex flex-col bg-gatex-card rounded-xl border border-white/5 overflow-hidden">
            <div class="flex justify-between items-center px-4 py-2 bg-white/5 border-b border-white/5">
                <span class="text-xs font-mono text-gray-400">main.py</span>
                <button @click="code = ''" class="text-xs text-gray-500 hover:text-white transition">Clear</button>
            </div>
            <textarea x-model="code" spellcheck="false"
                class="flex-1 w-full bg-[#1e1e2f] text-gray-200 font-mono text-sm p-4 resize-none outline-none focus:ring-0 leading-relaxed placeholder-gray-700"
                placeholder="# Type your Python code here...
print('Hello world!')" @keydown.tab.prevent="insertTab($event)"
                @keydown.backspace="handleBackspace($event)"></textarea>
        </div>

        <!-- Output Console -->
        <div
            class="flex-1 flex flex-col bg-gatex-console rounded-xl border border-white/5 overflow-hidden font-mono shadow-inner shadow-black/50">
            <div class="flex justify-between items-center px-4 py-2 bg-white/5 border-b border-white/5">
                <span class="text-xs text-gray-400">Output</span>
                <span class="text-xs text-gray-500" x-show="executionTime">Time: <span
                        x-text="executionTime"></span>s</span>
            </div>
            <div class="flex-1 overflow-auto p-4 font-mono text-sm">
                <template x-if="!output && !error && !isRunning">
                    <div class="text-gray-600 italic">Run code to see output...</div>
                </template>

                <!-- Stdout -->
                <pre x-show="output" class="text-gray-300 whitespace-pre-wrap" x-text="output"></pre>

                <!-- Stderr/Error -->
                <pre x-show="error" class="text-red-400 whitespace-pre-wrap mt-2 pt-2 border-t border-red-900/30"
                    x-text="error"></pre>
            </div>
        </div>

    </main>

    <script>
        const API_BASE = 'http://127.0.0.1:8000'; // Adjust as needed

        function compilerApp() {
            return {
                code: "print('Hello from Tunex!')\n\nfor i in range(5):\n    print(f'Count: {i}')",
                output: '',
                error: '',
                isRunning: false,
                executionTime: null,

                async runCode() {
                    this.isRunning = true;
                    this.output = '';
                    this.error = '';
                    this.executionTime = null;

                    const startTime = performance.now();

                    try {
                        const res = await fetch(`${API_BASE}/api/tunex/compiler/run`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ code: this.code })
                        });

                        const data = await res.json();

                        this.output = data.output || '';
                        this.error = data.error || '';

                        if (data.status === 'error' && !this.error) {
                            this.error = "Unknown error occurred.";
                        }

                    } catch (e) {
                        console.error(e);
                        this.error = "Failed to connect to the server. Is the backend running?";
                    } finally {
                        this.isRunning = false;
                        this.executionTime = ((performance.now() - startTime) / 1000).toFixed(3);
                    }
                },

                insertTab(e) {
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;

                    // set textarea value to: text before caret + tab + text after caret
                    this.code = this.code.substring(0, start) +
                        "    " + this.code.substring(end);

                    // put caret at right position again
                    this.$nextTick(() => {
                        e.target.selectionStart = e.target.selectionEnd = start + 4;
                    });
                },

                handleBackspace(e) {
                    const el = e.target;
                    const start = el.selectionStart;
                    const end = el.selectionEnd;

                    if (start !== end) return; // Selection exists, let default handle it

                    const text = el.value;
                    const before = text.substring(0, start);
                    const lineStart = before.lastIndexOf('\n') + 1;
                    const linePrefix = before.substring(lineStart);

                    // Check if we are at an indentation boundary (multiple of 4 spaces)
                    // and the line prefix consists only of whitespace
                    if (/^\s+$/.test(linePrefix) && linePrefix.length % 4 === 0 && linePrefix.length > 0) {
                        e.preventDefault();
                        // Remove 4 spaces
                        this.code = text.substring(0, start - 4) + text.substring(end);

                        // Restore cursor position
                        this.$nextTick(() => {
                            el.selectionStart = el.selectionEnd = start - 4;
                        });
                    }
                }
            }
        }
    </script>
</body>

</html>