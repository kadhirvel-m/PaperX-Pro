<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Academics - Paper X</title>
    <meta name="description" content="Academic dashboard: syllabus mastery, progress, schedule & insights." />
    <link rel="icon" type="image/svg+xml" href="assets/img/favicon.svg" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.11/dist/dotlottie-wc.js" type="module"></script>
    <script defer src="assets/js/analytics-tracker.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0..1,0"
        rel="stylesheet" />

    <!-- Tailwind (CDN for demo) -->
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.28)',
                        soft: '0 6px 22px rgba(30,30,47,0.14)',
                        card: '0 24px 64px -20px rgba(30,30,47,0.45)',
                        ringed: '0 0 0 1px rgba(158,75,138,0.35), 0 6px 22px rgba(158,75,138,0.35)'
                    },
                    backgroundImage: {
                        'hero-dark': 'radial-gradient(900px 520px at 50% -15%, rgba(158,75,138,0.35), transparent 65%), linear-gradient(180deg,#1E1E2F 0%,#201934 55%,#141321 100%)',
                        'hero-light': 'radial-gradient(1000px 560px at 50% -18%, rgba(158,75,138,0.18), transparent 62%), linear-gradient(180deg,#FFFFFF 0%,#FBF8FC 55%,#F7F2F9 100%)',
                        'mesh-dark': 'radial-gradient(40% 50% at 20% 0%, rgba(158,75,138,0.18), transparent 60%), radial-gradient(40% 60% at 100% 0%, rgba(76,42,89,0.35), transparent 60%)',
                    },
                    keyframes: {
                        fadeUp: { '0%': { opacity: 0, transform: 'translateY(14px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
                        pulseBar: { '0%,100%': { opacity: .55 }, '50%': { opacity: .15 } },
                        ringIn: { '0%': { transform: 'scale(.92)', opacity: .6 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                    },
                    animation: {
                        fadeUp: 'fadeUp .6s cubic-bezier(.4,.1,.2,1)',
                        pulseBar: 'pulseBar 2s ease-in-out infinite',
                        ringIn: 'ringIn .5s ease-out both'
                    }
                }
            }
        }
    </script>

    <!-- Brand utilities + a11y helpers -->
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .glass-panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, .82), rgba(255, 255, 255, .66));
            backdrop-filter: blur(28px);
            box-shadow: 0 12px 42px -10px rgba(30, 30, 47, .18);
        }

        .dark .glass-panel {
            background: linear-gradient(180deg, rgba(30, 30, 47, .78), rgba(30, 30, 47, .58));
            box-shadow: 0 22px 60px -12px rgba(0, 0, 0, .55);
        }

        .metric-ring {
            background: conic-gradient(var(--ring-color, #9E4B8A) calc(var(--pct, 0)*1%), rgba(158, 75, 138, .16) 0);
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, rgba(0, 0, 0, .04), rgba(0, 0, 0, .08), rgba(0, 0, 0, .04));
            background-size: 300% 100%;
            animation: shimmer 2.3s linear infinite;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
        }

        @keyframes shimmer {
            0% {
                background-position: 0 0
            }

            100% {
                background-position: -300% 0
            }
        }

        /* Star Rating Display Styles */
        .star-display {
            display: inline-flex;
            gap: 1px;
            align-items: center;
            margin-left: 4px;
        }

        .star-display .star {
            font-size: 14px;
            color: #9ca3af;
            font-variation-settings: 'FILL' 0;
        }

        .star-display .star.filled {
            color: #f59e0b;
            font-variation-settings: 'FILL' 1;
        }

        /* Course title: truncate on mobile, show full from sm+ */
        .course-title {
            max-width: 12ch;
        }

        @media (min-width: 640px) {
            .course-title {
                max-width: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        #pageLoader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease, visibility 0.4s;
        }

        .loaded #pageLoader {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .dark #pageLoader {
            background: rgba(30, 30, 47, 0.7);
        }

        /* ===== Enhanced Streak Component Styles ===== */
        .streak-card:hover .streak-glow-bg {
            opacity: 1;
            transform: scale(1.1);
        }

        .streak-glow-bg {
            transition: all 0.5s ease;
            animation: glow-pulse 4s ease-in-out infinite;
        }

        .streak-glow-secondary {
            animation: glow-pulse 3s ease-in-out infinite reverse;
        }

        @keyframes glow-pulse {

            0%,
            100% {
                opacity: 0.15;
                transform: scale(1);
            }

            50% {
                opacity: 0.3;
                transform: scale(1.05);
            }
        }

        /* Fire Icon Animation */
        .fire-icon-main {
            animation: fire-float 2s ease-in-out infinite;
        }

        @keyframes fire-float {

            0%,
            100% {
                transform: translateY(0) scale(1);
                filter: drop-shadow(0 0 8px rgba(251, 146, 60, 0.6));
            }

            50% {
                transform: translateY(-3px) scale(1.05);
                filter: drop-shadow(0 0 15px rgba(251, 146, 60, 0.8));
            }
        }

        .fire-container {
            animation: fire-container-glow 2s ease-in-out infinite;
        }

        @keyframes fire-container-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(251, 146, 60, 0.2), inset 0 0 20px rgba(251, 146, 60, 0.1);
            }

            50% {
                box-shadow: 0 0 30px rgba(251, 146, 60, 0.4), inset 0 0 30px rgba(251, 146, 60, 0.2);
            }
        }

        /* Fire Particles */
        .fire-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: linear-gradient(to top, #f97316, #fbbf24);
            border-radius: 50%;
            opacity: 0;
        }

        .particle-1 {
            top: 50%;
            left: 30%;
            animation: particle-rise 2.5s ease-out infinite;
        }

        .particle-2 {
            top: 60%;
            left: 50%;
            animation: particle-rise 2s ease-out infinite 0.5s;
        }

        .particle-3 {
            top: 55%;
            left: 70%;
            animation: particle-rise 2.2s ease-out infinite 1s;
        }

        @keyframes particle-rise {
            0% {
                opacity: 0;
                transform: translateY(0) scale(1);
            }

            20% {
                opacity: 0.8;
            }

            100% {
                opacity: 0;
                transform: translateY(-30px) scale(0.3);
            }
        }

        /* Streak Number Glow */
        .streak-number {
            text-shadow: 0 0 30px rgba(251, 146, 60, 0.3);
            animation: number-glow 3s ease-in-out infinite;
        }

        @keyframes number-glow {

            0%,
            100% {
                filter: drop-shadow(0 0 10px rgba(251, 146, 60, 0.3));
            }

            50% {
                filter: drop-shadow(0 0 20px rgba(251, 146, 60, 0.5));
            }
        }

        /* Progress Bar Shimmer */
        .streak-progress-bar {
            position: relative;
            overflow: hidden;
        }

        .streak-shimmer {
            animation: streak-shimmer 2s linear infinite;
        }

        @keyframes streak-shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Day Items */
        .streak-day-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s ease;
            flex: 1;
            min-width: 0;
        }

        .streak-day-item:hover {
            transform: scale(1.1);
        }

        .streak-day-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .streak-day-label {
            font-size: 9px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        /* Completed Days */
        .streak-day-item.completed .streak-day-circle {
            background: linear-gradient(135deg, #f97316, #ea580c);
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.4);
            border: 2px solid rgba(251, 146, 60, 0.3);
        }

        .streak-day-item.completed .streak-day-label {
            color: #f97316;
        }

        /* Today */
        .streak-day-item.today .streak-day-circle {
            background: linear-gradient(135deg, #fbbf24, #f97316, #ef4444);
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.5);
        }

        .today-pulse {
            animation: today-pulse 1.5s ease-in-out infinite;
        }

        @keyframes today-pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px rgba(249, 115, 22, 0.8);
            }
        }

        .today-label {
            color: #fbbf24 !important;
            font-weight: 700 !important;
        }

        /* Future/Inactive Days */
        .streak-day-item.future {
            opacity: 0.5;
        }

        .streak-day-item.future .streak-day-circle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .dark .streak-day-item.future .streak-day-circle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .streak-day-item.future:hover {
            opacity: 0.7;
        }

        /* Light mode adjustments */
        .streak-day-item.future .streak-day-circle {
            background: rgba(0, 0, 0, 0.05);
            border: 1px dashed rgba(0, 0, 0, 0.1);
        }
    </style>

    <!-- Persist theme before paint -->
    <script>
            (function () {
                try {
                    const s = localStorage.getItem('px_theme');
                    const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const useDark = s ? s === 'dark' : prefers;
                    if (useDark) document.documentElement.classList.add('dark');
                } catch (_) { }
            })();
    </script>
    <script src="config.js"></script>
    <script src="auth.js" defer></script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
    <!-- Loading Overlay -->
    <div id="pageLoader">
        <dotlottie-wc src="https://lottie.host/848055f4-11c7-4032-80e0-d51319c33bca/lF6845uqpU.lottie"
            style="width: 300px;height: 300px" autoplay loop></dotlottie-wc>
    </div>
    <!-- ================= NAVBAR ================= -->
    <header
        class="sticky top-0 z-50 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3.5">
            <a href="index.html" class="flex items-center gap-3 shrink-0" aria-label="Paper X Home">
                <img src="assets/img/logo-light.svg" class="h-9 w-auto dark:hidden" alt="Paper X" />
                <img src="assets/img/logo-dark.svg" class="h-9 w-auto hidden dark:block" alt="Paper X" />
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a href="index.html" class="hover:text-brandlt-900 dark:hover:text-white">Home</a>
                <a href="wishlist.html"
                    class="hover:text-brandlt-900 dark:hover:text-white inline-flex items-center gap-1"><span
                        class="material-symbols-rounded text-base">favorite</span>Wishlist</a>
                <a href="history.html"
                    class="hover:text-brandlt-900 dark:hover:text-white inline-flex items-center gap-1"><span
                        class="material-symbols-rounded text-base">history</span>History</a>
                <a href="help.html" class="hover:text-brandlt-900 dark:hover:text-white">Help</a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden lg:block">Theme</span>
                </button>
                <a href="login.html"
                    class="px-3 py-2 text-sm text-neutral-700 dark:text-white/80 hover:text-brandlt-900 dark:hover:text-white rounded-full">Log
                    in</a>
                <a href="signup.html"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 text-white text-sm font-semibold px-4 py-2.5 hover:shadow-glow transition">Sign
                    up</a>
                <a id="navProfile" href="profile.html" title="Profile"
                    class="hidden items-center justify-center w-10 h-10 rounded-full overflow-hidden border border-black/10 dark:border-white/10 bg-white/90 dark:bg-brand-900/60">
                    <img id="navProfileImg" alt="Profile" class="w-full h-full object-cover hidden" />
                    <span id="navProfileInitial" class="text-xs font-semibold">ME</span>
                </a>
                <button id="signOutBtn" type="button" title="Sign out" aria-label="Sign out"
                    class="hidden items-center gap-2 rounded-full border border-black/10 dark:border-white/15 px-3 py-1.5 text-sm text-neutral-700 dark:text-white/80 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded text-base">logout</span>
                    <span>Sign out</span>
                </button>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button id="navEduEditBtn" type="button" aria-label="Edit education"
                    class="hidden inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded">edit</span>
                </button>
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ================= HERO / OVERVIEW ================= -->
    <section class="relative overflow-hidden">
        <!-- Subtle mesh accents -->
        <div class="pointer-events-none absolute inset-0 opacity-[.06] dark:opacity-[.12] bg-mesh-dark"></div>
        <div class="container pt-10 pb-6 lg:pt-14 lg:pb-10">
            <div class="grid lg:grid-cols-[1.1fr_0.9fr] gap-10 items-start">
                <!-- Left: Headline + metrics -->
                <div>
                    <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight leading-tight mb-4">
                        Your Academic <span
                            class="bg-gradient-to-r from-brand-500 via-brand-700 to-brand-900 bg-clip-text text-transparent">Command
                            Center</span>
                    </h1>
                    <p class="hidden md:block text-neutral-600 dark:text-white/70 max-w-xl">Track syllabus mastery,
                        revisit topics, and
                        accelerate revision with adaptive progress signals and instant access to generated notes.</p>
                    <div class="hidden md:flex mt-8 flex-wrap gap-4">
                        <a href="#syllabus-section"
                            class="inline-flex items-center gap-2 rounded-full bg-brand-500 text-white px-6 py-3 text-sm font-semibold shadow-glow hover:shadow-ringed transition">
                            <span class="material-symbols-rounded text-base">school</span>
                            View Syllabus
                        </a>
                        <a href="notes_generator.html"
                            class="inline-flex items-center gap-2 rounded-full ring-1 ring-black/10 dark:ring-white/15 px-6 py-3 text-sm font-semibold hover:bg-black/5 dark:hover:bg-white/5 transition">
                            <span class="material-symbols-rounded text-base">auto_stories</span>
                            Generate Notes
                        </a>
                    </div>

                    <!-- KPI cards -->
                    <div class="mt-10 grid grid-cols-3 gap-4 max-w-md">
                        <div class="glass-panel rounded-2xl p-4 flex flex-col gap-2 animate-fadeUp"
                            style="animation-delay:.05s">
                            <p class="text-[11px] uppercase tracking-wide text-neutral-600 dark:text-white/60">Topics
                                Done</p>
                            <div class="flex items-end gap-2">
                                <span id="statTopicsDone" class="text-2xl font-extrabold">0</span>
                                <span class="text-xs text-neutral-500 dark:text-white/50">/ <span
                                        id="statTopicsTotal">0</span></span>
                            </div>
                            <div class="h-1 rounded-full bg-brand-500/20 overflow-hidden">
                                <div id="barTopics" class="h-full w-0 bg-brand-500 animate-pulseBar"></div>
                            </div>
                        </div>
                        <div class="glass-panel rounded-2xl p-4 flex flex-col gap-2 animate-fadeUp"
                            style="animation-delay:.1s">
                            <p class="text-[11px] uppercase tracking-wide text-neutral-600 dark:text-white/60">
                                Completion</p>
                            <div class="relative h-14 w-14 animate-ringIn">
                                <div id="ringCompletion" class="absolute inset-0 rounded-full metric-ring"
                                    style="--pct:0;--ring-color:#9E4B8A"></div>
                                <div id="ringCompletionText"
                                    class="absolute inset-0 flex items-center justify-center text-xs font-semibold">0%
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel rounded-2xl p-4 flex flex-col gap-2 animate-fadeUp"
                            style="animation-delay:.15s">
                            <p class="text-[11px] uppercase tracking-wide text-neutral-600 dark:text-white/60">Active
                                Courses</p>
                            <div id="statCourses" class="text-2xl font-extrabold">0</div>
                            <div id="statSemester" class="text-xs text-neutral-500 dark:text-white/50">Sem -</div>
                        </div>
                    </div>
                </div>

                <!-- Right: Profile card -->
                <div class="relative">
                    <div class="hidden md:block glass-panel rounded-3xl p-6 md:p-8 space-y-6 animate-fadeUp"
                        style="animation-delay:.2s">
                        <div class="flex items-start gap-4">
                            <div id="avatar"
                                class="relative w-20 h-20 rounded-2xl overflow-hidden ring-2 ring-brand-500/40 bg-brandlt-100 dark:bg-brand-900/40 flex items-center justify-center text-2xl font-bold">
                                U</div>
                            <img id="avatarImg" class="hidden absolute w-20 h-20 object-cover rounded-2xl"
                                alt="Profile" />
                            <div class="flex-1 min-w-0">
                                <h2 id="name" class="text-xl font-semibold truncate">-</h2>
                                <p id="email" class="text-sm text-neutral-600 dark:text-white/65 truncate">-</p>
                                <div class="mt-3 flex flex-wrap gap-2 text-[11px] font-medium">
                                    <span id="semester"
                                        class="px-2 py-1 rounded-full bg-brand-500/10 text-brand-700 dark:text-brandlt-200">Sem
                                        -</span>
                                    <span id="regno"
                                        class="px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15">-</span>
                                    <span id="phone"
                                        class="px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15">-</span>
                                </div>
                            </div>
                            <button type="button" id="eduEditBtn"
                                class="inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-medium ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                                <span class="material-symbols-rounded text-sm">edit</span>
                                Edit
                            </button>
                        </div>
                        <div class="grid sm:grid-cols-3 gap-4 text-xs">
                            <div class="flex flex-col gap-1"><span
                                    class="text-neutral-500 dark:text-white/50">College</span><span id="college"
                                    class="font-medium truncate">-</span></div>
                            <div class="flex flex-col gap-1"><span
                                    class="text-neutral-500 dark:text-white/50">Department</span><span id="department"
                                    class="font-medium truncate">-</span></div>
                            <div class="flex flex-col gap-1"><span
                                    class="text-neutral-500 dark:text-white/50">Batch</span><span id="batch"
                                    class="font-medium truncate">-</span></div>
                        </div>
                    </div>

                    <!-- Enhanced Streak Component -->
                    <div class="glass-panel rounded-3xl p-6 md:p-8 relative overflow-hidden streak-card animate-fadeUp mt-6"
                        style="animation-delay:.3s">
                        <!-- Animated Background Fire Glow -->
                        <div
                            class="absolute -right-20 -top-20 w-56 h-56 bg-orange-500/20 rounded-full blur-[80px] streak-glow-bg">
                        </div>
                        <div
                            class="absolute -left-10 -bottom-10 w-32 h-32 bg-red-500/10 rounded-full blur-[60px] streak-glow-secondary">
                        </div>

                        <!-- Main Header Section -->
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <span
                                        class="text-neutral-500 dark:text-gray-400 text-[10px] font-bold uppercase tracking-widest">üî•
                                        Learning Streak</span>
                                    <span id="streakBadge"
                                        class="hidden px-2 py-0.5 bg-orange-500/20 text-orange-500 dark:text-orange-400 text-[9px] font-bold rounded-full border border-orange-500/20">ON
                                        FIRE</span>
                                </div>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-5xl font-black"
                                        style="color: #fbbf24; text-shadow: 0 0 20px rgba(251, 191, 36, 0.8), 0 0 40px rgba(249, 115, 22, 0.5), 0 0 60px rgba(249, 115, 22, 0.3);"
                                        id="currentStreak">0</span>
                                    <span class="text-sm font-bold text-neutral-600 dark:text-gray-300">Days</span>
                                    <span class="text-[10px] text-neutral-500 dark:text-gray-500 ml-2"
                                        id="streakPersonalBest">¬∑ Personal Best: 0</span>
                                </div>
                            </div>

                            <!-- Premium Fire Icon with Particle Effects -->
                            <div class="relative">
                                <div class="fire-container w-16 h-16 rounded-2xl bg-gradient-to-br from-orange-500/30 via-red-500/20 to-transparent flex items-center justify-center backdrop-blur-sm"
                                    style="border: 1px solid #fbbf24;">
                                    <span class="material-symbols-rounded text-3xl fire-icon-main"
                                        style="color: #fbbf24;">local_fire_department</span>
                                </div>
                                <!-- Fire particles -->
                                <div class="fire-particle particle-1"></div>
                                <div class="fire-particle particle-2"></div>
                                <div class="fire-particle particle-3"></div>
                            </div>
                        </div>

                        <!-- Streak Milestone Progress -->
                        <div class="mt-4 z-10 relative">
                            <div class="flex items-center justify-between mb-2">
                                <span
                                    class="text-[10px] text-neutral-500 dark:text-gray-400 uppercase tracking-wider font-semibold">Next
                                    Milestone</span>
                                <span class="text-[10px] text-orange-500 dark:text-orange-400 font-bold"
                                    id="nextMilestoneText">7 Days üéØ</span>
                            </div>
                            <div class="relative h-2 bg-neutral-200 dark:bg-brand-900 rounded-full overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 to-red-500/20"></div>
                                <div class="h-full bg-gradient-to-r from-orange-400 via-orange-500 to-red-500 rounded-full streak-progress-bar"
                                    id="streakProgressBar" style="width: 0%;">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent streak-shimmer">
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-[9px] text-neutral-500 dark:text-gray-600" id="prevMilestoneLabel">0
                                    üî•</span>
                                <span class="text-[9px] text-orange-500 font-bold" id="currentStreakLabel">0</span>
                                <span class="text-[9px] text-neutral-500 dark:text-gray-600" id="nextMilestoneLabel">7
                                    üèÜ</span>
                            </div>
                        </div>

                        <!-- Weekly Calendar - Enhanced -->
                        <div class="mt-5 z-10 relative">
                            <div class="flex items-center justify-between mb-3">
                                <span
                                    class="text-[10px] text-neutral-500 dark:text-gray-400 uppercase tracking-wider font-semibold">This
                                    Week</span>
                                <span class="text-[9px] text-neutral-500 dark:text-gray-500" id="weekProgressText">0/7
                                    days complete</span>
                            </div>
                            <div class="flex justify-between items-start" id="streakCalendarGrid"
                                style="display: flex; flex-direction: row; gap: 8px;">
                                <!-- Calendar populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ================= SYLLABUS EXPLORER ================= -->
    <section id="syllabus-section" class="relative py-12 md:py-16 border-t border-black/5 dark:border-white/10">
        <div class="container">
            <header class="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                    <h3 class="text-2xl md:text-3xl font-extrabold tracking-tight">Syllabus Explorer</h3>
                    <p class="mt-2 text-neutral-600 dark:text-white/70 max-w-xl">Expand courses to track unit mastery.
                        Toggle topics as you complete them to update progress instantly.</p>
                </div>
                <div class="flex flex-wrap items-center gap-3">
                    <div class="relative">
                        <span
                            class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500 text-base">search</span>
                        <input id="syllabusSearch" type="text" placeholder="Filter topics‚Ä¶"
                            class="pl-9 pr-3 py-2 text-sm rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-brand-900/40 focus:outline-none focus:ring-2 focus:ring-brand-500 w-56">
                    </div>
                    <button id="expandAllCourses"
                        class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                        <span class="material-symbols-rounded text-base">unfold_more</span>
                        Expand All
                    </button>
                    <button id="collapseAllCourses"
                        class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                        <span class="material-symbols-rounded text-base">unfold_less</span>
                        Collapse All
                    </button>
                </div>
            </header>

            <div id="progressError" class="hidden text-sm text-red-500 dark:text-red-300 mb-4"></div>
            <div id="syllabus" class="grid gap-6"></div>
            <div id="syllabusEmpty" class="hidden text-sm text-neutral-600 dark:text-white/60 mt-6">No syllabus found
                for your batch / semester yet.</div>
        </div>
    </section>

    <!-- ================= QUICK ACTIONS & INSIGHTS ================= -->
    <section class="py-14 border-t border-black/5 dark:border-white/10">
        <div class="container grid lg:grid-cols-3 gap-10 items-start">
            <div class="lg:col-span-2 space-y-8">
                <div class="glass-panel rounded-3xl p-6 md:p-8 space-y-6">
                    <div class="flex items-center justify-between">
                        <h4 class="text-lg font-semibold">Upcoming (Beta)</h4>
                        <span
                            class="text-[11px] px-2 py-1 rounded-full bg-brand-500/10 text-brand-700 dark:text-brandlt-200">Soon</span>
                    </div>
                    <div id="upcomingList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div
                            class="rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4 bg-white/70 dark:bg-brand-900/40 flex flex-col gap-2">
                            <span class="text-xs font-medium text-neutral-500 dark:text-white/50">Exams</span>
                            <p class="text-sm text-neutral-600 dark:text-white/65">Adaptive exam prep timeline will
                                appear here.</p>
                        </div>
                        <div
                            class="rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4 bg-white/70 dark:bg-brand-900/40 flex flex-col gap-2">
                            <span class="text-xs font-medium text-neutral-500 dark:text-white/50">Study Streak</span>
                            <p class="text-sm text-neutral-600 dark:text-white/65">Daily revision streak metrics
                                incoming.</p>
                        </div>
                        <div
                            class="rounded-2xl ring-1 ring-black/5 dark:ring-white/10 p-4 bg-white/70 dark:bg-brand-900/40 flex flex-col gap-2">
                            <span class="text-xs font-medium text-neutral-500 dark:text-white/50">Targets</span>
                            <p class="text-sm text-neutral-600 dark:text-white/65">Set weekly topic goals soon.</p>
                        </div>
                    </div>
                </div>
            </div>
            <aside class="space-y-8">
                <div class="glass-panel rounded-3xl p-6 md:p-8 space-y-6">
                    <h4 class="text-lg font-semibold flex items-center gap-2">
                        <span class="material-symbols-rounded text-base">tips_and_updates</span>
                        Tips
                    </h4>
                    <ul id="tipsList" class="text-sm space-y-3 text-neutral-600 dark:text-white/65">
                        <li>Use the check icon to mark a topic complete - progress updates instantly.</li>
                        <li>Generate AI-notes for any topic via the linked notes page.</li>
                    </ul>
                </div>
            </aside>
        </div>
    </section>

    <!-- ================= FOOTER ================= -->
    <footer
        class="py-10 border-t border-black/5 dark:border-white/10 text-center text-xs text-neutral-600 dark:text-white/60">
        ¬© <span id="year"></span> Paper X ‚Ä¢ Academics Dashboard
    </footer>

    <!-- ================= TEMPLATES ================= -->
    <template id="courseCardTpl">
        <div
            class="rounded-2xl ring-1 ring-black/5 dark:ring-white/10 bg-white/80 dark:bg-brand-900/55 backdrop-blur overflow-hidden group">
            <div class="px-5 py-4 flex items-center justify-between cursor-pointer hover:bg-white/70 dark:hover:bg-brand-900/40 transition-colors"
                data-course-toggle aria-expanded="false">
                <div class="flex items-center gap-3 font-semibold text-sm md:text-base">
                    <span class="material-symbols-rounded text-neutral-500 transition-transform duration-200 -rotate-90"
                        data-course-caret>expand_more</span>
                    <span data-cc class="text-brand-600 dark:text-brand-400"></span>
                    <span class="opacity-40">‚Ä¢</span>
                    <span data-title class="truncate course-title"></span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:block w-40 h-2 rounded bg-black/5 dark:bg-white/10 overflow-hidden"
                        aria-label="Course progress">
                        <div class="h-full bg-brand-500 transition-all" style="width:0%" data-course-progress-bar></div>
                    </div>
                    <span class="text-[11px] rounded-full ring-1 ring-black/10 dark:ring-white/15 px-2 py-0.5"><span
                            data-course-progress-text>0/0</span></span>
                    <span class="text-[11px] rounded-full ring-1 ring-black/10 dark:ring-white/15 px-2 py-0.5">Sem <span
                            data-sem></span></span>
                </div>
            </div>
            <div class="p-5 grid gap-4" data-units></div>
        </div>
    </template>

    <template id="unitItemTpl">
        <div class="rounded-xl ring-1 ring-black/5 dark:ring-white/10 bg-white/70 dark:bg-brand-900/40">
            <div
                class="w-full px-4 py-3 flex items-center justify-between hover:bg-white/60 dark:hover:bg-brand-900/30 transition-colors">
                <button type="button" class="flex-1 text-left flex items-center gap-2 text-sm font-medium"
                    data-unit-toggle aria-expanded="false">
                    <span class="material-symbols-rounded text-neutral-500 transition-transform duration-200 -rotate-90"
                        data-unit-caret>expand_more</span>
                    <span data-unit-title></span>
                </button>
                <button type="button"
                    class="ml-3 inline-flex items-center gap-1 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-4 py-1.5 text-[11px] font-semibold text-white shadow-[0_10px_28px_rgba(158,75,138,0.35)] hover:shadow-[0_14px_34px_rgba(158,75,138,0.45)] transition disabled:opacity-60 disabled:cursor-not-allowed"
                    data-unit-blink>
                    <span class="material-symbols-rounded text-sm">bolt</span>
                    Blink
                </button>
            </div>
            <div class="px-4 pb-4">
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-36 h-2 rounded bg-black/5 dark:bg-white/10 overflow-hidden"
                        aria-label="Unit progress">
                        <div class="h-full bg-emerald-500 transition-all" style="width:0%" data-unit-progress-bar></div>
                    </div>
                    <span class="text-[11px] text-neutral-600 dark:text-white/60" data-unit-progress-text>0/0</span>
                </div>
                <ul class="space-y-0.5 text-sm leading-tight" data-topics></ul>
            </div>
        </div>
    </template>

    <!-- ================= SCRIPTS ================= -->
    <script>
        const API_BASE = (window.API_BASE || 'http://localhost:8000').replace(/\/$/, '');
        const completedTopicIds = new Set();
        const wishlistedTopicIds = new Set();
        const $ = (id) => document.getElementById(id);
        const setText = (id, val) => { const n = $(id); if (n) n.textContent = val ?? '-'; };
        function initials(name) { if (!name) return 'U'; return name.trim().split(/\s+/).slice(0, 2).map(p => p[0]?.toUpperCase()).join('') || 'U'; }
        function getToken() { try { return localStorage.getItem('px_token'); } catch { return null; } }
        function authHeaders() { const t = getToken(); return t ? { Authorization: `Bearer ${t}` } : {}; }
        function escapeHtml(str) {
            return (str ?? '').toString().replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const isSuccess = (res) => res && !res.error && !res.unauthorized && typeof res.status === 'number' && res.status >= 200 && res.status < 300;
        const progressErrorNode = () => $('progressError');
        function showProgressError(message) {
            const el = progressErrorNode();
            if (!el) return;
            el.textContent = message;
            el.classList.remove('hidden');
        }
        function clearProgressError() {
            const el = progressErrorNode();
            if (!el) return;
            el.textContent = '';
            el.classList.add('hidden');
        }

        async function fetchJson(url, opts = {}) {
            try {
                const r = await fetch(url, opts);
                if (r.status === 401) return { unauthorized: true };
                const data = await (r.ok ? r.json() : null);
                return { status: r.status, data };
            } catch (e) { return { error: true }; }
        }
        // Token refresh helper - attempts to refresh access token if expired or about to expire
        async function refreshTokenIfNeeded() {
            const REFRESH_TOKEN_KEY = 'px_refresh_token';
            const TOKEN_EXPIRES_KEY = 'px_token_expires_at';
            const USER_TOKEN_KEY = 'px_token';

            const refreshToken = localStorage.getItem(REFRESH_TOKEN_KEY);
            const expiresAt = localStorage.getItem(TOKEN_EXPIRES_KEY);
            const accessToken = localStorage.getItem(USER_TOKEN_KEY);

            // If no refresh token, can't refresh
            if (!refreshToken) return false;

            // If access token exists and not expired (with 5 min buffer), no refresh needed
            if (accessToken && expiresAt) {
                const expiryTime = parseInt(expiresAt, 10);
                const bufferMs = 5 * 60 * 1000; // 5 minutes
                if (Date.now() < (expiryTime - bufferMs)) {
                    return true; // Token still valid
                }
            }

            // Need to refresh
            try {
                console.log('[Academics] Token expired or missing. Attempting refresh...');
                const res = await fetch(`${API_BASE}/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                if (!res.ok) {
                    console.warn('[Academics] Refresh failed:', res.status);
                    return false;
                }
                const data = await res.json();
                if (data.access_token) {
                    console.log('[Academics] Token refreshed successfully.');
                    localStorage.setItem(USER_TOKEN_KEY, data.access_token);
                    if (data.refresh_token) {
                        localStorage.setItem(REFRESH_TOKEN_KEY, data.refresh_token);
                    }
                    if (data.expires_in) {
                        const newExpiresAt = Date.now() + (data.expires_in * 1000);
                        localStorage.setItem(TOKEN_EXPIRES_KEY, newExpiresAt.toString());
                    }
                    return true;
                }
                return false;
            } catch (e) {
                console.error('[Academics] Token refresh failed:', e);
                return false;
            }
        }

        async function loadProfileAndProgress() {
            // First attempt to refresh token if needed
            await refreshTokenIfNeeded();

            if (!getToken()) { window.location.href = 'login.html'; return; }
            clearProgressError();
            const maxAttempts = 3;
            try {
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    const result = await attemptProfileAndProgressLoad();
                    if (result.unauthorized) { window.location.href = 'login.html'; return; }
                    if (result.ok) { clearProgressError(); return; }
                    showProgressError('Still syncing your progress, retrying...');
                    await wait(Math.min(1200, 400 * (attempt + 1)));
                }
                showProgressError('We could not load your progress right now. Please refresh or try again in a moment.');
            } finally {
                // Hide loader
                document.body.classList.add('loaded');
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    setTimeout(() => { loader.style.display = 'none'; }, 450);
                }
            }
        }

        async function attemptProfileAndProgressLoad() {
            try {
                const [meOut, progOut] = await Promise.all([
                    fetchJson(`${API_BASE}/api/me`, { headers: authHeaders() }),
                    fetchJson(`${API_BASE}/api/progress/topics`, { headers: authHeaders() })
                ]);
                if (meOut.unauthorized || progOut.unauthorized) {
                    return { unauthorized: true };
                }
                if (!isSuccess(meOut) || !meOut?.data?.profile) {
                    return { ok: false };
                }
                if (!isSuccess(progOut)) {
                    return { ok: false };
                }

                const profile = meOut.data.profile;
                window.__PX_PROFILE_SNAPSHOT = profile;
                __pxEduMaybeRequire(profile).catch(err => console.error('Education modal failed', err));
                if (typeof window.__PX_NAV_APPLY === 'function') { window.__PX_NAV_APPLY(profile); }
                renderProfile(profile);

                const progressIds = Array.isArray(progOut.data?.completed_topic_ids) ? progOut.data.completed_topic_ids : [];
                completedTopicIds.clear();
                progressIds.forEach(id => completedTopicIds.add(id));

                const syllabus = Array.isArray(meOut.data?.syllabus) ? meOut.data.syllabus : [];
                const emptyState = $('syllabusEmpty');
                if (emptyState) emptyState.classList.toggle('hidden', Boolean(syllabus.length));

                const teacherNotesBySubject = await loadTeacherNotesForSubjects(syllabus);

                // Collect all topic names (lowercase) and fetch blink links
                const allTopicNames = [];
                const allTopicIds = [];
                syllabus.forEach(c => (c.units || []).forEach(u => (u.topics || []).forEach(t => {
                    if (t.topic) allTopicNames.push(t.topic.toLowerCase());
                    if (t.id) allTopicIds.push(t.id);
                })));
                const blinkLinks = await fetchBlinkLinks(allTopicNames);
                const topicRatings = await fetchTopicRatings(allTopicIds);

                // Fetch wishlist status for all topics
                await fetchWishlistStatus();

                renderSyllabus(syllabus, teacherNotesBySubject, blinkLinks, topicRatings);
                computeAggregateStats(syllabus);

                // Load streak data after main content is loaded
                loadStreakFromAPI();

                return { ok: true };
            } catch (err) {
                console.warn('[Academics] attempt load failed', err);
                return { ok: false };
            }
        }

        async function loadTeacherNotesForSubjects(syllabus = []) {
            const notesBySubject = new Map();
            const subjectIds = new Set();
            (syllabus || []).forEach(course => {
                if (course?.id) subjectIds.add(String(course.id));
                else if (course?.course_id) subjectIds.add(String(course.course_id));
                else if (course?.subject_id) subjectIds.add(String(course.subject_id));
            });
            if (!subjectIds.size) {
                return notesBySubject;
            }
            await Promise.all(
                Array.from(subjectIds).map(async (sid) => {
                    try {
                        const notesRes = await fetchJson(`${API_BASE}/api/marketplace/subjects/${encodeURIComponent(sid)}/teacher-notes`, { headers: authHeaders() });
                        if (isSuccess(notesRes) && Array.isArray(notesRes.data?.notes) && notesRes.data.notes.length) {
                            const sorted = [...notesRes.data.notes].sort((a, b) => {
                                const aDate = Date.parse(a.updated_at || a.created_at || '') || 0;
                                const bDate = Date.parse(b.updated_at || b.created_at || '') || 0;
                                return bDate - aDate;
                            });
                            notesBySubject.set(sid, sorted);
                        }
                    } catch (err) {
                        console.warn('[Academics] teacher notes fetch failed', sid, err);
                    }
                })
            );
            return notesBySubject;
        }

        function renderProfile(p) {
            const avatar = $('avatar'); const img = $('avatarImg');
            avatar.textContent = initials(p.name);
            if (p.profile_image_url) { img.src = p.profile_image_url; img.classList.remove('hidden'); }
            setText('name', p.name); setText('email', p.email);
            setText('semester', p.semester ? `Sem ${p.semester}` : 'Sem -');
            setText('regno', p.regno); setText('phone', p.phone);
            setText('college', p.college?.name || p.college || '-');
            setText('department', p.department?.name || p.department || '-');
            setText('batch', p.batch ? `${p.batch.from}-${p.batch.to}` : '-');
        }

        function pct(done, total) { return total ? Math.round((done / total) * 100) : 0; }
        function updateRing(p) { const ring = $('ringCompletion'); const text = $('ringCompletionText'); if (ring) ring.style.setProperty('--pct', p); if (text) text.textContent = p + '%'; }

        // Fetch blink links for topic names
        async function fetchBlinkLinks(topicNames) {
            const blinkLinksMap = new Map();
            if (!topicNames || !topicNames.length) return blinkLinksMap;

            try {
                const topicsParam = topicNames.join(',');
                const res = await fetchJson(`${API_BASE}/api/blink/links?topics=${encodeURIComponent(topicsParam)}`, { headers: authHeaders() });
                if (isSuccess(res) && res.data?.links) {
                    Object.entries(res.data.links).forEach(([topicKey, link]) => {
                        blinkLinksMap.set(topicKey, link);
                    });
                }
            } catch (err) {
                console.warn('[Academics] Failed to fetch blink links', err);
            }
            return blinkLinksMap;
        }

        // Fetch topic ratings for display
        async function fetchTopicRatings(topicIds) {
            const ratingsMap = new Map();
            if (!topicIds || !topicIds.length) return ratingsMap;

            try {
                const res = await fetch(`${API_BASE}/api/syllabus/topics/ratings/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ topic_ids: topicIds })
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data?.ratings) {
                        Object.entries(data.ratings).forEach(([topicId, rating]) => {
                            ratingsMap.set(topicId, rating);
                        });
                    }
                }
            } catch (err) {
                console.warn('[Academics] Failed to fetch topic ratings', err);
            }
            return ratingsMap;
        }

        // Fetch user's wishlist to track which topics are wishlisted
        async function fetchWishlistStatus() {
            try {
                const res = await fetchJson(`${API_BASE}/api/wishlist`, { headers: authHeaders() });
                if (isSuccess(res) && res.data?.wishlist) {
                    wishlistedTopicIds.clear();
                    res.data.wishlist.forEach(item => {
                        if (item.topic_id) wishlistedTopicIds.add(item.topic_id);
                    });
                }
            } catch (err) {
                console.warn('[Academics] Failed to fetch wishlist', err);
            }
        }

        // Toggle wishlist for a topic
        async function toggleWishlist(topicId, btn, icon) {
            const wasWishlisted = wishlistedTopicIds.has(topicId);
            // Optimistic UI update
            if (wasWishlisted) {
                wishlistedTopicIds.delete(topicId);
                icon.style.color = 'currentColor';
                icon.style.fontVariationSettings = "'FILL' 0";
                btn.style.opacity = '0';
                btn.title = 'Add to wishlist';
            } else {
                wishlistedTopicIds.add(topicId);
                icon.style.color = '#ef4444';
                icon.style.fontVariationSettings = "'FILL' 1";
                btn.style.opacity = '1';
                btn.title = 'Remove from wishlist';
            }

            try {
                const res = await fetch(`${API_BASE}/api/wishlist/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ topic_id: topicId })
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.detail || 'Failed');
                }
                // Sync with server response
                if (data.wishlisted) {
                    wishlistedTopicIds.add(topicId);
                    icon.style.color = '#ef4444';
                    icon.style.fontVariationSettings = "'FILL' 1";
                    btn.style.opacity = '1';
                    btn.title = 'Remove from wishlist';
                } else {
                    wishlistedTopicIds.delete(topicId);
                    icon.style.color = 'currentColor';
                    icon.style.fontVariationSettings = "'FILL' 0";
                    btn.style.opacity = '0';
                    btn.title = 'Add to wishlist';
                }
            } catch (err) {
                console.error('[Academics] Wishlist toggle failed', err);
                // Revert UI on error
                if (wasWishlisted) {
                    wishlistedTopicIds.add(topicId);
                    icon.style.color = '#ef4444';
                    icon.style.fontVariationSettings = "'FILL' 1";
                    btn.style.opacity = '1';
                    btn.title = 'Remove from wishlist';
                } else {
                    wishlistedTopicIds.delete(topicId);
                    icon.style.color = 'currentColor';
                    icon.style.fontVariationSettings = "'FILL' 0";
                    btn.style.opacity = '0';
                    btn.title = 'Add to wishlist';
                }
            }
        }

        // Record topic view in history
        async function recordTopicHistory(topicId, topicName) {
            try {
                await fetch(`${API_BASE}/api/history/record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ topic_id: topicId, topic_name: topicName })
                });
            } catch (err) {
                console.warn('[Academics] Failed to record history', err);
            }
        }

        function computeAggregateStats(syllabus) {
            let totalTopics = 0, doneTopics = 0, courses = 0, semesterLabel = '';
            syllabus.forEach(c => { courses++; semesterLabel = c.semester || semesterLabel; (c.units || []).forEach(u => { (u.topics || []).forEach(t => { totalTopics++; if (completedTopicIds.has(t.id)) doneTopics++; }); }); });
            setText('statTopicsDone', doneTopics); setText('statTopicsTotal', totalTopics); setText('statCourses', courses); setText('statSemester', semesterLabel ? 'Sem ' + semesterLabel : 'Sem -');
            const completion = pct(doneTopics, totalTopics); updateRing(completion); const bar = $('barTopics'); if (bar) { bar.style.width = (completion || 0) + '%'; bar.classList.remove('animate-pulseBar'); }
        }

        function renderSyllabus(list, teacherNotesBySubject = new Map(), blinkLinksMap = new Map(), topicRatingsMap = new Map()) {
            const wrap = $('syllabus'); wrap.innerHTML = ''; const cTpl = $('courseCardTpl'); const uTpl = $('unitItemTpl');
            const courseNodes = [];
            list.forEach(c => {
                const cNode = cTpl.content.cloneNode(true); const header = cNode.querySelector('[data-course-toggle]'); const caret = cNode.querySelector('[data-course-caret]'); const unitsWrap = cNode.querySelector('[data-units]'); const progBar = cNode.querySelector('[data-course-progress-bar]'); const progText = cNode.querySelector('[data-course-progress-text]');
                cNode.querySelector('[data-cc]').textContent = c.course_code; cNode.querySelector('[data-title]').textContent = c.title; cNode.querySelector('[data-sem]').textContent = c.semester;
                unitsWrap.classList.add('hidden'); header.setAttribute('aria-expanded', 'false');
                header.addEventListener('click', () => { const collapsed = unitsWrap.classList.toggle('hidden'); const expanded = !collapsed; header.setAttribute('aria-expanded', expanded ? 'true' : 'false'); caret.classList.toggle('-rotate-90', !expanded ? true : false); caret.classList.toggle('rotate-0', expanded ? true : false); });
                const courseId = c.id || c.course_id || c.subject_id;
                const courseKey = courseId ? String(courseId) : null;
                const courseCounts = { done: 0, total: 0 };
                (c.units || []).forEach(u => {
                    const uNode = uTpl.content.cloneNode(true);
                    const uHeader = uNode.querySelector('[data-unit-toggle]');
                    const uCaret = uNode.querySelector('[data-unit-caret]');
                    const topicsWrap = uNode.querySelector('[data-topics]');
                    const unitTitle = uNode.querySelector('[data-unit-title]');
                    const unitProgBar = uNode.querySelector('[data-unit-progress-bar]');
                    const unitProgText = uNode.querySelector('[data-unit-progress-text]');
                    const blinkBtn = uNode.querySelector('[data-unit-blink]');

                    // Check BOTH tables for blink images:
                    // 1. syllabus_topics.image_url (old way)
                    const hasImageInSyllabus = Array.isArray(u.topics) && u.topics.some(t => (t.image_url || '').trim() !== '');

                    // 2. ai_notes.blink_link (new way)
                    let hasBlinkInAiNotes = false;
                    if (Array.isArray(u.topics)) {
                        for (const t of u.topics) {
                            const topicKey = (t.topic || '').toLowerCase();
                            if (blinkLinksMap.has(topicKey)) {
                                hasBlinkInAiNotes = true;
                                break;
                            }
                        }
                    }

                    // Show blink button if ANY topic has image in EITHER table
                    const hasAnyBlink = hasImageInSyllabus || hasBlinkInAiNotes;

                    topicsWrap.classList.add('hidden');
                    uHeader.setAttribute('aria-expanded', 'false');
                    unitTitle.textContent = u.unit_title || u.title || 'Unit';

                    uHeader.addEventListener('click', (ev) => {
                        if (ev.target.closest('[data-unit-blink]')) return;
                        const collapsed = topicsWrap.classList.toggle('hidden');
                        const expanded = !collapsed;
                        uHeader.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                        uCaret.classList.toggle('-rotate-90', !expanded);
                        uCaret.classList.toggle('rotate-0', expanded);
                    });

                    if (blinkBtn) {
                        const unitId = u.id || u.unit_id;
                        // Show blink button if any topic has image in either table
                        blinkBtn.classList.toggle('hidden', !hasAnyBlink);
                        blinkBtn.addEventListener('click', (ev) => {
                            ev.stopPropagation();
                            if (!unitId) return;
                            // Open syllabus_blink.html carousel page
                            const url = `syllabus_blink.html?unit_id=${encodeURIComponent(unitId)}&course_title=${encodeURIComponent(c.title || '')}&unit_title=${encodeURIComponent(u.unit_title || u.title || '')}`;
                            window.open(url, '_blank', 'noopener');
                        });
                    }
                    const unitCounts = { done: 0, total: 0 };
                    (u.topics || []).forEach(t => {
                        const li = document.createElement('li'); li.className = 'flex items-center gap-2 py-0.5 px-2 rounded hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-sm leading-tight';
                        const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'p-1 rounded focus:outline-none focus:ring-2 focus:ring-brand-500/40'; const icon = document.createElement('span'); icon.className = 'material-symbols-rounded text-[20px]';
                        const initChecked = completedTopicIds.has(t.id); icon.textContent = initChecked ? 'check_circle' : 'radio_button_unchecked'; icon.style.color = initChecked ? '#10b981' : 'currentColor'; btn.appendChild(icon); btn.dataset.topicId = t.id;
                        btn.addEventListener('click', () => toggleTopic(t.id, icon, unitCounts, courseCounts, unitProgBar, unitProgText, progBar, progText, unitTitle)); li.appendChild(btn);

                        // Create a wrapper for topic name and wishlist button with JS-based hover
                        const topicWishlistGroup = document.createElement('span');
                        topicWishlistGroup.className = 'inline-flex items-center gap-1';

                        const a = document.createElement('a');
                        a.href = 'notes_generator.html?topic=' + encodeURIComponent(t.topic);
                        a.textContent = t.topic;
                        a.target = '_blank';
                        a.rel = 'noopener';
                        a.className = 'text-brand-600 dark:text-brand-300 hover:underline';
                        a.onclick = () => {
                            // Record to history
                            recordTopicHistory(t.id, t.topic);
                            if (window.Analytics) {
                                window.Analytics.track('topic_opened', { topic: t.topic });
                            }
                        };
                        topicWishlistGroup.appendChild(a);

                        // Wishlist button
                        const wishBtn = document.createElement('button');
                        wishBtn.type = 'button';
                        const isWishlisted = wishlistedTopicIds.has(t.id);
                        // Show always if wishlisted, otherwise hide until hover via JS events
                        wishBtn.className = 'p-1 rounded hover:bg-black/5 dark:hover:bg-white/10 transition';
                        wishBtn.style.opacity = isWishlisted ? '1' : '0';
                        wishBtn.title = isWishlisted ? 'Remove from wishlist' : 'Add to wishlist';
                        const wishIcon = document.createElement('span');
                        wishIcon.className = 'material-symbols-rounded text-[18px]';
                        wishIcon.textContent = 'favorite';
                        wishIcon.style.color = isWishlisted ? '#ef4444' : 'currentColor';
                        wishIcon.style.fontVariationSettings = isWishlisted ? "'FILL' 1" : "'FILL' 0";
                        wishBtn.appendChild(wishIcon);
                        wishBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleWishlist(t.id, wishBtn, wishIcon);
                        });
                        topicWishlistGroup.appendChild(wishBtn);

                        // JavaScript hover handlers for showing/hiding wishlist button on individual topic
                        topicWishlistGroup.addEventListener('mouseenter', () => {
                            if (!wishlistedTopicIds.has(t.id)) {
                                wishBtn.style.opacity = '1';
                            }
                        });
                        topicWishlistGroup.addEventListener('mouseleave', () => {
                            if (!wishlistedTopicIds.has(t.id)) {
                                wishBtn.style.opacity = '0';
                            }
                        });

                        li.appendChild(topicWishlistGroup);

                        // Star rating display (read-only) - show only the number of stars rated
                        const topicRating = topicRatingsMap.get(t.id);
                        if (topicRating && topicRating >= 1 && topicRating <= 3) {
                            const starContainer = document.createElement('span');
                            starContainer.className = 'star-display';
                            starContainer.title = `Staff rating: ${topicRating} star${topicRating > 1 ? 's' : ''}`;
                            for (let s = 1; s <= topicRating; s++) {
                                const star = document.createElement('span');
                                star.className = 'star material-symbols-rounded filled';
                                star.textContent = 'star';
                                starContainer.appendChild(star);
                            }
                            li.appendChild(starContainer);
                        }

                        const labUrl = (t.lab_url || '').trim();
                        if (labUrl) {
                            const labLink = document.createElement('a');
                            labLink.href = labUrl;
                            labLink.target = '_blank';
                            labLink.rel = 'noopener';
                            labLink.innerHTML = '<span class="material-symbols-rounded text-[16px]">science</span><span>Labs</span>';
                            labLink.className = 'ml-auto inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[12px] font-semibold bg-brand-500/10 text-brand-700 dark:text-brandlt-200 ring-1 ring-brand-500/25 hover:bg-brand-500/20 hover:shadow-glow transition';
                            labLink.title = 'Open lab material';
                            labLink.onclick = () => {
                                if (window.Analytics) {
                                    window.Analytics.track('lab_started', {
                                        url: labUrl,
                                        topic: t.topic
                                    });
                                }
                            };
                            li.appendChild(labLink);
                        }

                        unitCounts.total++; if (initChecked) unitCounts.done++; topicsWrap.appendChild(li);
                    });
                    courseCounts.total += unitCounts.total; courseCounts.done += unitCounts.done; updateUnitProgress(unitCounts, unitProgBar, unitProgText); updateUnitCompletedStyle(unitCounts, unitTitle); unitsWrap.appendChild(uNode);
                });

                const subjectNotes = courseKey ? (teacherNotesBySubject.get(courseKey) || []) : [];
                if (subjectNotes.length) {
                    const notesCard = document.createElement('div');
                    notesCard.className = 'rounded-xl ring-1 ring-brand-500/20 bg-brand-500/5 dark:bg-brand-900/40 overflow-hidden';
                    notesCard.innerHTML = `
                        <div class="px-4 py-3 flex items-center justify-between text-sm font-semibold text-brand-700 dark:text-brandlt-200 bg-brand-500/10 dark:bg-brand-500/20">
                            <span class="inline-flex items-center gap-2"><span class="material-symbols-rounded text-base">library_books</span>Teacher Notes</span>
                            <span class="text-[11px] font-medium">${subjectNotes.length + ' file' + (subjectNotes.length === 1 ? '' : 's')}</span>
                        </div>
                    `;
                    const notesBody = document.createElement('div');
                    notesBody.className = 'px-4 pb-4';
                    const listEl = document.createElement('ul');
                    listEl.className = 'divide-y divide-black/5 dark:divide-white/10';
                    subjectNotes.forEach(note => {
                        const li = document.createElement('li');
                        li.className = 'py-2';
                        const price = Number(note.price_cents || 0);
                        const priceLabel = price > 0 ? `Rs ${(price / 100).toFixed(0)}` : 'Free';
                        const seller = note.seller?.name || 'Teacher';
                        const updated = note.updated_at || note.created_at;
                        const formattedDate = updated ? new Date(updated).toLocaleDateString() : '';
                        const link = document.createElement('a');
                        link.href = `matketplace/notes/note_detail.html?id=${encodeURIComponent(note.id)}`;
                        link.target = '_blank';
                        link.rel = 'noopener';
                        link.className = 'flex items-center justify-between gap-3 text-sm text-brand-600 dark:text-brand-200 hover:underline';
                        link.innerHTML = `
                            <span class="flex-1">${escapeHtml(note.title || 'Untitled note')}</span>
                            <span class="flex items-center gap-2 text-[11px] text-neutral-500 dark:text-white/60">
                                <span class="px-2 py-0.5 rounded-full bg-brand-500/15 text-brand-700 dark:text-brandlt-200">${priceLabel}</span>
                                ${formattedDate ? `<span>${formattedDate}</span>` : ''}
                                <span>${escapeHtml(seller)}</span>
                            </span>
                        `;
                        li.appendChild(link);
                        listEl.appendChild(li);
                    });
                    notesBody.appendChild(listEl);
                    notesCard.appendChild(notesBody);
                    unitsWrap.appendChild(notesCard);
                }

                updateCourseProgress(courseCounts, progBar, progText); wrap.appendChild(cNode); courseNodes.push({ header, unitsWrap });
            });

            // Expand/collapse helpers
            const expandAllBtn = $('expandAllCourses'); const collapseAllBtn = $('collapseAllCourses');
            if (expandAllBtn) expandAllBtn.onclick = () => { courseNodes.forEach(n => { n.unitsWrap.classList.remove('hidden'); n.header.setAttribute('aria-expanded', 'true'); }); };
            if (collapseAllBtn) collapseAllBtn.onclick = () => { courseNodes.forEach(n => { n.unitsWrap.classList.add('hidden'); n.header.setAttribute('aria-expanded', 'false'); }); };

            // Search filter
            const search = $('syllabusSearch');
            if (search) {
                search.oninput = () => {
                    const q = search.value.trim().toLowerCase();
                    document.querySelectorAll('#syllabus [data-units]').forEach(uw => {
                        uw.querySelectorAll('[data-unit-toggle]').forEach(btn => {
                            const unit = btn.parentElement; const topics = unit.querySelector('[data-topics]');
                            let matchCount = 0; topics.querySelectorAll('li a').forEach(a => { const m = !q || a.textContent.toLowerCase().includes(q); a.parentElement.classList.toggle('hidden', !m); if (m) matchCount++; });
                            const showUnit = !q || matchCount > 0; unit.classList.toggle('hidden', !showUnit);
                            // auto expand matching units
                            if (q && showUnit) { topics.classList.remove('hidden'); btn.setAttribute('aria-expanded', 'true'); unit.querySelector('[data-unit-caret]')?.classList.replace('-rotate-90', 'rotate-0'); }
                        });
                    });
                };
            }
        }

        function toggleTopic(id, icon, unitCounts, courseCounts, unitProgBar, unitProgText, courseProgBar, courseProgText, unitTitle) {
            const willCheck = !completedTopicIds.has(id);
            fetch(`${API_BASE}/api/progress/toggle`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders() }, body: JSON.stringify({ topic_id: id, completed: willCheck }) }).catch(() => { });
            if (willCheck) { completedTopicIds.add(id); unitCounts.done++; courseCounts.done++; } else { completedTopicIds.delete(id); unitCounts.done--; courseCounts.done--; }
            icon.textContent = willCheck ? 'check_circle' : 'radio_button_unchecked'; icon.style.color = willCheck ? '#10b981' : 'currentColor';
            updateUnitProgress(unitCounts, unitProgBar, unitProgText); updateCourseProgress(courseCounts, courseProgBar, courseProgText); updateUnitCompletedStyle(unitCounts, unitTitle);
            computeAggregateStatsFromState();
        }

        function computeAggregateStatsFromState() { /* reserved for potential DOM-scan recompute */ }
        function updateUnitProgress(c, b, t) { const p = pct(c.done, c.total); if (b) b.style.width = p + '%'; if (t) t.textContent = `${c.done}/${c.total}`; }
        function updateCourseProgress(c, b, t) { const p = pct(c.done, c.total); if (b) b.style.width = p + '%'; if (t) t.textContent = `${c.done}/${c.total}`; }
        function updateUnitCompletedStyle(c, titleEl) { if (!titleEl) return; const complete = c.total > 0 && c.done >= c.total; titleEl.classList.toggle('line-through', complete); titleEl.classList.toggle('opacity-60', complete); }

        // Quick note (local only)
        const notesKey = 'px_quick_notes';
        function loadNotes() { try { return JSON.parse(localStorage.getItem(notesKey) || '[]'); } catch { return []; } }
        function saveNotes(list) {
            try { localStorage.setItem(notesKey, JSON.stringify(list.slice(-50))); } catch { }
        }
        const form = $('quickNoteForm');
        if (form) {
            form.addEventListener('submit', e => {
                e.preventDefault(); const topic = $('quickNoteTopic').value.trim(); const body = $('quickNoteBody').value.trim();
                if (!topic && !body) { $('quickNoteStatus').textContent = 'Nothing to save.'; return; }
                const list = loadNotes(); list.push({ topic, body, ts: Date.now() }); saveNotes(list);
                $('quickNoteTopic').value = ''; $('quickNoteBody').value = ''; $('quickNoteStatus').textContent = 'Saved locally (' + list.length + ' notes).';
                setTimeout(() => $('quickNoteStatus').textContent = '', 3000);
            });
        }

        // Theme toggle (shared)
        (function () {
            const root = document.documentElement;
            const applyIcon = (m) => document.querySelectorAll('[data-theme-toggle] .material-symbols-rounded').forEach(i => i.textContent = m === 'dark' ? 'light_mode' : 'dark_mode');
            const set = (m) => { if (m === 'dark') { root.classList.add('dark'); } else { root.classList.remove('dark'); } localStorage.setItem('px_theme', m); applyIcon(m); };
            const current = root.classList.contains('dark') ? 'dark' : 'light'; applyIcon(current);
            document.addEventListener('click', e => { const b = e.target.closest('[data-theme-toggle]'); if (!b) return; set(root.classList.contains('dark') ? 'light' : 'dark'); });
        })();

        // Nav profile helpers
        (function initNavAuth() {
            const t = getToken();
            const navProfile = document.getElementById('navProfile');
            const navProfileImg = document.getElementById('navProfileImg');
            const navProfileInitial = document.getElementById('navProfileInitial');
            const signOutBtn = document.getElementById('signOutBtn');
            const navEduEditBtn = document.getElementById('navEduEditBtn');
            if (!t) return;
            document.querySelectorAll('a[href="login.html"], a[href="signup.html"]').forEach(a => { a.classList.add('hidden'); a.style.display = 'none'; });
            if (navProfile) navProfile.classList.remove('hidden');
            if (navEduEditBtn) navEduEditBtn.classList.remove('hidden');
            if (signOutBtn) {
                signOutBtn.classList.remove('hidden');
                signOutBtn.onclick = () => { try { localStorage.removeItem('px_token'); } catch { } window.location.href = 'login.html'; };
            }
            const applyNavProfile = (profile) => {
                if (!profile) return; let initialsTxt = 'ME';
                if (profile.name) { initialsTxt = profile.name.split(' ').filter(Boolean).map(part => part[0]?.toUpperCase()).slice(0, 2).join('') || 'ME'; }
                if (navProfileInitial) { navProfileInitial.textContent = initialsTxt; navProfileInitial.classList.remove('hidden'); }
                if (profile.profile_image_url && navProfileImg) { navProfileImg.src = profile.profile_image_url; navProfileImg.classList.remove('hidden'); if (navProfileInitial) navProfileInitial.classList.add('hidden'); } else if (navProfileImg) { navProfileImg.classList.add('hidden'); }
            };
            window.__PX_NAV_APPLY = applyNavProfile;
        })();

        // ===== Streak Component Logic (Backend API) =====
        // loadStreakFromAPI is called from attemptProfileAndProgressLoad after main data loads
        async function loadStreakFromAPI(retryCount = 0) {
            const token = getToken();
            if (!token) {
                console.log('[Streak] No token, skipping');
                return;
            }

            const maxRetries = 3;
            try {
                const res = await fetch(`${API_BASE}/api/streak`, {
                    headers: authHeaders()
                });

                if (!res.ok) {
                    console.warn('[Streak] API error:', res.status);
                    // Retry on transient errors
                    if (retryCount < maxRetries && (res.status >= 500 || res.status === 0)) {
                        await wait(500 * (retryCount + 1));
                        return loadStreakFromAPI(retryCount + 1);
                    }
                    return;
                }

                const data = await res.json();
                renderStreakData(data);

                // Also ping to record activity (fire-and-forget)
                fetch(`${API_BASE}/api/streak/ping`, {
                    method: 'POST',
                    headers: authHeaders()
                }).catch(() => { });
            } catch (err) {
                console.error('[Streak] Fetch error:', err);
                // Retry on network errors
                if (retryCount < maxRetries) {
                    await wait(500 * (retryCount + 1));
                    return loadStreakFromAPI(retryCount + 1);
                }
            }
        }

        function renderStreakData(data) {
            const currentStreak = data.current_streak || 0;
            const longestStreak = data.longest_streak || 0;

            // Update streak number
            const currentStreakEl = document.getElementById('currentStreak');
            const personalBestEl = document.getElementById('streakPersonalBest');
            const streakBadge = document.getElementById('streakBadge');

            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            if (personalBestEl) personalBestEl.textContent = `¬∑ Personal Best: ${longestStreak}`;
            if (streakBadge && currentStreak >= 3) streakBadge.classList.remove('hidden');

            // Milestones from API
            const nextM = data.next_milestone || 7;
            const prevM = data.prev_milestone || 0;
            const progress = data.milestone_progress || 0;

            const nextMilestoneText = document.getElementById('nextMilestoneText');
            const streakProgressBar = document.getElementById('streakProgressBar');
            const prevMilestoneLabel = document.getElementById('prevMilestoneLabel');
            const currentStreakLabel = document.getElementById('currentStreakLabel');
            const nextMilestoneLabel = document.getElementById('nextMilestoneLabel');

            if (nextMilestoneText) nextMilestoneText.textContent = `${nextM} Days üéØ`;
            if (streakProgressBar) streakProgressBar.style.width = `${progress}%`;
            if (prevMilestoneLabel) prevMilestoneLabel.textContent = `${prevM} üî•`;
            if (currentStreakLabel) currentStreakLabel.textContent = currentStreak;
            if (nextMilestoneLabel) nextMilestoneLabel.textContent = `${nextM} üèÜ`;

            // Week data from API
            const weekData = data.week_data || [];
            const weekProgressText = document.getElementById('weekProgressText');
            if (weekProgressText) weekProgressText.textContent = `${data.days_completed || 0}/7 days complete`;

            // Render calendar
            const calendarGrid = document.getElementById('streakCalendarGrid');
            if (calendarGrid && weekData.length) {
                calendarGrid.innerHTML = '';
                weekData.forEach(day => {
                    let itemClass = 'streak-day-item';
                    let circleContent = '';
                    let labelClass = 'streak-day-label';

                    if (day.is_active) {
                        itemClass += ' completed';
                        circleContent = '<span class="material-symbols-rounded text-xs text-white">check</span>';
                        if (day.is_today) {
                            itemClass = 'streak-day-item today';
                            circleContent = '<span class="material-symbols-rounded text-xs text-white">local_fire_department</span>';
                            labelClass += ' today-label';
                        }
                    } else if (day.is_future) {
                        itemClass += ' future';
                        circleContent = `<span class="text-[10px] text-neutral-500 dark:text-gray-600">${day.date}</span>`;
                    } else {
                        itemClass += ' future'; // Past inactive
                        circleContent = `<span class="text-[10px] text-neutral-500 dark:text-gray-600">${day.date}</span>`;
                    }

                    const pulseClass = (day.is_today && day.is_active) ? 'today-pulse' : '';

                    const html = `
                        <div class="${itemClass}">
                            <div class="streak-day-circle ${pulseClass}">
                                ${circleContent}
                            </div>
                            <span class="${labelClass}">${day.day}</span>
                        </div>
                    `;
                    calendarGrid.insertAdjacentHTML('beforeend', html);
                });
            }
        }

        // --- Education required modal (reuses profile.html education selection logic) ---
        const EDUCATION_CUSTOM_VALUE = '__custom__';
        let __pxEduCollegesCache = [];
        let __pxEduCollegesLoadPromise = null;
        const __pxEduCollegeDetailCache = new Map();

        const __pxEduDomReady = new Promise((resolve) => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', resolve, { once: true });
            } else {
                resolve();
            }
        });

        let __pxEduBound = false;
        const __pxEduEls = () => ({
            modal: document.getElementById('eduRequiredModal'),
            wrap: document.getElementById('eduRequiredFormWrap'),
            saveBtn: document.getElementById('eduRequiredSaveBtn'),
            status: document.getElementById('eduRequiredStatus'),
            closeBtn: document.getElementById('eduRequiredCloseBtn'),
        });

        const __pxEduGetAuthHeaders = () => {
            try { return authHeaders(); } catch (_) { return {}; }
        };

        async function __pxEduLoadCollegesList() {
            if (__pxEduCollegesCache.length) return __pxEduCollegesCache;
            if (!__pxEduCollegesLoadPromise) {
                __pxEduCollegesLoadPromise = fetch(`${API_BASE}/api/colleges`, { headers: __pxEduGetAuthHeaders() })
                    .then(res => (res.ok ? res.json() : []))
                    .catch(err => {
                        console.error('Failed to load colleges', err);
                        return [];
                    })
                    .then(items => {
                        __pxEduCollegesCache = Array.isArray(items)
                            ? items
                                .filter(col => col && col.id && col.name)
                                .map(col => ({ id: String(col.id), name: col.name }))
                            : [];
                        return __pxEduCollegesCache;
                    });
            }
            return __pxEduCollegesLoadPromise;
        }

        function __pxEduGetCollegeById(id) {
            if (!id) return null;
            return __pxEduCollegesCache.find(col => String(col.id) === String(id)) || null;
        }

        function __pxEduFindCollegeByName(name) {
            if (!name) return null;
            const target = String(name).trim().toLowerCase();
            if (!target) return null;
            return __pxEduCollegesCache.find(col => String(col?.name || '').trim().toLowerCase() === target) || null;
        }

        async function __pxEduLoadCollegeDetails(collegeId) {
            if (!collegeId) return null;
            const key = String(collegeId);
            if (__pxEduCollegeDetailCache.has(key)) {
                return __pxEduCollegeDetailCache.get(key);
            }
            try {
                const res = await fetch(`${API_BASE}/api/colleges/${key}`, { headers: __pxEduGetAuthHeaders() });
                if (!res.ok) throw new Error(`status ${res.status}`);
                const data = await res.json();
                __pxEduCollegeDetailCache.set(key, data);
                return data;
            } catch (err) {
                console.error('Failed to load college details', err);
                __pxEduCollegeDetailCache.set(key, null);
                return null;
            }
        }

        function __pxEduFindDegreeByName(degrees, name) {
            if (!Array.isArray(degrees) || !name) return null;
            const target = String(name).trim().toLowerCase();
            if (!target) return null;
            return degrees.find(deg => String(deg?.name || '').trim().toLowerCase() === target) || null;
        }

        function __pxEduFindDepartmentByName(departments, name) {
            if (!Array.isArray(departments) || !name) return null;
            const target = String(name).trim().toUpperCase();
            if (!target) return null;
            return departments.find(dep => String(dep?.name || '').trim().toUpperCase() === target) || null;
        }

        function __pxEduFormatBatchRange(batch) {
            if (!batch) return '';
            const from = Number(batch.from ?? batch.from_year);
            const to = Number(batch.to ?? batch.to_year);
            if (Number.isFinite(from) && Number.isFinite(to)) {
                return `${from}-${to}`;
            }
            return '';
        }

        function __pxEduFillSelectOptions(select, options, { placeholder = 'Select...', includeCustom = false } = {}) {
            if (!select) return;
            select.innerHTML = '';
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = placeholder;
            select.appendChild(placeholderOption);
            (options || []).forEach(opt => {
                if (!opt) return;
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                select.appendChild(option);
            });
            if (includeCustom) {
                const customOption = document.createElement('option');
                customOption.value = EDUCATION_CUSTOM_VALUE;
                customOption.textContent = 'Other / Not listed';
                select.appendChild(customOption);
            }
        }

        function __pxEduToggleCustomInput(input, show) {
            if (!input) return;
            if (show) input.classList.remove('hidden');
            else input.classList.add('hidden');
        }

        function __pxEduBuildEducationRowNode() {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
        <div class="rounded-2xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-brand-900/55 backdrop-blur p-4 grid gap-3 min-w-0" data-entry="education">
          <input type="hidden" name="edu_id" />
          <input type="hidden" name="edu_school" />
          <input type="hidden" name="edu_degree" />
          <input type="hidden" name="edu_department" />
          <input type="hidden" name="edu_batch_range" />
          <input type="hidden" name="edu_college_id" />
          <input type="hidden" name="edu_degree_id" />
          <input type="hidden" name="edu_department_id" />
          <input type="hidden" name="edu_batch_id" />

                    <label class="grid gap-1 min-w-0">
            <span class="text-xs text-black/70 dark:text-white/70">Institution *</span>
                        <select data-role="edu-college" required class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white px-3 py-2">
              <option value="">Select college</option>
            </select>
                        <input data-role="edu-college-custom" type="text" placeholder="Enter institution manually" class="hidden w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2 mt-2" />
          </label>

                    <div class="grid md:grid-cols-2 gap-3 min-w-0">
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Degree *</span>
                            <select data-role="edu-degree" required disabled class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white px-3 py-2">
                <option value="">Select degree</option>
              </select>
                            <input data-role="edu-degree-custom" type="text" placeholder="Enter degree" class="hidden w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2 mt-2" />
            </label>
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Department *</span>
                            <select data-role="edu-department" required disabled class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white px-3 py-2">
                <option value="">Select department</option>
              </select>
                            <input data-role="edu-department-custom" type="text" placeholder="Enter department" class="hidden w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2 mt-2" />
            </label>
          </div>

                    <div class="grid md:grid-cols-3 gap-3 min-w-0">
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Batch *</span>
                            <select data-role="edu-batch" required disabled class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white px-3 py-2">
                <option value="">Select batch</option>
              </select>
                            <input data-role="edu-batch-custom" type="text" placeholder="e.g., 2022-2026" class="hidden w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2 mt-2" />
            </label>
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Section *</span>
                            <select name="edu_section" required class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white px-3 py-2">
                <option value="">Select section</option>
                ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(ch => `<option value="${ch}">${ch}</option>`).join('')}
              </select>
            </label>
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Current Semester *</span>
                            <input name="edu_current_semester" required type="number" min="1" max="12" placeholder="5" class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2" />
            </label>
          </div>

                    <div class="grid md:grid-cols-2 gap-3 min-w-0">
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Registration No. <span class="text-black/45 dark:text-white/45">Optional</span></span>
                            <input name="edu_regno" type="text" placeholder="22TN0049" class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2" />
            </label>
                        <label class="grid gap-1 min-w-0">
              <span class="text-xs text-black/70 dark:text-white/70">Grade / GPA <span class="text-black/45 dark:text-white/45">Optional</span></span>
                            <input name="edu_grade" type="text" placeholder="9.1 CGPA" class="w-full min-w-0 rounded-2xl border border-black/10 dark:border-white/10 bg-white/70 dark:bg-brand-900/70 text-neutral-900 dark:text-white placeholder:text-black/40 dark:placeholder:text-white/40 px-3 py-2" />
            </label>
          </div>
        </div>
      `;
            return wrapper.firstElementChild;
        }

        async function __pxEduInitializeEducationRow(row, data = {}) {
            const hiddenSchool = row.querySelector('input[name="edu_school"]');
            const hiddenDegree = row.querySelector('input[name="edu_degree"]');
            const hiddenDepartment = row.querySelector('input[name="edu_department"]');
            const hiddenBatch = row.querySelector('input[name="edu_batch_range"]');
            const hiddenCollegeId = row.querySelector('input[name="edu_college_id"]');
            const hiddenDegreeId = row.querySelector('input[name="edu_degree_id"]');
            const hiddenDepartmentId = row.querySelector('input[name="edu_department_id"]');
            const hiddenBatchId = row.querySelector('input[name="edu_batch_id"]');
            const sectionSelect = row.querySelector('select[name="edu_section"]');

            const collegeSelect = row.querySelector('[data-role="edu-college"]');
            const collegeCustomInput = row.querySelector('[data-role="edu-college-custom"]');
            const degreeSelect = row.querySelector('[data-role="edu-degree"]');
            const degreeCustomInput = row.querySelector('[data-role="edu-degree-custom"]');
            const departmentSelect = row.querySelector('[data-role="edu-department"]');
            const departmentCustomInput = row.querySelector('[data-role="edu-department-custom"]');
            const batchSelect = row.querySelector('[data-role="edu-batch"]');
            const batchCustomInput = row.querySelector('[data-role="edu-batch-custom"]');
            const currentSemesterInput = row.querySelector('input[name="edu_current_semester"]');
            const regnoInput = row.querySelector('input[name="edu_regno"]');
            const gradeInput = row.querySelector('input[name="edu_grade"]');

            if (!collegeSelect || !degreeSelect || !departmentSelect || !batchSelect) return;

            const state = { degrees: [] };
            let initialValues = {
                collegeName: data.school || '',
                degreeName: data.degree || '',
                departmentName: data.department || '',
                batchRange: data.batch_range || '',
            };

            if (hiddenSchool) hiddenSchool.value = initialValues.collegeName;
            if (hiddenDegree) hiddenDegree.value = initialValues.degreeName;
            if (hiddenDepartment) hiddenDepartment.value = initialValues.departmentName;
            if (hiddenBatch) hiddenBatch.value = initialValues.batchRange;
            if (currentSemesterInput && data.current_semester) currentSemesterInput.value = String(data.current_semester);
            if (regnoInput && data.regno) regnoInput.value = String(data.regno);
            if (gradeInput && data.grade) gradeInput.value = String(data.grade);

            const colleges = await __pxEduLoadCollegesList().catch(() => []);
            const collegeOptions = (colleges || []).map(col => ({ value: col.id, label: col.name }));
            __pxEduFillSelectOptions(collegeSelect, collegeOptions, { placeholder: 'Select college', includeCustom: true });

            if (initialValues.collegeName) {
                const match = __pxEduFindCollegeByName(initialValues.collegeName);
                if (match) {
                    collegeSelect.value = match.id;
                } else {
                    collegeSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (collegeCustomInput) {
                        collegeCustomInput.value = initialValues.collegeName;
                        __pxEduToggleCustomInput(collegeCustomInput, true);
                    }
                }
            } else if (!collegeOptions.length) {
                collegeSelect.value = EDUCATION_CUSTOM_VALUE;
                if (collegeCustomInput) __pxEduToggleCustomInput(collegeCustomInput, true);
            }

            async function handleCollegeChange(isInitial = false) {
                const selected = collegeSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;

                if (isCustom) {
                    if (collegeCustomInput) __pxEduToggleCustomInput(collegeCustomInput, true);
                    if (hiddenSchool) hiddenSchool.value = (collegeCustomInput?.value || '').trim();
                    if (hiddenCollegeId) hiddenCollegeId.value = '';

                    degreeSelect.disabled = false;
                    state.degrees = [];
                    __pxEduFillSelectOptions(degreeSelect, [], { placeholder: 'Select degree', includeCustom: true });
                    degreeSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.degreeName && degreeCustomInput) {
                        degreeCustomInput.value = initialValues.degreeName;
                    }
                    if (degreeCustomInput) __pxEduToggleCustomInput(degreeCustomInput, true);
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();

                    departmentSelect.disabled = false;
                    __pxEduFillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.departmentName && departmentCustomInput) {
                        departmentCustomInput.value = initialValues.departmentName;
                    }
                    if (departmentCustomInput) __pxEduToggleCustomInput(departmentCustomInput, true);
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();

                    batchSelect.disabled = false;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    if (isInitial && initialValues?.batchRange) {
                        batchSelect.value = initialValues.batchRange;
                        if (hiddenBatch) hiddenBatch.value = initialValues.batchRange;
                        if (batchCustomInput) {
                            __pxEduToggleCustomInput(batchCustomInput, false);
                            batchCustomInput.value = '';
                        }
                    } else {
                        batchSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (batchCustomInput) __pxEduToggleCustomInput(batchCustomInput, true);
                        if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    }
                    return;
                }

                if (collegeCustomInput) {
                    __pxEduToggleCustomInput(collegeCustomInput, false);
                    collegeCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenSchool) hiddenSchool.value = '';
                    if (hiddenCollegeId) hiddenCollegeId.value = '';

                    degreeSelect.disabled = true;
                    __pxEduFillSelectOptions(degreeSelect, [], { placeholder: 'Select degree', includeCustom: true });
                    degreeSelect.value = '';
                    if (degreeCustomInput) {
                        __pxEduToggleCustomInput(degreeCustomInput, false);
                        degreeCustomInput.value = '';
                    }
                    if (hiddenDegree) hiddenDegree.value = '';

                    departmentSelect.disabled = true;
                    __pxEduFillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = '';
                    if (departmentCustomInput) {
                        __pxEduToggleCustomInput(departmentCustomInput, false);
                        departmentCustomInput.value = '';
                    }
                    if (hiddenDepartment) hiddenDepartment.value = '';

                    batchSelect.disabled = true;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        __pxEduToggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    return;
                }

                const college = __pxEduGetCollegeById(selected);
                if (hiddenSchool) hiddenSchool.value = college?.name || '';
                if (hiddenCollegeId) hiddenCollegeId.value = selected;

                const reqId = selected;
                const details = await __pxEduLoadCollegeDetails(selected);
                if (!details || String(reqId) !== String(collegeSelect.value)) return;

                const degrees = Array.isArray(details.degrees) ? details.degrees : [];
                state.degrees = degrees;

                degreeSelect.disabled = false;
                const degreeOptions = degrees.map(d => ({ value: String(d.id), label: d.name }));
                __pxEduFillSelectOptions(degreeSelect, degreeOptions, { placeholder: 'Select degree', includeCustom: true });

                if (isInitial && initialValues?.degreeName) {
                    const match = __pxEduFindDegreeByName(degrees, initialValues.degreeName);
                    if (match) {
                        degreeSelect.value = String(match.id);
                    } else {
                        degreeSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (degreeCustomInput) {
                            degreeCustomInput.value = initialValues.degreeName;
                            __pxEduToggleCustomInput(degreeCustomInput, true);
                        }
                    }
                }

                await handleDegreeChange(true);
            }

            async function handleDegreeChange(isInitial = false) {
                const selected = degreeSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;
                if (isCustom) {
                    if (degreeCustomInput) __pxEduToggleCustomInput(degreeCustomInput, true);
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();
                    if (hiddenDegreeId) hiddenDegreeId.value = '';

                    departmentSelect.disabled = false;
                    __pxEduFillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.departmentName && departmentCustomInput) {
                        departmentCustomInput.value = initialValues.departmentName;
                    }
                    if (departmentCustomInput) __pxEduToggleCustomInput(departmentCustomInput, true);
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();

                    batchSelect.disabled = false;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (batchCustomInput) __pxEduToggleCustomInput(batchCustomInput, true);
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    return;
                }

                if (degreeCustomInput) {
                    __pxEduToggleCustomInput(degreeCustomInput, false);
                    degreeCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenDegree) hiddenDegree.value = '';
                    if (hiddenDegreeId) hiddenDegreeId.value = '';
                    departmentSelect.disabled = true;
                    __pxEduFillSelectOptions(departmentSelect, [], { placeholder: 'Select department', includeCustom: true });
                    departmentSelect.value = '';
                    if (departmentCustomInput) {
                        __pxEduToggleCustomInput(departmentCustomInput, false);
                        departmentCustomInput.value = '';
                    }
                    if (hiddenDepartment) hiddenDepartment.value = '';

                    batchSelect.disabled = true;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        __pxEduToggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    return;
                }

                const degree = (state.degrees || []).find(d => String(d.id) === String(selected)) || null;
                if (hiddenDegree) hiddenDegree.value = degree?.name || '';
                if (hiddenDegreeId) hiddenDegreeId.value = selected;

                const departments = Array.isArray(degree?.departments) ? degree.departments : [];
                departmentSelect.disabled = false;
                const departmentOptions = departments.map(dep => ({ value: String(dep.id), label: dep.name }));
                __pxEduFillSelectOptions(departmentSelect, departmentOptions, { placeholder: 'Select department', includeCustom: true });

                if (isInitial && initialValues?.departmentName) {
                    const match = __pxEduFindDepartmentByName(departments, initialValues.departmentName);
                    if (match) {
                        departmentSelect.value = String(match.id);
                    } else {
                        departmentSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (departmentCustomInput) {
                            departmentCustomInput.value = initialValues.departmentName;
                            __pxEduToggleCustomInput(departmentCustomInput, true);
                        }
                    }
                }

                await handleDepartmentChange(true);
            }

            async function handleDepartmentChange(isInitial = false) {
                const selected = departmentSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;
                if (isCustom) {
                    if (departmentCustomInput) __pxEduToggleCustomInput(departmentCustomInput, true);
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();
                    if (hiddenDepartmentId) hiddenDepartmentId.value = '';

                    batchSelect.disabled = false;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = EDUCATION_CUSTOM_VALUE;
                    if (isInitial && initialValues?.batchRange && batchCustomInput) {
                        batchCustomInput.value = initialValues.batchRange;
                    }
                    if (batchCustomInput) __pxEduToggleCustomInput(batchCustomInput, true);
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    if (hiddenBatchId) hiddenBatchId.value = '';
                    return;
                }

                if (departmentCustomInput) {
                    __pxEduToggleCustomInput(departmentCustomInput, false);
                    departmentCustomInput.value = '';
                }

                if (!selected) {
                    if (hiddenDepartment) hiddenDepartment.value = '';
                    if (hiddenDepartmentId) hiddenDepartmentId.value = '';
                    batchSelect.disabled = true;
                    __pxEduFillSelectOptions(batchSelect, [], { placeholder: 'Select batch', includeCustom: true });
                    batchSelect.value = '';
                    if (batchCustomInput) {
                        __pxEduToggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = '';
                    return;
                }

                const degrees = state.degrees || [];
                const currentDegree = degrees.find(d => String(d.id) === String(degreeSelect.value)) || null;
                const departments = Array.isArray(currentDegree?.departments) ? currentDegree.departments : [];
                const department = departments.find(dep => String(dep.id) === String(selected)) || null;
                if (hiddenDepartment) hiddenDepartment.value = department?.name || '';
                if (hiddenDepartmentId) hiddenDepartmentId.value = selected;

                // Batch list comes from college details (details.batches)
                const details = await __pxEduLoadCollegeDetails(collegeSelect.value);
                const batches = Array.isArray(details?.batches) ? details.batches : [];
                batchSelect.disabled = false;
                const batchOptions = batches
                    .map(b => ({ value: __pxEduFormatBatchRange(b), label: __pxEduFormatBatchRange(b) }))
                    .filter(opt => opt.value);
                __pxEduFillSelectOptions(batchSelect, batchOptions, { placeholder: 'Select batch', includeCustom: true });

                if (isInitial && initialValues?.batchRange) {
                    const found = batchOptions.find(o => o.value === initialValues.batchRange);
                    if (found) {
                        batchSelect.value = found.value;
                    } else {
                        batchSelect.value = EDUCATION_CUSTOM_VALUE;
                        if (batchCustomInput) {
                            batchCustomInput.value = initialValues.batchRange;
                            __pxEduToggleCustomInput(batchCustomInput, true);
                        }
                    }
                }

                await handleBatchChange(true);
            }

            function handleBatchChange(isInitial = false) {
                const selected = batchSelect.value;
                const isCustom = selected === EDUCATION_CUSTOM_VALUE;
                if (isCustom) {
                    if (batchCustomInput) __pxEduToggleCustomInput(batchCustomInput, true);
                    if (isInitial && initialValues?.batchRange && batchCustomInput) {
                        batchCustomInput.value = initialValues.batchRange;
                    }
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                    if (hiddenBatchId) hiddenBatchId.value = '';
                } else {
                    if (batchCustomInput) {
                        __pxEduToggleCustomInput(batchCustomInput, false);
                        batchCustomInput.value = '';
                    }
                    if (hiddenBatch) hiddenBatch.value = selected || '';
                    if (hiddenBatchId) hiddenBatchId.value = '';
                }
            }

            function handleCollegeCustomInput() {
                if (collegeSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenSchool) hiddenSchool.value = (collegeCustomInput?.value || '').trim();
                }
            }

            function handleDegreeCustomInput() {
                if (degreeSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenDegree) hiddenDegree.value = (degreeCustomInput?.value || '').trim();
                }
            }

            function handleDepartmentCustomInput() {
                if (departmentSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenDepartment) hiddenDepartment.value = (departmentCustomInput?.value || '').trim();
                }
            }

            function handleBatchCustomInput() {
                if (batchSelect.value === EDUCATION_CUSTOM_VALUE) {
                    if (hiddenBatch) hiddenBatch.value = (batchCustomInput?.value || '').trim();
                }
            }

            collegeSelect.addEventListener('change', () => { handleCollegeChange(false); });
            collegeCustomInput?.addEventListener('input', handleCollegeCustomInput);
            degreeSelect.addEventListener('change', () => { handleDegreeChange(false); });
            degreeCustomInput?.addEventListener('input', handleDegreeCustomInput);
            departmentSelect.addEventListener('change', () => { handleDepartmentChange(false); });
            departmentCustomInput?.addEventListener('input', handleDepartmentCustomInput);
            batchSelect.addEventListener('change', () => { handleBatchChange(false); });
            batchCustomInput?.addEventListener('input', handleBatchCustomInput);

            if (sectionSelect && data.section) {
                sectionSelect.value = String(data.section).trim().toUpperCase();
            }

            await handleCollegeChange(true);
            initialValues = null;
        }

        function __pxEduCollectEducationData(container) {
            const rows = Array.from(container?.querySelectorAll('[data-entry="education"]') || []);
            return rows.map(row => {
                const school = row.querySelector('input[name="edu_school"]').value.trim();
                if (!school) return null;
                const currentSemesterRaw = row.querySelector('input[name="edu_current_semester"]').value.trim();
                const current_semester = currentSemesterRaw ? parseInt(currentSemesterRaw, 10) : null;
                const college_id = row.querySelector('input[name="edu_college_id"]').value.trim() || null;
                const degree_id = row.querySelector('input[name="edu_degree_id"]').value.trim() || null;
                const department_id = row.querySelector('input[name="edu_department_id"]').value.trim() || null;
                const batch_id = row.querySelector('input[name="edu_batch_id"]').value.trim() || null;
                return {
                    id: row.querySelector('input[name="edu_id"]').value || null,
                    school,
                    degree: row.querySelector('input[name="edu_degree"]').value.trim() || null,
                    department: row.querySelector('input[name="edu_department"]').value.trim() || null,
                    batch_range: row.querySelector('input[name="edu_batch_range"]').value || null,
                    regno: row.querySelector('input[name="edu_regno"]').value.trim() || null,
                    current_semester: (Number.isFinite(current_semester) && current_semester > 0) ? current_semester : null,
                    grade: row.querySelector('input[name="edu_grade"]').value.trim() || null,
                    activities: null,
                    description: null,
                    college_id,
                    degree_id,
                    department_id,
                    batch_id,
                    section: (row.querySelector('select[name="edu_section"]').value || '').trim() || null,
                };
            }).filter(Boolean);
        }

        function __pxEduNeedsCompletion(profile) {
            const list = Array.isArray(profile?.education_entries) ? profile.education_entries : [];
            return !list.some(ed => {
                const school = (ed?.school || '').trim();
                const degree = (ed?.degree || '').trim();
                const department = (ed?.department || '').trim();
                const batch = (ed?.batch_range || '').trim();
                const section = (ed?.section || '').trim();
                const semester = Number(ed?.current_semester);
                return school && degree && department && batch && section && Number.isFinite(semester) && semester > 0;
            });
        }

        function __pxEduShowStatus(message, ok = true) {
            const { status } = __pxEduEls();
            if (!status) return;
            status.classList.remove('hidden');
            status.textContent = message;
            status.classList.toggle('border-rose-400/40', !ok);
            status.classList.toggle('text-rose-600', !ok);
            status.classList.toggle('border-emerald-400/40', ok);
            status.classList.toggle('text-emerald-600', ok);
        }

        function __pxEduOpenModal() {
            const { modal } = __pxEduEls();
            if (!modal) return;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function __pxEduCloseModal() {
            const { modal } = __pxEduEls();
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        function __pxBuildProfileUpdatePayload(profile, educationEntries) {
            const specializations = Array.isArray(profile?.specializations)
                ? profile.specializations
                : (profile?.specializations ? String(profile.specializations).split(',').map(s => s.trim()).filter(Boolean) : []);

            return {
                name: profile?.name || null,
                phone: profile?.phone || null,
                headline: profile?.headline || null,
                location: profile?.location || null,
                dob: profile?.dob || null,
                bio: profile?.bio || null,
                linkedin: profile?.linkedin || null,
                github: profile?.github || null,
                leetcode: profile?.leetcode || null,
                portfolio_url: profile?.portfolio_url || null,
                website: profile?.website || null,
                twitter: profile?.twitter || null,
                instagram: profile?.instagram || null,
                medium: profile?.medium || null,
                specializations,
                technologies: profile?.technologies || null,
                skills: profile?.skills || null,
                certifications: profile?.certifications || null,
                languages: profile?.languages || null,
                interests: profile?.interests || null,
                achievements: profile?.achievements || null,
                experience: profile?.experience || null,
                publications: profile?.publications || null,
                project_info: profile?.project_info || null,
                experiences: Array.isArray(profile?.experiences) ? profile.experiences : [],
                education_entries: educationEntries,
                certification_entries: Array.isArray(profile?.certification_entries) ? profile.certification_entries : [],
                portfolio_projects: Array.isArray(profile?.portfolio_projects) ? profile.portfolio_projects : [],
                publication_entries: Array.isArray(profile?.publication_entries) ? profile.publication_entries : [],
            };
        }

        async function __pxEduEnsureModalReady(profile) {
            const { wrap } = __pxEduEls();
            if (!wrap) return;
            if (wrap.dataset.ready === 'true') return;
            wrap.innerHTML = '';
            const node = __pxEduBuildEducationRowNode();
            wrap.appendChild(node);
            await __pxEduInitializeEducationRow(node, profile?.education_entries?.[0] || {});
            wrap.dataset.ready = 'true';
        }

        async function __pxEduOpenEditorFromProfile() {
            await __pxEduEnsureBound();
            const profile = window.__PX_PROFILE_SNAPSHOT || {};
            await __pxEduEnsureModalReady(profile);
            __pxEduOpenModal();
        }

        async function __pxEduMaybeRequire(profile) {
            await __pxEduDomReady;
            await __pxEduEnsureBound();
            const { modal } = __pxEduEls();
            if (!modal) return;
            if (!__pxEduNeedsCompletion(profile)) {
                __pxEduCloseModal();
                return;
            }
            await __pxEduEnsureModalReady(profile);
            __pxEduOpenModal();
        }

        async function __pxEduEnsureBound() {
            if (__pxEduBound) return;
            await __pxEduDomReady;
            const { saveBtn, closeBtn, modal } = __pxEduEls();
            if (!saveBtn) return;

            if (closeBtn) {
                closeBtn.addEventListener('click', (event) => {
                    event.preventDefault?.();
                    __pxEduCloseModal();
                });
            }

            if (modal) {
                modal.addEventListener('click', (event) => {
                    const { modal: currentModal } = __pxEduEls();
                    if (!currentModal || currentModal.classList.contains('hidden')) return;
                    if (event.target.closest('[data-edu-modal-panel]')) return;
                    __pxEduCloseModal();
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key !== 'Escape') return;
                const { modal: currentModal } = __pxEduEls();
                if (!currentModal || currentModal.classList.contains('hidden')) return;
                __pxEduCloseModal();
            });

            const bindEdit = (el) => {
                if (!el) return;
                el.addEventListener('click', async (event) => {
                    event.preventDefault?.();
                    await __pxEduOpenEditorFromProfile();
                });
            };
            bindEdit(document.getElementById('eduEditBtn'));
            bindEdit(document.getElementById('navEduEditBtn'));
            saveBtn.addEventListener('click', async () => {
                try {
                    const profile = window.__PX_PROFILE_SNAPSHOT || {};
                    const { wrap } = __pxEduEls();
                    const entries = __pxEduCollectEducationData(wrap);
                    const entry = entries[0] || {};
                    const requiredOk = Boolean((entry.school || '').trim())
                        && Boolean((entry.degree || '').trim())
                        && Boolean((entry.department || '').trim())
                        && Boolean((entry.batch_range || '').trim())
                        && Boolean((entry.section || '').trim())
                        && Number.isFinite(Number(entry.current_semester))
                        && Number(entry.current_semester) > 0;

                    if (!requiredOk) {
                        __pxEduShowStatus('Please select college, degree, department, batch, section and current semester.', false);
                        return;
                    }

                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-70');
                    __pxEduShowStatus('Saving‚Ä¶', true);

                    const payload = __pxBuildProfileUpdatePayload(profile, [entry]);
                    const res = await fetch(`${API_BASE}/api/profile/me`, {
                        method: 'PUT',
                        headers: { ...__pxEduGetAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const out = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        __pxEduShowStatus(out?.detail || 'Failed to save education.', false);
                        return;
                    }

                    __pxEduShowStatus('Saved!', true);
                    __pxEduCloseModal();
                    if (wrap) wrap.dataset.ready = 'false';
                    await loadProfileAndProgress();
                } catch (err) {
                    console.error(err);
                    __pxEduShowStatus('Failed to save education. Please try again.', false);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-70');
                }
            });
            __pxEduBound = true;
        }

        // Bootstrap
        loadProfileAndProgress();
    </script>

    <script src="auth.js"></script>
    <script>const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();</script>

    <!-- Education required modal (shown only when education is missing) -->
    <div id="eduRequiredModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/70"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div data-edu-modal-panel
                class="w-full max-w-2xl rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 text-neutral-900 dark:text-white shadow-card backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6 overflow-y-auto overflow-x-hidden"
                style="max-height: calc(100vh - 2rem); max-height: calc(100dvh - 2rem);">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h3 class="text-lg font-semibold">Add your education</h3>
                        <p class="text-xs text-black/60 dark:text-white/60 mt-1">Select your college, degree,
                            department, batch,
                            section and current semester to continue.</p>
                    </div>
                    <button id="eduRequiredCloseBtn" type="button" aria-label="Close"
                        class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>

                <div id="eduRequiredStatus"
                    class="hidden mt-3 text-xs rounded-lg border border-black/10 dark:border-white/10 px-3 py-2"></div>

                <div id="eduRequiredFormWrap" class="mt-4"></div>

                <div class="mt-5 flex items-center justify-end gap-2">
                    <button id="eduRequiredSaveBtn" type="button"
                        class="inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-3 text-sm font-semibold bg-brand-600 text-white hover:bg-brand-700">
                        <span class="material-symbols-rounded text-[18px]">save</span>
                        Save education
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>