<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paper X — Upload Note</title>
  <link rel="icon" type="image/x-icon" href="../../assets/img/favicon.svg">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet">

  <!-- Tailwind -->
  <link rel="stylesheet" href="../../assets/css/tailwind.css" />
  <script>
    try {
      if (window.tailwind) {
        tailwind.config = {
          darkMode: 'class',
          theme: {
            container: { center: true, padding: '1rem' },
            extend: {
              fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
              colors: {
                brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }
              },
              backgroundImage: {
                'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)',
                'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)'
              },
              boxShadow: { card: '0 6px 24px rgba(0,0,0,.12)', glow: '0 8px 30px rgba(158,75,138,0.35)' },
              keyframes: {
                shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } }
              },
              animation: { shimmer: 'shimmer 1.6s infinite linear' }
            }
          }
        };
      }
    } catch (_) { }
  </script>

  <style>
    .material-symbols-rounded {
      vertical-align: -6px
    }

    .glass {
      background: rgba(255, 255, 255, .72);
      backdrop-filter: blur(12px)
    }

    .dark .glass {
      background: rgba(30, 30, 47, .55)
    }

    html:not(.dark) h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      color: #1E1E2F
    }

    .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .06)
    }

    .dark .ring-soft {
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
    }

    .drop-active {
      outline: 2px dashed rgba(158, 75, 138, .7);
      outline-offset: -8px
    }

    /* Dark theme page background gradient (from index.html) */
    .dark body {
      background-image: linear-gradient(to left top, #1e1e2f, #242138, #2b2440, #332649, #3d2850, #3f254a, #402244, #401f3e, #34182d, #26131e, #190b11, #000000);
      background-repeat: no-repeat;
      background-size: cover;
    }
  </style>

  <!-- Theme boot BEFORE anything else (unified with index/about) -->
  <script>
    (function () {
      const stored = localStorage.getItem('px_theme');
      const prefers = matchMedia('(prefers-color-scheme: dark)').matches;
      const mode = stored ? stored : (prefers ? 'dark' : 'light');
      if (mode === 'dark') document.documentElement.classList.add('dark');
    })();
  </script>

  <!-- Config first -->
  <script src="../../config.js"></script>
  <script src="../../auth.js" defer></script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
  <!-- GLOBAL HEADER -->
  <header
    class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
    <div class="container flex items-center justify-between py-3">
      <a href="../../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
        <img src="../../assets/img/logo-light.svg" alt="Paper X" class="h-9 w-auto dark:hidden">
        <img src="../../assets/img/logo-dark.svg" alt="Paper X" class="h-9 w-auto hidden dark:block">
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="./notes_marketplace.html">Marketplace</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white font-medium" href="./upload_note.html">Upload</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../collage/clg_info.html">Colleges</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../help.html">Help</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../staff_profile.html">Profile</a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <button data-theme-toggle
          class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
            class="material-symbols-rounded text-base">dark_mode</span></button>
      </div>
      <div class="md:hidden flex items-center gap-2">
        <button data-theme-toggle
          class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
            class="material-symbols-rounded">dark_mode</span></button>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="border-b border-black/5 dark:border-white/10 bg-white/70 dark:bg-brand-900/50 backdrop-blur">
    <div class="container py-6 md:py-8 flex flex-col gap-2">
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Upload Note</h1>
      <p class="text-sm text-neutral-600 dark:text-white/60">Share high‑quality material with the community. Clean,
        modern, and fast.</p>
      <!-- Stepper -->
      <div class="mt-3 flex items-center gap-2 text-[11px]">
        <span
          class="inline-flex items-center gap-1 px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10"><span
            class="material-symbols-rounded text-sm">edit</span>Details</span>
        <span class="material-symbols-rounded opacity-40">chevron_right</span>
        <span
          class="inline-flex items-center gap-1 px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10"><span
            class="material-symbols-rounded text-sm">school</span>Academic</span>
        <span class="material-symbols-rounded opacity-40">chevron_right</span>
        <span
          class="inline-flex items-center gap-1 px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10"><span
            class="material-symbols-rounded text-sm">upload_file</span>File</span>
        <span class="material-symbols-rounded opacity-40">chevron_right</span>
        <span
          class="inline-flex items-center gap-1 px-2 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10"><span
            class="material-symbols-rounded text-sm">check_circle</span>Publish</span>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <main class="container py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- MAIN FORM COLUMN -->
    <form id="uploadForm" class="lg:col-span-8 space-y-6" novalidate>
      <!-- Card: Details -->
      <section class="glass rounded-2xl p-6 ring-1 ring-black/10 dark:ring-white/15 shadow-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold">Note details</h2>
          <button type="button" id="clearDraft"
            class="text-xs inline-flex items-center gap-1 px-3 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"><span
              class="material-symbols-rounded text-sm">auto_delete</span>Clear draft</button>
        </div>
        <div class="grid md:grid-cols-2 gap-5">
          <div class="space-y-2">
            <label class="text-sm font-medium">Title *</label>
            <input name="title" required placeholder="e.g. Data Structures Unit 1"
              class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" />
            <p data-err="title" class="hidden text-[11px] text-rose-500">Title is required</p>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Price (₹) — 0 for free</label>
            <div class="flex items-center gap-2">
              <input name="price_cents" type="number" min="0" value="0"
                class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" />
              <button type="button" id="makeFree"
                class="text-xs px-3 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15">Make Free</button>
            </div>
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Subject</label>
            <input name="subject" class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Unit</label>
            <input name="unit" class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Exam Type</label>
            <input name="exam_type" placeholder="Midterm / Finals / GATE"
              class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-medium">Tags</label>
            <div class="rounded-lg border bg-white/90 dark:bg-white/10 px-2 py-1 flex flex-wrap gap-1" id="tagHost">
              <input id="tagInput" class="flex-1 min-w-[8rem] bg-transparent outline-none text-sm px-2 py-1"
                placeholder="Type and press Enter" />
            </div>
            <input type="hidden" name="categories" id="tagsHidden" />
          </div>
          <div class="space-y-2 md:col-span-2">
            <label class="text-sm font-medium flex items-center gap-2">Cover Image <span
                class="text-[10px] font-normal text-neutral-500 dark:text-white/50">(Optional)</span></label>
            <div class="flex items-start gap-4">
              <div id="coverPreview"
                class="w-28 h-20 rounded-lg ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10 flex items-center justify-center text-neutral-400 text-xs overflow-hidden">
                <span class="material-symbols-rounded text-base opacity-60">image</span>
              </div>
              <div class="flex-1 flex flex-col gap-2">
                <input id="coverInput" name="cover" type="file" accept="image/png,image/jpeg,image/webp,image/gif"
                  class="text-xs" />
                <p class="text-[11px] text-neutral-500 dark:text-white/50">PNG / JPG / WEBP / GIF up to 5MB. Recommended
                  16:10.</p>
                <button type="button" id="removeCover"
                  class="self-start text-[11px] px-2 py-1 rounded ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 hidden">Remove</button>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 space-y-2">
          <label class="text-sm font-medium">Description</label>
          <textarea name="description" rows="4"
            class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10"
            placeholder="Brief overview, key topics covered, and how this helps."></textarea>
        </div>
      </section>

      <!-- Card: Academic links -->
      <section class="glass rounded-2xl p-6 ring-1 ring-black/10 dark:ring-white/15 shadow-card">
        <h2 class="text-sm font-semibold mb-4">Academic linkage</h2>
        <div class="grid md:grid-cols-2 gap-5">
          <div class="space-y-2"><label class="text-sm font-medium">College</label><select name="college_id"
              id="collegeSel" class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10">
              <option value="">-- Select College --</option>
            </select></div>
          <div class="space-y-2"><label class="text-sm font-medium">Degree</label><select name="degree_id"
              id="degreeSel" class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" disabled>
              <option value="">-- Select Degree --</option>
            </select></div>
          <div class="space-y-2"><label class="text-sm font-medium">Department</label><select name="department_id"
              id="deptSel" class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" disabled>
              <option value="">-- Select Department --</option>
            </select></div>
          <div class="space-y-2"><label class="text-sm font-medium">Batch</label><select name="batch_id" id="batchSel"
              class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" disabled>
              <option value="">-- Select Batch --</option>
            </select></div>
          <div class="space-y-2"><label class="text-sm font-medium">Semester</label><select name="semester" id="semSel"
              class="w-full rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-white/10" disabled>
              <option value="">-- Semester --</option>
            </select></div>
        </div>
      </section>

      <!-- Card: File -->
      <section class="glass rounded-2xl p-6 ring-1 ring-black/10 dark:ring-white/15 shadow-card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold">File</h2>
          <span id="fileInfo" class="text-xs text-neutral-600 dark:text-white/70">PDF / MD / Image</span>
        </div>
        <div id="dropzone"
          class="rounded-2xl ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/5 p-6 grid place-items-center text-center cursor-pointer">
          <div>
            <div
              class="mx-auto w-14 h-14 rounded-2xl bg-white/70 dark:bg-white/10 grid place-items-center ring-1 ring-black/10 dark:ring-white/15 mb-3">
              <span class="material-symbols-rounded">cloud_upload</span></div>
            <p class="text-sm font-medium">Drag & drop or click to choose a file</p>
            <p class="text-xs text-neutral-600 dark:text-white/70 mt-1">.pdf, .md, .png, .jpg up to ~25MB</p>
          </div>
          <input id="fileInput" name="file" type="file" class="hidden" required />
        </div>
        <div id="filePreview" class="mt-4 hidden">
          <div class="flex items-center gap-3">
            <div
              class="w-16 h-16 rounded-lg overflow-hidden ring-1 ring-black/10 dark:ring-white/15 bg-white/60 dark:bg-white/10 grid place-items-center"
              id="thumbBox">
              <span class="material-symbols-rounded">description</span>
            </div>
            <div class="flex-1 min-w-0">
              <div id="fileName" class="text-sm font-medium truncate">—</div>
              <div id="fileMeta" class="text-xs text-neutral-600 dark:text-white/70">—</div>
            </div>
            <button type="button" id="removeFile"
              class="size-10 grid place-items-center rounded-full ring-1 ring-black/10 dark:ring-white/15"><span
                class="material-symbols-rounded">close</span></button>
          </div>
          <div class="mt-4 w-full h-2 rounded bg-black/5 dark:bg-white/10 overflow-hidden">
            <div id="progBar" class="h-full w-0 bg-brand-500"></div>
          </div>
        </div>
      </section>

      <!-- Actions -->
      <div class="flex items-center gap-3">
        <button
          class="bg-brand-500 hover:bg-brand-600 text-white font-medium px-5 py-2 rounded-lg text-sm inline-flex items-center gap-2"
          type="submit"><span class="material-symbols-rounded">publish</span>Publish</button>
        <button type="button" id="saveDraft"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg ring-1 ring-black/10 dark:ring-white/15"><span
            class="material-symbols-rounded">save</span>Save draft</button>
        <p id="status" class="text-sm text-neutral-600 dark:text-white/70"></p>
      </div>
    </form>

    <!-- ASIDE PREVIEW COLUMN -->
    <aside class="lg:col-span-4 space-y-4">
      <div class="sticky top-24 space-y-4">
        <div class="glass rounded-2xl p-5 ring-1 ring-black/10 dark:ring-white/15 shadow-card">
          <h3 class="text-sm font-semibold mb-3">Listing preview</h3>
          <article class="rounded-xl border border-black/5 dark:border-white/10 bg-white/70 dark:bg-white/5 p-4">
            <div class="flex items-start gap-2">
              <h4 id="pTitle" class="font-semibold text-sm line-clamp-2">Untitled note</h4>
              <span id="pPrice"
                class="ml-auto text-xs px-2 py-0.5 rounded bg-brand-500/10 text-brand-700 dark:text-fuchsia-200 font-medium">Free</span>
            </div>
            <p id="pDesc" class="text-xs text-neutral-600 dark:text-white/70 line-clamp-3 mt-1">Description will appear
              here as you type.</p>
            <div id="pMeta" class="mt-2 flex items-center gap-2 text-[11px] text-neutral-600 flex-wrap"></div>
          </article>
        </div>
        <div class="glass rounded-2xl p-5 ring-1 ring-black/10 dark:ring-white/15 shadow-card">
          <h3 class="text-sm font-semibold mb-3">Tips</h3>
          <ul class="text-xs list-disc pl-4 space-y-1 text-neutral-700 dark:text-white/80">
            <li>Clear, descriptive title improves discovery.</li>
            <li>Add subject, unit and exam type—buyers filter by these.</li>
            <li>Upload clean scans or export to PDF for best quality.</li>
            <li>Free items often gain more ratings and traction.</li>
          </ul>
        </div>
      </div>
    </aside>
  </main>

  <!-- TOASTS -->
  <div id="toastHost" class="fixed inset-0 pointer-events-none flex flex-col items-end gap-2 p-4 z-50"></div>

  <script>
    // ===== Utilities =====
    const el = (sel, root = document) => root.querySelector(sel);
    const els = (sel, root = document) => [...root.querySelectorAll(sel)];

    // Theme toggle
    // Unified theme toggle (same behavior as index/about)
    (function () {
      const root = document.documentElement;
      const toggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
      const updateIcons = (mode) => toggles().forEach(btn => { const ic = btn.querySelector('.material-symbols-rounded'); if (ic) ic.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode'; });
      const setTheme = (mode) => { mode === 'dark' ? root.classList.add('dark') : root.classList.remove('dark'); localStorage.setItem('px_theme', mode); updateIcons(mode); };
      setTheme(root.classList.contains('dark') ? 'dark' : 'light');
      document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; setTheme(root.classList.contains('dark') ? 'light' : 'dark'); });
    })();

    // API helpers
    async function resolveApiBase(retries = 10) { const base = (window.__API_BASE || window.API_BASE || '').replace(/\/$/, ''); if (base) return base; if (retries <= 0) return ''; return new Promise(res => setTimeout(() => res(resolveApiBase(retries - 1)), 100)); }
    function getToken() { const keys = ['px_token', 'sb-access-token', 'supabase.auth.token']; for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } } return ''; }

    function showToast(msg, type = 'info', opts = {}) { const host = el('#toastHost'); if (!host) return; const div = document.createElement('div'); div.className = `pointer-events-auto select-none text-sm rounded-lg shadow-lg px-4 py-3 flex items-center gap-2 border backdrop-blur-sm ${type === 'success' ? 'bg-emerald-500/90 text-white border-emerald-400/50' : type === 'error' ? 'bg-rose-600/90 text-white border-rose-400/50' : 'bg-black/80 text-white border-white/10'}`; div.innerHTML = `<span class="material-symbols-rounded text-base">${type === 'success' ? 'check_circle' : (type === 'error' ? 'error' : 'info')}</span><span>${msg}</span>`; host.appendChild(div); const ttl = opts.ttl || 2600; setTimeout(() => { div.classList.add('opacity-0', 'translate-y-1'); setTimeout(() => div.remove(), 320); }, ttl); }

    // ===== Draft (localStorage) =====
    const DRAFT_KEY = 'px_upload_draft';
    function saveDraft() { const fd = new FormData(el('#uploadForm')); const o = Object.fromEntries(fd.entries()); try { localStorage.setItem(DRAFT_KEY, JSON.stringify(o)); showToast('Draft saved', 'success'); } catch { showToast('Could not save draft', 'error'); } }
    function loadDraft() { try { const raw = localStorage.getItem(DRAFT_KEY); if (!raw) return; const o = JSON.parse(raw); for (const [k, v] of Object.entries(o)) { const n = el(`[name="${CSS.escape(k)}"]`); if (!n || k === 'file') continue; n.value = v; } reflectPreview(); } catch { } }
    function clearDraft() { localStorage.removeItem(DRAFT_KEY); showToast('Draft cleared'); }

    // ===== Form live preview =====
    function chip(txt) { return `<span class="px-2 py-0.5 rounded-full ring-1 ring-black/10 dark:ring-white/15">${txt}</span>`; }
    function reflectPreview() { const t = el('[name="title"]').value.trim(); const d = el('[name="description"]').value.trim(); const s = el('[name="subject"]').value.trim(); const u = el('[name="unit"]').value.trim(); const e = el('[name="exam_type"]').value.trim(); const p = parseInt(el('[name="price_cents"]').value || '0', 10); el('#pTitle').textContent = t || 'Untitled note'; el('#pDesc').textContent = d || 'Description will appear here as you type.'; el('#pPrice').textContent = p > 0 ? `₹${p}` : 'Free'; el('#pMeta').innerHTML = [s, u, e].filter(Boolean).map(chip).join(''); }

    els('input, textarea, select', el('#uploadForm')).forEach(n => { n.addEventListener('input', reflectPreview); n.addEventListener('change', reflectPreview); });
    el('#makeFree').addEventListener('click', () => { const inp = el('[name="price_cents"]'); inp.value = 0; reflectPreview(); });
    el('#saveDraft').addEventListener('click', saveDraft);
    el('#clearDraft').addEventListener('click', () => { clearDraft(); el('#uploadForm').reset(); reflectPreview(); });

    // ===== Tags (chips) =====
    const tagHost = el('#tagHost'); const tagInput = el('#tagInput'); const tagsHidden = el('#tagsHidden');
    function tagsArr() { const cur = [...tagHost.querySelectorAll('[data-tag]')].map(x => x.dataset.tag); return cur; }
    function renderTags() { const arr = tagsArr(); tagsHidden.value = arr.join(', '); }
    tagInput.addEventListener('keydown', e => { if (e.key === 'Enter' && tagInput.value.trim()) { e.preventDefault(); const v = tagInput.value.trim(); const b = document.createElement('button'); b.type = 'button'; b.className = 'inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-brand-500/10 text-brand-700 dark:text-fuchsia-200 text-xs'; b.innerHTML = `<span class="material-symbols-rounded text-sm">sell</span>${v}<span class="material-symbols-rounded text-sm">close</span>`; b.dataset.tag = v; b.addEventListener('click', () => { b.remove(); renderTags(); reflectPreview(); }); tagHost.insertBefore(b, tagInput); tagInput.value = ''; renderTags(); reflectPreview(); } });

    // ===== Dropzone + preview =====
    const drop = el('#dropzone'); const inputFile = el('#fileInput'); const preview = el('#filePreview'); const thumbBox = el('#thumbBox'); const fileName = el('#fileName'); const fileMeta = el('#fileMeta'); const prog = el('#progBar'); const removeBtn = el('#removeFile');
    const chooseFile = () => inputFile.click();
    drop.addEventListener('click', chooseFile);
    ;['dragenter', 'dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drop-active'); }));
    ;['dragleave', 'drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drop-active'); }));
    drop.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if (f) assignFile(f); });
    inputFile.addEventListener('change', () => { const f = inputFile.files?.[0]; if (f) assignFile(f); });
    removeBtn.addEventListener('click', () => { inputFile.value = ''; preview.classList.add('hidden'); prog.style.width = '0%'; });

    function assignFile(file) {
      if (!file) return; const ok = /\.(pdf|md|png|jpe?g)$/i.test(file.name); if (!ok) { showToast('Unsupported file type', 'error'); return; } preview.classList.remove('hidden'); fileName.textContent = file.name; fileMeta.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`; prog.style.width = '0%';
      if (file.type.startsWith('image/')) { const r = new FileReader(); r.onload = () => { thumbBox.innerHTML = `<img src="${r.result}" alt="preview" class="w-full h-full object-cover">`; }; r.readAsDataURL(file); } else { thumbBox.innerHTML = `<span class="material-symbols-rounded">${/pdf/.test(file.type) ? 'picture_as_pdf' : 'description'}</span>`; }
    }

    // Cover image handlers
    const coverInput = document.getElementById('coverInput');
    const coverPreview = document.getElementById('coverPreview');
    const removeCoverBtn = document.getElementById('removeCover');
    if (coverInput) {
      coverInput.addEventListener('change', () => { const f = coverInput.files?.[0]; if (!f) return; if (!/^image\//.test(f.type)) { showToast('Cover must be an image', 'error'); coverInput.value = ''; return; } if (f.size > 5 * 1024 * 1024) { showToast('Cover >5MB', 'error'); coverInput.value = ''; return; } const r = new FileReader(); r.onload = () => { coverPreview.innerHTML = `<img src="${r.result}" class="w-full h-full object-cover" alt="cover">`; removeCoverBtn.classList.remove('hidden'); }; r.readAsDataURL(f); });
    }
    if (removeCoverBtn) { removeCoverBtn.addEventListener('click', () => { coverInput.value = ''; coverPreview.innerHTML = '<span class="material-symbols-rounded text-base opacity-60">image</span>'; removeCoverBtn.classList.add('hidden'); }); }

    // ===== Academic cascade =====
    let apiBase; async function fetchJSON(url) { try { const r = await fetch(url); if (!r.ok) return null; return await r.json(); } catch { return null; } }
    const collegeSel = el('#collegeSel'); const degreeSel = el('#degreeSel'); const deptSel = el('#deptSel'); const batchSel = el('#batchSel'); const semSel = el('#semSel');
    function clearSelect(sel, label, disable = true) { sel.innerHTML = `<option value="">${label}</option>`; sel.disabled = disable; }
    async function loadColleges() { if (!apiBase) apiBase = await resolveApiBase(); clearSelect(collegeSel, '-- Select College --', false); const data = await fetchJSON(`${apiBase}/api/colleges`); if (Array.isArray(data)) data.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; collegeSel.appendChild(o); }); }
    async function loadDegrees(collegeId) { clearSelect(degreeSel, '-- Select Degree --'); clearSelect(deptSel, '-- Select Department --'); clearSelect(batchSel, '-- Select Batch --'); clearSelect(semSel, '-- Semester --'); if (!collegeId) return; degreeSel.disabled = true; deptSel.disabled = true; batchSel.disabled = true; semSel.disabled = true; const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/degrees`); degreeSel.disabled = false; if (Array.isArray(data)) data.forEach(d => { const o = document.createElement('option'); o.value = d.id || d; o.textContent = d.name || d; degreeSel.appendChild(o); }); }
    async function loadDepartments(collegeId) { clearSelect(deptSel, '-- Select Department --'); clearSelect(batchSel, '-- Select Batch --'); clearSelect(semSel, '-- Semester --'); if (!collegeId) return; deptSel.disabled = true; const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/departments/full`); deptSel.disabled = false; if (Array.isArray(data)) data.forEach(d => { const o = document.createElement('option'); o.value = d.id || d.name || d; o.textContent = d.name || d; deptSel.appendChild(o); }); }
    async function loadBatches(collegeId, deptName) { clearSelect(batchSel, '-- Select Batch --'); clearSelect(semSel, '-- Semester --'); if (!collegeId || !deptName) return; batchSel.disabled = true; const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/departments/${encodeURIComponent(deptName)}/batches/full`); batchSel.disabled = false; if (Array.isArray(data)) data.forEach(b => { const opt = document.createElement('option'); const from = b.from_year ?? b.from ?? b.fromYear; const to = b.to_year ?? b.to ?? b.toYear; let label = ''; if (Number.isInteger(from) && Number.isInteger(to)) label = `${from}-${to}`; else if (Number.isInteger(from)) label = String(from); else label = b.range || b.name || 'Batch'; opt.value = b.id || b.batch_id || `${from || ''}-${to || ''}`; opt.textContent = label; batchSel.appendChild(opt); }); }
    function enableSemester() { semSel.disabled = false; if (!semSel.querySelector('option[value="1"]')) { for (let i = 1; i <= 8; i++) { const o = document.createElement('option'); o.value = String(i); o.textContent = String(i); semSel.appendChild(o); } } }

    collegeSel.addEventListener('change', e => { const v = e.target.value; loadDegrees(v); loadDepartments(v); reflectPreview(); });
    degreeSel.addEventListener('change', reflectPreview);
    deptSel.addEventListener('change', e => { const deptTxt = deptSel.options[deptSel.selectedIndex]?.textContent; loadBatches(collegeSel.value, deptTxt); reflectPreview(); });
    batchSel.addEventListener('change', () => { enableSemester(); reflectPreview(); });
    semSel.addEventListener('change', reflectPreview);

    // ===== Submit (with progress) =====
    const form = el('#uploadForm');
    form.addEventListener('submit', async e => {
      e.preventDefault(); const status = el('#status'); status.textContent = 'Preparing…';
      // Basic validation
      const title = form.title.value.trim(); if (!title) { el('[data-err="title"]').classList.remove('hidden'); form.title.focus(); showToast('Please add a title', 'error'); return; } else { el('[data-err="title"]').classList.add('hidden'); }
      const file = inputFile.files?.[0]; if (!file) { showToast('Please choose a file', 'error'); return; }

      if (!apiBase) apiBase = await resolveApiBase();
      const fd = new FormData(form);
      // Convert price rupees ➝ cents
      const priceRupees = parseInt(fd.get('price_cents') || '0', 10); fd.set('price_cents', String((priceRupees || 0) * 100));

      // Send file directly to backend; backend uses service role to upload to Supabase
      const token = getToken();
      const url = `${apiBase}/api/marketplace/notes` + (token ? `?token=${encodeURIComponent(token)}` : '');
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      if (token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.upload.onprogress = (e) => { if (e.lengthComputable) { const pct = Math.round((e.loaded / e.total) * 100); prog.style.width = pct + '%'; } };
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          prog.style.width = '100%'; showToast('Note uploaded successfully!', 'success'); status.textContent = '';
          setTimeout(() => { location.href = './notes_marketplace.html'; }, 1200);
        } else {
          let msg = 'Upload failed';
          try { const j = JSON.parse(xhr.responseText || '{}'); msg = j.detail || msg; } catch {}
          showToast('Upload failed', 'error'); status.textContent = msg;
        }
      };
      xhr.onerror = () => { showToast('Network error', 'error'); status.textContent = 'Network error'; };
      xhr.send(fd);
    });

    // Keyboard shortcut: Ctrl/Cmd + Enter to submit
    document.addEventListener('keydown', e => { if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { form.requestSubmit(); } });

    // Boot
    (async () => { loadDraft(); reflectPreview(); await loadColleges(); })();
  </script>
</body>

</html>
