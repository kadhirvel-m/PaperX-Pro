<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paper X — Notes Marketplace</title>
    <link rel="icon" type="image/x-icon" href="../../assets/img/favicon.svg">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">

    <!-- Tailwind -->
    <link rel="stylesheet" href="../../assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }
                    },
                    backgroundImage: {
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)',
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)'
                    },
                    boxShadow: { card: '0 6px 24px rgba(0,0,0,.12)', glow: '0 8px 30px rgba(158,75,138,0.35)' },
                    keyframes: {
                        shimmer: { '0%': { backgroundPosition: '-1000px 0' }, '100%': { backgroundPosition: '1000px 0' } }
                    },
                    animation: {
                        shimmer: 'shimmer 1.6s infinite linear'
                    }
                }
            }
        };
    </script>

    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.72);
            backdrop-filter: blur(12px);
        }

        .dark .glass {
            background: rgba(30, 30, 47, 0.55);
        }

        /* Dark theme page background gradient (from index.html) */
        .dark body {
            background-image: linear-gradient(to left top, #1e1e2f, #242138, #2b2440, #332649, #3d2850, #3f254a, #402244, #401f3e, #34182d, #26131e, #190b11, #000000);
            background-repeat: no-repeat;
            background-size: cover;
        }

        html:not(.dark) h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            color: #1E1E2F;
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.06) 25%, rgba(0, 0, 0, 0.12) 37%, rgba(0, 0, 0, 0.06) 63%);
            background-size: 1000px 100%;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.06) 25%, rgba(255, 255, 255, 0.12) 37%, rgba(255, 255, 255, 0.06) 63%);
        }

        /* Futuristic card */
        .note-card {
            position: relative;
            overflow: hidden
        }

        .note-card::before {
            content: "";
            position: absolute;
            inset: auto -40% 0 -40%;
            height: 120px;
            background: radial-gradient(120px 40px at 50% 100%, rgba(158, 75, 138, .25), transparent 70%);
            filter: blur(14px);
            opacity: .7;
            transition: opacity .3s ease
        }

        .note-card:hover::before {
            opacity: 1
        }

        .note-thumb {
            aspect-ratio: 16/10;
            background-image: linear-gradient(135deg, rgba(76, 42, 89, .12), rgba(158, 75, 138, .08));
        }

        .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .06)
        }

        .dark .ring-soft {
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .12)
        }

        /* Gradient hero text (copied from index.html) */
        .gradient-hero-text {
            display: inline-block;
            /* ensure background sizing ties to content */
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
        }

        /* Dark theme override for gradient hero text */
        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }
    </style>

    <!-- Theme boot BEFORE anything else (same snippet as index/about) -->
    <script>
        (function () {
            const stored = localStorage.getItem('px_theme');
            const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const mode = stored ? stored : (prefers ? 'dark' : 'light');
            if (mode === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>

    <!-- Load config first so API_BASE is defined before auth.js -->
    <script src="../../config.js"></script>
    <script src="../../auth.js" defer></script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
    <!-- HEADER (unchanged structure/styles) -->
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-3">
            <a href="../../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="../../assets/img/logo-light.svg" alt="Paper X" class="h-9 w-auto dark:hidden">
                <img src="../../assets/img/logo-dark.svg" alt="Paper X" class="h-9 w-auto hidden dark:block">
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white font-medium"
                    href="./notes_marketplace.html">Marketplace</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="./upload_note.html">Upload</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../collage/clg_info.html">Colleges</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../help.html">Help</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white" href="../../staff_profile.html">Profile</a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5">
                    <span class="material-symbols-rounded text-base">dark_mode</span>
                </button>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <button id="openFilters"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5"
                    aria-label="Open filters">
                    <span class="material-symbols-rounded">tune</span>
                </button>
            </div>
        </div>
    </header>

    <!-- HERO / SEARCH + STATS BAR -->
    <section class="border-b border-black/5 dark:border-white/10 bg-white/70 dark:bg-brand-900/50 backdrop-blur">
        <div class="container py-6 md:py-8">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                <div>
                    <h1
                        class="text-3xl md:text-4xl font-extrabold tracking-tight mx-auto max-w-5xl leading-[1.08] gradient-hero-text">
                        Notes Marketplace</h1>
                    <p class="text-sm text-neutral-600 dark:text-white/60 mt-1">Discover peer‑reviewed notes, past
                        papers, and quick revision packs.</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-neutral-600 dark:text-white/60">
                    <span id="statCount"
                        class="inline-flex items-center gap-1 px-3 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/5">0
                        items</span>
                    <span
                        class="inline-flex items-center gap-1 px-3 py-1 rounded-full ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/5"><span
                            class="material-symbols-rounded text-sm">verified</span> Peer rated</span>
                </div>
            </div>
            <div class="mt-5">
                <!-- All filters in one row -->
                <div id="inlineFilters" class="flex flex-col md:flex-row gap-2 items-center flex-wrap">
                    <div class="flex-1 md:flex-none md:w-64 relative">
                        <span
                            class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400">search</span>
                        <input id="q" placeholder="Search by title, keywords…"
                            class="w-full rounded-xl pl-11 pr-4 py-3 text-sm ring-1 ring-black/10 dark:ring-white/15 bg-white/90 dark:bg-white/10 focus:outline-none focus:ring-2 focus:ring-brand-500" />
                    </div>

                    <select id="collegeFilter"
                        class="w-32 rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-brand-900/40">
                        <option value="">College</option>
                    </select>

                    <select id="degreeFilter" disabled
                        class="w-32 rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-brand-900/40">
                        <option value="">Degree</option>
                    </select>

                    <select id="deptFilter" disabled
                        class="w-32 rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-brand-900/40">
                        <option value="">Department</option>
                    </select>

                    <select id="batchFilter" disabled
                        class="w-28 rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-brand-900/40">
                        <option value="">Batch</option>
                    </select>

                    <select id="semFilter" disabled
                        class="w-24 rounded-lg border px-3 py-2 text-sm bg-white/90 dark:bg-brand-900/40">
                        <option value="">Semester</option>
                    </select>

                    <input id="minPrice" type="number" min="0" placeholder="Min ₹"
                        class="w-20 rounded-lg border px-2 py-2 text-sm bg-white/90 dark:bg-brand-900/40" />
                    <input id="maxPrice" type="number" min="0" placeholder="Max ₹"
                        class="w-20 rounded-lg border px-2 py-2 text-sm bg-white/90 dark:bg-brand-900/40" />

                    <button id="applyFilters"
                        class="inline-flex items-center justify-center gap-1.5 rounded-lg px-3 py-2 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_10px_30px_rgba(158,75,138,0.28)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.35)] transition min-w-[90px]">
                        <span class="material-symbols-rounded text-base">filter_alt</span>Apply
                    </button>

                    <button id="clearAll"
                        class="inline-flex items-center justify-center gap-1.5 rounded-lg px-3 py-2 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_10px_30px_rgba(158,75,138,0.28)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.35)] transition min-w-[90px]"><span
                            class="material-symbols-rounded text-base">clear</span>Clear</button>

                    <a href="./upload_note.html"
                        class="inline-flex items-center justify-center gap-1.5 rounded-lg px-3 py-2 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_10px_30px_rgba(158,75,138,0.28)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.35)] transition min-w-[90px] md:ml-auto"><span
                            class="material-symbols-rounded text-base">upload</span>Upload</a>
                </div>
            </div>
        </div>
    </section>

    <main class="container py-8 space-y-6">
        <!-- filters moved inline beside search -->

        <!-- Controls row: view + sort -->
        <div class="flex items-center justify-between gap-3 flex-wrap">
            <div class="hidden md:flex items-center gap-2" role="tablist" aria-label="Scopes">
                <button data-scope value="all"
                    class="scope-btn px-3 py-1.5 text-xs font-medium rounded-full bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15">All</button>
                <button data-scope value="free"
                    class="scope-btn px-3 py-1.5 text-xs font-medium rounded-full ring-1 ring-black/10 dark:ring-white/15">Free</button>
                <button data-scope value="top"
                    class="scope-btn px-3 py-1.5 text-xs font-medium rounded-full ring-1 ring-black/10 dark:ring-white/15">Top
                    rated</button>
                <button data-scope value="new"
                    class="scope-btn px-3 py-1.5 text-xs font-medium rounded-full ring-1 ring-black/10 dark:ring-white/15">New</button>
            </div>
            <div class="flex items-center gap-2 ml-auto">
                <div class="hidden sm:flex items-center gap-1 rounded-lg ring-1 ring-black/10 dark:ring-white/15 p-1 bg-white/70 dark:bg-white/10"
                    role="tablist" aria-label="View">
                    <button id="viewGrid"
                        class="px-2.5 py-1.5 rounded-md bg-brand-500/10 text-brand-700 dark:text-fuchsia-200"
                        title="Grid view"><span class="material-symbols-rounded text-base">grid_view</span></button>
                    <button id="viewList" class="px-2.5 py-1.5 rounded-md" title="List view"><span
                            class="material-symbols-rounded text-base">view_agenda</span></button>
                </div>
                <label class="flex items-center gap-2 text-xs text-neutral-600 dark:text-white/70">
                    <span class="hidden sm:inline">Sort</span>
                    <select id="sortBy"
                        class="text-sm rounded-lg ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10 py-2 px-3">
                        <option value="relevance">Relevance</option>
                        <option value="newest">Newest</option>
                        <option value="rating">Rating</option>
                        <option value="price_low">Price: Low → High</option>
                        <option value="price_high">Price: High → Low</option>
                    </select>
                </label>
            </div>
        </div>

        <section class="space-y-6">
            <!-- RESULTS -->
            <div class="space-y-4">
                <div id="alertBar"
                    class="hidden text-xs rounded-lg p-3 ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/10">
                </div>

                <div id="notesGrid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4" role="list"></div>
                <div id="notesList"
                    class="hidden divide-y divide-black/5 dark:divide-white/10 rounded-xl ring-1 ring-black/10 dark:ring-white/15 bg-white/70 dark:bg-white/5">
                </div>

                <div id="emptyState" class="hidden text-sm text-neutral-500 dark:text-white/60 py-16 text-center">
                    <div
                        class="mx-auto w-20 h-20 rounded-2xl bg-white/70 dark:bg-white/10 flex items-center justify-center ring-1 ring-black/10 dark:ring-white/15 mb-4">
                        <span class="material-symbols-rounded">hourglass_empty</span>
                    </div>
                    No notes match your filters.
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-center gap-2 pt-2" id="pager" hidden>
                    <button id="prevPage"
                        class="px-3 py-1.5 text-sm rounded-md ring-1 ring-black/10 dark:ring-white/15">Prev</button>
                    <span id="pageInfo" class="text-xs text-neutral-600 dark:text-white/60">Page 1</span>
                    <button id="nextPage"
                        class="px-3 py-1.5 text-sm rounded-md ring-1 ring-black/10 dark:ring-white/15">Next</button>
                </div>
            </div>
        </section>
    </main>

    <!-- MOBILE FILTER DRAWER -->
    <div id="filterDrawer" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40" id="closeFilters"></div>
        <div
            class="absolute right-0 top-0 bottom-0 w-full max-w-md glass shadow-card ring-1 ring-black/10 dark:ring-white/15 p-6 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-semibold">Filters</h3>
                <button id="closeFiltersBtn"
                    class="size-10 grid place-items-center rounded-full ring-1 ring-black/10 dark:ring-white/15"><span
                        class="material-symbols-rounded">close</span></button>
            </div>
            <div id="drawerFilters" class="space-y-5"></div>
            <div class="mt-6 flex gap-2">
                <button id="drawerClear"
                    class="flex-1 px-4 py-2 rounded-lg ring-1 ring-black/10 dark:ring-white/15">Clear</button>
                <button id="drawerApply" class="flex-1 px-4 py-2 rounded-lg bg-brand-500 text-white">Apply</button>
            </div>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="noteCardTpl">
        <article
            class="note-card group rounded-2xl border border-black/5 dark:border-white/10 shadow-card bg-white/80 dark:bg-[#1f1f2d]/70 backdrop-blur flex flex-col hover:shadow-lg transition"
            role="listitem">
            <div class="relative rounded-t-2xl overflow-hidden h-2"></div>
            <div class="p-4 flex flex-col gap-3 flex-1">
                <div class="flex items-start gap-2">
                    <h3
                        class="font-semibold text-sm leading-5 line-clamp-2 title text-neutral-900 dark:text-neutral-100 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors">
                    </h3>
                    <span class="ml-auto priceChip"></span>
                    <a class="detailsIconLink inline-flex items-center justify-center size-7 rounded-md ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 transition"
                        href="#" title="Open details" aria-label="Open note details">
                        <span class="material-symbols-rounded text-[18px] leading-none">open_in_new</span>
                    </a>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-3 desc"></p>
                <div class="flex flex-wrap gap-1 text-[10px] meta"></div>
                <div class="flex flex-wrap gap-1 academicChips"></div>
                <div
                    class="mt-auto pt-3 border-t border-black/5 dark:border-white/10 flex items-center justify-between">
                    <div class="seller hidden flex items-center gap-2">
                        <span class="relative inline-flex items-center justify-center">
                            <img data-avatar
                                class="w-7 h-7 rounded-full object-cover bg-gray-200 dark:bg-gray-700 hidden ring-1 ring-black/5 dark:ring-white/10"
                                alt="Seller avatar" />
                            <span data-initial
                                class="w-7 h-7 rounded-full bg-gradient-to-br from-brand-500/30 to-brand-500/10 text-brand-700 dark:text-fuchsia-200 flex items-center justify-center text-[11px] font-semibold ring-1 ring-black/5 dark:ring-white/10"></span>
                        </span>
                        <a data-profile-link-name
                            class="text-[11px] font-medium text-gray-700 dark:text-gray-300 hover:underline truncate max-w-[7.5rem]"></a>
                    </div>
                    <span class="text-[11px] rating text-amber-500"></span>
                </div>
            </div>
        </article>
    </template>

    <template id="noteRowTpl">
        <article class="p-4 flex items-start gap-4" role="listitem">
            <div class="flex-1 min-w-0">
                <div class="flex items-start gap-2">
                    <h3
                        class="font-semibold text-sm line-clamp-1 title text-neutral-900 dark:text-neutral-100 hover:text-brand-600 dark:hover:text-brand-400 transition-colors">
                    </h3>
                    <span class="ml-auto priceChip"></span>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 mt-1 desc"></p>
                <div class="flex items-center gap-2 text-[11px] text-gray-500 flex-wrap mt-2 meta"></div>
            </div>
            <div class="flex flex-col items-end gap-2">
                <span class="text-[11px] rating text-amber-500"></span>
                <a class="text-xs font-medium text-brand-700 dark:text-fuchsia-200 hover:underline detailsLink"
                    href="#">Details</a>
            </div>
        </article>
    </template>

    <template id="skeletonCardTpl">
        <div class="rounded-xl ring-1 ring-black/10 dark:ring-white/15 p-4 bg-white/70 dark:bg-white/5">
            <div class="h-4 w-2/3 skeleton animate-shimmer rounded mb-2"></div>
            <div class="h-3 w-full skeleton animate-shimmer rounded mb-1"></div>
            <div class="h-3 w-5/6 skeleton animate-shimmer rounded mb-4"></div>
            <div class="h-3 w-1/3 skeleton animate-shimmer rounded"></div>
        </div>
    </template>

    <!-- SCRIPTS -->
    <script>
        // Utilities
        const el = (sel, root = document) => root.querySelector(sel);
        const els = (sel, root = document) => [...root.querySelectorAll(sel)];

        // Unified theme toggle (mirrors index/about)
        (function () {
            const root = document.documentElement;
            const toggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
            const updateIcons = (mode) => toggles().forEach(btn => { const ic = btn.querySelector('.material-symbols-rounded'); if (ic) ic.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode'; });
            const setTheme = (mode) => { mode === 'dark' ? root.classList.add('dark') : root.classList.remove('dark'); localStorage.setItem('px_theme', mode); updateIcons(mode); };
            // Initialize icon state
            setTheme(root.classList.contains('dark') ? 'dark' : 'light');
            document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; setTheme(root.classList.contains('dark') ? 'light' : 'dark'); });
        })();

        // API base resolver
        async function resolveApiBase(retries = 10) {
            const base = (window.__API_BASE || window.API_BASE || '').replace(/\/$/, '');
            if (base) return base;
            if (retries <= 0) return '';
            return new Promise(res => setTimeout(() => res(resolveApiBase(retries - 1)), 100));
        }
        let apiBase;
        function getAuthToken() {
            const keys = ['px_token', 'sb-access-token', 'supabase.auth.token'];
            for (const k of keys) { try { const v = localStorage.getItem(k); if (v) return v; } catch { } }
            return '';
        }

        // Fetch helpers
        async function fetchJSON(url, headers = {}) {
            try {
                const r = await fetch(url, { headers });
                if (!r.ok) return null; return await r.json();
            } catch { return null; }
        }

        async function fetchNotes(params = {}) {
            const qs = new URLSearchParams(params).toString();
            const token = getAuthToken();
            const url = `${apiBase}/api/marketplace/notes${qs ? ('?' + qs) : ''}`;
            let r;
            try {
                r = await fetch(url, { cache: 'no-store', headers: token ? { 'Authorization': 'Bearer ' + token } : {} });
            } catch (e) {
                console.error('Network error listing notes', e);
                return { items: [], total: 0 };
            }
            if (!r.ok) {
                let msg = 'List failed';
                try { const j = await r.json(); msg = j.detail || msg; } catch { }
                console.warn('Marketplace list error:', msg);
                showAlert(msg);
                return { items: [], total: 0 };
            }
            try { return await r.json(); } catch { return { items: [], total: 0 }; }
        }

        // UI state
        let state = {
            scope: 'all',
            view: 'grid',
            page: 1,
            page_size: 24,
            sort: 'relevance'
        };

        // Controls wiring
        el('#viewGrid').addEventListener('click', () => switchView('grid'));
        el('#viewList').addEventListener('click', () => switchView('list'));
        el('#sortBy').addEventListener('change', () => { state.sort = el('#sortBy').value; load(true); });
        els('.scope-btn').forEach(b => b.addEventListener('click', () => { state.scope = b.value; highlightScopes(); load(true); }));

        // Quick chips (attach handlers only if the buttons exist)
        ['quickFree', 'quickTop', 'quickNew'].forEach(id => {
            const btn = el('#' + id);
            if (!btn) return;
            btn.addEventListener('click', () => {
                if (id === 'quickFree') state.scope = 'free';
                if (id === 'quickTop') state.scope = 'top';
                if (id === 'quickNew') state.scope = 'new';
                highlightScopes();
                load(true);
            });
        });

        function highlightScopes() {
            els('.scope-btn').forEach(b => {
                const active = b.value === state.scope;
                b.classList.toggle('bg-white/70', active);
                b.classList.toggle('dark:bg-white/10', active);
                b.classList.toggle('ring-1', true);
                b.classList.toggle('ring-black/10', true);
                b.classList.toggle('dark:ring-white/15', true);
            });
        }

        function switchView(v) {
            state.view = v;
            el('#viewGrid').classList.toggle('bg-brand-500/10', v === 'grid');
            el('#viewList').classList.toggle('bg-brand-500/10', v === 'list');
            el('#notesGrid').classList.toggle('hidden', v !== 'grid');
            el('#notesList').classList.toggle('hidden', v !== 'list');
        }

        // Alert helper
        function showAlert(msg) {
            const bar = el('#alertBar');
            bar.textContent = msg; bar.classList.remove('hidden');
            setTimeout(() => bar.classList.add('hidden'), 3000);
        }

        // Renderers
        function renderSkeletons() {
            const grid = el('#notesGrid');
            const tpl = el('#skeletonCardTpl');
            grid.innerHTML = '';
            for (let i = 0; i < 8; i++) grid.appendChild(tpl.content.cloneNode(true));
            el('#notesList').innerHTML = '';
            el('#emptyState').classList.add('hidden');
        }

        function renderNotes(items = [], total = 0) {
            el('#statCount').textContent = `${total || items.length} items`;
            const grid = el('#notesGrid');
            const list = el('#notesList');
            grid.innerHTML = ''; list.innerHTML = '';
            if (!items.length) { el('#emptyState').classList.remove('hidden'); el('#pager').hidden = true; return; }
            el('#emptyState').classList.add('hidden');
            const cardTpl = el('#noteCardTpl');
            const rowTpl = el('#noteRowTpl');
            items.forEach(n => {
                const priceText = (n.price_cents || 0) === 0 ? 'Free' : `₹${(n.price_cents / 100).toFixed(0)}`;
                const subjArr = [n.subject, n.unit, n.exam_type].filter(Boolean);
                const subjHtml = subjArr.map(x => `<span class="px-2 py-0.5 rounded-full ring-1 ring-black/10 dark:ring-white/15">${x}</span>`).join('');
                const ratingTxt = n.rating_count ? `★ ${Number(n.avg_rating).toFixed(1)} (${n.rating_count})` : '';
                const detailsHref = `./note_detail.html?id=${n.id}`;
                const frag = cardTpl.content.cloneNode(true);
                const q = (s) => frag.querySelector(s);
                const titleEl = q('h3.title, .title, h3'); if (titleEl) titleEl.textContent = n.title;
                const priceEl = q('.priceChip'); if (priceEl) priceEl.textContent = priceText;
                const descEl = q('.desc, .note-desc'); if (descEl) descEl.textContent = n.description || '';
                // Cover image
                // Cover image intentionally removed per requirement; placeholder height kept minimal.
                const metaEl = q('.meta, .metaTags'); if (metaEl) metaEl.innerHTML = subjHtml;
                const ratingEl = q('.rating'); if (ratingEl) ratingEl.textContent = ratingTxt;
                const detailsEl = q('.detailsLink'); if (detailsEl) detailsEl.href = detailsHref;
                const iconLink = q('.detailsIconLink'); if (iconLink) iconLink.href = detailsHref;
                const acadEl = q('.academicChips'); if (acadEl) {
                    const chips = [];
                    if (n.college_code || n.college_abbrev) chips.push(n.college_code || n.college_abbrev);
                    if (n.degree_name) chips.push(n.degree_name);
                    if (n.department_name) chips.push(n.department_name);
                    if (n.batch_from && n.batch_to) chips.push(`${n.batch_from}-${n.batch_to}`); else if (n.batch_range) chips.push(n.batch_range);
                    if (n.semester) chips.push('Sem ' + n.semester);
                    acadEl.innerHTML = chips.map(c => `<span class="px-2 py-0.5 rounded-full bg-black/5 dark:bg-white/10 text-[10px]">${c}</span>`).join('');
                }
                if (n.seller && n.seller.id) {
                    const sellerWrap = q('.seller');
                    if (sellerWrap) {
                        sellerWrap.classList.remove('hidden');
                        const nameLink = sellerWrap.querySelector('[data-profile-link-name]');
                        const avatar = sellerWrap.querySelector('[data-avatar]');
                        const initial = sellerWrap.querySelector('[data-initial]');
                        const s = n.seller;
                        const profUrl = s.profile_href ? (s.profile_href.startsWith('http') ? s.profile_href : `../../teacher_profile.html?user=${encodeURIComponent(s.id)}`) : (s.is_teacher ? `../../teacher_profile.html?user=${encodeURIComponent(s.id)}` : `../../staff_profile.html?user=${encodeURIComponent(s.id)}`);
                        if (nameLink) { nameLink.href = profUrl; nameLink.textContent = s.name || 'User'; }
                        if (initial) initial.textContent = (s.name || 'U').trim().charAt(0).toUpperCase() || 'U';
                        if (s.avatar_url && avatar) { avatar.src = s.avatar_url; avatar.classList.remove('hidden'); if (initial) initial.classList.add('hidden'); }
                        // Teacher badge with text
                        if (s.is_teacher && nameLink && !sellerWrap.querySelector('.teacher-badge')) {
                            nameLink.insertAdjacentHTML('afterend', '<span class="teacher-badge inline-flex items-center gap-0.5 text-[10px] font-medium px-1.5 py-0.5 rounded-full bg-emerald-500/10 text-emerald-600 dark:text-emerald-300 ring-1 ring-emerald-500/30"><span class="material-symbols-rounded text-[13px] leading-none">verified</span><span>Teacher</span></span>');
                        }
                    }
                }
                grid.appendChild(frag);
                const rowFrag = rowTpl.content.cloneNode(true);
                const rq = (s) => rowFrag.querySelector(s);
                const rTitle = rq('.title, .row-title'); if (rTitle) rTitle.textContent = n.title;
                const rPrice = rq('.priceChip, .row-price'); if (rPrice) rPrice.textContent = priceText;
                const rDesc = rq('.desc, .row-desc'); if (rDesc) rDesc.textContent = n.description || '';
                const rMeta = rq('.meta, .row-meta'); if (rMeta) rMeta.innerHTML = subjHtml;
                const rRating = rq('.rating, .row-rating'); if (rRating) rRating.textContent = ratingTxt;
                const rLink = rq('.detailsLink, .row-link'); if (rLink) rLink.href = detailsHref;
                list.appendChild(rowFrag);
            });
            el('#pager').hidden = true;
        }

        // Load orchestration
        let loadTimer = null;
        async function load(immediate = false) {
            const exec = async () => {
                if (!apiBase) apiBase = await resolveApiBase();
                renderSkeletons();
                const params = buildParams();
                const data = await fetchNotes(params);
                renderNotes(data.items || [], data.total || 0);
            };
            if (immediate) return exec();
            if (loadTimer) cancelAnimationFrame(loadTimer);
            loadTimer = requestAnimationFrame(exec);
        }

        function buildParams() {
            const params = { page: state.page, page_size: state.page_size, sort: state.sort };
            const qv = el('#q').value.trim(); if (qv) params.q = qv;
            const min = el('#minPrice').value; if (min) params.min_price = min;
            const max = el('#maxPrice').value; if (max) params.max_price = max;
            const col = el('#collegeFilter').value; if (col) params.college_id = col;
            const deg = el('#degreeFilter').value; if (deg) params.degree_id = deg;
            const dep = el('#deptFilter').value; if (dep) params.department_id = dep;
            const bat = el('#batchFilter').value; if (bat) params.batch_id = bat;
            const sem = el('#semFilter').value; if (sem) params.semester = sem;
            if (state.scope === 'free') { params.max_price = 0; }
            if (state.scope === 'top') { params.sort = 'rating'; }
            if (state.scope === 'new') { params.sort = 'newest'; }
            // Quick chips -> map to tags
            const tags = els('.chip.active').map(c => c.value);
            if (tags.length) params.tags = tags.join(',');
            return params;
        }

        // Search on Enter
        el('#q').addEventListener('keydown', (e) => { if (e.key === 'Enter') load(true); });

        // Apply/Clear
        el('#applyFilters').addEventListener('click', () => load(true));
        el('#clearAll').addEventListener('click', () => { els('input, select', el('#inlineFilters') || document).forEach(x => { if (x.tagName === 'SELECT') x.selectedIndex = 0; else x.value = ''; }); els('.chip').forEach(c => c.classList.remove('active')); state.scope = 'all'; highlightScopes(); load(true); });

        // Chips toggle
        document.addEventListener('click', e => { const c = e.target.closest('.chip'); if (!c) return; c.classList.toggle('active'); });

        // Mobile drawer
        const drawer = el('#filterDrawer');
        const sidebar = el('#inlineFilters') || el('#sidebarFilters');
        el('#openFilters').addEventListener('click', () => { // clone filters into drawer
            const host = el('#drawerFilters'); host.innerHTML = '';
            if (sidebar) host.appendChild(sidebar.cloneNode(true));
            drawer.classList.remove('hidden');
        });
        el('#closeFilters').addEventListener('click', () => drawer.classList.add('hidden'));
        el('#closeFiltersBtn').addEventListener('click', () => drawer.classList.add('hidden'));
        el('#drawerClear').addEventListener('click', () => { els('input, select', drawer).forEach(x => { if (x.tagName === 'SELECT') x.selectedIndex = 0; else x.value = ''; }); els('.chip', drawer).forEach(c => c.classList.remove('active')); });
        el('#drawerApply').addEventListener('click', () => { drawer.classList.add('hidden'); load(true); });

        // Academic cascading filters
        const collegeSel = document.getElementById('collegeFilter');
        const degreeSel = document.getElementById('degreeFilter');
        const deptSel = document.getElementById('deptFilter');
        const batchSel = document.getElementById('batchFilter');
        const semSel = document.getElementById('semFilter');
        function clearSel(sel, label, disable = true) { sel.innerHTML = `<option value="">${label}</option>`; sel.disabled = disable; }

        async function loadColleges() {
            if (!apiBase) apiBase = await resolveApiBase();
            clearSel(collegeSel, 'College', false);
            const data = await fetchJSON(`${apiBase}/api/colleges`);
            if (Array.isArray(data)) data.forEach(c => { const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; collegeSel.appendChild(o); });
        }
        async function loadDegrees(collegeId) {
            clearSel(degreeSel, 'Degree'); clearSel(deptSel, 'Department'); clearSel(batchSel, 'Batch'); clearSel(semSel, 'Semester');
            if (!collegeId) return; degreeSel.disabled = false; deptSel.disabled = true; batchSel.disabled = true; semSel.disabled = true;
            const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/degrees`);
            if (Array.isArray(data)) data.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = d.name; degreeSel.appendChild(o); });
        }
        async function loadDepartments(collegeId) {
            clearSel(deptSel, 'Department'); clearSel(batchSel, 'Batch'); clearSel(semSel, 'Semester');
            if (!collegeId) return; deptSel.disabled = false;
            const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/departments/full`);
            if (Array.isArray(data)) data.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.textContent = d.name; deptSel.appendChild(o); });
        }
        async function loadBatches(collegeId, deptName) {
            clearSel(batchSel, 'Batch'); clearSel(semSel, 'Semester');
            if (!collegeId || !deptName) return; batchSel.disabled = false;
            const data = await fetchJSON(`${apiBase}/api/colleges/${collegeId}/departments/${encodeURIComponent(deptName)}/batches/full`);
            if (Array.isArray(data)) data.forEach(b => { const o = document.createElement('option'); const from = b.from_year ?? b.from; const to = b.to_year ?? b.to; o.value = b.id || `${from}-${to}`; o.textContent = (Number.isInteger(from) && Number.isInteger(to)) ? `${from}-${to}` : (b.range || 'Batch'); batchSel.appendChild(o); });
        }
        function enableSemester() { clearSel(semSel, 'Semester', false); for (let i = 1; i <= 8; i++) { const o = document.createElement('option'); o.value = String(i); o.textContent = String(i); semSel.appendChild(o); } }

        collegeSel.addEventListener('change', e => { const v = e.target.value; loadDegrees(v); loadDepartments(v); });
        deptSel.addEventListener('change', e => { const deptTxt = deptSel.options[deptSel.selectedIndex]?.textContent; loadBatches(collegeSel.value, deptTxt); });
        batchSel.addEventListener('change', () => { enableSemester(); });

        // Initial boot
        document.addEventListener('DOMContentLoaded', () => { switchView('grid'); highlightScopes(); loadColleges(); load(true); });
    </script>
</body>

</html>