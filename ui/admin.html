<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Paper X — Admin Users</title>
  <link rel="icon" type="image/svg+xml" href="assets/img/favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/tailwind.css" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
          colors: { brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' }, magenta: '#9E4B8A' },
          boxShadow: { glass: '0 8px 28px -6px rgba(30,30,47,.55),0 2px 6px rgba(0,0,0,.3)', neon: '0 0 0 1px rgba(255,255,255,.08), 0 4px 14px -2px rgba(158,75,138,.55), 0 18px 48px -8px rgba(76,42,89,.55)' }
        }
      }
    }
  </script>
  <style>
    .material-symbols-rounded {
      vertical-align: -5px
    }

    html.dark body {
      background: radial-gradient(circle at 25% 15%, #4C2A59 0%, rgba(30, 30, 47, 0) 55%), linear-gradient(135deg, #1E1E2F 0%, #221B38 40%, #141321 100%)
    }

    body {
      background: linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 50%, #F7F2F9 100%)
    }

    .glass-panel {
      background: linear-gradient(135deg, rgba(255, 255, 255, .72), rgba(255, 255, 255, .55));
      backdrop-filter: saturate(1.35) blur(14px);
      -webkit-backdrop-filter: saturate(1.35) blur(14px)
    }

    .dark .glass-panel {
      background: linear-gradient(135deg, rgba(40, 28, 55, .75), rgba(30, 24, 47, .65))
    }

    /* Unified gradient text style (synced with index.html) */
    .gradient-text {
      display: inline-block;
      background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
      background-size: 200% 200%;
      animation: gradient-shift 4s ease-in-out infinite;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      -webkit-box-decoration-break: clone;
      box-decoration-break: clone
    }

    .dark .gradient-text {
      background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC)
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }

    @keyframes shift {
      0% {
        background-position: 0 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0 50%
      }
    }

    .table-grid tr {
      transition: background .25s ease
    }

    .table-grid tr:hover {
      background: rgba(158, 75, 138, .06)
    }

    .dark .table-grid tr:hover {
      background: rgba(158, 75, 138, .18)
    }

    .avatar-ring {
      box-shadow: 0 0 0 1.5px rgba(255, 255, 255, .85), 0 0 0 3px rgba(158, 75, 138, .35)
    }

    .dark .avatar-ring {
      box-shadow: 0 0 0 1.5px rgba(255, 255, 255, .25), 0 0 0 3px rgba(158, 75, 138, .55)
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 500;
      line-height: 1;
      background: rgba(158, 75, 138, .12);
      color: #4C2A59
    }

    .dark .chip {
      background: rgba(158, 75, 138, .22);
      color: #EFA3DC
    }

    .status-pill {
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      letter-spacing: .5px;
      text-transform: uppercase
    }

    .pill-active {
      background: linear-gradient(135deg, #4C2A59, #9E4B8A);
      color: #fff
    }

    .pill-new {
      background: linear-gradient(135deg, #9E4B8A, #FF7FD1);
      color: #fff
    }

    .loader-dots span {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #9E4B8A;
      display: inline-block;
      animation: bounce 1s infinite ease-in-out
    }

    .loader-dots span:nth-child(2) {
      animation-delay: .2s
    }

    .loader-dots span:nth-child(3) {
      animation-delay: .4s
    }

    @keyframes bounce {

      0%,
      80%,
      100% {
        transform: scale(.4);
        opacity: .45
      }

      40% {
        transform: scale(1);
        opacity: 1
      }
    }

    .layout-toggle button.active {
      background: linear-gradient(135deg, #9E4B8A, #4C2A59);
      color: #fff
    }

    .grid-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, .75), rgba(255, 255, 255, .55));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px)
    }

    .dark .grid-card {
      background: linear-gradient(135deg, rgba(40, 28, 55, .72), rgba(30, 24, 47, .55))
    }
  </style>
  <script>(() => { const stored = localStorage.getItem('px_theme'); const prefers = window.matchMedia('(prefers-color-scheme:dark)').matches; const dark = stored ? stored === 'dark' : prefers; if (dark) document.documentElement.classList.add('dark'); })();</script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white">
  <header
    class="sticky top-0 z-30 backdrop-blur bg-white/70 dark:bg-brand-900/70 border-b border-black/5 dark:border-white/10">
    <div class="max-w-7xl mx-auto px-4 flex items-center justify-between h-16">
      <a href="index.html" class="flex items-center gap-2 font-bold tracking-tight text-lg"><img
          src="assets/img/logo-light.svg" class="h-8 w-auto dark:hidden" /><img src="assets/img/logo-dark.svg"
          class="h-8 w-auto hidden dark:block" /><span class="gradient-text hidden sm:inline">Admin • Users</span></a>
      <div class="flex items-center gap-2">
        <button id="themeToggle"
          class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 hover:bg-white dark:hover:bg-white/20 transition material-symbols-rounded"
          title="Toggle theme">dark_mode</button>
        <a href="profile.html"
          class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-medium bg-brand-500 text-white hover:shadow-neon">Profile</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-10 space-y-8">
    <section class="flex flex-col lg:flex-row lg:items-end gap-6">
      <div class="flex-1 space-y-3">
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight gradient-text">User Directory</h1>
        <p class="text-sm md:text-base text-neutral-600 dark:text-white/60 max-w-2xl">Search, filter and inspect every
          registered profile. This dashboard surfaces core academic + social indicators to help moderation, curation and
          growth analytics.</p>
        <div id="stats" class="flex flex-wrap items-center gap-3 text-xs"></div>
      </div>
      <div class="w-full max-w-md glass-panel rounded-2xl p-5 ring-1 ring-black/10 dark:ring-white/10 shadow-glass">
        <form id="filterForm" class="space-y-4" autocomplete="off">
          <div class="flex gap-3">
            <div class="flex-1 relative">
              <span
                class="material-symbols-rounded absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400 dark:text-white/40 text-[20px]">search</span>
              <input id="searchInput" type="text" placeholder="Search name, email, regno, skill…"
                class="w-full rounded-xl pl-10 pr-3 py-2.5 bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/60" />
            </div>
            <div class="flex items-center gap-1 layout-toggle">
              <button type="button" data-view="table"
                class="h-10 w-10 rounded-xl flex items-center justify-center bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 text-neutral-600 dark:text-white/70 hover:bg-white dark:hover:bg-white/20 material-symbols-rounded"
                title="Table view">table</button>
              <button type="button" data-view="grid"
                class="h-10 w-10 rounded-xl flex items-center justify-center bg-white/70 dark:bg-white/10 ring-1 ring-black/10 dark:ring-white/15 text-neutral-600 dark:text-white/70 hover:bg-white dark:hover:bg-white/20 material-symbols-rounded"
                title="Grid view">grid_view</button>
            </div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-[11px]">
            <select id="semesterFilter"
              class="rounded-xl bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/50">
              <option value="">Semester</option>
            </select>
            <select id="batchFilter"
              class="rounded-xl bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/50">
              <option value="">Batch</option>
            </select>
            <select id="deptFilter"
              class="rounded-xl bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/50">
              <option value="">Department</option>
            </select>
            <select id="sortSelect"
              class="rounded-xl bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500/50">
              <option value="">Sort: Default</option>
              <option value="name">Name A→Z</option>
              <option value="semester">Semester ↓</option>
              <option value="created_desc">Newest</option>
              <option value="verification">Verification Score ↓</option>
            </select>
          </div>
        </form>
      </div>
    </section>

    <section id="resultsWrapper" class="space-y-4">
      <div id="loadingState" class="flex items-center gap-3 text-sm text-brand-500 dark:text-magenta">
        <div class="loader-dots"><span></span><span></span><span></span></div><span>Loading users…</span>
      </div>
      <div id="errorState" class="hidden text-sm text-red-600 dark:text-red-400 font-medium"></div>
      <div id="tableView" class="overflow-x-auto hidden">
        <table class="w-full text-sm table-grid">
          <thead class="text-left text-[11px] uppercase tracking-wide text-neutral-500 dark:text-white/40">
            <tr class="border-b border-black/5 dark:border-white/10">
              <th class="py-2 pr-3 font-semibold">User</th>
              <th class="py-2 pr-3 font-semibold">Academic</th>
              <th class="py-2 pr-3 font-semibold">Department</th>
              <th class="py-2 pr-3 font-semibold">Verification</th>
              <th class="py-2 pr-3 font-semibold">Role</th>
              <th class="py-2 pr-3 font-semibold">Updated</th>
              <th class="py-2 pr-3 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="userRows" class="align-top divide-y divide-black/5 dark:divide-white/10"></tbody>
        </table>
      </div>
      <div id="gridView" class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 hidden"></div>
      <div id="emptyState" class="hidden text-center py-12 text-sm text-neutral-500 dark:text-white/40">No users match
        current filters.</div>
    </section>

    <!-- Teacher Applications Review -->
    <section id="teacherApplicationsSection" class="space-y-5">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="space-y-1">
          <h2 class="text-2xl font-bold tracking-tight gradient-text">Teacher Applications</h2>
          <p class="text-sm text-neutral-600 dark:text-white/50 max-w-2xl">Review pending teacher signups, inspect
            submitted ID cards (front & back) and approve or reject with notes. Only approved users gain the <code
              class="px-1 py-0.5 rounded bg-black/5 dark:bg-white/10 text-xs">teacher</code> role.</p>
        </div>
        <div class="flex items-center gap-3 flex-wrap">
          <select id="teacherAppStatusFilter"
            class="rounded-xl bg-white/80 dark:bg-white/10 border border-black/10 dark:border-white/10 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500/50">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="">All</option>
          </select>
          <button id="refreshTeacherApps"
            class="inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium bg-brand-500 text-white hover:shadow-neon transition"><span
              class="material-symbols-rounded text-[18px]">refresh</span>Refresh</button>
        </div>
      </div>
      <div id="teacherAppsLoading" class="flex items-center gap-3 text-sm text-brand-500 dark:text-magenta hidden">
        <div class="loader-dots"><span></span><span></span><span></span></div><span>Loading applications…</span>
      </div>
      <div id="teacherAppsError" class="hidden text-sm text-red-600 dark:text-red-400 font-medium"></div>
      <div id="teacherAppsEmpty" class="hidden text-sm text-neutral-500 dark:text-white/40">No applications for this
        filter.</div>
      <div id="teacherAppsTableWrapper" class="overflow-x-auto">
        <table class="w-full text-sm table-grid" id="teacherAppsTable">
          <thead class="text-left text-[11px] uppercase tracking-wide text-neutral-500 dark:text-white/40">
            <tr class="border-b border-black/5 dark:border-white/10">
              <th class="py-2 pr-3 font-semibold">Applicant</th>
              <th class="py-2 pr-3 font-semibold">Academic</th>
              <th class="py-2 pr-3 font-semibold">Subjects</th>
              <th class="py-2 pr-3 font-semibold">ID Cards</th>
              <th class="py-2 pr-3 font-semibold">Submitted</th>
              <th class="py-2 pr-3 font-semibold">Status</th>
              <th class="py-2 pr-3 font-semibold">Notes</th>
              <th class="py-2 pr-3 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="teacherAppsTbody" class="align-top divide-y divide-black/5 dark:divide-white/10"></tbody>
        </table>
      </div>
    </section>
  </main>

  <template id="rowTemplate">
    <tr>
      <td class="py-3 pr-3">
        <div class="flex items-center gap-3">
          <div class="relative">
            <img data-avatar class="h-12 w-12 rounded-xl object-cover avatar-ring bg-neutral-200 dark:bg-white/10"
              alt="avatar" />
            <span data-initial
              class="absolute inset-0 flex items-center justify-center text-xs font-semibold tracking-wide text-neutral-700 dark:text-white/70"></span>
          </div>
          <div>
            <div class="font-semibold leading-tight" data-name></div>
            <div class="text-[11px] opacity-70" data-email></div>
            <div class="mt-1 flex flex-wrap gap-1" data-status></div>
          </div>
        </div>
      </td>
      <td class="py-3 pr-3 text-[12px]">
        <div data-academic class="space-y-1"></div>
      </td>
      <td class="py-3 pr-3 text-[12px]" data-department></td>
      <td class="py-3 pr-3" data-verify></td>
      <td class="py-3 pr-3 text-[11px]" data-role></td>
      <td class="py-3 pr-3 text-[11px] opacity-60" data-updated></td>
      <td class="py-3 pr-3 text-[11px]" data-actions></td>
    </tr>
  </template>

  <template id="cardTemplate">
    <article
      class="grid-card rounded-2xl ring-1 ring-black/10 dark:ring-white/10 p-4 hover:shadow-neon transition relative overflow-hidden">
      <div class="flex items-start gap-3">
        <div class="relative">
          <img data-avatar class="h-14 w-14 rounded-xl object-cover avatar-ring bg-neutral-200 dark:bg-white/10"
            alt="avatar" />
          <span data-initial
            class="absolute inset-0 flex items-center justify-center text-sm font-semibold tracking-wide text-neutral-700 dark:text-white/70"></span>
        </div>
        <div class="flex-1 min-w-0">
          <h3 class="font-semibold leading-snug truncate" data-name></h3>
          <p class="text-[11px] opacity-70 truncate" data-email></p>
          <div class="mt-1 flex flex-wrap gap-1" data-status></div>
        </div>
        <div class="text-[11px] opacity-60" data-verify></div>
      </div>
      <div class="mt-3 space-y-2 text-[11px]">
        <div data-academic class="flex flex-wrap gap-2"></div>
      </div>
      <div class="mt-3 flex items-center justify-between gap-2 text-[10px] opacity-50"><span data-updated></span>
        <div class="flex gap-1" data-actions-card>
          <button
            class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-white/60 dark:bg-white/10 hover:bg-white dark:hover:bg-white/20 transition"
            data-view-profile title="View profile"><span
              class="material-symbols-rounded text-xs">open_in_new</span></button>
          <button
            class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-red-500/80 text-white hover:bg-red-600 transition"
            data-delete-user title="Delete user"><span class="material-symbols-rounded text-xs">delete</span></button>
        </div>
      </div>
    </article>
  </template>

  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script>
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    // --- Dynamic API base resolution (so admin page can be served from another port) ---
    let API = (window.API_BASE || '').replace(/\/$/, '');
    async function fetchWithTimeout(url, options = {}, timeoutMs = 1500) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try {
        return await fetch(url, { ...options, signal: controller.signal });
      } finally {
        clearTimeout(t);
      }
    }
    async function resolveApiBase() {
      if (API) return;
      if (location.port === '8000') { API = location.origin; return; }
      const host = location.hostname;
      const candidates = [location.origin, `http://${host}:8000`, `https://${host}:8000`];
      for (const base of candidates) {
        try {
          const r = await fetchWithTimeout(base + '/api/admin/self-check', { method: 'HEAD' }, 900);
          if (r.ok || r.status === 401 || r.status === 403) { API = base.replace(/\/$/, ''); window.API_BASE = API; return; }
        } catch (_) { }
      }
      // fallback: current origin
      API = location.origin;
    }

    const state = { raw: [], filtered: [], view: localStorage.getItem('admin_users_view') || 'table' };

    function fmtDate(ts) { if (!ts) return ''; try { return new Date(ts).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); } catch (_) { return ''; } }
    function initials(name) { if (!name) return ''; return name.split(/\s+/).map(p => p[0]).slice(0, 2).join('').toUpperCase(); }

    function computeStats() { const total = state.raw.length; const semesters = new Set(); const depts = new Set(); state.raw.forEach(u => { if (u.semester) semesters.add(u.semester); if (u.department) depts.add(u.department); }); return { total, semesters: semesters.size, depts: depts.size }; }

    function renderStats() { const s = computeStats(); const el = $('#stats'); if (!el) return; el.innerHTML = [['Users', s.total], ['Semesters', s.semesters], ['Departments', s.depts]].map(([k, v]) => `<span class="chip">${k}: <strong>${v}</strong></span>`).join(''); }

    function buildFilters() {
      const semesterSel = $('#semesterFilter');
      const batchSel = $('#batchFilter');
      const deptSel = $('#deptFilter');
      // Clear previous options but preserve the first placeholder option.
      [semesterSel, batchSel, deptSel].forEach(sel => {
        if (!sel) return;
        while (sel.options.length > 1) sel.remove(1);
      });
      const semesters = [...new Set(state.raw.map(u => u.semester).filter(Boolean))].sort((a, b) => a - b);
      semesters.forEach(s => {
        const o = document.createElement('option');
        o.value = s;
        o.textContent = 'Sem ' + s;
        semesterSel.appendChild(o);
      });
      const batches = [...new Set(state.raw.map(u => u.batch_range).filter(Boolean))];
      batches.forEach(r => {
        const o = document.createElement('option');
        o.value = r;
        o.textContent = r;
        batchSel.appendChild(o);
      });
      const depts = [...new Set(state.raw.map(u => u.department).filter(Boolean))].sort();
      depts.forEach(d => {
        const o = document.createElement('option');
        o.value = d;
        o.textContent = d;
        deptSel.appendChild(o);
      });
    }

    function applyFilters() {
      const q = ($('#searchInput').value || '').toLowerCase();
      const sem = $('#semesterFilter').value;
      const batch = $('#batchFilter').value;
      const dept = $('#deptFilter').value;

      const toStrList = (v) => {
        if (v == null) return [];
        if (Array.isArray(v)) return v.map(x => String(x ?? '').trim()).filter(Boolean);
        if (typeof v === 'string') return [v];
        if (typeof v === 'number' || typeof v === 'boolean') return [String(v)];
        return [];
      };

      state.filtered = state.raw.filter(u => {
        if (q) {
          const hayParts = [
            u.name,
            u.email,
            u.regno,
            u.department,
            u.batch_range,
            ...toStrList(u.skills),
            ...toStrList(u.technologies),
            ...toStrList(u.specializations),
          ].map(x => String(x ?? '')).join(' ').toLowerCase();
          if (!hayParts.includes(q)) return false;
        }
        if (sem && String(u.semester) !== sem) return false;
        if (batch && u.batch_range !== batch) return false;
        if (dept && u.department !== dept) return false;
        return true;
      });
      sortData();
      render();
    }

    function sortData() { const sort = $('#sortSelect').value; if (!sort) return; const arr = state.filtered; const collator = new Intl.Collator(undefined, { sensitivity: 'base' }); switch (sort) { case 'name': arr.sort((a, b) => collator.compare(a.name || '', b.name || '')); break; case 'semester': arr.sort((a, b) => (b.semester || 0) - (a.semester || 0)); break; case 'created_desc': arr.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()); break; case 'verification': arr.sort((a, b) => (b.verification_score || 0) - (a.verification_score || 0)); break; } }

    function setView(v) { state.view = v; localStorage.setItem('admin_users_view', v); $('#tableView').classList.toggle('hidden', v !== 'table'); $('#gridView').classList.toggle('hidden', v !== 'grid'); $$('.layout-toggle button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === v)); }

    function render() { const rowsEl = $('#userRows'); const gridEl = $('#gridView'); if (!rowsEl || !gridEl) return; rowsEl.innerHTML = ''; gridEl.innerHTML = ''; const data = state.filtered; $('#emptyState').classList.toggle('hidden', data.length !== 0); data.forEach(u => { const rowT = $('#rowTemplate').content.firstElementChild.cloneNode(true); fillEntry(rowT, u); rowsEl.appendChild(rowT); const cardT = $('#cardTemplate').content.firstElementChild.cloneNode(true); fillEntry(cardT, u); gridEl.appendChild(cardT); }); }

    function fillEntry(node, u) {
      const avatar = node.querySelector('[data-avatar]'); const init = node.querySelector('[data-initial]'); if (avatar) { if (u.profile_image_url) { avatar.src = u.profile_image_url; init.textContent = ''; } else { avatar.removeAttribute('src'); init.textContent = initials(u.name || u.email || ''); } }
      const nameEl = node.querySelector('[data-name]'); if (nameEl) nameEl.textContent = u.name || '(no name)'; const emailEl = node.querySelector('[data-email]'); if (emailEl) emailEl.textContent = u.email || ''; const statusEl = node.querySelector('[data-status]'); if (statusEl) { statusEl.innerHTML = ''; if (u.semester) statusEl.innerHTML += `<span class="chip">Sem ${u.semester}</span>`; if (u.department) statusEl.innerHTML += `<span class="chip">${u.department}</span>`; if (u.batch_range) statusEl.innerHTML += `<span class="chip">${u.batch_range}</span>`; }
      const academic = node.querySelector('[data-academic]'); if (academic) { academic.innerHTML = ''; if (u.regno) academic.innerHTML += `<div><span class="font-medium">Reg:</span> ${u.regno}</div>`; if (u.semester) academic.innerHTML += `<div><span class="font-medium">Sem:</span> ${u.semester}</div>`; if (u.batch_range) academic.innerHTML += `<div><span class="font-medium">Batch:</span> ${u.batch_range}</div>`; }
      const deptCell = node.querySelector('[data-department]'); if (deptCell) { deptCell.textContent = u.department || '—'; }
      const links = node.querySelector('[data-links]'); if (links) { const mk = (icon, label, url) => `<a href="${url}" target="_blank" rel="noopener" class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-white/70 dark:bg-white/10 hover:bg-white dark:hover:bg-white/20 text-[10px]"><span class="material-symbols-rounded text-xs">${icon}</span>${label}</a>`; links.innerHTML = ''; if (u.linkedin) links.innerHTML += mk('work', 'LinkedIn', u.linkedin); if (u.github) links.innerHTML += mk('code', 'GitHub', u.github); if (u.leetcode) links.innerHTML += mk('developer_mode', 'LeetCode', u.leetcode); }
      const skills = node.querySelector('[data-skills]'); if (skills) { const list = [...(u.skills || []), ...(u.technologies || [])].slice(0, 6); skills.innerHTML = list.map(s => `<span class="chip">${s}</span>`).join(''); }
      const verify = node.querySelector('[data-verify]'); if (verify) { const v = u.verification_score || 0; verify.innerHTML = v ? `<span class="status-pill pill-active"><span class="material-symbols-rounded text-[14px]">verified</span>${v.toFixed(0)}</span>` : '<span class="status-pill pill-new">NEW</span>'; }
      const updated = node.querySelector('[data-updated]'); if (updated) updated.textContent = fmtDate(u.updated_at || u.created_at);
      const vp = node.querySelector('[data-view-profile]'); if (vp) vp.addEventListener('click', () => window.open(`profile_public.html?u=${encodeURIComponent(u.user_id || u.auth_user_id || '')}`, '_blank'));
      const roleCell = node.querySelector('[data-role]');
      const actionsCell = node.querySelector('[data-actions]');
      const actionsCard = node.querySelector('[data-actions-card]');
      if (roleCell) { roleCell.innerHTML = roleSelectHTML(u); }
      if (actionsCell) { actionsCell.innerHTML = deleteBtnHTML(u); }
      if (actionsCard) { const delBtn = actionsCard.querySelector('[data-delete-user]'); if (delBtn) attachDeleteHandler(delBtn, u); }
      // Attach role change if present
      const sel = node.querySelector('select[data-role-select]'); if (sel) { attachRoleChange(sel, u); }
      const delBtnRow = node.querySelector('[data-delete-user]'); if (delBtnRow) attachDeleteHandler(delBtnRow, u);
    }

    const ROLE_OPTIONS = ['admin', 'teacher', 'moderator', 'student', 'employee'];
    function roleSelectHTML(u) {
      return `<select data-role-select class="rounded-md bg-white/70 dark:bg-white/10 border border-black/10 dark:border-white/10 px-2 py-1 text-[11px] focus:outline-none">
        ${ROLE_OPTIONS.map(r => `<option value="${r}" ${(u.role || 'student') === r ? 'selected' : ''}>${r}</option>`).join('')}
      </select>`;
    }
    function deleteBtnHTML(u) {
      return `<button data-delete-user title="Delete user" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-red-500/80 hover:bg-red-600 text-white text-[11px]">
        <span class="material-symbols-rounded text-[14px]">delete</span>
      </button>`;
    }
    async function apiUpdateRole(user, uRole) {
      const token = await getAccessToken();
      const res = await fetch(`${API}/api/admin/users/${encodeURIComponent(user.user_id)}/role`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify({ role: uRole }) });
      if (!res.ok) { throw new Error(`Role update failed: ${res.status}`); }
      return res.json();
    }
    async function apiDeleteUser(user) {
      const token = await getAccessToken();
      const res = await fetch(`${API}/api/admin/users/${encodeURIComponent(user.user_id)}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } });
      if (!res.ok) { const txt = await res.text(); throw new Error(`Delete failed: ${res.status} ${txt}`); }
      return res.json();
    }
    function attachRoleChange(sel, u) {
      sel.addEventListener('change', async () => {
        const newRole = sel.value;
        const prev = u.role;
        sel.disabled = true; sel.classList.add('opacity-60');
        try { await apiUpdateRole(u, newRole); u.role = newRole; }
        catch (err) { console.error(err); alert(err.message || 'Role update error'); sel.value = prev; }
        finally { sel.disabled = false; sel.classList.remove('opacity-60'); }
      });
    }
    function attachDeleteHandler(btn, u) {
      btn.addEventListener('click', async () => {
        if (!confirm(`Delete user ${u.name || u.email}? This cannot be undone (profile only).`)) return;
        btn.disabled = true; btn.classList.add('opacity-60');
        try { await apiDeleteUser(u); state.raw = state.raw.filter(x => x.user_id !== u.user_id); applyFilters(); }
        catch (err) { console.error(err); alert(err.message || 'Delete failed'); }
        finally { btn.disabled = false; btn.classList.remove('opacity-60'); }
      });
    }

    async function getAccessToken() {
      // Primary token per auth.js
      try { const t = localStorage.getItem('px_token'); if (t) return t; } catch (_) { }
      // Supabase session (if client injected somewhere else)
      try { if (window.supabase && supabase.auth) { const { data } = await supabase.auth.getSession(); const tk = data?.session?.access_token; if (tk) return tk; } } catch (_) { }
      // Fallback keys (legacy / experiments)
      const fallbacks = ['access_token', 'auth_token', 'sb-access-token'];
      for (const k of fallbacks) { try { const v = localStorage.getItem(k); if (v) return v; } catch (_) { } }
      return null;
    }

    async function adminSelfCheck() {
      const token = await getAccessToken();
      if (!token) throw new Error('No auth token (px_token) found — please login');
      const res = await fetch(API + '/api/admin/self-check', { headers: { 'Authorization': 'Bearer ' + token } });
      if (res.status === 401) throw new Error('401 Unauthorized – token invalid or expired');
      if (res.status === 403) throw new Error('Not an admin — access denied');
      if (!res.ok) throw new Error('Self-check failed: ' + res.status);
      return res.json();
    }

    function showNotAdmin() {
      $('#resultsWrapper').innerHTML = `<div class="p-10 text-center space-y-4 glass-panel rounded-2xl">
        <div class="mx-auto w-14 h-14 rounded-full flex items-center justify-center bg-red-500/10 text-red-600 dark:text-red-400"><span class="material-symbols-rounded">block</span></div>
        <h2 class="text-xl font-bold">Admin Access Required</h2>
        <p class="text-sm opacity-70 max-w-md mx-auto">Your account does not have administrator privileges. Contact an existing admin to grant the <code class='px-1 py-0.5 rounded bg-black/5 dark:bg-white/10 text-xs'>admin</code> role.</p>
      </div>`;
    }

    let _usersFetchSeq = 0;
    async function fetchUsers() {
      const seq = ++_usersFetchSeq;
      $('#loadingState').classList.remove('hidden');
      $('#errorState').classList.add('hidden');
      try {
        await resolveApiBase();
        const prevSem = $('#semesterFilter')?.value || '';
        const prevBatch = $('#batchFilter')?.value || '';
        const prevDept = $('#deptFilter')?.value || '';
        const prevSort = $('#sortSelect')?.value || '';
        const token = await getAccessToken();
        if (!token) throw new Error('No auth token (px_token) found — please login');
        const q = ($('#searchInput')?.value || '').trim();
        const url = q ? `${API}/api/admin/users?q=${encodeURIComponent(q)}` : `${API}/api/admin/users`;
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.status === 401) { throw new Error('401 Unauthorized – token invalid or expired'); }
        if (res.status === 403) { showNotAdmin(); return; }
        if (!res.ok) { throw new Error('Request failed: ' + res.status); }
        const data = await res.json();
        if (seq !== _usersFetchSeq) return;
        state.raw = (data.users || data || []).map(row => ({ ...row, batch_range: row.batch_from && row.batch_to ? `${row.batch_from}-${row.batch_to}` : (row.batch_range || '') }));
        renderStats();
        buildFilters();
        if ($('#semesterFilter')) $('#semesterFilter').value = prevSem;
        if ($('#batchFilter')) $('#batchFilter').value = prevBatch;
        if ($('#deptFilter')) $('#deptFilter').value = prevDept;
        if ($('#sortSelect')) $('#sortSelect').value = prevSort;
        applyFilters();
      } catch (err) {
        const msg = err?.message || 'Error loading users';
        console.warn('[admin] fetch error', err);
        if (/Not an admin/i.test(msg)) { showNotAdmin(); return; }
        $('#errorState').textContent = msg;
        $('#errorState').classList.remove('hidden');
        if (/No auth token/i.test(msg)) {
          setTimeout(() => { location.href = 'login.html?next=' + encodeURIComponent(location.pathname); }, 1200);
        }
      } finally {
        $('#loadingState').classList.add('hidden');
        setView(state.view);
      }
    }

    let _searchFetchTimer = null;
    document.addEventListener('input', e => {
      if (e.target.matches('#searchInput')) {
        // Immediate client-side filter, plus real-time refresh (debounced).
        applyFilters();
        clearTimeout(_searchFetchTimer);
        _searchFetchTimer = setTimeout(() => { fetchUsers(); }, 250);
      }
    });
    document.addEventListener('change', e => { if (e.target.matches('#semesterFilter,#batchFilter,#deptFilter,#sortSelect')) applyFilters(); });
    document.addEventListener('click', e => { const btn = e.target.closest('.layout-toggle button'); if (btn) { setView(btn.dataset.view); } if (e.target.id === 'themeToggle') { const root = document.documentElement; const dark = root.classList.toggle('dark'); localStorage.setItem('px_theme', dark ? 'dark' : 'light'); e.target.textContent = dark ? 'light_mode' : 'dark_mode'; } });

    (async () => {
      await fetchUsers();
      // Load teacher applications after users so page becomes interactive sooner.
      try { await fetchTeacherApplications(); } catch (_) { /* ignore */ }
    })();

    // ---------- Teacher Applications Review Logic ----------
    const teacherState = { applications: [], status: 'pending' };
    const teacherAppsTbody = document.getElementById('teacherAppsTbody');
    const teacherAppsLoading = document.getElementById('teacherAppsLoading');
    const teacherAppsError = document.getElementById('teacherAppsError');
    const teacherAppsEmpty = document.getElementById('teacherAppsEmpty');
    const statusFilter = document.getElementById('teacherAppStatusFilter');

    let academicMeta = null;
    async function fetchAcademicMeta() {
      try {
        const res = await fetch(`${API}/api/public/academic-meta`);
        if (res.ok) { academicMeta = await res.json(); }
      } catch (_) { /* silent */ }
    }

    function mapCollege(id) {
      if (!id || !academicMeta) return id ? ('#' + id.slice(0, 8)) : '—';
      const c = (academicMeta.colleges || []).find(x => x.id === id);
      return c ? c.name : ('#' + id.slice(0, 8));
    }
    function mapDept(id) {
      if (!id || !academicMeta) return id ? ('#' + id.slice(0, 8)) : '—';
      const d = (academicMeta.departments || []).find(x => x.id === id);
      return d ? d.name : ('#' + id.slice(0, 8));
    }
    function resolveImgPath(p) {
      if (!p) return '';
      if (/^https?:/i.test(p)) return p;
      const clean = p.replace(/^\.\/?/, '');
      // ensure leading slash
      const rel = clean.startsWith('assets/') ? '/' + clean : (clean.startsWith('/') ? clean : '/' + clean);
      // if API base is different origin, prefix fully qualified URL for images so browser loads from backend port
      try {
        if (API && !rel.startsWith('http')) {
          const apiUrl = new URL(API);
          // only prefix if current origin differs
          if (location.origin !== apiUrl.origin) { return apiUrl.origin + rel; }
        }
      } catch (_) { }
      return rel;
    }

    async function fetchTeacherApplications() {
      teacherAppsLoading.classList.remove('hidden');
      teacherAppsError.classList.add('hidden');
      teacherAppsEmpty.classList.add('hidden');
      teacherAppsTbody.innerHTML = '';
      try {
        const token = await getAccessToken();
        if (!token) throw new Error('Missing auth token');
        const q = statusFilter.value ? `?status=${encodeURIComponent(statusFilter.value)}` : '';
        const res = await fetch(`${API}/api/teacher/applications${q}`, { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.status === 403) { /* not admin handled already above */ return; }
        if (!res.ok) throw new Error('Failed to load: ' + res.status);
        const data = await res.json();
        teacherState.applications = (data.applications || []);
        if (academicMeta === null) { await fetchAcademicMeta(); }
        renderTeacherApplications();
      } catch (err) {
        teacherAppsError.textContent = err.message || 'Error loading applications';
        teacherAppsError.classList.remove('hidden');
      } finally {
        teacherAppsLoading.classList.add('hidden');
      }
    }

    function teacherAppRow(app) {
      const front = resolveImgPath(app.id_card_front_path || '');
      const back = resolveImgPath(app.id_card_back_path || '');
      const created = fmtDate(app.created_at);
      const statusColors = { pending: 'bg-amber-500/80', approved: 'bg-green-600/85', rejected: 'bg-red-600/85' };
      const pillColor = statusColors[app.status] || 'bg-neutral-500/70';
      const subjects = (Array.isArray(app.subjects) ? app.subjects : []).join(', ');
      const collegeName = mapCollege(app.college_id);
      const deptName = mapDept(app.department_id);
      return `<tr>
        <td class="py-3 pr-3 align-top">
          <div class="font-semibold leading-tight">${app.name || '(no name)'}</div>
          <div class="text-[11px] opacity-70 break-all">${app.email || ''}</div>
        </td>
        <td class="py-3 pr-3 text-[11px] align-top">
          <div><span class="font-medium">College:</span> ${collegeName || '—'}</div>
          <div><span class="font-medium">Dept:</span> ${deptName || '—'}</div>
        </td>
        <td class="py-3 pr-3 text-[11px] align-top">${subjects || '<span class="opacity-60">None</span>'}</td>
        <td class="py-3 pr-3 text-[11px] align-top">
          <div class="flex gap-2">
            ${front ? `<img src="${front}" alt="Front ID" class="h-16 w-20 object-cover rounded-md cursor-pointer ring-1 ring-black/10 dark:ring-white/10" data-full="${front}" data-img-preview/>` : '<div class="h-16 w-20 rounded-md bg-neutral-200/60 dark:bg-white/5 flex items-center justify-center text-[10px] opacity-50">No front</div>'}
            ${back ? `<img src="${back}" alt="Back ID" class="h-16 w-20 object-cover rounded-md cursor-pointer ring-1 ring-black/10 dark:ring-white/10" data-full="${back}" data-img-preview/>` : '<div class="h-16 w-20 rounded-md bg-neutral-200/60 dark:bg-white/5 flex items-center justify-center text-[10px] opacity-50">No back</div>'}
          </div>
        </td>
        <td class="py-3 pr-3 text-[11px] align-top">${created || ''}</td>
        <td class="py-3 pr-3 text-[11px] align-top"><span class="status-pill ${pillColor} text-white">${app.status}</span></td>
        <td class="py-3 pr-3 align-top w-[180px]">
          <textarea data-notes placeholder="Notes" class="w-full rounded-md bg-white/70 dark:bg-white/10 border border-black/10 dark:border-white/10 px-2 py-1 text-[11px] focus:outline-none focus:ring-2 focus:ring-brand-500/40 resize-none h-16"></textarea>
        </td>
        <td class="py-3 pr-3 align-top text-[11px]">
          <div class="flex flex-col gap-2">
            <button data-approve class="inline-flex items-center justify-center gap-1 px-2 py-1 rounded-md bg-green-600/80 hover:bg-green-600 text-white font-medium disabled:opacity-50"><span class="material-symbols-rounded text-[16px]">check_circle</span></button>
            <button data-reject class="inline-flex items-center justify-center gap-1 px-2 py-1 rounded-md bg-red-600/80 hover:bg-red-600 text-white font-medium disabled:opacity-50"><span class="material-symbols-rounded text-[16px]">cancel</span></button>
          </div>
        </td>
      </tr>`;
    }

    function renderTeacherApplications() {
      teacherAppsTbody.innerHTML = '';
      const list = teacherState.applications;
      if (!list.length) { teacherAppsEmpty.classList.remove('hidden'); return; }
      teacherAppsEmpty.classList.add('hidden');
      list.forEach(app => {
        const wrapper = document.createElement('tbody');
        wrapper.innerHTML = teacherAppRow(app);
        const row = wrapper.firstElementChild;
        attachTeacherAppHandlers(row, app);
        teacherAppsTbody.appendChild(row);
      });
    }

    async function reviewApplication(app, status, notes) {
      const token = await getAccessToken();
      if (!token) throw new Error('Missing token');
      const res = await fetch(`${API}/api/teacher/applications/${encodeURIComponent(app.id)}/review`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify({ status, notes: notes || '' })
      });
      if (!res.ok) throw new Error(`Review failed: ${res.status}`);
      const payload = await res.json();
      // Debug group for teacher profile sync diagnostics
      console.groupCollapsed('%cTeacher Approval', 'color:#16a34a;font-weight:bold');
      console.log('Application ID:', app.id);
      console.log('User ID:', app.auth_user_id);
      console.log('Requested status:', status);
      console.log('Review response:', payload);
      if (payload && payload.status === 'approved' && app.auth_user_id) {
        try {
          const raw = await fetch(`${API}/api/admin/teacher-profiles/${encodeURIComponent(app.auth_user_id)}`, { headers: { 'Authorization': 'Bearer ' + token } });
          const rawJson = await raw.json();
          console.log('Raw teacher_profiles row:', rawJson);
          if (!rawJson.row) {
            console.warn('teacher_profiles row missing. If profile_sync=error check migrations.');
          }
        } catch (e) {
          console.error('Error fetching raw teacher profile row', e);
        }
      }
      console.groupEnd();
      return payload;
    }

    function attachTeacherAppHandlers(card, app) {
      const approveBtn = card.querySelector('[data-approve]');
      const rejectBtn = card.querySelector('[data-reject]');
      const notesEl = card.querySelector('[data-notes]');
      const imgEls = card.querySelectorAll('[data-img-preview]');
      imgEls.forEach(img => img.addEventListener('click', () => openImageModal(img.getAttribute('data-full'), img.alt)));
      function setLoading(disabled) { [approveBtn, rejectBtn, notesEl].forEach(el => el && (el.disabled = disabled)); }
      if (approveBtn) { approveBtn.addEventListener('click', async () => { if (!confirm('Approve this application?')) return; try { setLoading(true); await reviewApplication(app, 'approved', notesEl.value); await fetchTeacherApplications(); } catch (err) { alert(err.message || 'Approve error'); } finally { setLoading(false); } }); }
      if (rejectBtn) { rejectBtn.addEventListener('click', async () => { const reason = notesEl.value || prompt('Optional rejection notes:', ''); if (!confirm('Reject this application?')) return; try { setLoading(true); await reviewApplication(app, 'rejected', reason); await fetchTeacherApplications(); } catch (err) { alert(err.message || 'Reject error'); } finally { setLoading(false); } }); }
    }

    // Simple image modal
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 hidden items-center justify-center z-50';
    modal.innerHTML = `<div class="absolute inset-0 bg-black/70 backdrop-blur-sm modal-overlay" data-close></div>
      <div class="relative max-w-lg w-[90%] rounded-2xl overflow-hidden ring-1 ring-white/10 shadow-neon glass-panel">
        <button class="absolute top-2 right-2 h-9 w-9 flex items-center justify-center rounded-full bg-black/40 text-white hover:bg-black/60 material-symbols-rounded" data-close title="Close">close</button>
        <img class="max-h-[70vh] w-full object-contain bg-black/30" data-modal-img alt="Preview"/>
        <div class="p-3 text-[12px] opacity-80" data-caption></div>
      </div>`;
    document.body.appendChild(modal);
    function openImageModal(src, caption) {
      const img = modal.querySelector('[data-modal-img]');
      const cap = modal.querySelector('[data-caption]');
      if (img) img.src = src;
      if (cap) cap.textContent = caption || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeImageModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    modal.addEventListener('click', e => {
      if (e.target === modal || e.target.hasAttribute('data-close')) { closeImageModal(); }
    });
    window.openImageModal = openImageModal;

    document.getElementById('refreshTeacherApps').addEventListener('click', fetchTeacherApplications);
    statusFilter.addEventListener('change', fetchTeacherApplications);
    // Initial load
    fetchTeacherApplications();
  </script>
</body>

</html>