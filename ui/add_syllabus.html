<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Syllabus — Pa[p]er X</title>
  <meta name="description" content="Create a course with units and topics for your batch & semester." />
  <script>
    (function () { try { var k = ['cx-theme', 'theme', 'px-theme']; var m = null; for (var i = 0; i < k.length; i++) { var v = localStorage.getItem(k[i]); if (v === 'dark' || v === 'light') { m = v; break; } } if (!m && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { m = 'dark'; } if (m) { document.documentElement.classList.toggle('dark', m === 'dark'); } } catch (e) { } })();
  </script>
  <link rel="stylesheet" href="assets/css/tailwind.css" />
  <script src="./config.js"></script>
  <script>
    // Hide auth buttons globally if present and token exists (defensive)
    (function () {
      const t = localStorage.getItem('px_token');
      if (!t) return;
      document.querySelectorAll('a[href="login.html"], a[href="signup.html"]').forEach(a => a.classList.add('hidden'));
    })();

    tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { display: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] }, colors: { brand: { 50: '#f0f7ff', 100: '#e0efff', 200: '#b9dbff', 300: '#8ac4ff', 400: '#59a9ff', 500: '#2b8cff', 600: '#116fe6', 700: '#0a57b4', 800: '#0b4890', 900: '#0d3a73' }, night: { 900: '#0a0c10', 800: '#0f131a', 700: '#141a22', 600: '#1a2230' } }, boxShadow: { glow: '0 0 0 1px rgba(59,130,246,.2), 0 8px 40px rgba(59,130,246,.15)', neon: '0 0 25px rgba(43,140,255,.35), 0 0 60px rgba(43,140,255,.25)' }, backgroundImage: { 'grid-radial': 'radial-gradient(circle at 20% 10%, rgba(43,140,255,.25), transparent 35%), radial-gradient(circle at 80% 20%, rgba(168,85,247,.2), transparent 35%), radial-gradient(circle at 50% 80%, rgba(16,185,129,.2), transparent 35%)' } } } }
  </script>
  <style>
    .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .12)
    }

    .glass-dark {
      background: rgba(20, 24, 32, .55);
      border-color: rgba(255, 255, 255, .08)
    }
  </style>
</head>

<body
  class="font-display bg-white text-slate-900 dark:bg-night-900 dark:text-slate-200 selection:bg-brand-200 selection:text-slate-900">
  <div aria-hidden="true" class="fixed inset-0 -z-10 bg-grid-radial opacity-70 dark:opacity-50"></div>
  <header
    class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-night-900/50 border-b border-black/5 dark:border-white/5">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <a href="index.html" class="flex items-center gap-3 group">
          <div
            class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-400 via-brand-500 to-indigo-500 shadow-neon grid place-items-center text-white font-bold tracking-tight">
            PX</div>
          <div>
            <p class="text-lg font-semibold leading-tight group-hover:text-brand-600">Pa[p]er X</p>
            <p class="text-xs text-slate-500 dark:text-slate-400 -mt-1">Agentic AI for Indian syllabi</p>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <a href="profile.html"
            class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">Profile</a>
          <button id="logoutBtn" title="Sign out" aria-label="Sign out"
            class="inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 12H3" />
              <path d="M15 12l-4-4" />
              <path d="M15 12l-4 4" />
              <path d="M21 7v10a2 2 0 0 1-2 2h-6" />
            </svg>
            <span>Sign Out</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="relative">
    <section class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 pt-10 pb-20">
      <div
        class="rounded-2xl glass glass-dark p-6 md:p-8 shadow-neon border border-white/10 bg-white/80 dark:bg-night-800/70">
        <div class="flex items-center justify-between">
          <div>
            <div
              class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/60 dark:bg-night-800/60 px-3 py-1 text-xs text-slate-700 dark:text-slate-300 backdrop-blur">
              <span class="h-2 w-2 rounded-full bg-brand-400"></span>
              Add syllabus
            </div>
            <h1 class="mt-3 text-2xl font-bold">Create Course • Units & Topics</h1>
            <p class="text-sm text-slate-600 dark:text-slate-300">Batch and semester default from your profile.</p>
          </div>
          <a href="profile.html"
            class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Back
            to Profile</a>
        </div>

        <!-- Context from profile -->
        <div id="ctx" class="mt-6 grid md:grid-cols-3 gap-3 text-sm">
          <div class="rounded-lg border border-slate-200/60 dark:border-white/10 p-3"><span
              class="text-slate-500">College:</span> <span id="ctxCollege">—</span></div>
          <div class="rounded-lg border border-slate-200/60 dark:border-white/10 p-3"><span
              class="text-slate-500">Department:</span> <span id="ctxDepartment">—</span></div>
          <div class="rounded-lg border border-slate-200/60 dark:border-white/10 p-3"><span
              class="text-slate-500">Batch:</span> <span id="ctxBatch">—</span></div>
        </div>

        <!-- Form -->
        <form id="courseForm" class="mt-6 grid gap-6" novalidate>
          <div class="grid md:grid-cols-3 gap-4">
            <label class="grid gap-1">
              <span class="text-sm">Course code</span>
              <input required name="course_code" placeholder="e.g., CS201"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
            <label class="grid gap-1 md:col-span-2">
              <span class="text-sm">Course title</span>
              <input required name="title" placeholder="e.g., Data Structures"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            <label class="grid gap-1">
              <span class="text-sm">Semester</span>
              <select name="semester" id="semester"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2">
                <option value="">Use profile</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
              </select>
            </label>
            <div class="md:col-span-2 grid items-end">
              <span class="text-xs text-slate-500">Batch is fixed to your profile's batch.</span>
            </div>
          </div>

          <!-- Units Builder -->
          <div class="grid gap-3">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">Units</h2>
              <div class="flex gap-2">
                <button type="button" id="addUnitBtn"
                  class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Add
                  Unit</button>
                <button type="button" id="expandAllBtn"
                  class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Expand
                  all</button>
              </div>
            </div>
            <div id="unitsWrap" class="grid gap-4"></div>
          </div>

          <div class="flex items-center justify-between">
            <div id="status"
              class="hidden rounded-lg bg-white/70 dark:bg-night-800/70 border border-slate-200/60 dark:border-white/10 p-3 font-mono text-[12px] text-slate-700 dark:text-slate-300">
            </div>
            <div class="flex gap-2">
              <a href="profile.html"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 px-4 py-2 text-sm hover:border-brand-400/60">Cancel</a>
              <button type="submit" id="submitBtn"
                class="rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 px-5 py-2.5 text-white shadow-neon">Save
                Course</button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </main>

  <template id="unitTpl">
    <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-night-800/70">
      <div class="px-4 py-3 border-b border-slate-200/60 dark:border-white/10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span
            class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-brand-500/10 text-brand-600 text-xs font-semibold"
            data-unit-index>1</span>
          <input placeholder="Unit title (e.g., Arrays & Linked Lists)"
            class="unit-title w-full rounded-md border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-1.5 text-sm" />
        </div>
        <div class="flex items-center gap-2">
          <button type="button"
            class="toggle-btn rounded-md border border-slate-200/60 dark:border-white/10 px-2 py-1 text-xs">Collapse</button>
          <button type="button"
            class="remove-unit rounded-md border border-rose-200/60 dark:border-rose-900/40 px-2 py-1 text-xs hover:border-rose-400/60">Remove</button>
        </div>
      </div>
      <div class="p-4 grid gap-3" data-body>
        <div class="grid gap-2" data-topics></div>
        <button type="button"
          class="add-topic rounded-md border border-slate-200/60 dark:border-white/10 px-2 py-1 text-xs hover:border-brand-400/60 w-max">Add
          Topic</button>
      </div>
    </div>
  </template>

  <template id="topicTpl">
    <div class="flex items-center gap-2">
      <input placeholder="Topic (e.g., Singly Linked List)"
        class="topic-input w-full rounded-md border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-1.5 text-sm" />
      <button type="button"
        class="remove-topic rounded-md border border-rose-200/60 dark:border-rose-900/40 px-2 py-1 text-xs hover:border-rose-400/60">Remove</button>
    </div>
  </template>

  <script>
    const apiBase = (window.API_BASE || 'https://paperxapp.onrender.com').replace(/\/$/, '');
    const unitsWrap = document.getElementById('unitsWrap');
    const unitTpl = document.getElementById('unitTpl');
    const topicTpl = document.getElementById('topicTpl');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const addUnitBtn = document.getElementById('addUnitBtn');
    const expandAllBtn = document.getElementById('expandAllBtn');

    let ctx = { batch_id: null, semester: null, college: null, department: null, batchLabel: null };

    function token() { try { return localStorage.getItem('px_token'); } catch { return null; } }

    function setCtxUI() {
      document.getElementById('ctxCollege').textContent = ctx.college || '—';
      document.getElementById('ctxDepartment').textContent = ctx.department || '—';
      document.getElementById('ctxBatch').textContent = ctx.batchLabel || '—';
      // default semester selector
      if (ctx.semester) {
        const sel = document.getElementById('semester');
        if (sel && !sel.value) sel.value = String(ctx.semester);
      }
    }

    async function ensureProfile() {
      const t = token();
      if (!t) { window.location.href = 'login.html'; return; }
      try {
        const res = await fetch(`${apiBase}/api/me`, { headers: { 'Authorization': `Bearer ${t}` } });
        if (!res.ok) { window.location.href = 'login.html'; return; }
        const data = await res.json();
        const p = data?.profile || {};
        // Prefer education entries for academic context
        const edu = Array.isArray(p.education_entries) ? p.education_entries.slice() : [];
        let primaryEdu = null;
        if (edu.length) {
          // choose highest current_semester, else first
          edu.sort((a, b) => ((b?.current_semester || 0) - (a?.current_semester || 0)) || ((a?.order_index || 0) - (b?.order_index || 0)));
          primaryEdu = edu[0];
        }
        if (primaryEdu) {
          ctx.batch_id = primaryEdu.batch_id || null;
          ctx.semester = primaryEdu.current_semester || p.semester || null;
          ctx.college = (primaryEdu.college && primaryEdu.college.name) || p.college?.name || primaryEdu.school || null;
          ctx.department = (primaryEdu.department && primaryEdu.department.name) || p.department?.name || primaryEdu.department || null;
          if (primaryEdu.batch_id && primaryEdu.batch) {
            ctx.batchLabel = `${primaryEdu.batch.from}–${primaryEdu.batch.to}`;
          } else if (primaryEdu.batch_range) {
            ctx.batchLabel = primaryEdu.batch_range;
          } else if (p.batch) {
            ctx.batchLabel = `${p.batch.from}–${p.batch.to}`;
          }
        } else {
          // fallback to profile fields
          ctx.batch_id = p.batch?.id || null;
          ctx.semester = p.semester || null;
          ctx.college = p.college?.name || null;
          ctx.department = p.department?.name || null;
          ctx.batchLabel = p.batch ? `${p.batch.from}–${p.batch.to}` : null;
        }
        if (!ctx.batch_id) {
          alert('No batch detected from your education entries or profile. Please add education in profile_edit first.');
          window.location.href = 'profile_edit.html';
          return;
        }
        setCtxUI();
      } catch (e) {
        window.location.href = 'login.html';
      }
    }

    function renumberUnits() {
      [...unitsWrap.querySelectorAll('[data-unit-index]')].forEach((el, idx) => el.textContent = (idx + 1));
    }

    function addTopic(topicsWrap, topicValue = '') {
      const n = topicTpl.content.cloneNode(true);
      const input = n.querySelector('.topic-input');
      input.value = topicValue;
      n.querySelector('.remove-topic').addEventListener('click', () => {
        input.parentElement.remove();
      });
      topicsWrap.appendChild(n);
    }

    function addUnit(unitTitle = '') {
      const n = unitTpl.content.cloneNode(true);
      const unitNode = n.querySelector('div.rounded-xl');
      const body = n.querySelector('[data-body]');
      const toggleBtn = n.querySelector('.toggle-btn');
      const removeBtn = n.querySelector('.remove-unit');
      const titleInput = n.querySelector('.unit-title');
      const topicsWrap = n.querySelector('[data-topics]');
      const addTopicBtn = n.querySelector('.add-topic');
      titleInput.value = unitTitle;
      addTopic(topicsWrap, '');
      toggleBtn.addEventListener('click', () => {
        const hidden = body.classList.toggle('hidden');
        toggleBtn.textContent = hidden ? 'Expand' : 'Collapse';
      });
      removeBtn.addEventListener('click', () => { unitNode.remove(); renumberUnits(); });
      addTopicBtn.addEventListener('click', () => addTopic(topicsWrap, ''));
      unitsWrap.appendChild(n);
      renumberUnits();
    }

    function expandAll(expand = true) {
      unitsWrap.querySelectorAll('[data-body]').forEach(b => { b.classList.toggle('hidden', !expand); });
      unitsWrap.querySelectorAll('.toggle-btn').forEach(btn => { btn.textContent = expand ? 'Collapse' : 'Expand'; });
    }

    addUnitBtn.addEventListener('click', () => addUnit(''));
    expandAllBtn.addEventListener('click', () => {
      const anyCollapsed = [...unitsWrap.querySelectorAll('[data-body]')].some(b => b.classList.contains('hidden'));
      expandAll(anyCollapsed);
    });

    document.getElementById('logoutBtn').addEventListener('click', () => { try { localStorage.removeItem('px_token'); } catch { } window.location.href = 'login.html'; });

    // Initial unit
    addUnit('Unit 1');

    // Submit
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      status.classList.remove('hidden'); status.textContent = '';
      const fd = new FormData(e.currentTarget);
      const course_code = String(fd.get('course_code') || '').trim();
      const title = String(fd.get('title') || '').trim();
      const semSel = document.getElementById('semester');
      const semester = Number(semSel.value || ctx.semester || 0);
      if (!course_code || !title) { status.textContent = '⚠️ Course code and title are required.'; return; }
      if (!ctx.batch_id) { status.textContent = '⚠️ No batch found in profile.'; return; }
      if (!semester || semester < 1 || semester > 12) { status.textContent = '⚠️ Choose a valid semester (1-12) or set it in profile.'; return; }

      const units = [];
      unitsWrap.querySelectorAll('.unit-title').forEach((ut, idx) => {
        const titleVal = String(ut.value || '').trim();
        const topicsWrap = ut.closest('div.rounded-xl').querySelector('[data-topics]');
        const topics = [...topicsWrap.querySelectorAll('.topic-input')].map(inp => String(inp.value || '').trim()).filter(Boolean).map(t => ({ topic: t }));
        if (titleVal) units.push({ unit_title: titleVal, topics });
      });
      if (!units.length) { status.textContent = '⚠️ Add at least one unit with a title.'; return; }

      const payload = { batch_id: ctx.batch_id, semester, course_code, title, units };

      submitBtn.disabled = true; submitBtn.textContent = 'Saving…';
      try {
        const res = await fetch(`${apiBase}/api/syllabus/courses`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) { status.textContent = `❌ ${out?.detail || 'Failed to save course.'}`; return; }
        status.textContent = '✔ Saved. Redirecting…';
        setTimeout(() => { window.location.href = 'profile.html'; }, 600);
      } catch (err) {
        status.textContent = '❌ Network error. Please try again.';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Save Course';
      }
    });

    ensureProfile();
  </script>
</body>

</html>