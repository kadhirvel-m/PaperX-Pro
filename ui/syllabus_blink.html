<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Syllabus Blink - Paper X</title>
    <link rel="icon" type="image/svg+xml" href="assets/img/favicon.svg" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script defer src="assets/js/analytics-tracker.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />

    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }
    </style>
    <script>
        (function () {
            try {
                const s = localStorage.getItem('px_theme');
                const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const useDark = s ? s === 'dark' : prefers;
                if (useDark) document.documentElement.classList.add('dark');
            } catch (_) { }
        })();
    </script>
    <script src="config.js"></script>
</head>

<body class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark">
    <main class="min-h-screen flex flex-col">

        <section class="flex-1 relative py-4 md:py-2">
            <div class="container max-w-5xl">
                <div id="status" class="mb-4 text-sm text-neutral-600 dark:text-white/70"></div>

                <div id="viewerShell"
                    class="relative rounded-3xl bg-white/80 dark:bg-brand-900/70 ring-1 ring-black/5 dark:ring-white/10 shadow-card overflow-hidden flex flex-col">
                    <div
                        class="absolute inset-x-10 -top-24 h-64 bg-[radial-gradient(circle_at_top,_rgba(158,75,138,0.4),_transparent_60%)] pointer-events-none opacity-60">
                    </div>

                    <div class="relative p-4 md:p-6 flex flex-col gap-4">
                        <header class="flex items-center justify-between gap-4">
                            <div>
                                <p id="unitLabel" class="text-xs font-medium text-brand-700 dark:text-brandlt-200 mb-1">
                                    Unit</p>
                                <h2 id="unitTitle" class="text-lg md:text-xl font-semibold line-clamp-2">-</h2>
                                <p id="courseTitle" class="text-xs text-neutral-500 dark:text-white/60 mt-1">-</p>
                            </div>
                            <div class="flex flex-col items-end gap-2 text-xs">
                                <span id="counterBadge"
                                    class="inline-flex items-center gap-1 rounded-full px-3 py-1 bg-brand-500/10 text-brand-700 dark:text-brandlt-200">
                                    <span class="material-symbols-rounded text-sm">photo_library</span>
                                    <span id="counterText">0 / 0</span>
                                </span>
                                <span id="topicTitle"
                                    class="text-[11px] text-neutral-600 dark:text-white/65 max-w-xs text-right truncate">-</span>
                            </div>
                        </header>

                        <div class="relative mt-2 md:mt-4 flex items-center justify-center">
                            <div
                                class="w-full rounded-2xl bg-black/5 dark:bg-black/40 overflow-hidden flex items-center justify-center">
                                <img id="topicImage" alt="Topic visual"
                                    class="w-full h-auto max-h-[70vh] object-contain transition duration-300 opacity-0" />
                                <div id="noImageFallback"
                                    class="text-xs text-neutral-500 dark:text-white/60 text-center px-6 hidden">
                                    No image URL found for this topic. Use the syllabus page to attach one.
                                </div>
                            </div>
                        </div>

                        <footer class="mt-3 flex items-center justify-between gap-4">
                            <div class="flex items-center gap-2 text-[11px] text-neutral-500 dark:text-white/65">
                                <span class="size-1.5 rounded-full bg-emerald-400"></span>
                                <span>Use left / right arrow keys to navigate quickly.</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <button id="prevBtn" type="button"
                                    class="inline-flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium bg-black/5 dark:bg-white/5 text-neutral-800 dark:text-white/80 hover:bg-black/10 dark:hover:bg-white/10 disabled:opacity-40 disabled:cursor-not-allowed">
                                    <span class="material-symbols-rounded text-sm">chevron_left</span>
                                    Prev
                                </button>
                                <button id="nextBtn" type="button"
                                    class="inline-flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium bg-gradient-to-r from-brand-500 to-brand-700 text-white shadow-glow hover:shadow-ringed disabled:opacity-40 disabled:cursor-not-allowed">
                                    Next
                                    <span class="material-symbols-rounded text-sm">chevron_right</span>
                                </button>
                            </div>
                        </footer>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_BASE = (window.API_BASE || 'https://paperxapp.onrender.com').replace(/\/$/, '');
        const $ = (id) => document.getElementById(id);
        function getToken() {
            const keys = ['px_token', 'teacherToken', 'userToken', 'sb-access-token', 'supabase.auth.token'];
            for (const key of keys) {
                try {
                    const val = localStorage.getItem(key);
                    if (val) return val;
                } catch { }
            }
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const name = localStorage.key(i);
                    if (/token/i.test(name || '')) {
                        const val = localStorage.getItem(name);
                        if (val && val.length > 10) return val;
                    }
                }
            } catch { }
            return null;
        }
        function authHeaders() { const t = getToken(); return t ? { Authorization: `Bearer ${t}` } : {}; }

        async function fetchJson(url, opts = {}) {
            try {
                const r = await fetch(url, opts);
                const data = await (r.ok ? r.json() : null);
                return { ok: r.ok, status: r.status, data };
            } catch (e) { return { ok: false, error: true }; }
        }

        function readQuery() {
            const p = new URLSearchParams(window.location.search);
            return {
                unitId: p.get('unit_id'),
                courseTitle: p.get('course_title') || '',
                unitTitle: p.get('unit_title') || ''
            };
        }

        let topics = [];
        let cursor = 0;

        function applyMeta(meta) {
            const title = (meta.courseTitle || '') + (meta.unitTitle ? ` • ${meta.unitTitle}` : '');
            if (title) document.title = `Blink – ${title} | Paper X`;
            if ($('pageTitle')) $('pageTitle').textContent = meta.unitTitle || 'Unit';
            if ($('unitLabel')) $('unitLabel').textContent = meta.unitTitle ? 'Unit' : '';
            if ($('unitTitle')) $('unitTitle').textContent = meta.unitTitle || 'Unit';
            if ($('courseTitle')) $('courseTitle').textContent = meta.courseTitle || '';
        }

        function renderState() {
            const total = topics.length;
            if (!total) {
                if ($('status')) $('status').textContent = 'No topics with images were found for this unit yet.';
                if ($('viewerShell')) $('viewerShell').classList.add('opacity-60');
                $('prevBtn').disabled = true;
                $('nextBtn').disabled = true;
                $('counterText').textContent = '0 / 0';
                $('topicTitle').textContent = '-';
                $('topicImage').classList.add('opacity-0');
                $('noImageFallback').classList.remove('hidden');
                return;
            }
            if (cursor < 0) cursor = 0;
            if (cursor >= total) cursor = total - 1;
            const item = topics[cursor];
            $('counterText').textContent = `${cursor + 1} / ${total}`;
            $('topicTitle').textContent = item.topic || '-';
            const img = $('topicImage');
            const fallback = $('noImageFallback');
            if (item.image_url) {
                img.src = item.image_url;
                img.onload = () => img.classList.add('opacity-100');
                img.onerror = () => { img.classList.add('opacity-0'); fallback.classList.remove('hidden'); };
                img.classList.remove('opacity-0');
                fallback.classList.add('hidden');
            } else {
                img.src = '';
                img.classList.add('opacity-0');
                fallback.classList.remove('hidden');
            }
            $('prevBtn').disabled = cursor === 0;
            $('nextBtn').disabled = cursor === total - 1;

            // Track Blink View
            if (window.Analytics) {
                window.Analytics.track('note_viewed', {
                    variant: 'cheatsheet',
                    topic: item.topic,
                    unit_id: readQuery().unitId
                });
            }
        }

        async function loadTopicsForUnit(unitId) {
            if (!unitId) {
                if ($('status')) $('status').textContent = 'Missing unit id.';
                return;
            }
            if (!getToken()) {
                if ($('status')) $('status').textContent = 'Please log in to view this content.';
                return;
            }
            const res = await fetchJson(`${API_BASE}/api/syllabus/units/${encodeURIComponent(unitId)}/topics`, { headers: authHeaders() });
            if (!res || !res.ok) {
                if ($('status')) $('status').textContent = 'Could not load topics for this unit. Please try again later.';
                return;
            }
            const rawTopics = Array.isArray(res.data) ? res.data : [];
            topics = rawTopics.filter(t => (t.image_url || '').trim() !== '');
            cursor = 0;
            renderState();
        }

        function bindControls() {
            $('prevBtn').addEventListener('click', () => {
                if (cursor > 0) { cursor -= 1; renderState(); }
            });
            $('nextBtn').addEventListener('click', () => {
                if (cursor < topics.length - 1) { cursor += 1; renderState(); }
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    if (cursor > 0) { cursor -= 1; renderState(); }
                }
                if (e.key === 'ArrowRight') {
                    if (cursor < topics.length - 1) { cursor += 1; renderState(); }
                }
            });
        }

        (function init() {
            const meta = readQuery();
            applyMeta(meta);
            bindControls();
            loadTopicsForUnit(meta.unitId);
        })();
    </script>
</body>

</html>