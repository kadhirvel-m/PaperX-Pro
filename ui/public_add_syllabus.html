<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Syllabus (Public) — Pa[p]er X</title>
  <meta name="description"
    content="Public page to add a syllabus course with units and topics by selecting college, department, batch, and semester." />
  <script>
    (function () { try { var k = ['cx-theme', 'theme', 'px-theme']; var m = null; for (var i = 0; i < k.length; i++) { var v = localStorage.getItem(k[i]); if (v === 'dark' || v === 'light') { m = v; break; } } if (!m && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) { m = 'dark'; } if (m) { document.documentElement.classList.toggle('dark', m === 'dark'); } } catch (e) { } })();
  </script>
  <link rel="stylesheet" href="assets/css/tailwind.css" />
  <script src="./config.js"></script>
  <script>
    tailwind.config = { darkMode: 'class', theme: { extend: { fontFamily: { display: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] }, colors: { brand: { 50: '#f0f7ff', 100: '#e0efff', 200: '#b9dbff', 300: '#8ac4ff', 400: '#59a9ff', 500: '#2b8cff', 600: '#116fe6', 700: '#0a57b4', 800: '#0b4890', 900: '#0d3a73' }, night: { 900: '#0a0c10', 800: '#0f131a', 700: '#141a22', 600: '#1a2230' } }, boxShadow: { glow: '0 0 0 1px rgba(59,130,246,.2), 0 8px 40px rgba(59,130,246,.15)', neon: '0 0 25px rgba(43,140,255,.35), 0 0 60px rgba(43,140,255,.25)' }, backgroundImage: { 'grid-radial': 'radial-gradient(circle at 20% 10%, rgba(43,140,255,.25), transparent 35%), radial-gradient(circle at 80% 20%, rgba(168,85,247,.2), transparent 35%), radial-gradient(circle at 50% 80%, rgba(16,185,129,.2), transparent 35%)' } } } }
  </script>
  <style>
    .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .12)
    }

    .glass-dark {
      background: rgba(20, 24, 32, .55);
      border-color: rgba(255, 255, 255, .08)
    }
  </style>
</head>

<body
  class="font-display bg-white text-slate-900 dark:bg-night-900 dark:text-slate-200 selection:bg-brand-200 selection:text-slate-900">
  <div aria-hidden="true" class="fixed inset-0 -z-10 bg-grid-radial opacity-70 dark:opacity-50"></div>
  <header
    class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:supports-[backdrop-filter]:bg-night-900/50 border-b border-black/5 dark:border-white/5">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <a href="index.html" class="flex items-center gap-3 group">
          <div
            class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-400 via-brand-500 to-indigo-500 shadow-neon grid place-items-center text-white font-bold tracking-tight">
            PX</div>
          <div>
            <p class="text-lg font-semibold leading-tight group-hover:text-brand-600">Pa[p]er X</p>
            <p class="text-xs text-slate-500 dark:text-slate-400 -mt-1">Agentic AI for Indian syllabi</p>
          </div>
        </a>
        <div class="flex items-center gap-3">
          <a id="navProfile" href="profile.html" title="Profile"
            class="hidden items-center justify-center w-9 h-9 rounded-full overflow-hidden border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/60">
            <img id="navProfileImg" alt="Profile" class="w-full h-full object-cover hidden" />
            <span id="navProfileInitial" class="text-xs font-semibold">Me</span>
          </a>
          <button id="navSignOut" title="Sign out" aria-label="Sign out"
            class="hidden inline-flex items-center gap-2 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 12H3" />
              <path d="M15 12l-4-4" />
              <path d="M15 12l-4 4" />
              <path d="M21 7v10a2 2 0 0 1-2 2h-6" />
            </svg>
            <span>Sign Out</span>
          </button>
          <a href="login.html"
            class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">Sign
            in</a>
          <a href="signup.html"
            class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 hover:border-brand-400/60 text-sm">Sign
            up</a>
        </div>
      </div>
    </div>
  </header>

  <main class="relative">
    <section class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 pt-10 pb-20">
      <div
        class="rounded-2xl glass glass-dark p-6 md:p-8 shadow-neon border border-white/10 bg-white/80 dark:bg-night-800/70">
        <div class="flex items-center justify-between">
          <div>
            <div
              class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/60 dark:bg-night-800/60 px-3 py-1 text-xs text-slate-700 dark:text-slate-300 backdrop-blur">
              <span class="h-2 w-2 rounded-full bg-brand-400"></span>
              Public syllabus entry
            </div>
            <h1 class="mt-3 text-2xl font-bold">Create Course • Units & Topics</h1>
            <p class="text-sm text-slate-600 dark:text-slate-300">No login required. Select college → department → batch
              → semester, then add units and topics.</p>
          </div>
          <a href="index.html"
            class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Back
            to Home</a>
        </div>

        <!-- Selectors -->
        <form id="courseForm" class="mt-6 grid gap-6" novalidate>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="grid gap-1">
              <span class="text-sm">College</span>
              <select id="college" required
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"></select>
            </label>
            <label class="grid gap-1">
              <span class="text-sm">Department</span>
              <select id="department" required
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"
                disabled></select>
            </label>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <label class="grid gap-1">
              <span class="text-sm">Use existing batch (optional)</span>
              <select id="existingBatch"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2"
                disabled>
                <option value="">— Select after department —</option>
              </select>
            </label>
            <label class="grid gap-1">
              <span class="text-sm">From year</span>
              <input id="fromYear" type="number" min="1950" max="2100" placeholder="e.g., 2021"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
            <label class="grid gap-1">
              <span class="text-sm">To year</span>
              <input id="toYear" type="number" min="1950" max="2100" placeholder="e.g., 2025"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
          </div>

          <div class="grid md:grid-cols-3 gap-4">
            <label class="grid gap-1">
              <span class="text-sm">Semester</span>
              <select id="semester" required
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2">
                <option value="">— select —</option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
              </select>
            </label>
            <label class="grid gap-1">
              <span class="text-sm">Course code</span>
              <input id="courseCode" required placeholder="e.g., CS201"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
            <label class="grid gap-1 md:col-span-1">
              <span class="text-sm">Course title</span>
              <input id="courseTitle" required placeholder="e.g., Data Structures"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-2" />
            </label>
          </div>

          <!-- Units Builder -->
          <div class="grid gap-3">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold">Units</h2>
              <div class="flex gap-2">
                <button type="button" id="addUnitBtn"
                  class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Add
                  Unit</button>
                <button type="button" id="expandAllBtn"
                  class="rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-1.5 text-sm hover:border-brand-400/60">Expand
                  all</button>
              </div>
            </div>
            <div id="unitsWrap" class="grid gap-4"></div>
          </div>

          <div class="flex items-center justify-between">
            <div id="status"
              class="hidden rounded-lg bg-white/70 dark:bg-night-800/70 border border-slate-200/60 dark:border-white/10 p-3 font-mono text-[12px] text-slate-700 dark:text-slate-300">
            </div>
            <div class="flex gap-2">
              <a href="index.html"
                class="rounded-lg border border-slate-200/60 dark:border-white/10 px-4 py-2 text-sm hover:border-brand-400/60">Cancel</a>
              <button type="submit" id="submitBtn"
                class="rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 px-5 py-2.5 text-white shadow-neon">Save
                Course</button>
            </div>
          </div>
        </form>
      </div>
    </section>
  </main>

  <template id="unitTpl">
    <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-night-800/70">
      <div class="px-4 py-3 border-b border-slate-200/60 dark:border-white/10 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span
            class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-brand-500/10 text-brand-600 text-xs font-semibold"
            data-unit-index>1</span>
          <input placeholder="Unit title (e.g., Arrays & Linked Lists)"
            class="unit-title w-full rounded-md border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-1.5 text-sm" />
        </div>
        <div class="flex items-center gap-2">
          <button type="button"
            class="toggle-btn rounded-md border border-slate-200/60 dark:border-white/10 px-2 py-1 text-xs">Collapse</button>
          <button type="button"
            class="remove-unit rounded-md border border-rose-200/60 dark:border-rose-900/40 px-2 py-1 text-xs hover:border-rose-400/60">Remove</button>
        </div>
      </div>
      <div class="p-4 grid gap-3" data-body>
        <div class="grid gap-2" data-topics></div>
        <button type="button"
          class="add-topic rounded-md border border-slate-200/60 dark:border-white/10 px-2 py-1 text-xs hover:border-brand-400/60 w-max">Add
          Topic</button>
      </div>
    </div>
  </template>

  <template id="topicTpl">
    <div class="flex items-center gap-2">
      <input placeholder="Topic (e.g., Singly Linked List)"
        class="topic-input w-full rounded-md border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-night-800/70 px-3 py-1.5 text-sm" />
      <button type="button"
        class="remove-topic rounded-md border border-rose-200/60 dark:border-rose-900/40 px-2 py-1 text-xs hover:border-rose-400/60">Remove</button>
    </div>
  </template>

  <script>
      // Hide auth buttons and show avatar if logged in
      (function () {
        const t = localStorage.getItem('px_token');
        if (!t) return;
        document.querySelectorAll('a[href="login.html"], a[href="signup.html"]').forEach(a => a.classList.add('hidden'));
        const navProfile = document.getElementById('navProfile');
        const navProfileImg = document.getElementById('navProfileImg');
        const navProfileInitial = document.getElementById('navProfileInitial');
        const navSignOut = document.getElementById('navSignOut');
        if (navProfile) navProfile.classList.remove('hidden');
        if (navSignOut) { navSignOut.classList.remove('hidden'); navSignOut.onclick = () => { try { localStorage.removeItem('px_token'); } catch { } window.location.href = 'login.html'; }; }

        const applyNavProfile = (profile) => {
          if (!profile) return;
          let initials = 'ME';
          if (profile.name) {
            initials = profile.name
              .split(' ')
              .filter(Boolean)
              .map(part => part[0]?.toUpperCase())
              .slice(0, 2)
              .join('') || 'ME';
          }
          if (navProfileInitial) {
            navProfileInitial.textContent = initials;
            navProfileInitial.classList.remove('hidden');
          }
          if (profile.profile_image_url && navProfileImg) {
            navProfileImg.src = profile.profile_image_url;
            navProfileImg.classList.remove('hidden');
            if (navProfileInitial) navProfileInitial.classList.add('hidden');
          } else if (navProfileImg) {
            navProfileImg.classList.add('hidden');
          }
        };

        window.__PX_NAV_APPLY = applyNavProfile;

        const useProfile = (profile) => { if (profile) applyNavProfile(profile); };

        if (window.__PX_PROFILE_SNAPSHOT) {
          applyNavProfile(window.__PX_PROFILE_SNAPSHOT);
          return;
        }

        const apiBase = (window.API_BASE || 'https://paperxapp.onrender.com').replace(/\/$/, '');
        if (!window.__PX_NAV_PROFILE_PROMISE) {
          window.__PX_NAV_PROFILE_PROMISE = fetch(`${apiBase}/api/me`, { headers: { Authorization: `Bearer ${t}` } })
            .then(r => r.ok ? r.json() : null)
            .then(d => {
              const profile = d?.profile || null;
              if (profile) {
                window.__PX_PROFILE_SNAPSHOT = profile;
                applyNavProfile(profile);
              }
              return profile;
            })
            .catch(() => null);
        }

        const pending = window.__PX_NAV_PROFILE_PROMISE;
        if (pending && typeof pending.then === 'function') {
          pending.then(useProfile).catch(() => { });
        }
      })();

    const apiBase = (window.API_BASE || 'https://paperxapp.onrender.com').replace(/\/$/, '');

    const collegeSel = document.getElementById('college');
    const deptSel = document.getElementById('department');
    const existingBatchSel = document.getElementById('existingBatch');
    const fromYearInp = document.getElementById('fromYear');
    const toYearInp = document.getElementById('toYear');
    const semesterSel = document.getElementById('semester');
    const codeInp = document.getElementById('courseCode');
    const titleInp = document.getElementById('courseTitle');
    const unitsWrap = document.getElementById('unitsWrap');
    const unitTpl = document.getElementById('unitTpl');
    const topicTpl = document.getElementById('topicTpl');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');
    const addUnitBtn = document.getElementById('addUnitBtn');
    const expandAllBtn = document.getElementById('expandAllBtn');

    let ctx = { colleges: [], departments: [], batchList: [], selectedBatchId: null };

    function opt(text, value) {
      const o = document.createElement('option');
      o.textContent = text; o.value = value ?? '';
      return o;
    }

    async function loadColleges() {
      collegeSel.innerHTML = '';
      collegeSel.appendChild(opt('— select —', ''));
      try {
        const res = await fetch(`${apiBase}/api/colleges`);
        const data = await res.json();
        ctx.colleges = data || [];
        for (const c of ctx.colleges) collegeSel.appendChild(opt(c.name, c.id));
      } catch (e) {
        collegeSel.appendChild(opt('Failed to load', ''));
      }
    }

    async function loadDepartments(collegeId) {
      deptSel.innerHTML = '';
      deptSel.appendChild(opt('— select —', ''));
      existingBatchSel.innerHTML = '<option value="">— Select after department —</option>';
      existingBatchSel.disabled = true;
      ctx.departments = [];
      ctx.batchList = [];
      ctx.selectedBatchId = null;
      fromYearInp.value = '';
      toYearInp.value = '';
      if (!collegeId) { deptSel.disabled = true; return; }
      deptSel.disabled = false;
      try {
        const res = await fetch(`${apiBase}/api/colleges/${collegeId}/departments/full`);
        const data = await res.json();
        ctx.departments = data || [];
        for (const d of ctx.departments) deptSel.appendChild(opt(d.name, d.name));
      } catch (e) {
        deptSel.appendChild(opt('Failed to load', ''));
      }
    }

    async function loadBatches(collegeId, deptName) {
      existingBatchSel.innerHTML = '';
      existingBatchSel.appendChild(opt('— none / custom —', ''));
      existingBatchSel.disabled = false;
      ctx.batchList = [];
      ctx.selectedBatchId = null;
      fromYearInp.value = '';
      toYearInp.value = '';
      if (!collegeId || !deptName) { existingBatchSel.disabled = true; return; }
      try {
        const res = await fetch(`${apiBase}/api/colleges/${collegeId}/departments/${encodeURIComponent(deptName)}/batches/full`);
        const data = await res.json();
        ctx.batchList = data || [];
        for (const b of ctx.batchList) {
          const label = `${b.from_year}\u2013${b.to_year}`;
          existingBatchSel.appendChild(opt(label, b.id));
        }
      } catch (e) {
        existingBatchSel.appendChild(opt('Failed to load', ''));
      }
    }

    function renumberUnits() {
      [...unitsWrap.querySelectorAll('[data-unit-index]')].forEach((el, idx) => el.textContent = (idx + 1));
    }

    function addTopic(topicsWrap, topicValue = '') {
      const n = topicTpl.content.cloneNode(true);
      const input = n.querySelector('.topic-input');
      input.value = topicValue;
      n.querySelector('.remove-topic').addEventListener('click', () => {
        input.parentElement.remove();
      });
      topicsWrap.appendChild(n);
    }

    function addUnit(unitTitle = '') {
      const n = unitTpl.content.cloneNode(true);
      const unitNode = n.querySelector('div.rounded-xl');
      const body = n.querySelector('[data-body]');
      const toggleBtn = n.querySelector('.toggle-btn');
      const removeBtn = n.querySelector('.remove-unit');
      const titleInput = n.querySelector('.unit-title');
      const topicsWrap = n.querySelector('[data-topics]');
      const addTopicBtn = n.querySelector('.add-topic');
      titleInput.value = unitTitle;
      addTopic(topicsWrap, '');
      toggleBtn.addEventListener('click', () => {
        const hidden = body.classList.toggle('hidden');
        toggleBtn.textContent = hidden ? 'Expand' : 'Collapse';
      });
      removeBtn.addEventListener('click', () => { unitNode.remove(); renumberUnits(); });
      addTopicBtn.addEventListener('click', () => addTopic(topicsWrap, ''));
      unitsWrap.appendChild(n);
      renumberUnits();
    }

    function expandAll(expand = true) {
      unitsWrap.querySelectorAll('[data-body]').forEach(b => { b.classList.toggle('hidden', !expand); });
      unitsWrap.querySelectorAll('.toggle-btn').forEach(btn => { btn.textContent = expand ? 'Collapse' : 'Expand'; });
    }

    addUnitBtn.addEventListener('click', () => addUnit(''));
    expandAllBtn.addEventListener('click', () => {
      const anyCollapsed = [...unitsWrap.querySelectorAll('[data-body]')].some(b => b.classList.contains('hidden'));
      expandAll(anyCollapsed);
    });

    // Initial unit
    addUnit('Unit 1');

    // Selections
    collegeSel.addEventListener('change', (e) => {
      const id = e.target.value;
      loadDepartments(id);
    });
    deptSel.addEventListener('change', (e) => {
      const collegeId = collegeSel.value;
      const deptName = e.target.value;
      loadBatches(collegeId, deptName);
    });
    existingBatchSel.addEventListener('change', (e) => {
      const id = e.target.value || null;
      ctx.selectedBatchId = id || null;
      if (!id) { fromYearInp.value = ''; toYearInp.value = ''; return; }
      const row = ctx.batchList.find(b => String(b.id) === String(id));
      if (row) { fromYearInp.value = row.from_year; toYearInp.value = row.to_year; }
    });

    // Submit
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      status.classList.remove('hidden'); status.textContent = '';
      const college_id = collegeSel.value || '';
      const dept_name = (deptSel.value || '').trim();
      const from_year = Number(fromYearInp.value || 0);
      const to_year = Number(toYearInp.value || 0);
      const semester = Number(semesterSel.value || 0);
      const course_code = String(codeInp.value || '').trim();
      const title = String(titleInp.value || '').trim();

      if (!college_id) { status.textContent = '⚠️ Select a college.'; return; }
      if (!dept_name) { status.textContent = '⚠️ Select a department.'; return; }
      if (!semester || semester < 1 || semester > 12) { status.textContent = '⚠️ Choose a valid semester (1-12).'; return; }
      if (!course_code || !title) { status.textContent = '⚠️ Course code and title are required.'; return; }

      // Build units
      const units = [];
      unitsWrap.querySelectorAll('.unit-title').forEach((ut) => {
        const titleVal = String(ut.value || '').trim();
        const topicsWrap = ut.closest('div.rounded-xl').querySelector('[data-topics]');
        const topics = [...topicsWrap.querySelectorAll('.topic-input')].map(inp => String(inp.value || '').trim()).filter(Boolean).map(t => ({ topic: t }));
        if (titleVal) units.push({ unit_title: titleVal, topics });
      });
      if (!units.length) { status.textContent = '⚠️ Add at least one unit with a title.'; return; }

      submitBtn.disabled = true; submitBtn.textContent = 'Saving…';
      try {
        let batch_id = ctx.selectedBatchId;
        // If no existing batch selected, resolve/create using years
        if (!batch_id) {
          if (!from_year || !to_year || to_year < from_year) { status.textContent = '⚠️ Enter a valid batch year range.'; submitBtn.disabled = false; submitBtn.textContent = 'Save Course'; return; }
          const resB = await fetch(`${apiBase}/api/batches/resolve`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ college_id, dept_name, from_year, to_year }) });
          const outB = await resB.json().catch(() => ({}));
          if (!resB.ok) { status.textContent = `❌ ${outB?.detail || 'Failed to resolve batch.'}`; submitBtn.disabled = false; submitBtn.textContent = 'Save Course'; return; }
          batch_id = outB.id;
        }

        const payload = { batch_id, semester, course_code, title, units };
        const res = await fetch(`${apiBase}/api/syllabus/courses`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const out = await res.json().catch(() => ({}));
        if (!res.ok) { status.textContent = `❌ ${out?.detail || 'Failed to save course.'}`; return; }
        status.textContent = '✔ Saved. Thank you for contributing!';
        // Reset minimal fields for another entry
        codeInp.value = ''; titleInp.value = '';
        unitsWrap.innerHTML = ''; addUnit('Unit 1');
      } catch (err) {
        status.textContent = '❌ Network error. Please try again.';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Save Course';
      }
    });

    // Init
    loadColleges();
  </script>
</body>

</html>