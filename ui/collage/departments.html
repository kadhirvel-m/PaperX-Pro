<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Departments</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">

    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: {
                            50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F'
                        },
                        ink: '#1E1E2F', plum: '#4C2A59', orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        soft: '0 24px 60px rgba(30,30,47,0.25)'
                    },
                    backgroundImage: {
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)',
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .gradient-hero-text {
            display: inline-block;
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .hero-aurora::before {
            content: "";
            position: absolute;
            inset: -30% -5% auto -30%;
            height: 420px;
            background: radial-gradient(circle at top, rgba(158, 75, 138, 0.45), transparent 60%);
            filter: blur(60px);
            opacity: .65;
            pointer-events: none;
        }

        .hero-aurora::after {
            content: "";
            position: absolute;
            inset: auto -25% -35% 30%;
            height: 380px;
            background: radial-gradient(circle at bottom, rgba(76, 42, 89, 0.45), transparent 60%);
            filter: blur(60px);
            opacity: .55;
            pointer-events: none;
        }

        .dark .hero-aurora::before,
        .dark .hero-aurora::after {
            opacity: .8
        }

        #mobileNavBackdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease
        }

        #mobileNavPanel {
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease
        }

        #mobileNavBackdrop[data-open="true"],
        #mobileNavBackdrop.open {
            opacity: 1;
            pointer-events: auto
        }

        #mobileNavPanel[data-open="true"],
        #mobileNavPanel.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto
        }
    </style>
    <script>
            (() => { // early theme hydration
                const stored = localStorage.getItem('px_theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = stored ? stored === 'dark' : prefersDark;
                if (isDark) document.documentElement.classList.add('dark');
            })();
    </script>
    <script src="../config.js" defer></script>
    <script src="helpers.js" defer></script>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-4">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="../assets/img/logo-light.svg" alt="Paper X" class="h-10 w-auto dark:hidden">
                <img src="../assets/img/logo-dark.svg" alt="Paper X" class="h-10 w-auto hidden dark:block">
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../about.html">About</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../contact.html">Contact</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../help.html">Help</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="clg_info.html">
                    <span>Collages</span>
                    <span class="material-symbols-rounded text-base">hub</span>
                </a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
                <a href="../login.html"
                    class="text-sm text-neutral-700 dark:text-white/85 hover:text-brandlt-900 dark:hover:text-white px-3 py-2 rounded-full transition">Log
                    in</a>
                <a href="../signup.html"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 text-white text-sm font-semibold px-4 py-2.5 hover:shadow-glow transition">Sign
                    up</a>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <button id="mobileNavToggle" type="button" aria-expanded="false" aria-controls="mobileNavPanel"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="material-symbols-rounded" data-icon>menu</span>
                </button>
            </div>
        </div>
    </header>
    <div id="mobileNavBackdrop" aria-hidden="true"
        class="md:hidden fixed inset-0 z-40 bg-black/60 dark:bg-black/80 backdrop-blur-sm"></div>
    <nav id="mobileNavPanel" aria-hidden="true"
        class="md:hidden fixed inset-x-4 top-24 z-50 flex flex-col gap-5 max-h-[calc(100vh-6.5rem)] overflow-y-auto rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_1.5rem_4rem_-1.5rem_rgba(30,30,47,0.75)] backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6">
        <div class="flex flex-col gap-2 text-sm text-neutral-700 dark:text-white/80">
            <a href="../index.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Home</a>
            <a href="../about.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">About</a>
            <a href="../contact.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Contact</a>
            <a href="../help.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Help</a>
            <a href="clg_info.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 bg-brandlt-200/70 dark:bg-white/10 text-brand-700 dark:text-white transition">Collages</a>
        </div>
        <div class="flex flex-col gap-3 border-t border-black/5 dark:border-white/10 pt-4">
            <a href="../login.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 text-neutral-700 dark:text-white/80 hover:bg-black/5 dark:hover:bg-white/10 transition">Log
                in</a>
            <a href="../signup.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_4px_18px_-6px_rgba(158,75,138,0.6)] hover:shadow-[0_6px_24px_-8px_rgba(158,75,138,0.7)] transition">Sign
                up</a>
        </div>
    </nav>

    <main>
        <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10 hero-aurora">
            <div aria-hidden="true" class="absolute inset-0">
                <div class="absolute -top-36 right-10 h-80 w-80 rounded-full bg-brand-500/20 blur-3xl"></div>
                <div class="absolute bottom-[-8rem] left-10 h-72 w-72 rounded-full bg-brand-700/25 blur-3xl"></div>
            </div>
            <div class="relative container max-w-6xl py-5 md:py-7">
                <div class="lg:grid lg:grid-cols-2 lg:gap-12 items-start">
                    <!-- Left content -->
                    <div class="flex flex-col gap-6">
                        <div
                            class="flex flex-wrap items-center gap-3 text-xs font-medium text-neutral-500 dark:text-white/70">
                            <nav id="breadcrumbs" aria-label="Breadcrumb"
                                class="inline-flex flex-wrap items-center gap-2 text-xs md:text-sm"></nav>
                            <span class="hidden md:block h-4 w-px bg-black/10 dark:bg-white/15"></span>
                            <a id="backLink" href="degrees.html"
                                class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3 py-1.5 text-xs md:text-sm font-medium text-neutral-700 dark:text-white/70 hover:border-brand-500/50 transition">
                                <span class="material-symbols-rounded text-base">arrow_back</span>
                                Back to degrees
                            </a>
                        </div>
                        <div class="space-y-3">
                            <h1 id="pageTitle" class="text-2xl md:text-4xl font-bold gradient-hero-text">Departments
                            </h1>
                            <p id="pageSubtitle" class="hidden"></p>
                        </div>
                        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                            <button id="addDepartmentBtn" type="button"
                                class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-6 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">
                                <span class="material-symbols-rounded text-base">add</span>
                                Add department
                            </button>
                            <p class="text-sm md:text-base text-neutral-600 dark:text-white/65">Define the department
                                catalogue before mapping batches and subjects.</p>
                        </div>
                    </div>
                    <!-- Right media -->
                    <div class="mt-12 lg:mt-0 relative">
                        <div
                            class="relative group rounded-3xl overflow-hidden ring-1 ring-black/10 dark:ring-white/10 shadow-soft bg-black/5 dark:bg-white/5 h-56 sm:h-60 md:h-64 xl:h-45">
                            <video class="w-full h-full object-cover" autoplay muted loop playsinline
                                poster="../assets/img/placeholder-video.jpg">
                                <source src="../assets/video/collage/dept.mp4" type="video/mp4" />
                                Your browser does not support the video tag.
                            </video>
                            <div
                                class="pointer-events-none absolute inset-0 bg-gradient-to-tr from-brand-500/10 via-transparent to-brand-700/10 mix-blend-overlay">
                            </div>
                        </div>
                        <p class="mt-3 text-xs text-neutral-500 dark:text-white/50">A dynamic view of departments
                            forming the academic structure.</p>
                    </div>
                </div>
            </div>
        </section>
        <section class="py-16">
            <div class="container max-w-6xl">
                <div id="results" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3"></div>
            </div>
        </section>
    </main>

    <div id="departmentModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4 py-12 sm:px-6 lg:px-8"
        role="dialog" aria-modal="true" aria-labelledby="departmentModalTitle">
        <div id="departmentModalBackdrop" class="absolute inset-0 bg-brand-900/70 dark:bg-black/70 backdrop-blur-sm">
        </div>
        <div
            class="relative w-full max-w-xl rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_24px_60px_rgba(30,30,47,0.45)]">
            <div class="flex items-start justify-between gap-4 border-b border-black/5 dark:border-white/10 px-6 py-5">
                <div>
                    <h2 id="departmentModalTitle" class="text-xl font-semibold text-neutral-900 dark:text-white">Add a
                        new department</h2>
                    <p class="mt-1 text-sm text-neutral-600 dark:text-white/70">Provide the department / specialization
                        name.</p>
                </div>
                <button id="departmentModalClose" type="button"
                    class="rounded-full border border-transparent p-2 text-neutral-500 hover:text-brand-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
                    <span class="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
            <form id="departmentForm" class="space-y-5 px-6 py-6">
                <label class="block text-sm font-medium text-neutral-700 dark:text-white/85">
                    Department name
                    <input id="departmentName" name="name" type="text" required
                        class="mt-2 w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
                        placeholder="e.g. Computer Science Engineering" />
                </label>
                <p id="departmentModalMessage" class="hidden text-sm text-red-500"></p>
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <button id="departmentDeleteBtn" type="button"
                        class="hidden inline-flex items-center justify-center gap-2 rounded-full border border-red-300/60 bg-red-50 text-red-700 dark:bg-red-500/10 dark:text-red-200 px-4 py-2 text-sm font-medium hover:border-red-400/80 transition">
                        <span class="material-symbols-rounded text-base">delete</span>
                        Delete
                    </button>
                    <div class="flex items-center gap-3 ml-auto">
                        <button id="departmentModalCancel" type="button"
                            class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 px-4 py-2 text-sm font-medium text-neutral-600 dark:text-white/70 hover:border-brand-500/50 transition">Cancel</button>
                        <button id="departmentSubmitBtn" type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">
                            <span class="material-symbols-rounded text-base">save</span>
                            Save department
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <footer class="border-t border-black/5 dark:border-white/10 py-10">
        <div
            class="container flex flex-col gap-3 text-sm text-neutral-500 dark:text-white/60 sm:flex-row sm:items-center sm:justify-between">
            <p>© <span id="y"></span> Paper X · College Console.</p>
            <div class="flex flex-wrap items-center gap-4">
                <a href="../about.html" class="hover:text-brand-500 dark:hover:text-white transition">About</a>
                <a href="../help.html" class="hover:text-brand-500 dark:hover:text-white transition">Help centre</a>
                <a href="../contact.html" class="hover:text-brand-500 dark:hover:text-white transition">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        const y = document.getElementById('y'); if (y) y.textContent = new Date().getFullYear();
        const root = document.documentElement;
        const themeToggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
        const updateToggleIcons = (mode) => { themeToggles().forEach(btn => { const icon = btn.querySelector('.material-symbols-rounded'); if (icon) icon.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode'; }); };
        const setTheme = (mode) => { if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem('px_theme', mode); updateToggleIcons(mode); };
        setTheme(root.classList.contains('dark') ? 'dark' : 'light');
        document.addEventListener('click', (e) => { const trigger = e.target.closest('[data-theme-toggle]'); if (!trigger) return; const next = root.classList.contains('dark') ? 'light' : 'dark'; setTheme(next); });
    </script>
    <script>
        (function () { // mobile nav
            const toggle = document.getElementById('mobileNavToggle');
            const panel = document.getElementById('mobileNavPanel');
            const backdrop = document.getElementById('mobileNavBackdrop');
            if (!toggle || !panel || !backdrop) return;
            const icon = toggle.querySelector('[data-icon]');
            const focusableSelector = 'a[href], button:not([disabled])';
            const openMenu = () => { panel.setAttribute('data-open', 'true'); panel.classList.add('open'); panel.setAttribute('aria-hidden', 'false'); backdrop.setAttribute('data-open', 'true'); backdrop.classList.add('open'); backdrop.setAttribute('aria-hidden', 'false'); toggle.setAttribute('aria-expanded', 'true'); if (icon) icon.textContent = 'close'; document.body.classList.add('overflow-hidden'); const first = panel.querySelector(focusableSelector); if (first) first.focus(); };
            const closeMenu = () => { panel.removeAttribute('data-open'); panel.classList.remove('open'); panel.setAttribute('aria-hidden', 'true'); backdrop.removeAttribute('data-open'); backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); toggle.setAttribute('aria-expanded', 'false'); if (icon) icon.textContent = 'menu'; document.body.classList.remove('overflow-hidden'); toggle.focus(); };
            const toggleMenu = () => { const isOpen = toggle.getAttribute('aria-expanded') === 'true'; (isOpen ? closeMenu : openMenu)(); };
            toggle.addEventListener('click', toggleMenu); backdrop.addEventListener('click', closeMenu); panel.addEventListener('click', (evt) => { if (evt.target.closest('[data-close-mobile-nav]')) closeMenu(); }); window.addEventListener('keydown', (evt) => { if (evt.key === 'Escape') closeMenu(); }); window.matchMedia('(min-width: 768px)').addEventListener('change', (evt) => { if (evt.matches) closeMenu(); });
        })();
    </script>
    <script>
        const params = (window.Collage && typeof window.Collage.parseQuery === 'function') ? window.Collage.parseQuery() : (() => { const q = {}; const s = window.location ? window.location.search : ''; if (!s) return q; try { const usp = new URLSearchParams(s); usp.forEach((v, k) => { q[k] = v }); } catch (_) { } return q; })();
        const collegeId = params.collegeId; const collegeName = params.collegeName ? decodeURIComponent(params.collegeName) : ''; const degreeId = params.degreeId; const degreeName = params.degreeName ? decodeURIComponent(params.degreeName) : '';
        const results = document.getElementById('results');
        const titleEl = document.getElementById('pageTitle');
        const subtitleEl = document.getElementById('pageSubtitle');
        const breadcrumbsEl = document.getElementById('breadcrumbs');
        const backLink = document.getElementById('backLink');
        const addDepartmentBtn = document.getElementById('addDepartmentBtn');
        const departmentModal = document.getElementById('departmentModal');
        const departmentModalBackdrop = document.getElementById('departmentModalBackdrop');
        const departmentModalTitle = document.getElementById('departmentModalTitle');
        const departmentForm = document.getElementById('departmentForm');
        const departmentNameInput = document.getElementById('departmentName');
        const departmentModalMessage = document.getElementById('departmentModalMessage');
        const departmentModalCancel = document.getElementById('departmentModalCancel');
        const departmentModalClose = document.getElementById('departmentModalClose');
        const departmentSubmitBtn = document.getElementById('departmentSubmitBtn');
        const departmentDeleteBtn = document.getElementById('departmentDeleteBtn');
        const themeAccentPalette = [
            'from-brand-500/70 via-brandlt-300/60 to-brand-700/80',
            'from-[#FF7FD1]/55 via-[#B06AB3]/60 to-brand-700/80',
            'from-brandlt-200/60 via-white/40 to-brand-500/65',
            'from-[#7F57D1]/55 via-brand-500/60 to-brand-700/80',
            'from-brand-700/65 via-brandlt-400/55 to-brand-500/70'
        ];
        let currentCollegeLabel = collegeName || 'Selected college';
        let currentDegreeLabel = degreeName || 'Selected degree';
        let departmentsCache = [];
        let departmentModalMode = 'add';
        let editingDepartmentId = null;

        function makeBreadcrumb(items) { if (!Array.isArray(items)) return ''; return items.map((item, idx) => { if (!item) return ''; if (item.href && idx !== items.length - 1) { return `<a href="${item.href}" class="text-neutral-600 dark:text-white/70 hover:text-brand-500 dark:hover:text-white">${Collage.escapeHtml(item.label || item.text || '')}</a>`; } return `<span class="text-neutral-900 dark:text-white font-medium">${Collage.escapeHtml(item.label || item.text || '')}</span>`; }).filter(Boolean).join('<span class="text-neutral-400 dark:text-white/40">/</span>'); }

        function showLoader() { results.innerHTML = `<div class="col-span-full flex items-center justify-center py-16"><div class="h-12 w-12 animate-spin rounded-full border-2 border-brand-500/30 border-t-transparent"></div></div>`; }
        function showError(message) { results.innerHTML = `<div class="col-span-full rounded-3xl border border-red-400/35 bg-red-100/70 dark:bg-red-500/10 dark:border-red-400/25 p-8 shadow-soft"><h2 class="text-lg font-semibold text-red-700 dark:text-red-200">Unable to load departments</h2><p class="mt-2 text-sm text-red-600/85 dark:text-red-200/80">${Collage.escapeHtml(message || 'Please verify the degree context and try again.')}</p></div>`; }
        function showEmpty() { results.innerHTML = `<div class="col-span-full rounded-3xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-white/5 backdrop-blur p-8 text-sm text-neutral-600 dark:text-white/65"><h2 class="text-lg font-semibold text-neutral-900 dark:text-white">No departments yet</h2><p class="mt-2">Add department information for this degree to continue building the academic hierarchy.</p></div>`; }

        const deleteBtnDefaultHTML = `<span class="material-symbols-rounded text-base">delete</span>Delete`;

        function resetDepartmentModal() {
            departmentForm?.reset();
            departmentModalMessage.textContent = '';
            departmentModalMessage.classList.add('hidden');
            editingDepartmentId = null;
            departmentModalMode = 'add';
            departmentSubmitBtn.innerHTML = `<span class="material-symbols-rounded text-base">save</span>Save department`;
            if (departmentDeleteBtn) {
                departmentDeleteBtn.classList.add('hidden');
                departmentDeleteBtn.disabled = false;
                departmentDeleteBtn.innerHTML = deleteBtnDefaultHTML;
            }
        }

        function setDepartmentModalLoading(isLoading) {
            departmentSubmitBtn.disabled = isLoading;
            departmentSubmitBtn.innerHTML = isLoading
                ? `<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Saving…`
                : (departmentModalMode === 'edit'
                    ? `<span class="material-symbols-rounded text-base">save</span>Save changes`
                    : `<span class="material-symbols-rounded text-base">save</span>Save department`);
        }

        function setDepartmentDeleteLoading(isLoading) {
            if (!departmentDeleteBtn) return;
            departmentDeleteBtn.disabled = isLoading;
            departmentModalCancel.disabled = isLoading;
            departmentSubmitBtn.disabled = isLoading;
            departmentDeleteBtn.innerHTML = isLoading
                ? `<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Deleting…`
                : deleteBtnDefaultHTML;
        }

        function closeDepartmentModal() {
            departmentModal.classList.add('hidden');
            departmentModal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
            resetDepartmentModal();
        }

        function openDepartmentModal(mode = 'add', department) {
            if (!degreeId) return;
            resetDepartmentModal();
            departmentModalMode = mode;
            if (mode === 'edit' && department) {
                editingDepartmentId = department.id;
                departmentNameInput.value = department.name || '';
            }
            departmentModalTitle.textContent = mode === 'edit' ? 'Edit department' : `Add a new department for ${currentDegreeLabel}`;
            departmentSubmitBtn.innerHTML = mode === 'edit'
                ? `<span class="material-symbols-rounded text-base">save</span>Save changes`
                : `<span class="material-symbols-rounded text-base">save</span>Save department`;
            if (departmentDeleteBtn) {
                if (mode === 'edit') departmentDeleteBtn.classList.remove('hidden');
                else departmentDeleteBtn.classList.add('hidden');
                departmentDeleteBtn.disabled = false;
                departmentDeleteBtn.innerHTML = deleteBtnDefaultHTML;
            }
            departmentModal.classList.remove('hidden');
            departmentModal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                if (mode === 'edit') { departmentNameInput?.select(); }
                else { departmentNameInput?.focus(); }
            }, 80);
        }

        async function handleDepartmentSubmit(e) { e.preventDefault(); if (!collegeId || !degreeId) { departmentModalMessage.textContent = 'Missing college or degree context. Please navigate from the degrees page again.'; departmentModalMessage.classList.remove('hidden'); return; } const name = (departmentNameInput.value || '').trim(); if (!name) { departmentModalMessage.textContent = 'Please enter the department name.'; departmentModalMessage.classList.remove('hidden'); departmentNameInput.focus(); return; } departmentModalMessage.classList.add('hidden'); setDepartmentModalLoading(true); const payload = { name }; try { if (departmentModalMode === 'edit' && editingDepartmentId) { await Collage.fetchJson(`/api/departments/${editingDepartmentId}`, { method: 'PUT', body: payload, skipAuth: true }); } else { await Collage.fetchJson(`/api/degrees/${degreeId}/departments`, { method: 'POST', body: payload, skipAuth: true }); } closeDepartmentModal(); await loadDepartments(); } catch (error) { let message = error?.message ?? 'Unable to save department. Please try again.'; if (typeof message !== 'string') { try { message = JSON.stringify(message); } catch (_) { message = 'Unable to save department. Please try again.'; } } if (message === '[object Object]') message = 'Unexpected response from server. Please try again.'; departmentModalMessage.textContent = message; departmentModalMessage.classList.remove('hidden'); console.error(error); } finally { setDepartmentModalLoading(false); } }

        async function handleDepartmentDelete() {
            if (!editingDepartmentId) return;
            const ok = window.confirm('Delete this department and its batches? This cannot be undone.');
            if (!ok) return;
            setDepartmentDeleteLoading(true);
            departmentModalMessage.classList.add('hidden');
            try {
                await Collage.fetchJson(`/api/departments/${editingDepartmentId}`, { method: 'DELETE', skipAuth: true });
                closeDepartmentModal();
                await loadDepartments();
            } catch (error) {
                let message = error?.message ?? 'Unable to delete department. Please try again.';
                if (typeof message !== 'string') {
                    try { message = JSON.stringify(message); } catch (_) { message = 'Unable to delete department. Please try again.'; }
                }
                if (message === '[object Object]') message = 'Unexpected response from server. Please try again.';
                departmentModalMessage.textContent = message;
                departmentModalMessage.classList.remove('hidden');
                console.error(error);
            } finally {
                setDepartmentDeleteLoading(false);
            }
        }

        function initDepartmentModal() { if (!addDepartmentBtn) return; if (!degreeId) { addDepartmentBtn.disabled = true; addDepartmentBtn.classList.add('opacity-60', 'cursor-not-allowed'); } addDepartmentBtn.addEventListener('click', () => openDepartmentModal('add')); departmentModalCancel?.addEventListener('click', closeDepartmentModal); departmentModalClose?.addEventListener('click', closeDepartmentModal); departmentModalBackdrop?.addEventListener('click', closeDepartmentModal); departmentForm?.addEventListener('submit', handleDepartmentSubmit); departmentDeleteBtn?.addEventListener('click', handleDepartmentDelete); document.addEventListener('keydown', (ev) => { if (ev.key === 'Escape' && !departmentModal.classList.contains('hidden')) closeDepartmentModal(); }); }

        function attachDepartmentEditHandlers() { const editButtons = results.querySelectorAll('[data-department-edit]'); editButtons.forEach(btn => { btn.addEventListener('click', (ev) => { ev.preventDefault(); ev.stopPropagation(); ev.stopImmediatePropagation(); const id = btn.getAttribute('data-department-edit'); const department = departmentsCache.find(item => String(item.id) === String(id)); if (department) openDepartmentModal('edit', department); }); }); }
        function attachDepartmentCardNavigation() { const cards = results.querySelectorAll('[data-department-card]'); cards.forEach(card => { const href = card.getAttribute('data-department-card'); if (!href) return; card.addEventListener('click', (ev) => { if (ev.target.closest('[data-department-edit]')) return; if (ev.target.closest('a')) return; window.location.href = href; }); card.addEventListener('keydown', (ev) => { if ((ev.key === 'Enter' || ev.key === ' ') && !ev.target.closest('[data-department-edit]')) { ev.preventDefault(); window.location.href = href; } }); }); }

        async function loadDepartments() {
            if (!collegeId || !degreeId) { showError('Missing collegeId or degreeId in URL.'); return; } showLoader(); try {
                const data = await Collage.fetchJson(`/api/colleges/${collegeId}`, { skipAuth: true }); const collegeLabel = data?.name || collegeName || 'Selected college'; currentCollegeLabel = collegeLabel; const degrees = Array.isArray(data?.degrees) ? data.degrees : []; const degree = degrees.find(item => String(item.id) === String(degreeId)); if (backLink) { backLink.href = `degrees.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeLabel)}`; }
                if (!degree) { showError('Degree not found for this college.'); subtitleEl.textContent = 'Try picking another degree.'; titleEl.textContent = 'Departments'; breadcrumbsEl.innerHTML = makeBreadcrumb([{ label: 'Colleges', href: 'clg_info.html' }, { label: collegeLabel, href: `degrees.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeLabel)}` }, { label: degreeName || 'Unknown degree' }]); return; }
                currentDegreeLabel = degree?.name || degreeName || 'Selected degree'; titleEl.textContent = degrees.length ? `Departments in ${currentDegreeLabel}` : `Configure departments for ${currentDegreeLabel}`; const departments = Array.isArray(degree.departments) ? degree.departments : []; departmentsCache = departments.slice(); const deptCount = departments.length; subtitleEl.textContent = `${deptCount} department${deptCount === 1 ? '' : 's'} recorded.`; breadcrumbsEl.innerHTML = makeBreadcrumb([{ label: 'Colleges', href: 'clg_info.html' }, { label: collegeLabel, href: `degrees.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeLabel)}` }, { label: currentDegreeLabel }]); if (!deptCount) { showEmpty(); return; }
                results.innerHTML = departments.map((department, index) => {
                    const batches = Array.isArray(department.batches) ? department.batches : []; const firstBatch = batches[0]; const batchLabel = firstBatch ? Collage.escapeHtml(Collage.formatYearRange(firstBatch.from, firstBatch.to)) : '—'; const accentColor = themeAccentPalette[index % themeAccentPalette.length]; const departmentLink = `batches.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeLabel)}&degreeId=${encodeURIComponent(degreeId)}&degreeName=${encodeURIComponent(currentDegreeLabel)}&departmentId=${encodeURIComponent(department.id)}&departmentName=${encodeURIComponent(department.name || '')}`; const chips = [`<span class=\"inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/50 dark:bg-white/10 px-3 py-1 text-xs text-neutral-700 dark:text-white/80\">${batches.length} batch${batches.length === 1 ? '' : 'es'}</span>`]; if (firstBatch) { chips.push(`<span class=\"inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/50 dark:bg-white/10 px-3 py-1 text-xs text-neutral-700 dark:text-white/80\">${batchLabel}</span>`); }
                    return `<article class=\"group relative overflow-hidden rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur-xl p-6 shadow-soft transition hover:border-brand-500/50 focus-within:border-brand-500/50\" data-department-card=\"${departmentLink}\" tabindex=\"0\">\n<div class=\"absolute inset-x-6 top-6 h-32 rounded-3xl bg-gradient-to-r ${accentColor} opacity-20 blur-3xl\"></div>\n<button type=\"button\" data-department-edit=\"${department.id}\" aria-label=\"Edit ${Collage.escapeHtml(department.name || '')}\" class=\"absolute top-5 right-5 z-20 inline-flex items-center justify-center rounded-full border border-white/40 bg-white/85 dark:bg-white/10 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 transition\"><span class=\"material-symbols-rounded text-base\">edit</span></button>\n<div class=\"relative flex flex-wrap gap-2\">${chips.join('')}</div>\n<h2 class=\"relative z-10 mt-6 text-xl font-semibold text-neutral-900 dark:text-white\"><a href=\"${departmentLink}\" class=\"inline-flex items-center gap-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/60 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-brand-900 group-hover:text-brand-500 transition\">${Collage.escapeHtml(department.name || 'Unnamed department')}<span class=\"material-symbols-rounded text-base opacity-0 group-hover:opacity-100 transition\">north_east</span></a></h2>\n<p class=\"relative mt-3 text-sm text-neutral-600 dark:text-white/65\">Explore batches & their subjects mapped to this department.</p>\n<a class=\"relative mt-6 inline-flex items-center gap-2 text-sm font-medium text-brand-500 dark:text-white/85\" href=\"${departmentLink}\">View batches<span class=\"material-symbols-rounded text-base transition group-hover:translate-x-1\">arrow_forward</span></a>\n</article>`;
                }).join('');
                attachDepartmentEditHandlers(); attachDepartmentCardNavigation();
            } catch (err) { console.error(err); showError(err.message || 'Unexpected error'); }
        }

        document.addEventListener('DOMContentLoaded', () => { initDepartmentModal(); loadDepartments(); });
    </script>
</body>

</html>