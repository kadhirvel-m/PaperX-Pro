<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Batches</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' },
                        ink: '#1E1E2F', plum: '#4C2A59', orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        soft: '0 24px 60px rgba(30,30,47,0.25)'
                    },
                    backgroundImage: {
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg,#FFFFFF 0%,#FBF8FC 45%,#F7F2F9 100%)',
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg,#1E1E2F 0%,#201934 35%,#141321 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .gradient-hero-text {
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .hero-aurora::before {
            content: "";
            position: absolute;
            inset: -30% -5% auto -30%;
            height: 420px;
            background: radial-gradient(circle at top, rgba(158, 75, 138, .45), transparent 60%);
            filter: blur(60px);
            opacity: .65;
            pointer-events: none
        }

        .hero-aurora::after {
            content: "";
            position: absolute;
            inset: auto -25% -35% 30%;
            height: 380px;
            background: radial-gradient(circle at bottom, rgba(76, 42, 89, .45), transparent 60%);
            filter: blur(60px);
            opacity: .55;
            pointer-events: none
        }

        .dark .hero-aurora::before,
        .dark .hero-aurora::after {
            opacity: .8
        }

        #mobileNavBackdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease
        }

        #mobileNavPanel {
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease
        }

        #mobileNavBackdrop[data-open="true"],
        #mobileNavBackdrop.open {
            opacity: 1;
            pointer-events: auto
        }

        #mobileNavPanel[data-open="true"],
        #mobileNavPanel.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto
        }
    </style>
    <script>(() => { const s = localStorage.getItem('px_theme'); const p = window.matchMedia('(prefers-color-scheme: dark)').matches; const d = s ? s === 'dark' : p; if (d) document.documentElement.classList.add('dark'); })();</script>
    <script src="../config.js" defer></script>
    <script src="helpers.js" defer></script>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-4">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="../assets/img/logo-light.svg" alt="Paper X" class="h-10 w-auto dark:hidden" />
                <img src="../assets/img/logo-dark.svg" alt="Paper X" class="h-10 w-auto hidden dark:block" />
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../about.html">About</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../contact.html">Contact</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../help.html">Help</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="clg_info.html">
                    <span>Collages</span>
                    <span class="material-symbols-rounded text-base">hub</span>
                </a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
                <a href="../login.html"
                    class="text-sm text-neutral-700 dark:text-white/85 hover:text-brandlt-900 dark:hover:text-white px-3 py-2 rounded-full transition">Log
                    in</a>
                <a href="../signup.html"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 text-white text-sm font-semibold px-4 py-2.5 hover:shadow-glow transition">Sign
                    up</a>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"><span
                        class="material-symbols-rounded">dark_mode</span></button>
                <button id="mobileNavToggle" type="button" aria-expanded="false" aria-controls="mobileNavPanel"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="material-symbols-rounded" data-icon>menu</span>
                </button>
            </div>
        </div>
    </header>
    <div id="mobileNavBackdrop" aria-hidden="true"
        class="md:hidden fixed inset-0 z-40 bg-black/60 dark:bg-black/80 backdrop-blur-sm"></div>
    <nav id="mobileNavPanel" aria-hidden="true"
        class="md:hidden fixed inset-x-4 top-24 z-50 flex flex-col gap-5 max-h-[calc(100vh-6.5rem)] overflow-y-auto rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_1.5rem_4rem_-1.5rem_rgba(30,30,47,0.75)] backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6">
        <div class="flex flex-col gap-2 text-sm text-neutral-700 dark:text-white/80">
            <a href="../index.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Home</a>
            <a href="../about.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">About</a>
            <a href="../contact.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Contact</a>
            <a href="../help.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Help</a>
            <a href="clg_info.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 bg-brandlt-200/70 dark:bg-white/10 text-brand-700 dark:text-white transition">Collages</a>
        </div>
        <div class="flex flex-col gap-3 border-t border-black/5 dark:border-white/10 pt-4">
            <a href="../login.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 text-neutral-700 dark:text-white/80 hover:bg-black/5 dark:hover:bg-white/10 transition">Log
                in</a>
            <a href="../signup.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_4px_18px_-6px_rgba(158,75,138,0.6)] hover:shadow-[0_6px_24px_-8px_rgba(158,75,138,0.7)] transition">Sign
                up</a>
        </div>
    </nav>

    <main>
        <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10 hero-aurora">
            <div aria-hidden="true" class="absolute inset-0">
                <div class="absolute -top-36 right-10 h-80 w-80 rounded-full bg-brand-500/20 blur-3xl"></div>
                <div class="absolute bottom-[-8rem] left-10 h-72 w-72 rounded-full bg-brand-700/25 blur-3xl"></div>
            </div>
            <div class="relative container max-w-6xl py-8">
                <div class="flex flex-col gap-6">
                    <nav id="breadcrumbs"
                        class="flex flex-wrap items-center gap-2 text-xs md:text-sm font-medium text-neutral-500 dark:text-white/70"
                        aria-label="Breadcrumb"></nav>
                    <div class="space-y-3">
                        <h1 id="pageTitle" class="text-2xl md:text-4xl font-bold gradient-hero-text">Batches</h1>
                        <p id="pageSubtitle" class="text-neutral-600 dark:text-white/65">Loading batches…</p>
                        <div>
                            <a id="backLink" href="departments.html"
                                class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3 py-1.5 text-xs md:text-sm text-neutral-700 dark:text-white/70 hover:border-brand-500/50 transition"
                                title="Back to departments">
                                <span class="material-symbols-rounded text-base">arrow_back</span>
                                Back
                            </a>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                        <p class="text-sm md:text-base text-neutral-600 dark:text-white/65">Create cohorts for this
                            department before assigning subjects.</p>
                        <button id="addBatchBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-6 py-2.5 text-sm font-semibold text-white shadow-[0_10px_28px_rgba(158,75,138,0.35)] hover:shadow-[0_14px_34px_rgba(158,75,138,0.45)] transition">
                            <span class="material-symbols-rounded text-base">add</span>
                            Add batch
                        </button>
                    </div>
                </div>
            </div>
        </section>
        <section class="py-14">
            <div class="container max-w-6xl">
                <div id="results" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3"></div>
            </div>
        </section>
    </main>

    <div id="batchModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4 py-12 sm:px-6 lg:px-8"
        role="dialog" aria-modal="true" aria-labelledby="batchModalTitle">
        <div id="batchModalBackdrop" class="fixed inset-0 bg-brand-900/70 dark:bg-black/70 backdrop-blur-sm"></div>
        <div
            class="relative w-full max-w-xl rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_24px_60px_rgba(30,30,47,0.45)]">
            <div class="flex items-start justify-between gap-4 border-b border-black/5 dark:border-white/10 px-6 py-5">
                <div>
                    <h2 id="batchModalTitle" class="text-xl font-semibold text-neutral-900 dark:text-white">Add a new
                        batch</h2>
                    <p class="mt-1 text-sm text-neutral-600 dark:text-white/70">Set the academic year range for this
                        cohort.</p>
                </div>
                <button id="batchModalClose" type="button"
                    class="rounded-full border border-transparent p-2 text-neutral-500 hover:text-brand-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
                    <span class="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
            <form id="batchForm" class="space-y-5 px-6 py-6">
                <div class="grid gap-4 sm:grid-cols-2">
                    <label class="block text-sm font-medium text-neutral-700 dark:text-white/85">From year
                        <input id="batchFromYear" name="from" type="number" min="1950" max="2100" required
                            class="mt-2 w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
                            placeholder="e.g. 2021" />
                    </label>
                    <label class="block text-sm font-medium text-neutral-700 dark:text-white/85">To year
                        <input id="batchToYear" name="to" type="number" min="1950" max="2100" required
                            class="mt-2 w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
                            placeholder="e.g. 2025" />
                    </label>
                </div>
                <p id="batchModalMessage" class="hidden text-sm text-red-500"></p>
                <div class="flex items-center justify-end gap-3">
                    <button id="batchModalCancel" type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 px-4 py-2 text-sm font-medium text-neutral-600 dark:text-white/70 hover:border-brand-500/50 transition">Cancel</button>
                    <button id="batchSubmitBtn" type="submit"
                        class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">Save
                        batch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Existing logic script (adapted only for theme + mobile nav) -->
    <script>
        const params = (window.Collage && typeof window.Collage.parseQuery === 'function') ? window.Collage.parseQuery() : (() => { const q = {}; const s = window.location.search || ''; if (!s) return q; const usp = new URLSearchParams(s); usp.forEach((v, k) => q[k] = v); return q; })();
        let collegeId = params.collegeId; let collegeName = params.collegeName ? decodeURIComponent(params.collegeName) : ''; let degreeId = params.degreeId; let degreeName = params.degreeName ? decodeURIComponent(params.degreeName) : ''; let departmentId = params.departmentId; let departmentName = params.departmentName ? decodeURIComponent(params.departmentName) : '';
        // Attempt recovery from sessionStorage if critical params missing (back navigation without query string)
        (function recoverContext() {
            const need = !collegeId || !departmentId || !departmentName;
            if (!need) return;
            try {
                const raw = sessionStorage.getItem('px_ctx_batches');
                if (raw) {
                    const ctx = JSON.parse(raw);
                    if (ctx && typeof ctx === 'object') {
                        collegeId = collegeId || ctx.collegeId;
                        collegeName = collegeName || ctx.collegeName;
                        degreeId = degreeId || ctx.degreeId;
                        degreeName = degreeName || ctx.degreeName;
                        departmentId = departmentId || ctx.departmentId;
                        departmentName = departmentName || ctx.departmentName;
                        console.debug('[batches] recovered from sessionStorage', ctx);
                    }
                }
            } catch (e) { console.debug('[batches] sessionStorage recovery failed', e); }
            if (!collegeId || !departmentId || !departmentName) {
                try {
                    const raw2 = localStorage.getItem('px_ctx_batches_last');
                    if (raw2) {
                        const ctx2 = JSON.parse(raw2);
                        if (ctx2) {
                            collegeId = collegeId || ctx2.collegeId;
                            collegeName = collegeName || ctx2.collegeName;
                            degreeId = degreeId || ctx2.degreeId;
                            degreeName = degreeName || ctx2.degreeName;
                            departmentId = departmentId || ctx2.departmentId;
                            departmentName = departmentName || ctx2.departmentName;
                            console.debug('[batches] recovered from localStorage', ctx2);
                        }
                    }
                } catch (e2) { console.debug('[batches] localStorage recovery failed', e2); }
            }
            // If still missing, attempt upstream redirect if we have at least collegeId
            if ((!collegeId || !departmentId || !departmentName) && collegeId) {
                const redirectUrl = `departments.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}`;
                console.debug('[batches] redirecting upstream due to incomplete context');
                window.location.replace(redirectUrl);
            }
        })();
        const results = document.getElementById('results'); const titleEl = document.getElementById('pageTitle'); const subtitleEl = document.getElementById('pageSubtitle'); const breadcrumbsEl = document.getElementById('breadcrumbs'); const addBatchBtn = document.getElementById('addBatchBtn');
        const batchModal = document.getElementById('batchModal'); const batchModalBackdrop = document.getElementById('batchModalBackdrop'); const batchModalTitle = document.getElementById('batchModalTitle'); const batchForm = document.getElementById('batchForm'); const batchFromYearInput = document.getElementById('batchFromYear'); const batchToYearInput = document.getElementById('batchToYear'); const batchModalMessage = document.getElementById('batchModalMessage'); const batchModalCancel = document.getElementById('batchModalCancel'); const batchModalClose = document.getElementById('batchModalClose'); const batchSubmitBtn = document.getElementById('batchSubmitBtn');
        let batchesCache = []; let batchModalMode = 'add'; let editingBatchId = null;
        function makeBreadcrumb(items) { if (!Array.isArray(items)) return ''; return items.map((item, idx) => { if (!item) return ''; if (item.href && idx !== items.length - 1) { return `<a href="${item.href}" class="hover:text-brand-500 dark:hover:text-white">${Collage.escapeHtml(item.label || item.text || '')}</a>`; } return `<span class="text-neutral-900 dark:text-white font-medium">${Collage.escapeHtml(item.label || item.text || '')}</span>`; }).filter(Boolean).join('<span class="text-neutral-400 dark:text-white/40">/</span>'); }
        function showLoader() { results.innerHTML = `<div class=\"col-span-full flex items-center justify-center py-16\"><div class=\"h-12 w-12 animate-spin rounded-full border-2 border-brand-500/30 border-t-transparent\"></div></div>`; }
        function showError(message) { results.innerHTML = `<div class=\"col-span-full rounded-3xl border border-red-400/35 bg-red-100/70 dark:bg-red-500/10 dark:border-red-400/25 p-8 shadow-soft\"><h2 class=\"text-lg font-semibold text-red-700 dark:text-red-200\">Unable to load batches</h2><p class=\"mt-2 text-sm text-red-600/85 dark:text-red-200/80\">${Collage.escapeHtml(message || 'Please check the URL parameters and try again.')}</p></div>`; }
        function showEmpty() { results.innerHTML = `<div class=\"col-span-full rounded-3xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-white/5 backdrop-blur p-8 text-sm text-neutral-600 dark:text-white/65\"><h2 class=\"text-lg font-semibold text-neutral-900 dark:text-white\">No batches found</h2><p class=\"mt-2\">Create batches for this department to continue drilling down into subjects.</p></div>`; }
        function resetBatchModal() { batchForm?.reset(); batchModalMessage.textContent = ''; batchModalMessage.classList.add('hidden'); batchModalMode = 'add'; editingBatchId = null; batchSubmitBtn.innerHTML = '<span class="material-symbols-rounded text-base">save</span>Save batch'; }
        function setBatchModalLoading(isLoading) { batchSubmitBtn.disabled = isLoading; batchSubmitBtn.innerHTML = isLoading ? '<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Saving…' : (batchModalMode === 'edit' ? '<span class="material-symbols-rounded text-base">save</span>Save changes' : '<span class="material-symbols-rounded text-base">save</span>Save batch'); }
        function closeBatchModal() { batchModal.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); resetBatchModal(); }
        function openBatchModal(mode = 'add', batch) { if (!departmentId) return; resetBatchModal(); batchModalMode = mode; if (mode === 'edit' && batch) { editingBatchId = batch.id; batchFromYearInput.value = batch.from_year; batchToYearInput.value = batch.to_year; } const deptLabel = departmentName || 'this department'; batchModalTitle.textContent = mode === 'edit' ? 'Edit batch' : `Add a new batch for ${deptLabel}`; batchSubmitBtn.innerHTML = mode === 'edit' ? '<span class="material-symbols-rounded text-base">save</span>Save changes' : '<span class="material-symbols-rounded text-base">save</span>Save batch'; batchModal.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); setTimeout(() => { (mode === 'edit' ? batchFromYearInput : batchFromYearInput)?.focus(); }, 80); }
        function validateBatchYears(fromYear, toYear) { if (!Number.isInteger(fromYear) || !Number.isInteger(toYear)) return 'Enter both from and to years.'; if (fromYear < 1950 || fromYear > 2100 || toYear < 1950 || toYear > 2100) return 'Year range must be between 1950 and 2100.'; if (toYear < fromYear) return 'Ending year must be greater than or equal to the starting year.'; return ''; }
        async function handleBatchSubmit(e) { e.preventDefault(); if (!departmentId) { batchModalMessage.textContent = 'Missing department context. Please navigate from the departments page again.'; batchModalMessage.classList.remove('hidden'); return; } const fromYear = Number.parseInt(batchFromYearInput.value, 10); const toYear = Number.parseInt(batchToYearInput.value, 10); const v = validateBatchYears(fromYear, toYear); if (v) { batchModalMessage.textContent = v; batchModalMessage.classList.remove('hidden'); (Number.isInteger(fromYear) ? batchToYearInput : batchFromYearInput).focus(); return; } batchModalMessage.classList.add('hidden'); setBatchModalLoading(true); const payload = { from: fromYear, to: toYear }; try { if (batchModalMode === 'edit' && editingBatchId) { await Collage.fetchJson(`/api/batches/${editingBatchId}`, { method: 'PUT', body: payload, skipAuth: true }); } else { await Collage.fetchJson(`/api/departments/${departmentId}/batches`, { method: 'POST', body: payload, skipAuth: true }); } closeBatchModal(); await loadBatches(); } catch (error) { let message = error?.message ?? 'Unable to save batch. Please try again.'; if (typeof message !== 'string') { try { message = JSON.stringify(message); } catch (_) { message = 'Unable to save batch. Please try again.'; } } if (message === '[object Object]') message = 'Unexpected response from server. Please try again.'; batchModalMessage.textContent = message; batchModalMessage.classList.remove('hidden'); console.error(error); } finally { setBatchModalLoading(false); } }
        function initBatchModal() { if (!addBatchBtn) return; if (!departmentId) { addBatchBtn.disabled = true; addBatchBtn.classList.add('opacity-60', 'cursor-not-allowed'); } addBatchBtn.addEventListener('click', () => openBatchModal('add')); batchModalCancel?.addEventListener('click', closeBatchModal); batchModalClose?.addEventListener('click', closeBatchModal); batchModalBackdrop?.addEventListener('click', closeBatchModal); batchForm?.addEventListener('submit', handleBatchSubmit); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !batchModal.classList.contains('hidden')) closeBatchModal(); }); }
        function attachBatchEditHandlers() { results.querySelectorAll('[data-batch-edit]').forEach(btn => { btn.addEventListener('click', e => { e.preventDefault(); e.stopPropagation(); const id = btn.getAttribute('data-batch-edit'); const batch = batchesCache.find(b => String(b.id) === String(id)); if (batch) openBatchModal('edit', batch); }); }); }
        function attachBatchCardNavigation() { results.querySelectorAll('[data-batch-card]').forEach(card => { const href = card.getAttribute('data-batch-card'); if (!href) return; card.addEventListener('click', e => { if (e.target.closest('[data-batch-edit]')) return; if (e.target.closest('a')) return; window.location.href = href; }); card.addEventListener('keydown', e => { if ((e.key === 'Enter' || e.key === ' ') && !e.target.closest('[data-batch-edit]')) { e.preventDefault(); window.location.href = href; } }); }); }
        async function loadBatches() {
            if (!collegeId || !departmentId) { showError('Missing collegeId or departmentId in URL.'); return; } showLoader(); try {
                const deptKey = encodeURIComponent(departmentId);
                const batches = await Collage.fetchJson(`/api/departments/${deptKey}/batches/full`, { skipAuth: true }); const label = departmentName || 'Selected department'; titleEl.innerHTML = `Batches · <span class=\"opacity-80\">${Collage.escapeHtml(label)}</span>`; const list = Array.isArray(batches) ? batches : []; batchesCache = list.map(i => ({ id: i.id, from_year: Number(i.from_year), to_year: Number(i.to_year) })); subtitleEl.textContent = `${list.length} batch${list.length === 1 ? '' : 'es'} recorded for this department.`; breadcrumbsEl.innerHTML = makeBreadcrumb([
                    { label: 'Colleges', href: 'clg_info.html' },
                    { label: collegeName || 'College', href: `degrees.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeName || '')}` },
                    { label: degreeName || 'Degree', href: `departments.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}` },
                    { label }
                ]);
                // Provide a persistent back link (if an element exists for it in future) to departments with full context
                const backAnchor = document.getElementById('backLink');
                if (backAnchor) {
                    const deptBack = `departments.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}`;
                    backAnchor.setAttribute('href', deptBack);
                }
                if (!list.length) { showEmpty(); return; }
                const accentPalette = [
                    'from-brand-500/70 via-brandlt-300/60 to-brand-700/80',
                    'from-[#FF7FD1]/55 via-[#B06AB3]/60 to-brand-700/80',
                    'from-brandlt-200/60 via-white/40 to-brand-500/65',
                    'from-[#7F57D1]/55 via-brand-500/60 to-brand-700/80',
                    'from-brand-700/65 via-brandlt-400/55 to-brand-500/70'
                ];
                results.innerHTML = list.map((batch, index) => { const range = Collage.formatYearRange(batch.from_year, batch.to_year); const accent = accentPalette[index % accentPalette.length]; const subjectsLink = `subjects.html?collegeId=${encodeURIComponent(collegeId)}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}&departmentId=${encodeURIComponent(departmentId || '')}&departmentName=${encodeURIComponent(departmentName || '')}&batchId=${encodeURIComponent(batch.id)}&batchRange=${encodeURIComponent(range)}`; return `<article class=\"group relative overflow-hidden rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur-xl p-6 shadow-soft transition hover:shadow-glow focus-within:shadow-glow cursor-pointer\" data-batch-card=\"${subjectsLink}\" tabindex=\"0\"><div class=\"absolute inset-x-6 top-6 h-32 rounded-3xl bg-gradient-to-r ${accent} opacity-20 blur-3xl\"></div><button type=\"button\" data-batch-edit=\"${batch.id}\" aria-label=\"Edit batch ${Collage.escapeHtml(range)}\" class=\"absolute top-5 right-5 z-20 inline-flex items-center justify-center rounded-full border border-white/40 bg-white/85 dark:bg-white/10 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 transition\"><span class=\"material-symbols-rounded text-base\">edit</span></button><div class=\"relative flex items-center justify-between text-xs text-neutral-600 dark:text-white/70\"><span class=\"inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/50 dark:bg-white/10 px-3 py-1 text-xs text-neutral-700 dark:text-white/80\">Batch</span><span class=\"font-mono text-[11px] text-neutral-500/80 dark:text-white/50\">${Collage.escapeHtml(String(batch.id).slice(0, 8))}…</span></div><h2 class=\"relative mt-6 text-xl font-semibold text-neutral-900 dark:text-white group-hover:text-brand-500\"><a href=\"${subjectsLink}\" class=\"inline-flex items-center gap-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/60 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-brand-900\">${Collage.escapeHtml(range)}<span class=\"material-symbols-rounded text-base text-brand-500 opacity-0 group-hover:opacity-100 transition\">north_east</span></a></h2><p class=\"relative mt-3 text-sm text-neutral-600 dark:text-white/65\">View all subjects (syllabus courses) taught in this cohort and dive into their syllabus.</p><a class=\"relative mt-6 inline-flex items-center gap-2 text-sm font-medium text-brand-500 dark:text-white/85\" href=\"${subjectsLink}\">View subjects<span class=\"material-symbols-rounded text-base transition group-hover:translate-x-1\">arrow_forward</span></a></article>`; }).join('');
                attachBatchEditHandlers(); attachBatchCardNavigation();
            } catch (err) { console.error(err); showError(err.message || 'Unexpected error'); }
        }
        document.addEventListener('DOMContentLoaded', () => { initBatchModal(); loadBatches(); });
    </script>
    <script>
        // Theme toggles sync (reuse pattern from degrees.html)
        const root = document.documentElement; const themeBtns = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
        function updateThemeIcons(mode) { themeBtns().forEach(btn => { const ic = btn.querySelector('.material-symbols-rounded'); if (ic) ic.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode'; }); }
        function setTheme(mode) { if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem('px_theme', mode); updateThemeIcons(mode); }
        setTheme(root.classList.contains('dark') ? 'dark' : 'light');
        document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; const next = root.classList.contains('dark') ? 'light' : 'dark'; setTheme(next); });
    </script>
    <script>
        // Mobile nav interactions
        (function () {
            const toggle = document.getElementById('mobileNavToggle'); const panel = document.getElementById('mobileNavPanel'); const backdrop = document.getElementById('mobileNavBackdrop'); if (!toggle || !panel || !backdrop) return; const icon = toggle.querySelector('[data-icon]'); const focusable = 'a[href],button:not([disabled])'; function openMenu() { panel.setAttribute('data-open', 'true'); panel.classList.add('open'); panel.setAttribute('aria-hidden', 'false'); backdrop.setAttribute('data-open', 'true'); backdrop.classList.add('open'); backdrop.setAttribute('aria-hidden', 'false'); toggle.setAttribute('aria-expanded', 'true'); if (icon) icon.textContent = 'close'; document.body.classList.add('overflow-hidden'); const first = panel.querySelector(focusable); if (first) first.focus(); }
            function closeMenu() { panel.removeAttribute('data-open'); panel.classList.remove('open'); panel.setAttribute('aria-hidden', 'true'); backdrop.removeAttribute('data-open'); backdrop.classList.remove('open'); backdrop.setAttribute('aria-hidden', 'true'); toggle.setAttribute('aria-expanded', 'false'); if (icon) icon.textContent = 'menu'; document.body.classList.remove('overflow-hidden'); }
            function toggleMenu() { const isOpen = toggle.getAttribute('aria-expanded') === 'true'; (isOpen ? closeMenu : openMenu)(); }
            toggle.addEventListener('click', toggleMenu); backdrop.addEventListener('click', closeMenu); panel.addEventListener('click', e => { if (e.target.closest('[data-close-mobile-nav]')) closeMenu(); }); window.addEventListener('keydown', e => { if (e.key === 'Escape') closeMenu(); }); window.matchMedia('(min-width:768px)').addEventListener('change', e => { if (e.matches) closeMenu(); });
        })();
    </script>
</body>

</html>