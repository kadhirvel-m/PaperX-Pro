<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — Syllabus</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' },
                        ink: '#1E1E2F',
                        plum: '#4C2A59',
                        orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        soft: '0 24px 60px rgba(30,30,47,0.25)'
                    },
                    backgroundImage: {
                        'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg,#FFFFFF 0%,#FBF8FC 45%,#F7F2F9 100%)',
                        'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg,#1E1E2F 0%,#201934 35%,#141321 100%)'
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px
        }

        .gradient-hero-text {
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC)
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .hero-aurora::before {
            content: "";
            position: absolute;
            inset: -30% -5% auto -30%;
            height: 420px;
            background: radial-gradient(circle at top, rgba(158, 75, 138, .45), transparent 60%);
            filter: blur(60px);
            opacity: .65;
            pointer-events: none
        }

        .hero-aurora::after {
            content: "";
            position: absolute;
            inset: auto -25% -35% 30%;
            height: 380px;
            background: radial-gradient(circle at bottom, rgba(76, 42, 89, .45), transparent 60%);
            filter: blur(60px);
            opacity: .55;
            pointer-events: none
        }

        .dark .hero-aurora::before,
        .dark .hero-aurora::after {
            opacity: .8
        }

        #mobileNavBackdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease
        }

        #mobileNavPanel {
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease
        }

        #mobileNavBackdrop[data-open="true"],
        #mobileNavBackdrop.open {
            opacity: 1;
            pointer-events: auto
        }

        #mobileNavPanel[data-open="true"],
        #mobileNavPanel.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto
        }

        /* Ensure unit modal panel is scrollable and capped to viewport */
        #unitModalPanel {
            max-height: 90vh;
            height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: radial-gradient(120% 100% at 10% 10%, rgba(158, 75, 138, 0.08), transparent 45%), radial-gradient(120% 120% at 90% 0%, rgba(76, 42, 89, 0.08), transparent 45%), linear-gradient(135deg, rgba(255, 255, 255, 0.96) 0%, rgba(250, 245, 251, 0.92) 40%, rgba(247, 242, 249, 0.9) 100%);
            box-shadow: 0 26px 70px rgba(30, 30, 47, 0.35), 0 0 0 1px rgba(158, 75, 138, 0.08);
        }

        .dark #unitModalPanel {
            background: radial-gradient(120% 100% at 15% 5%, rgba(158, 75, 138, 0.18), transparent 50%), radial-gradient(120% 120% at 85% 0%, rgba(76, 42, 89, 0.22), transparent 45%), linear-gradient(135deg, rgba(32, 25, 52, 0.96) 0%, rgba(23, 19, 38, 0.96) 55%, rgba(20, 19, 33, 0.96) 100%);
            box-shadow: 0 26px 70px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        #unitModalPanel::before,
        #unitModalPanel::after {
            content: "";
            position: absolute;
            inset: auto;
            pointer-events: none;
        }

        #unitModalPanel::before {
            top: -140px;
            left: -120px;
            width: 320px;
            height: 320px;
            background: radial-gradient(circle, rgba(158, 75, 138, 0.18), transparent 60%);
            filter: blur(30px);
        }

        #unitModalPanel::after {
            bottom: -160px;
            right: -120px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(76, 42, 89, 0.18), transparent 60%);
            filter: blur(32px);
        }

        #unitModalBackdrop {
            background: radial-gradient(120% 120% at 15% 20%, rgba(158, 75, 138, 0.22), transparent 55%), radial-gradient(120% 120% at 80% 15%, rgba(76, 42, 89, 0.18), transparent 50%), rgba(30, 30, 47, 0.65);
        }
    </style>
    <script>
        (() => {
            const s = localStorage.getItem('px_theme');
            const p = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const d = s ? s === 'dark' : p;
            if (d) document.documentElement.classList.add('dark');
        })();
    </script>
    <script src="../config.js" defer></script>
    <script src="helpers.js" defer></script>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
        <div class="container flex items-center justify-between py-4">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="../assets/img/logo-light.svg" class="h-10 w-auto dark:hidden" alt="Paper X" />
                <img src="../assets/img/logo-dark.svg" class="h-10 w-auto hidden dark:block" alt="Paper X" />
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../about.html">About</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../contact.html">Contact</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../help.html">Help</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="clg_info.html"><span>Collages</span><span
                        class="material-symbols-rounded text-base">hub</span></a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme"><span class="material-symbols-rounded">dark_mode</span><span
                        class="hidden sm:block">Theme</span></button>
                <a href="../login.html"
                    class="text-sm text-neutral-700 dark:text-white/85 hover:text-brandlt-900 dark:hover:text-white px-3 py-2 rounded-full transition">Log
                    in</a>
                <a href="../signup.html"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 text-white text-sm font-semibold px-4 py-2.5 hover:shadow-glow transition">Sign
                    up</a>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"><span
                        class="material-symbols-rounded">dark_mode</span></button>
                <button id="mobileNavToggle" type="button" aria-expanded="false" aria-controls="mobileNavPanel"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"><span
                        class="sr-only">Toggle navigation</span><span class="material-symbols-rounded"
                        data-icon>menu</span></button>
            </div>
        </div>
    </header>
    <div id="mobileNavBackdrop" aria-hidden="true"
        class="md:hidden fixed inset-0 z-40 bg-black/60 dark:bg-black/80 backdrop-blur-sm"></div>
    <nav id="mobileNavPanel" aria-hidden="true"
        class="md:hidden fixed inset-x-4 top-24 z-50 flex flex-col gap-5 max-h-[calc(100vh-6.5rem)] overflow-y-auto rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_1.5rem_4rem_-1.5rem_rgba(30,30,47,0.75)] backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6">
        <div class="flex flex-col gap-2 text-sm text-neutral-700 dark:text-white/80">
            <a href="../index.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Home</a>
            <a href="../about.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">About</a>
            <a href="../contact.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Contact</a>
            <a href="../help.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Help</a>
            <a href="clg_info.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 bg-brandlt-200/70 dark:bg-white/10 text-brand-700 dark:text-white transition">Collages</a>
        </div>
        <div class="flex flex-col gap-3 border-t border-black/5 dark:border-white/10 pt-4">
            <a href="../login.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 text-neutral-700 dark:text-white/80 hover:bg-black/5 dark:hover:bg-white/10 transition">Log
                in</a>
            <a href="../signup.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_4px_18px_-6px_rgba(158,75,138,0.6)] hover:shadow-[0_6px_24px_-8px_rgba(158,75,138,0.7)] transition">Sign
                up</a>
        </div>
    </nav>
    <main>
        <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10 hero-aurora">
            <div aria-hidden="true" class="absolute inset-0">
                <div class="absolute -top-36 right-10 h-80 w-80 rounded-full bg-brand-500/20 blur-3xl"></div>
                <div class="absolute bottom-[-8rem] left-10 h-72 w-72 rounded-full bg-brand-700/25 blur-3xl"></div>
            </div>
            <div class="relative container max-w-5xl py-8">
                <div class="flex flex-col gap-6">
                    <nav id="breadcrumbs"
                        class="flex flex-wrap items-center gap-2 text-xs md:text-sm font-medium text-neutral-500 dark:text-white/70"
                        aria-label="Breadcrumb"></nav>
                    <div class="space-y-3">
                        <h1 id="pageTitle" class="text-2xl md:text-4xl font-bold gradient-hero-text">Subject syllabus
                        </h1>
                        <p id="pageSubtitle" class="text-neutral-600 dark:text-white/65">Loading syllabus…</p>
                    </div>
                    <div class="flex">
                        <a id="backLink" href="subjects.html"
                            class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3 py-1.5 text-xs md:text-sm text-neutral-700 dark:text-white/70 hover:border-brand-500/50 transition"
                            title="Back to subjects"><span
                                class="material-symbols-rounded text-base">arrow_back</span>Back</a>
                    </div>
                    <div id="contextPanel"
                        class="mt-4 rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur p-6 shadow-soft">
                    </div>
                    <div class="mt-2 flex justify-end">
                        <button id="addUnitBtn" type="button"
                            class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_10px_28px_rgba(158,75,138,0.35)] hover:shadow-[0_14px_34px_rgba(158,75,138,0.45)] transition disabled:opacity-60 disabled:cursor-not-allowed"
                            disabled><span class="material-symbols-rounded text-base">add</span>Add unit</button>
                    </div>
                    <div id="results" class="mt-6 space-y-6"></div>
                </div>
            </div>
        </section>
    </main>
    <div id="unitModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4 py-12 sm:px-6 lg:px-8"
        role="dialog" aria-modal="true" aria-labelledby="unitModalTitle">
        <div id="unitModalBackdrop" class="fixed inset-0 bg-brand-900/70 dark:bg-black/70 backdrop-blur-sm"></div>
        <div id="unitModalPanel"
            class="relative w-full max-w-2xl rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_24px_60px_rgba(30,30,47,0.45)] max-h-[90vh] h-[90vh] overflow-y-auto">
            <div class="flex items-start justify-between gap-4 border-b border-black/5 dark:border-white/10 px-6 py-5">
                <div>
                    <h2 id="unitModalTitle" class="text-xl font-semibold text-neutral-900 dark:text-white">Add a new
                        unit</h2>
                    <p class="mt-1 text-sm text-neutral-600 dark:text-white/70">Provide the unit title and list of
                        topics.</p>
                </div>
                <button id="unitModalClose" type="button"
                    class="rounded-full border border-transparent p-2 text-neutral-500 hover:text-brand-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60"><span
                        class="material-symbols-rounded text-lg">close</span></button>
            </div>
            <form id="unitForm" class="space-y-5 px-6 py-6">
                <label class="block text-sm font-medium text-neutral-700 dark:text-white/85">Unit title
                    <input id="unitTitle" name="unit_title" type="text" required maxlength="256"
                        placeholder="e.g. Introduction to Algorithms"
                        class="mt-2 w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40" />
                </label>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-neutral-700 dark:text-white/85">Topics</span>
                        <button id="addTopicRow" type="button"
                            class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3 py-1.5 text-xs font-medium text-neutral-700 dark:text-white/80 hover:border-brand-500/50 transition"><span
                                class="material-symbols-rounded text-base">add</span>Add topic</button>
                    </div>
                    <div id="topicsContainer" class="space-y-3"></div>
                </div>
                <p id="unitModalMessage" class="hidden text-sm text-red-500"></p>
                <div class="flex justify-end">
                    <button id="addTopicRowBottom" type="button"
                        class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-4 py-2 text-xs font-medium text-neutral-700 dark:text-white/80 hover:border-brand-500/50 transition">
                        <span class="material-symbols-rounded text-base">add</span>Add topic
                    </button>
                </div>
                <div class="flex items-center justify-between gap-3">
                    <button id="unitDeleteBtn" type="button"
                        class="hidden inline-flex items-center justify-center gap-2 rounded-full border border-red-300/60 bg-red-50 text-red-700 dark:bg-red-500/10 dark:text-red-200 px-4 py-2 text-sm font-medium hover:border-red-400/80 transition">
                        <span class="material-symbols-rounded text-base">delete</span>Delete
                    </button>
                    <button id="unitModalCancel" type="button"
                        class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 px-4 py-2 text-sm font-medium text-neutral-600 dark:text-white/70 hover:border-brand-500/50 transition">Cancel</button>
                    <button id="unitSubmitBtn" type="submit"
                        class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition"><span
                            class="material-symbols-rounded text-base">save</span>Save unit</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const params = (window.Collage && typeof window.Collage.parseQuery === 'function') ? window.Collage.parseQuery() : (() => {
            const q = {};
            const s = window.location.search || '';
            if (!s) return q;
            const usp = new URLSearchParams(s);
            usp.forEach((v, k) => q[k] = v);
            return q;
        })();
        const courseId = params.courseId;
        const courseCode = params.courseCode ? decodeURIComponent(params.courseCode) : '';
        const courseTitle = params.courseTitle ? decodeURIComponent(params.courseTitle) : '';
        const semesterParam = params.semester ? Number(params.semester) : null;
        const batchRange = params.batchRange ? decodeURIComponent(params.batchRange) : '';
        const batchId = params.batchId ? decodeURIComponent(params.batchId) : '';
        const collegeName = params.collegeName ? decodeURIComponent(params.collegeName) : '';
        const degreeName = params.degreeName ? decodeURIComponent(params.degreeName) : '';
        const departmentName = params.departmentName ? decodeURIComponent(params.departmentName) : '';

        const results = document.getElementById('results');
        const titleEl = document.getElementById('pageTitle');
        const subtitleEl = document.getElementById('pageSubtitle');
        const breadcrumbsEl = document.getElementById('breadcrumbs');
        const contextPanel = document.getElementById('contextPanel');
        const backLink = document.getElementById('backLink');
        const addUnitBtn = document.getElementById('addUnitBtn');

        const unitModal = document.getElementById('unitModal');
        const unitModalBackdrop = document.getElementById('unitModalBackdrop');
        const unitModalTitle = document.getElementById('unitModalTitle');
        const unitModalMessage = document.getElementById('unitModalMessage');
        const unitModalCancel = document.getElementById('unitModalCancel');
        const unitModalClose = document.getElementById('unitModalClose');
        const unitSubmitBtn = document.getElementById('unitSubmitBtn');
        const unitDeleteBtn = document.getElementById('unitDeleteBtn');
        const unitForm = document.getElementById('unitForm');
        const unitTitleInput = document.getElementById('unitTitle');
        const topicsContainer = document.getElementById('topicsContainer');
        const addTopicRowButton = document.getElementById('addTopicRow');
        const addTopicRowBottomButton = document.getElementById('addTopicRowBottom');

        let syllabusCourse = null;
        let unitModalMode = 'add';

        function makeBreadcrumb(items) {
            if (!Array.isArray(items)) return '';
            return items.map((item, idx) => {
                if (!item) return '';
                if (item.href && idx !== items.length - 1) {
                    return `<a href="${item.href}" class="hover:text-brand-500 dark:hover:text-white">${Collage.escapeHtml(item.label || item.text || '')}</a>`;
                }
                return `<span class="text-neutral-900 dark:text-white font-medium">${Collage.escapeHtml(item.label || item.text || '')}</span>`;
            }).filter(Boolean).join('<span class="text-neutral-400 dark:text-white/40">/</span>');
        }

        function showLoader() {
            results.innerHTML = `
                <div class="flex items-center justify-center py-16">
                    <div class="h-12 w-12 animate-spin rounded-full border-2 border-brand-500/30 border-t-transparent"></div>
                </div>`;
        }

        function showError(message) {
            results.innerHTML = `
                <div class="rounded-3xl border border-red-400/35 bg-red-100/70 dark:bg-red-500/10 dark:border-red-400/25 p-8 shadow-soft">
                    <h2 class="text-lg font-semibold text-red-700 dark:text-red-200">Unable to load syllabus</h2>
                    <p class="mt-2 text-sm text-red-600/85 dark:text-red-200/80">${Collage.escapeHtml(message || 'Please verify the course context and try again.')}</p>
                </div>`;
        }

        function showEmpty() {
            results.innerHTML = `
                <div class="rounded-3xl border border-black/5 dark:border-white/10 bg-white/80 dark:bg-white/5 backdrop-blur p-8 text-sm text-neutral-600 dark:text-white/65">
                    <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">No units yet</h2>
                    <p class="mt-2">Add units for this subject to build its syllabus structure.</p>
                </div>`;
        }

        function renderContext() {
            const parts = [
                courseCode ? `<span class="font-semibold">${Collage.escapeHtml(courseCode)}</span>` : '',
                courseTitle ? Collage.escapeHtml(courseTitle) : '',
                semesterParam ? `Semester ${semesterParam}` : '',
                batchRange ? `Batch ${Collage.escapeHtml(batchRange)}` : ''
            ].filter(Boolean);
            contextPanel.innerHTML = parts.length
                ? `<div class="flex flex-wrap gap-3 text-sm">${parts.map(p => `<span class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/70 dark:bg-white/5 px-3 py-1 text-neutral-700 dark:text-white/80">${p}</span>`).join('')}</div>`
                : '<p class="text-sm text-neutral-600 dark:text-white/65">Subject context unavailable.</p>';
        }

        function resetUnitModal() {
            unitForm?.reset();
            unitModalMessage.textContent = '';
            unitModalMessage.classList.add('hidden');
            unitModalMode = 'add';
            unitSubmitBtn.innerHTML = '<span class="material-symbols-rounded text-base">save</span>Save unit';
            if (unitDeleteBtn) unitDeleteBtn.classList.add('hidden');
            topicsContainer.innerHTML = '';
            addTopicRow();
        }

        function setUnitModalLoading(isLoading) {
            unitSubmitBtn.disabled = isLoading;
            unitSubmitBtn.innerHTML = isLoading
                ? '<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Saving…'
                : (unitModalMode === 'edit' ? '<span class="material-symbols-rounded text-base">save</span>Save changes' : '<span class="material-symbols-rounded text-base">save</span>Save unit');
        }

        function closeUnitModal() {
            unitModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            resetUnitModal();
        }

        function openUnitModal(mode = 'add', unit) {
            if (!courseId) return;
            resetUnitModal();
            unitModalMode = mode;

            if (mode === 'edit' && unit) {
                unitTitleInput.value = unit.unit_title || '';
                topicsContainer.innerHTML = '';
                (unit.topics || []).forEach(t => addTopicRow(t.topic_title || t.topic || ''));
            }

            unitModalTitle.textContent = mode === 'edit' ? 'Edit unit' : 'Add a new unit';
            unitSubmitBtn.innerHTML = mode === 'edit' ? '<span class="material-symbols-rounded text-base">save</span>Save changes' : '<span class="material-symbols-rounded text-base">save</span>Save unit';
            if (unitDeleteBtn) {
                if (mode === 'edit') unitDeleteBtn.classList.remove('hidden');
                else unitDeleteBtn.classList.add('hidden');
            }
            unitModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => { unitTitleInput?.focus(); }, 60);
        }

        function addTopicRow(value = '', insertAfterRow = null) {
            const id = Math.random().toString(36).slice(2, 9);
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.setAttribute('data-topic-row', '');
            row.innerHTML = `
                <button type="button" data-drag-handle aria-label="Drag to reorder"
                    class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 cursor-grab active:cursor-grabbing transition">
                    <span class="material-symbols-rounded text-base">drag_indicator</span>
                </button>
                <input type="text" data-topic-input id="topic-${id}" placeholder="Topic title" value="${Collage.escapeHtml(value)}" class="flex-1 rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40" maxlength="256" />
                <button type="button" aria-label="Add topic below" class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 transition">
                    <span class="material-symbols-rounded text-base">add</span>
                </button>
                <button type="button" aria-label="Remove topic" class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 p-2 text-neutral-500 hover:text-red-500 hover:border-red-500/50 transition"><span class="material-symbols-rounded text-base">close</span></button>`;

            const addBtn = row.querySelector('button[aria-label="Add topic below"]');
            addBtn.addEventListener('click', () => addTopicRow('', row));

            const removeBtn = row.querySelector('button[aria-label="Remove topic"]');
            removeBtn.addEventListener('click', () => {
                row.remove();
                if (!topicsContainer.querySelector('[data-topic-input]')) addTopicRow();
            });

            if (insertAfterRow && insertAfterRow.parentNode === topicsContainer) {
                if (insertAfterRow.nextSibling) {
                    topicsContainer.insertBefore(row, insertAfterRow.nextSibling);
                } else {
                    topicsContainer.appendChild(row);
                }
            } else {
                topicsContainer.appendChild(row);
            }

            // Make the handle itself draggable to ensure dragstart fires
            const handleBtn = row.querySelector('[data-drag-handle]');
            if (handleBtn) handleBtn.setAttribute('draggable', 'true');
            ensureDragDropEnabled();
        }

        addTopicRowButton.addEventListener('click', () => addTopicRow());
        addTopicRowBottomButton?.addEventListener('click', () => addTopicRow());

        // Drag and drop reordering with auto-scroll inside modal
        let dragEl = null;
        let autoScrollRAF = null;
        let scrollSpeed = 0; // pixels per frame

        function ensureDragDropEnabled() {
            if (!topicsContainer) return;
            // Delegate events only once
            if (topicsContainer.__dragBound) return;
            topicsContainer.__dragBound = true;

            topicsContainer.addEventListener('dragstart', (e) => {
                const row = e.target.closest('[data-topic-row]');
                const handle = e.target.closest('[data-drag-handle]');
                if (!row || !handle) { e.preventDefault(); return; }
                dragEl = row;
                dragEl.classList.add('opacity-50');
                try { e.dataTransfer.setData('text/plain', ''); } catch (_) { }
                e.dataTransfer.effectAllowed = 'move';
                if (typeof e.dataTransfer.setDragImage === 'function') {
                    const img = document.createElement('div');
                    img.style.width = '1px';
                    img.style.height = '1px';
                    img.style.opacity = '0';
                    document.body.appendChild(img);
                    e.dataTransfer.setDragImage(img, 0, 0);
                    setTimeout(() => img.remove(), 0);
                }
                startAutoScroll();
            });

            topicsContainer.addEventListener('dragover', (e) => {
                if (!dragEl) return;
                e.preventDefault();
                if (e.dataTransfer) e.dataTransfer.dropEffect = 'move';
                const after = getDragAfterElement(topicsContainer, e.clientY);
                if (after == null) topicsContainer.appendChild(dragEl);
                else topicsContainer.insertBefore(dragEl, after);
                updateAutoScroll(e.clientY);
            });

            topicsContainer.addEventListener('drop', (e) => { if (dragEl) e.preventDefault(); });

            topicsContainer.addEventListener('dragend', () => {
                if (dragEl) dragEl.classList.remove('opacity-50');
                dragEl = null;
                stopAutoScroll();
            });
        }

        function getDragAfterElement(container, y) {
            const els = [...container.querySelectorAll('[data-topic-row]:not(.opacity-50)')];
            let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
            for (const child of els) {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) closest = { offset, element: child };
            }
            return closest.element;
        }

        function startAutoScroll() {
            if (autoScrollRAF) cancelAnimationFrame(autoScrollRAF);
            const scroller = document.getElementById('unitModalPanel') || topicsContainer;
            const step = () => {
                if (scrollSpeed !== 0) {
                    scroller.scrollTop += scrollSpeed;
                }
                autoScrollRAF = requestAnimationFrame(step);
            };
            autoScrollRAF = requestAnimationFrame(step);
        }

        function stopAutoScroll() {
            if (autoScrollRAF) cancelAnimationFrame(autoScrollRAF);
            autoScrollRAF = null;
            scrollSpeed = 0;
        }

        function updateAutoScroll(clientY) {
            const scroller = document.getElementById('unitModalPanel') || topicsContainer;
            const rect = scroller.getBoundingClientRect();
            const threshold = 48; // px from edge to start autoscroll
            const maxSpeed = 12; // px per frame for smoothness

            if (clientY < rect.top + threshold) {
                const ratio = (rect.top + threshold - clientY) / threshold; // 0..1
                scrollSpeed = -Math.ceil(maxSpeed * ratio);
            } else if (clientY > rect.bottom - threshold) {
                const ratio = (clientY - (rect.bottom - threshold)) / threshold; // 0..1
                scrollSpeed = Math.ceil(maxSpeed * ratio);
            } else {
                scrollSpeed = 0;
            }
        }

        async function handleUnitSubmit(e) {
            e.preventDefault();
            if (!courseId) {
                unitModalMessage.textContent = 'Missing course context.';
                unitModalMessage.classList.remove('hidden');
                return;
            }
            const unit_title = (unitTitleInput.value || '').trim();
            if (!unit_title) {
                unitModalMessage.textContent = 'Enter the unit title.';
                unitModalMessage.classList.remove('hidden');
                unitTitleInput.focus();
                return;
            }
            const topicInputs = [...topicsContainer.querySelectorAll('[data-topic-input]')];
            // Backend expects 'topic' field per topic row
            const topics = topicInputs.map(inp => (inp.value || '').trim()).filter(Boolean).map(t => ({ topic: t }));
            const payload = { unit_title, topics };
            setUnitModalLoading(true);
            unitModalMessage.classList.add('hidden');
            try {
                if (unitModalMode === 'edit' && syllabusCourse && syllabusCourse.editingUnitId) {
                    await Collage.fetchJson(`/api/syllabus/units/${syllabusCourse.editingUnitId}`, { method: 'PUT', body: payload, skipAuth: true });
                } else {
                    await Collage.fetchJson(`/api/syllabus/courses/${courseId}/units`, { method: 'POST', body: payload, skipAuth: true });
                }
                closeUnitModal();
                await loadSyllabus();
            } catch (error) {
                let m = error?.message ?? 'Unable to save unit.';
                if (typeof m !== 'string') {
                    try { m = JSON.stringify(m); } catch (_) { m = 'Unable to save unit.'; }
                }
                if (m === '[object Object]') m = 'Unexpected response.';
                unitModalMessage.textContent = m;
                unitModalMessage.classList.remove('hidden');
                console.error(error);
            } finally {
                setUnitModalLoading(false);
            }
        }

        unitForm.addEventListener('submit', handleUnitSubmit);
        unitModalCancel.addEventListener('click', closeUnitModal);
        unitModalClose.addEventListener('click', closeUnitModal);
        unitModalBackdrop.addEventListener('click', closeUnitModal);
        document.addEventListener('keydown', e => { if (e.key === 'Escape' && !unitModal.classList.contains('hidden')) closeUnitModal(); });

        function setUnitDeleteLoading(isLoading) {
            if (!unitDeleteBtn) return;
            unitDeleteBtn.disabled = isLoading;
            unitModalCancel.disabled = isLoading;
            unitSubmitBtn.disabled = isLoading;
            unitDeleteBtn.innerHTML = isLoading
                ? '<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Deleting…'
                : '<span class="material-symbols-rounded text-base">delete</span>Delete';
        }

        async function handleUnitDelete() {
            if (!syllabusCourse || !syllabusCourse.editingUnitId) return;
            const ok = window.confirm('Delete this unit and all its topics? This action cannot be undone.');
            if (!ok) return;
            setUnitDeleteLoading(true);
            unitModalMessage.classList.add('hidden');
            try {
                await Collage.fetchJson(`/api/syllabus/units/${syllabusCourse.editingUnitId}`, { method: 'DELETE', skipAuth: true });
                closeUnitModal();
                await loadSyllabus();
            } catch (error) {
                let m = error?.message ?? 'Unable to delete unit.';
                if (typeof m !== 'string') {
                    try { m = JSON.stringify(m); } catch (_) { m = 'Unable to delete unit.'; }
                }
                if (m === '[object Object]') m = 'Unexpected response.';
                unitModalMessage.textContent = m;
                unitModalMessage.classList.remove('hidden');
                console.error(error);
            } finally {
                setUnitDeleteLoading(false);
            }
        }
        if (unitDeleteBtn) unitDeleteBtn.addEventListener('click', handleUnitDelete);

        function renderUnits(units) {
            if (!units.length) {
                showEmpty();
                return;
            }
            results.innerHTML = units.map(u => {
                const topics = Array.isArray(u.topics) ? u.topics : [];
                return `
          <article class="group relative overflow-hidden rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur p-6 shadow-soft">
            <div class="absolute inset-x-6 top-6 h-24 rounded-3xl bg-gradient-to-r from-brand-500/40 via-brandlt-300/30 to-brand-700/40 opacity-20 blur-2xl"></div>
            <div class="relative flex items-start justify-between gap-4">
              <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">${Collage.escapeHtml(u.unit_title || 'Unit')}</h2>
              <button type="button" data-unit-edit="${u.id}" class="inline-flex items-center justify-center rounded-full border border-white/40 bg-white/85 dark:bg-white/10 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 transition">
                <span class="material-symbols-rounded text-base">edit</span>
              </button>
            </div>
                        <ul class="relative mt-4 space-y-3 text-sm text-neutral-700 dark:text-white/75">
                                                                                                                ${topics.map(t => {
                    const label = Collage.escapeHtml(t.topic_title || t.topic || '');
                    const imgUrl = (t.image_url || '').trim();
                    const hasImage = !!imgUrl;
                    const videoUrl = (t.video_url || '').trim();
                    const hasVideo = !!videoUrl;
                    const pptUrl = (t.ppt_url || '').trim();
                    const hasPpt = !!pptUrl;
                    const imgBtnLabel = hasImage ? 'Remove image' : 'Upload image';
                    const imgBtnIcon = hasImage ? 'image_not_supported' : 'add_photo_alternate';
                    const imgBtnAttr = hasImage ? 'data-topic-image-remove' : 'data-topic-image-upload';
                    const imgCurrentAttr = hasImage ? `data-current-url=\"${Collage.escapeHtml(imgUrl)}\"` : '';
                    const videoBtnLabel = hasVideo ? 'Remove video' : 'Video link';
                    const videoBtnIcon = hasVideo ? 'link_off' : 'play_circle';
                    const videoBtnAttr = hasVideo ? 'data-topic-video-remove' : 'data-topic-video-upload';
                    const videoCurrentAttr = hasVideo ? `data-current-url=\"${Collage.escapeHtml(videoUrl)}\"` : '';
                    const pptBtnLabel = hasPpt ? 'Remove PPT' : 'PPT link';
                    const pptBtnIcon = hasPpt ? 'link_off' : 'slideshow';
                    const pptBtnAttr = hasPpt ? 'data-topic-ppt-remove' : 'data-topic-ppt-upload';
                    const pptCurrentAttr = hasPpt ? `data-current-url=\"${Collage.escapeHtml(pptUrl)}\"` : '';
                    const labUrl = (t.lab_url || '').trim();
                    const hasLab = !!labUrl;
                    const labBtnLabel = hasLab ? 'Remove Lab' : 'Lab link';
                    const labBtnIcon = hasLab ? 'link_off' : 'science';
                    const labBtnAttr = hasLab ? 'data-topic-lab-remove' : 'data-topic-lab-upload';
                    const labCurrentAttr = hasLab ? `data-current-url=\"${Collage.escapeHtml(labUrl)}\"` : '';
                    return `<li class=\"flex items-start justify-between gap-3\">
        <div class=\"flex items-start gap-2\">
        <span class=\"material-symbols-rounded text-base text-brand-500 mt-0.5\">check_small</span>
                <span>${label}</span>
    </div>
        <div class=\"flex flex-wrap items-center gap-1.5 justify-end\">
            <button type=\"button\" ${imgBtnAttr}=\"${t.id}\" ${imgCurrentAttr} class=\"inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-medium transition ${hasImage ? 'border-red-200 bg-red-50 text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200 hover:bg-red-100 hover:border-red-300 dark:hover:bg-red-500/20' : 'border-emerald-200 bg-emerald-50 text-emerald-700 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-200 hover:bg-emerald-100 hover:border-emerald-300 dark:hover:bg-emerald-500/20'}\">
                <span class=\"material-symbols-rounded text-sm\">${imgBtnIcon}</span>
                <span>${imgBtnLabel}</span>
            </button>
            <button type=\"button\" ${videoBtnAttr}=\"${t.id}\" ${videoCurrentAttr} class=\"inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-medium transition ${hasVideo ? 'border-red-200 bg-red-50 text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200 hover:bg-red-100 hover:border-red-300 dark:hover:bg-red-500/20' : 'border-sky-200 bg-sky-50 text-sky-700 dark:border-sky-500/40 dark:bg-sky-500/10 dark:text-sky-200 hover:bg-sky-100 hover:border-sky-300 dark:hover:bg-sky-500/20'}\">
                <span class=\"material-symbols-rounded text-sm\">${videoBtnIcon}</span>
                <span>${videoBtnLabel}</span>
            </button>
            <button type=\"button\" ${pptBtnAttr}=\"${t.id}\" ${pptCurrentAttr} class=\"inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-medium transition ${hasPpt ? 'border-red-200 bg-red-50 text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200 hover:bg-red-100 hover:border-red-300 dark:hover:bg-red-500/20' : 'border-amber-200 bg-amber-50 text-amber-800 dark:border-amber-500/40 dark:bg-amber-500/10 dark:text-amber-200 hover:bg-amber-100 hover:border-amber-300 dark:hover:bg-amber-500/20'}\">
                <span class=\"material-symbols-rounded text-sm\">${pptBtnIcon}</span>
                <span>${pptBtnLabel}</span>
            </button>
            <button type=\"button\" ${labBtnAttr}=\"${t.id}\" ${labCurrentAttr} class=\"inline-flex items-center gap-1 rounded-full border px-2.5 py-1 text-[11px] font-medium transition ${hasLab ? 'border-red-200 bg-red-50 text-red-700 dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200 hover:bg-red-100 hover:border-red-300 dark:hover:bg-red-500/20' : 'border-purple-200 bg-purple-50 text-purple-700 dark:border-purple-500/40 dark:bg-purple-500/10 dark:text-purple-200 hover:bg-purple-100 hover:border-purple-300 dark:hover:bg-purple-500/20'}\">
                <span class=\"material-symbols-rounded text-sm\">${labBtnIcon}</span>
                <span>${labBtnLabel}</span>
            </button>
        </div>
</li>`;
                }).join('') || '<li class=\"italic opacity-70\">No topics recorded.</li>'}
            </ul>
          </article>`;
            }).join('');
            attachUnitEditHandlers();
            attachTopicLinkHandlers();
        }

        function attachTopicLinkHandlers() {
            if (!results) return;

            results.querySelectorAll('[data-topic-image-upload]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-image-upload');
                    if (!topicId) return;
                    const current = btn.getAttribute('data-current-url') || '';
                    const value = window.prompt('Enter image URL for this topic:', current);
                    if (value === null) return;
                    const trimmed = (value || '').trim();
                    if (!trimmed) {
                        alert('Image URL cannot be empty.');
                        return;
                    }
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/image`, {
                            method: 'PUT',
                            body: { image_url: trimmed },
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to save image URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-image-remove]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-image-remove');
                    if (!topicId) return;
                    const ok = window.confirm('Remove the image URL for this topic?');
                    if (!ok) return;
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/image`, {
                            method: 'DELETE',
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to remove image URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-video-upload]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-video-upload');
                    if (!topicId) return;
                    const current = btn.getAttribute('data-current-url') || '';
                    const value = window.prompt('Enter video URL for this topic:', current);
                    if (value === null) return;
                    const trimmed = (value || '').trim();
                    if (!trimmed) {
                        alert('Video URL cannot be empty.');
                        return;
                    }
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/video`, {
                            method: 'PUT',
                            body: { video_url: trimmed },
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to save video URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-video-remove]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-video-remove');
                    if (!topicId) return;
                    const ok = window.confirm('Remove the video URL for this topic?');
                    if (!ok) return;
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/video`, {
                            method: 'DELETE',
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to remove video URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-ppt-upload]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-ppt-upload');
                    if (!topicId) return;
                    const current = btn.getAttribute('data-current-url') || '';
                    const value = window.prompt('Enter PPT URL for this topic:', current);
                    if (value === null) return;
                    const trimmed = (value || '').trim();
                    if (!trimmed) {
                        alert('PPT URL cannot be empty.');
                        return;
                    }
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/ppt`, {
                            method: 'PUT',
                            body: { ppt_url: trimmed },
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to save PPT URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-ppt-remove]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-ppt-remove');
                    if (!topicId) return;
                    const ok = window.confirm('Remove the PPT URL for this topic?');
                    if (!ok) return;
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/ppt`, {
                            method: 'DELETE',
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to remove PPT URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-lab-upload]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-lab-upload');
                    if (!topicId) return;
                    const current = btn.getAttribute('data-current-url') || '';
                    const value = window.prompt('Enter Lab URL for this topic:', current);
                    if (value === null) return;
                    const trimmed = (value || '').trim();
                    if (!trimmed) {
                        alert('Lab URL cannot be empty.');
                        return;
                    }
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/lab`, {
                            method: 'PUT',
                            body: { lab_url: trimmed },
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to save Lab URL.');
                    }
                });
            });

            results.querySelectorAll('[data-topic-lab-remove]').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const topicId = btn.getAttribute('data-topic-lab-remove');
                    if (!topicId) return;
                    const ok = window.confirm('Remove the Lab URL for this topic?');
                    if (!ok) return;
                    try {
                        await Collage.fetchJson(`/api/syllabus/topics/${topicId}/lab`, {
                            method: 'DELETE',
                            skipAuth: true,
                        });
                        await loadSyllabus();
                    } catch (err) {
                        console.error(err);
                        alert(err?.message || 'Unable to remove Lab URL.');
                    }
                });
            });
        }

        function attachUnitEditHandlers() {
            results.querySelectorAll('[data-unit-edit]').forEach(btn => {
                btn.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = btn.getAttribute('data-unit-edit');
                    const u = (syllabusCourse?.units || []).find(x => String(x.id) === String(id));
                    if (u) {
                        syllabusCourse.editingUnitId = u.id;
                        // Normalize topic field to 'topic' for editing convenience
                        const normalizedTopics = (u.topics || []).map(t => ({ topic: t.topic || t.topic_title || '' }));
                        openUnitModal('edit', { unit_title: u.unit_title, topics: normalizedTopics });
                    }
                });
            });
        }

        async function loadSyllabus() {
            if (!courseId) {
                showError('Missing courseId.');
                return;
            }
            showLoader();
            try {
                // Correct endpoint: backend provides full course (with units & topics) at /api/syllabus/courses/{course_id}
                const data = await Collage.fetchJson(`/api/syllabus/courses/${courseId}`, { skipAuth: true });
                // Expected shape (SyllabusCourseOut): { id, batch_id, semester, course_code, title, units:[{id,unit_title,topics:[{id,topic_title,...}]}] }
                if (!data || data.detail === 'Course not found') {
                    showError('Syllabus course not found.');
                    return;
                }
                syllabusCourse = {
                    id: data.id,
                    course_code: data.course_code,
                    title: data.title,
                    semester: data.semester,
                    units: Array.isArray(data.units) ? data.units : []
                };
                titleEl.innerHTML = `Subject syllabus <span class="opacity-70">· ${Collage.escapeHtml(courseCode || '')}</span>`;
                subtitleEl.textContent = `${syllabusCourse.units.length} unit${syllabusCourse.units.length === 1 ? '' : 's'} defined.`;
                breadcrumbsEl.innerHTML = makeBreadcrumb([
                    { label: 'Colleges', href: 'clg_info.html' },
                    { label: collegeName || 'College', href: `degrees.html?collegeId=${encodeURIComponent(params.collegeId || '')}&collegeName=${encodeURIComponent(collegeName || '')}` },
                    { label: degreeName || 'Degree', href: `departments.html?collegeId=${encodeURIComponent(params.collegeId || '')}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(params.degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}` },
                    { label: departmentName || 'Department', href: `batches.html?collegeId=${encodeURIComponent(params.collegeId || '')}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(params.degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}&departmentName=${encodeURIComponent(departmentName || '')}` },
                    { label: 'Subjects', href: `subjects.html?collegeId=${encodeURIComponent(params.collegeId || '')}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(params.degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}&departmentName=${encodeURIComponent(departmentName || '')}&batchRange=${encodeURIComponent(batchRange || '')}` },
                    { label: courseCode || 'Syllabus' }
                ]);
                renderContext();
                addUnitBtn.disabled = false;
                // Update back link with full subjects context
                if (backLink) {
                    const subjectsUrl = `subjects.html?collegeId=${encodeURIComponent(params.collegeId || '')}&collegeName=${encodeURIComponent(collegeName || '')}&degreeId=${encodeURIComponent(params.degreeId || '')}&degreeName=${encodeURIComponent(degreeName || '')}&departmentName=${encodeURIComponent(departmentName || '')}&batchId=${encodeURIComponent(batchId || '')}&batchRange=${encodeURIComponent(batchRange || '')}`;
                    backLink.setAttribute('href', subjectsUrl);
                }
            } catch (err) {
                console.error(err);
                showError(err.message || 'Unexpected error');
            }

            renderUnits(syllabusCourse.units || []);
        }

        addUnitBtn.addEventListener('click', () => openUnitModal('add'));
        document.addEventListener('DOMContentLoaded', () => { loadSyllabus(); });
    </script>
    <script>
        // Theme
        const root = document.documentElement;
        const themeBtns = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));

        function updateThemeIcons(mode) {
            themeBtns().forEach(b => {
                const ic = b.querySelector('.material-symbols-rounded');
                if (ic) ic.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode';
            });
        }

        function setTheme(mode) {
            if (mode === 'dark') root.classList.add('dark');
            else root.classList.remove('dark');
            localStorage.setItem('px_theme', mode);
            updateThemeIcons(mode);
        }
        setTheme(root.classList.contains('dark') ? 'dark' : 'light');
        document.addEventListener('click', e => {
            const t = e.target.closest('[data-theme-toggle]');
            if (!t) return;
            const next = root.classList.contains('dark') ? 'light' : 'dark';
            setTheme(next);
        });
    </script>
    <script>
        // Mobile nav
        (function () {
            const toggle = document.getElementById('mobileNavToggle');
            const panel = document.getElementById('mobileNavPanel');
            const backdrop = document.getElementById('mobileNavBackdrop');
            if (!toggle || !panel || !backdrop) return;
            const icon = toggle.querySelector('[data-icon]');
            const focusable = 'a[href],button:not([disabled])';

            function openMenu() {
                panel.setAttribute('data-open', 'true');
                panel.classList.add('open');
                panel.setAttribute('aria-hidden', 'false');
                backdrop.setAttribute('data-open', 'true');
                backdrop.classList.add('open');
                backdrop.setAttribute('aria-hidden', 'false');
                toggle.setAttribute('aria-expanded', 'true');
                if (icon) icon.textContent = 'close';
                document.body.classList.add('overflow-hidden');
                const f = panel.querySelector(focusable);
                if (f) f.focus();
            }

            function closeMenu() {
                panel.removeAttribute('data-open');
                panel.classList.remove('open');
                panel.setAttribute('aria-hidden', 'true');
                backdrop.removeAttribute('data-open');
                backdrop.classList.remove('open');
                backdrop.setAttribute('aria-hidden', 'true');
                toggle.setAttribute('aria-expanded', 'false');
                if (icon) icon.textContent = 'menu';
                document.body.classList.remove('overflow-hidden');
            }

            function toggleMenu() {
                const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                (isOpen ? closeMenu : openMenu)();
            }

            toggle.addEventListener('click', toggleMenu);
            backdrop.addEventListener('click', closeMenu);
            panel.addEventListener('click', e => { if (e.target.closest('[data-close-mobile-nav]')) closeMenu(); });
            window.addEventListener('keydown', e => { if (e.key === 'Escape') closeMenu(); });
            window.matchMedia('(min-width:768px)').addEventListener('change', e => { if (e.matches) closeMenu(); });
        })();
    </script>
</body>

</html>