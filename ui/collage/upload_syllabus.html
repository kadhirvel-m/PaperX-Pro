<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paper X â€” Upload Syllabus</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
    rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/tailwind.css" />
  <script>
    try {
      if (window.tailwind) {
        window.tailwind.config = {
          darkMode: 'class',
          theme: {
            container: { center: true, padding: '1rem' },
            extend: {
              fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
              colors: {
                brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                brandlt: { 50: '#FAF5FB', 100: '#F3E7F2', 200: '#E7D0E4', 300: '#D9B4D3', 400: '#C88DBA', 500: '#9E4B8A', 700: '#4C2A59', 900: '#1E1E2F' }
              },
              boxShadow: {
                glow: '0 8px 30px rgba(158,75,138,0.35)',
                soft: '0 24px 60px rgba(30,30,47,0.25)'
              },
              backgroundImage: {
                'hero-light': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg,#FFFFFF 0%,#FBF8FC 45%,#F7F2F9 100%)',
                'hero-dark': 'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg,#1E1E2F 0%,#201934 35%,#141321 100%)'
              }
            }
          }
        };
      }
    } catch (_) { }
  </script>
  <style>
    .material-symbols-rounded {
      vertical-align: -6px
    }

    .gradient-hero-text {
      background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
      background-size: 200% 200%;
      animation: gradient-shift 4s ease-in-out infinite;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text
    }

    .dark .gradient-hero-text {
      background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC)
    }

    @keyframes gradient-shift {
      0% {
        background-position: 0% 50%
      }

      50% {
        background-position: 100% 50%
      }

      100% {
        background-position: 0% 50%
      }
    }
  </style>
  <script>
    (() => {
      const s = localStorage.getItem('px_theme');
      const p = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const d = s ? s === 'dark' : p;
      if (d) document.documentElement.classList.add('dark');
    })();
  </script>
  <script src="../config.js" defer></script>
  <script src="helpers.js" defer></script>
</head>

<body
  class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">
  <header
    class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10">
    <div class="container flex items-center justify-between py-4">
      <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
        <img src="../assets/img/logo-light.svg" class="h-10 w-auto dark:hidden" alt="Paper X" />
        <img src="../assets/img/logo-dark.svg" class="h-10 w-auto hidden dark:block" alt="Paper X" />
      </a>
      <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
        <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../index.html">Home</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../about.html">About</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../contact.html">Contact</a>
        <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../help.html">Help</a>
        <a id="navCollages"
          class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
          href="clg_info.html"><span>Collages</span><span class="material-symbols-rounded text-base">hub</span></a>
      </nav>
      <div class="hidden md:flex items-center gap-2">
        <button data-theme-toggle
          class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
          aria-label="Toggle theme"><span class="material-symbols-rounded">dark_mode</span><span
            class="hidden sm:block">Theme</span></button>
      </div>
    </div>
  </header>

  <main>
    <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10">
      <div class="relative container max-w-5xl py-8">
        <nav id="breadcrumbs"
          class="flex flex-wrap items-center gap-2 text-xs md:text-sm font-medium text-neutral-500 dark:text-white/70"
          aria-label="Breadcrumb"></nav>
        <div class="mt-4 space-y-2">
          <h1 class="text-2xl md:text-4xl font-bold gradient-hero-text">Upload Syllabus</h1>
          <p id="subtitle" class="text-neutral-600 dark:text-white/65">Upload a PDF syllabus to parse and save units &
            topics.</p>
          <p id="batchMeta" class="text-sm text-neutral-600 dark:text-white/65"></p>
        </div>
      </div>
    </section>

    <section class="py-12">
      <div class="container max-w-3xl">
        <form id="uploadForm"
          class="grid gap-5 rounded-3xl border border-black/5 dark:border-white/10 bg-white/85 dark:bg-white/5 backdrop-blur p-6">
          <div class="grid gap-1">
            <label class="text-sm font-medium">Syllabus PDF <span class="text-red-500">*</span></label>
            <input id="file" type="file" accept="application/pdf" required
              class="block w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/90 dark:bg-white/10 px-3.5 py-2.5 text-sm" />
            <p class="text-xs text-neutral-500 dark:text-white/50">Only PDF is supported.</p>
          </div>
          <!-- Bulk upload: course code/title will be detected per subject -->
          <div class="grid gap-1 sm:grid-cols-2 sm:gap-4">
            <label class="grid gap-1">
              <span class="text-sm font-medium">Semester</span>
              <input id="semester" type="number" min="1" max="12" placeholder="1-12" required
                class="mt-1 rounded-2xl border border-black/10 dark:border-white/15 bg-white/90 dark:bg-white/10 px-3.5 py-2.5 text-sm" />
            </label>
            <div class="grid items-end">
              <p class="text-xs text-neutral-500 dark:text-white/50">Upload full semester PDF containing multiple
                subjects. We will detect and save them all.</p>
            </div>
          </div>
          <div id="status" class="hidden text-sm"></div>
          <div class="flex items-center gap-3">
            <a id="backBtn" href="subjects.html"
              class="inline-flex items-center gap-2 rounded-full border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-4 py-2 text-sm text-neutral-700 dark:text-white/80">Cancel</a>
            <button id="submitBtn" type="submit"
              class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_10px_28px_rgba(158,75,138,0.35)] hover:shadow-[0_14px_34px_rgba(158,75,138,0.45)] transition">
              <span class="material-symbols-rounded text-base">cloud_upload</span>
              Upload & Parse
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <script>
    const Q = (window.Collage && Collage.parseQuery) ? Collage.parseQuery() : {};
    let API = (window.API_BASE || (window.Collage && Collage.API_BASE) || '').replace(/\/$/, '');
    // Resolve a working API base by probing the upload info endpoint
    async function resolveApiBase() {
      const candidates = [];
      if (API) candidates.push(API);
      try { const ls = localStorage.getItem('API_BASE'); if (ls) candidates.push(ls.replace(/\/$/, '')); } catch (_) { }
      candidates.push('http://127.0.0.1:8000');
      const tried = new Set();
      for (const base of candidates) {
        if (!base || tried.has(base)) continue;
        tried.add(base);
        try {
          const r = await fetch(base.replace(/\/$/, '') + '/api/syllabus/upload', { method: 'GET' });
          if (r.ok) return base.replace(/\/$/, '');
          // Some setups may return 200 with text/html; still accept
          if (r.status === 200) return base.replace(/\/$/, '');
        } catch (_) { }
      }
      return API || 'http://127.0.0.1:8000';
    }
    function readStoredCtx() {
      try { const s = sessionStorage.getItem('px_ctx_batches'); if (s) return JSON.parse(s); } catch (_) { }
      try { const l = localStorage.getItem('px_ctx_batches_last'); if (l) return JSON.parse(l); } catch (_) { }
      return {};
    }
    const stored = readStoredCtx();

    const el = id => document.getElementById(id);
    const fileEl = el('file');
    // Bulk mode: code/title hints not used
    const codeEl = { value: '' };
    const titleEl = { value: '' };
    const semEl = el('semester');
    const formEl = el('uploadForm');
    const statusEl = el('status');
    const submitBtn = el('submitBtn');
    const breadcrumbsEl = el('breadcrumbs');
    const batchMeta = el('batchMeta');
    const backBtn = el('backBtn');

    const batchId = Q.batchId || stored.batchId || '';
    const collegeName = (Q.collegeName || stored.collegeName || '').toString();
    const degreeName = (Q.degreeName || stored.degreeName || '').toString();
    const departmentName = (Q.departmentName || stored.departmentName || '').toString();
    const batchRange = (Q.batchRange || stored.batchRange || '').toString();

    function breadcrumb(items) {
      const esc = s => (Collage && Collage.escapeHtml) ? Collage.escapeHtml(s) : s.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
      return items.map((it, i) => it.href && i !== items.length - 1 ? `<a href="${it.href}">${esc(it.label)}</a>` : `<span>${esc(it.label)}</span>`).join('<span class="material-symbols-rounded">chevron_right</span>');
    }

    function setStatus(text, type) {
      statusEl.textContent = text || '';
      statusEl.classList.remove('hidden', 'text-red-500', 'text-green-600', 'text-neutral-600');
      statusEl.classList.add(type === 'error' ? 'text-red-500' : (type === 'ok' ? 'text-green-600' : 'text-neutral-600'));
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // pick a working API base and reflect it in UI
      const resolved = await resolveApiBase();
      if (resolved && resolved !== API) {
        API = resolved;
        try { localStorage.setItem('API_BASE', API); } catch (_) { }
        console.debug('[upload] Using API_BASE:', API);
      }
      const backUrl = `subjects.html?collegeId=${encodeURIComponent(Q.collegeId || stored.collegeId || '')}&collegeName=${encodeURIComponent(collegeName)}&degreeId=${encodeURIComponent(Q.degreeId || stored.degreeId || '')}&degreeName=${encodeURIComponent(degreeName)}&departmentId=${encodeURIComponent(Q.departmentId || stored.departmentId || '')}&departmentName=${encodeURIComponent(departmentName)}&batchId=${encodeURIComponent(batchId)}&batchRange=${encodeURIComponent(batchRange)}`;
      breadcrumbsEl.innerHTML = breadcrumb([
        { label: 'Collages', href: 'clg_info.html' },
        { label: collegeName || 'College' },
        { label: degreeName || 'Degree' },
        { label: departmentName || 'Department' },
        { label: 'Subjects', href: backUrl },
        { label: 'Upload Syllabus' }
      ]);
      batchMeta.textContent = batchRange ? `Batch ${batchRange}` : '';
      backBtn.setAttribute('href', backUrl);

      async function postUpload({ preferNaive = false, timeoutMs = 90000 } = {}) {
        const ctrl = new AbortController();
        const timer = setTimeout(() => { try { ctrl.abort(); } catch (_) { } }, timeoutMs);
        const fd = new FormData();
        fd.append('file', fileEl.files[0]);
        fd.append('batch_id', batchId);
        // bulk: no course_code/title
        if (semEl.value) fd.append('semester', semEl.value.trim());
        if (preferNaive) fd.append('prefer_naive', '1');
        const url = API.replace(/\/$/, '') + '/api/syllabus/upload-bulk';
        let res;
        try {
          res = await fetch(url, { method: 'POST', body: fd, signal: ctrl.signal });
        } finally {
          clearTimeout(timer);
        }
        return res;
      }

      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!batchId) { setStatus('Missing batch context.', 'error'); return; }
        const f = fileEl.files && fileEl.files[0];
        if (!f) { setStatus('Please choose a PDF file.', 'error'); return; }
        if (f.type !== 'application/pdf' && !f.name.toLowerCase().endsWith('.pdf')) {
          setStatus('Only PDF files are supported.', 'error'); return;
        }
        const semVal = (semEl.value || '').trim();
        if (!semVal) { setStatus('Enter the semester (1-12).', 'error'); semEl.focus(); return; }
        const semNum = Number(semVal);
        if (Number.isNaN(semNum) || semNum < 1 || semNum > 12) {
          setStatus('Semester must be between 1 and 12.', 'error');
          semEl.focus();
          return;
        }

        setStatus('Uploading and parsing bulk syllabus…', 'info');
        try {
          let res;
          try {
            res = await postUpload({ preferNaive: false, timeoutMs: 90000 });
          } catch (err) {
            if (err && (err.name === 'AbortError' || String(err).includes('aborted'))) {
              setStatus('Still working… Retrying with heuristic parsing.', 'info');
              res = await postUpload({ preferNaive: true, timeoutMs: 90000 });
            } else {
              throw err;
            }
          }
          if (!res.ok) {
            let msg = res.statusText;
            try { const j = await res.json(); msg = j.detail || j.message || msg; } catch (_) { }
            throw new Error(msg || `Upload failed (${res.status})`);
          }
          const data = await res.json();
          const count = Array.isArray(data) ? data.length : (data ? 1 : 0);
          setStatus(`Parsed and saved ${count} subject${count === 1 ? '' : 's'}.`, 'ok');
          try { sessionStorage.setItem('px_flash', `Added ${count} subject${count === 1 ? '' : 's'} for semester ${encodeURIComponent(semVal)}`); } catch (_) { }
          const backUrl2 = `subjects.html?collegeId=${encodeURIComponent(Q.collegeId || stored.collegeId || '')}&collegeName=${encodeURIComponent(collegeName)}&degreeId=${encodeURIComponent(Q.degreeId || stored.degreeId || '')}&degreeName=${encodeURIComponent(degreeName)}&departmentId=${encodeURIComponent(Q.departmentId || stored.departmentId || '')}&departmentName=${encodeURIComponent(departmentName)}&batchId=${encodeURIComponent(batchId)}&batchRange=${encodeURIComponent(batchRange)}`;
          setTimeout(() => { window.location.href = backUrl2; }, 900);
        } catch (err) {
          console.error(err);
          if (err && (err.name === 'AbortError' || String(err).toLowerCase().includes('aborted'))) {
            setStatus('Upload timed out. Please try again.', 'error');
          } else {
            setStatus(err.message || 'Failed to upload/parse syllabus.', 'error');
          }
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  </script>

  <script>
    // Theme toggle
    const root = document.documentElement;
    const themeBtns = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
    function updateThemeIcons(mode) { themeBtns().forEach(b => { const ic = b.querySelector('.material-symbols-rounded'); if (ic) ic.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode'; }); }
    function setTheme(mode) { if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem('px_theme', mode); updateThemeIcons(mode); }
    setTheme(root.classList.contains('dark') ? 'dark' : 'light');
    document.addEventListener('click', e => { const t = e.target.closest('[data-theme-toggle]'); if (!t) return; const next = root.classList.contains('dark') ? 'light' : 'dark'; setTheme(next); });
  </script>
</body>

</html>