<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Paper X — College Directory</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/favicon.svg">

    <!-- Inter + Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,600,0,0"
        rel="stylesheet">

    <!-- Tailwind (forms/typography/aspect-ratio) -->
    <link rel="stylesheet" href="../assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'] },
                    colors: {
                        brand: { 900: '#1E1E2F', 700: '#4C2A59', 500: '#9E4B8A' },
                        brandlt: {
                            50: '#FAF5FB',
                            100: '#F3E7F2',
                            200: '#E7D0E4',
                            300: '#D9B4D3',
                            400: '#C88DBA',
                            500: '#9E4B8A',
                            700: '#4C2A59',
                            900: '#1E1E2F'
                        },
                        ink: '#1E1E2F',
                        plum: '#4C2A59',
                        orchid: '#9E4B8A'
                    },
                    boxShadow: {
                        glow: '0 8px 30px rgba(158,75,138,0.35)',
                        soft: '0 20px 44px rgba(30,30,47,0.2)'
                    },
                    backgroundImage: {
                        'hero-light':
                            'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.18), transparent 60%), linear-gradient(180deg, #FFFFFF 0%, #FBF8FC 45%, #F7F2F9 100%)',
                        'hero-dark':
                            'radial-gradient(1000px 600px at 50% -10%, rgba(158,75,138,0.28), transparent 60%), linear-gradient(180deg, #1E1E2F 0%, #201934 35%, #141321 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        .material-symbols-rounded {
            vertical-align: -6px;
        }

        .gradient-hero-text {
            display: inline-block;
            background-image: linear-gradient(90deg, #1E1E2F, #4C2A59, #9E4B8A, #4C2A59, #1E1E2F);
            background-size: 200% 200%;
            animation: gradient-shift 4s ease-in-out infinite;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dark .gradient-hero-text {
            background-image: linear-gradient(90deg, #EFA3DC, #CA6CB3, #FFFFFF, #CA6CB3, #EFA3DC);
        }

        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .hero-aurora::before {
            content: "";
            position: absolute;
            inset: -30% -5% auto -30%;
            height: 420px;
            background: radial-gradient(circle at top, rgba(158, 75, 138, 0.45), transparent 60%);
            filter: blur(60px);
            opacity: 0.65;
            pointer-events: none;
        }

        .hero-aurora::after {
            content: "";
            position: absolute;
            inset: auto -25% -35% 30%;
            height: 380px;
            background: radial-gradient(circle at bottom, rgba(76, 42, 89, 0.45), transparent 60%);
            filter: blur(60px);
            opacity: 0.55;
            pointer-events: none;
        }

        .dark .hero-aurora::before {
            opacity: 0.75;
        }

        .dark .hero-aurora::after {
            opacity: 0.75;
        }

        #mobileNavBackdrop {
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }

        #mobileNavPanel {
            opacity: 0;
            transform: translateY(-12px);
            pointer-events: none;
            transition: opacity .25s ease, transform .25s ease;
        }

        #mobileNavBackdrop[data-open="true"],
        #mobileNavBackdrop.open {
            opacity: 1;
            pointer-events: auto;
        }

        #mobileNavPanel[data-open="true"],
        #mobileNavPanel.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .dark body {
            background-image: linear-gradient(to left top,
                    #1e1e2f,
                    #242138,
                    #2b2440,
                    #332649,
                    #3d2850,
                    #3f254a,
                    #402244,
                    #401f3e,
                    #34182d,
                    #26131e,
                    #190b11,
                    #000000);
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>

    <script>
            (() => {
                const stored = localStorage.getItem('px_theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = stored ? stored === 'dark' : prefersDark;
                if (isDark) document.documentElement.classList.add('dark');
            })();
    </script>

    <script src="../config.js" defer></script>
    <script src="helpers.js" defer></script>
</head>

<body
    class="min-h-screen font-sans antialiased text-neutral-900 dark:text-white bg-hero-light dark:bg-hero-dark transition-colors">

    <!-- Navbar -->
    <header
        class="sticky top-0 z-40 bg-white/70 dark:bg-brand-900/60 backdrop-blur supports-[backdrop-filter]:saturate-150 border-b border-black/5 dark:border-white/10 relative">
        <div class="container flex items-center justify-between py-4">
            <a href="../index.html" class="flex items-center gap-3" aria-label="Paper X Home">
                <img src="../assets/img/logo-light.svg" alt="Paper X" class="h-10 w-auto dark:hidden">
                <img src="../assets/img/logo-dark.svg" alt="Paper X" class="h-10 w-auto hidden dark:block">
            </a>
            <nav class="hidden md:flex items-center gap-6 text-sm text-neutral-700 dark:text-white/85">
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../index.html">Home</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../about.html">About</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../contact.html">Contact</a>
                <a class="hover:text-brandlt-900 dark:hover:text-white transition" href="../help.html">Help</a>
                <a class="inline-flex items-center gap-1 rounded-full bg-brandlt-200/70 px-3 py-1.5 text-brand-700 dark:bg-white/10 dark:text-white"
                    href="clg_info.html" aria-current="page">
                    <span>Collages</span>
                    <span class="material-symbols-rounded text-base">auto_awesome</span>
                </a>
            </nav>
            <div class="hidden md:flex items-center gap-2">
                <button data-theme-toggle
                    class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition"
                    aria-label="Toggle theme">
                    <span class="material-symbols-rounded">dark_mode</span>
                    <span class="hidden sm:block">Theme</span>
                </button>
                <a href="../login.html"
                    class="text-sm text-neutral-700 dark:text-white/85 hover:text-brandlt-900 dark:hover:text-white px-3 py-2 rounded-full transition">
                    Log in
                </a>
                <a href="../signup.html"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 text-white text-sm font-semibold px-4 py-2.5 hover:shadow-glow transition">
                    Sign up
                </a>
            </div>
            <div class="md:hidden flex items-center gap-2">
                <button type="button" data-theme-toggle aria-label="Toggle theme"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="material-symbols-rounded">dark_mode</span>
                </button>
                <button id="mobileNavToggle" type="button" aria-expanded="false" aria-controls="mobileNavPanel"
                    class="inline-flex items-center justify-center size-10 rounded-full ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/5 transition">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="material-symbols-rounded" data-icon>menu</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile navigation (drawer) -->
    <div id="mobileNavBackdrop" aria-hidden="true"
        class="md:hidden fixed inset-0 z-40 bg-black/60 dark:bg-black/80 backdrop-blur-sm"></div>
    <nav id="mobileNavPanel" aria-hidden="true"
        class="md:hidden fixed inset-x-4 top-24 z-50 flex flex-col gap-5 max-h-[calc(100vh-6.5rem)] overflow-y-auto rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_1.5rem_4rem_-1.5rem_rgba(30,30,47,0.75)] backdrop-blur supports-[backdrop-filter]:backdrop-blur-xl p-6">
        <div class="flex flex-col gap-2 text-sm text-neutral-700 dark:text-white/80">
            <a href="../index.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Home</a>
            <a href="../about.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">About</a>
            <a href="../contact.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Contact</a>
            <a href="../help.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 hover:bg-brandlt-100/70 hover:dark:bg-brand-700/20 transition">Help</a>
            <a href="clg_info.html" data-close-mobile-nav
                class="rounded-xl px-3 py-2 bg-brandlt-200/70 dark:bg-white/10 text-brand-700 dark:text-white transition">
                Collages
            </a>
        </div>
        <div class="flex flex-col gap-3 border-t border-black/5 dark:border-white/10 pt-4">
            <a href="../login.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-medium ring-1 ring-black/10 dark:ring-white/15 text-neutral-700 dark:text-white/80 hover:bg-black/5 dark:hover:bg-white/10 transition">
                Log in
            </a>
            <a href="../signup.html" data-close-mobile-nav
                class="inline-flex items-center justify-center rounded-full px-5 py-3 text-sm font-semibold text-white bg-gradient-to-r from-[#9E4B8A] via-[#B06AB3] to-[#FF7FD1] shadow-[0_4px_18px_-6px_rgba(158,75,138,0.6)] hover:shadow-[0_6px_24px_-8px_rgba(158,75,138,0.7)] transition">
                Sign up
            </a>
        </div>
    </nav>

    <main>
        <!-- Hero -->
        <section class="relative overflow-hidden border-b border-black/5 dark:border-white/10 hero-aurora">
            <div aria-hidden="true" class="absolute inset-0">
                <div class="absolute -top-32 right-0 h-72 w-72 rounded-full bg-brand-500/20 blur-3xl dark:blur-[90px]">
                </div>
                <div class="absolute top-24 -left-32 h-80 w-80 rounded-full bg-brand-700/20 blur-3xl dark:blur-[90px]">
                </div>
            </div>
            <div class="relative container max-w-6xl py-5 md:py-7">
                <div class="lg:grid lg:grid-cols-2 lg:gap-12 items-start">
                    <!-- Left content -->
                    <div>
                        <div class="max-w-3xl space-y-6">
                            <h1 class="text-2xl md:text-4xl font-extrabold leading-tight gradient-hero-text">
                                Orchestrate every college from one console.
                            </h1>
                            <p class="text-lg md:text-xl text-neutral-600 dark:text-white/70">
                                Curate your entire academic hierarchy, from colleges to syllabi, using the same
                                futuristic
                                experience that powers the Paper X marketing site.
                            </p>
                        </div>
                        <div class="mt-8 flex flex-col gap-3 sm:flex-row sm:items-center">
                            <button id="addCollegeBtn" type="button"
                                class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-6 py-3 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">
                                <span class="material-symbols-rounded text-base">add</span>
                                Add college
                            </button>
                            <a href="../help.html#collage"
                                class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 text-sm font-medium text-neutral-700 dark:text-white/75 ring-1 ring-black/10 dark:ring-white/15 hover:bg-black/5 dark:hover:bg-white/10 transition">
                                <span class="material-symbols-rounded text-base">lightbulb</span>
                                Bulk import playbook
                            </a>
                        </div>
                    </div>
                    <!-- Right media -->
                    <div class="mt-14 lg:mt-0 relative">
                        <div
                            class="relative group rounded-3xl overflow-hidden ring-1 ring-black/10 dark:ring-white/10 shadow-soft bg-black/5 dark:bg-white/5 h-44 sm:h-50 md:h-44 xl:h-60">
                            <video class="w-full h-full object-cover" autoplay muted loop playsinline
                                poster="../assets/img/placeholder-video.jpg">
                                <source src="../assets/video/collage/clg.mp4" type="video/mp4" />
                                Your browser does not support the video tag.
                            </video>
                            <div
                                class="pointer-events-none absolute inset-0 bg-gradient-to-tr from-brand-500/10 via-transparent to-brand-700/10 mix-blend-overlay">
                            </div>
                        </div>
                        <p class="mt-3 text-xs text-neutral-500 dark:text-white/50">A live glimpse of the unified
                            console experience.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Directory section -->
        <section class="py-4">
            <div class="container max-w-6xl">
                <div id="results" class="mt-10 grid gap-6 sm:grid-cols-2 xl:grid-cols-3"></div>
            </div>
        </section>
    </main>

    <!-- Modal -->
    <div id="collegeModal"
        class="fixed inset-0 z-50 hidden flex items-center justify-center px-4 py-12 sm:px-6 lg:px-8">
        <div id="collegeModalBackdrop" class="absolute inset-0 bg-brand-900/70 dark:bg-black/70 backdrop-blur-sm"></div>
        <div
            class="relative w-full max-w-xl rounded-3xl border border-black/10 dark:border-white/10 bg-white/95 dark:bg-brand-900/95 shadow-[0_24px_60px_rgba(30,30,47,0.45)]">
            <div class="flex items-start justify-between gap-4 border-b border-black/5 dark:border-white/10 px-6 py-5">
                <div>
                    <h2 id="collegeModalTitle" class="text-xl font-semibold text-neutral-900 dark:text-white">Add a new
                        college</h2>
                    <p class="mt-1 text-sm text-neutral-600 dark:text-white/65">Provide the exact label that should
                        appear
                        throughout the navigator.</p>
                </div>
                <button id="collegeModalClose" type="button"
                    class="rounded-full border border-transparent p-2 text-neutral-500 hover:text-brand-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/60">
                    <span class="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
            <form id="collegeForm" class="space-y-5 px-6 py-6">
                <div class="grid gap-6 md:grid-cols-3 items-start">
                    <label class="block text-sm font-medium text-neutral-700 dark:text-white/85 md:col-span-2">
                        College name
                        <input id="collegeName" name="name" type="text" required
                            class="mt-2 w-full rounded-2xl border border-black/10 dark:border-white/15 bg-white/80 dark:bg-white/5 px-3.5 py-2.5 text-sm text-neutral-900 dark:text-white focus:border-brand-500 focus:outline-none focus:ring-2 focus:ring-brand-500/40"
                            placeholder="e.g. Mannakul Vinayagar Institute of Technology" />
                    </label>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-neutral-700 dark:text-white/85">Logo
                            <input id="collegeLogo" type="file" accept="image/png,image/jpeg,image/webp,image/svg+xml"
                                class="mt-2 block w-full text-xs file:mr-3 file:rounded-full file:border-0 file:bg-brand-500 file:px-3 file:py-1.5 file:text-white file:text-xs hover:file:bg-brand-700 cursor-pointer" />
                        </label>
                        <img id="collegeLogoPreview"
                            class="hidden w-20 h-20 rounded-xl object-cover ring-1 ring-black/10 dark:ring-white/15 bg-white/40 dark:bg-white/10"
                            alt="Logo preview" />
                        <p class="text-[10px] text-neutral-500 dark:text-white/40">PNG/JPG/WEBP/SVG • Optional</p>
                        <button type="button" id="changeLogoBtn"
                            class="hidden text-xs text-brand-500 hover:text-brand-700 dark:text-white/70 underline">Change
                            logo</button>
                        <button type="button" id="uploadLogoNowBtn"
                            class="hidden mt-1 inline-flex items-center gap-1 rounded-full bg-brand-500 text-white px-3 py-1.5 text-[11px] font-medium shadow hover:bg-brand-700 transition">
                            <span class="material-symbols-rounded text-[16px]">cloud_upload</span>
                            Upload logo
                        </button>
                    </div>
                </div>
                <p id="collegeModalMessage" class="hidden text-sm text-red-500"></p>
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <button id="collegeDeleteBtn" type="button"
                        class="hidden inline-flex items-center justify-center gap-2 rounded-full border border-red-300/60 bg-red-50 text-red-700 dark:bg-red-500/10 dark:text-red-200 px-4 py-2 text-sm font-medium hover:border-red-400/80 transition">
                        <span class="material-symbols-rounded text-base">delete</span>
                        Delete
                    </button>
                    <div class="flex items-center gap-3 ml-auto">
                        <button id="collegeModalCancel" type="button"
                            class="inline-flex items-center justify-center rounded-full border border-black/10 dark:border-white/15 px-4 py-2 text-sm font-medium text-neutral-600 dark:text-white/70 hover:border-brand-500/50 transition">
                            Cancel
                        </button>
                        <button id="collegeSubmitBtn" type="submit"
                            class="inline-flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-brand-500 via-[#B06AB3] to-[#FF7FD1] px-5 py-2.5 text-sm font-semibold text-white shadow-[0_12px_30px_rgba(158,75,138,0.35)] hover:shadow-[0_16px_36px_rgba(158,75,138,0.45)] transition">
                            <span class="material-symbols-rounded text-base">save</span>
                            Save college
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <footer class="border-t border-black/5 dark:border-white/10 py-10">
        <div
            class="container flex flex-col gap-3 text-sm text-neutral-500 dark:text-white/60 sm:flex-row sm:items-center sm:justify-between">
            <p>© <span id="y"></span> Paper X · College Console.</p>
            <div class="flex flex-wrap items-center gap-4">
                <a href="../about.html" class="hover:text-brand-500 dark:hover:text-white transition">About</a>
                <a href="../help.html" class="hover:text-brand-500 dark:hover:text-white transition">Help centre</a>
                <a href="../contact.html" class="hover:text-brand-500 dark:hover:text-white transition">Contact</a>
            </div>
        </div>
    </footer>

    <script>
        const y = document.getElementById('y');
        if (y) y.textContent = new Date().getFullYear();

        const root = document.documentElement;
        const themeToggles = () => Array.from(document.querySelectorAll('[data-theme-toggle]'));
        const updateToggleIcons = (mode) => {
            themeToggles().forEach(btn => {
                const icon = btn.querySelector('.material-symbols-rounded');
                if (icon) icon.textContent = mode === 'dark' ? 'light_mode' : 'dark_mode';
            });
        };
        const setTheme = (mode) => {
            if (mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
            localStorage.setItem('px_theme', mode);
            updateToggleIcons(mode);
        };
        setTheme(root.classList.contains('dark') ? 'dark' : 'light');
        document.addEventListener('click', (e) => {
            const trigger = e.target.closest('[data-theme-toggle]');
            if (!trigger) return;
            const next = root.classList.contains('dark') ? 'light' : 'dark';
            setTheme(next);
        });
    </script>
    <script>
        (function () {
            const toggle = document.getElementById('mobileNavToggle');
            const panel = document.getElementById('mobileNavPanel');
            const backdrop = document.getElementById('mobileNavBackdrop');
            if (!toggle || !panel || !backdrop) return;

            const icon = toggle.querySelector('[data-icon]');
            const focusableSelector = 'a[href], button:not([disabled])';

            const openMenu = () => {
                panel.setAttribute('data-open', 'true');
                panel.classList.add('open');
                panel.setAttribute('aria-hidden', 'false');
                backdrop.setAttribute('data-open', 'true');
                backdrop.classList.add('open');
                backdrop.setAttribute('aria-hidden', 'false');
                toggle.setAttribute('aria-expanded', 'true');
                if (icon) icon.textContent = 'close';
                document.body.classList.add('overflow-hidden');
                const first = panel.querySelector(focusableSelector);
                if (first) first.focus();
            };

            const closeMenu = () => {
                panel.removeAttribute('data-open');
                panel.classList.remove('open');
                panel.setAttribute('aria-hidden', 'true');
                backdrop.removeAttribute('data-open');
                backdrop.classList.remove('open');
                backdrop.setAttribute('aria-hidden', 'true');
                toggle.setAttribute('aria-expanded', 'false');
                if (icon) icon.textContent = 'menu';
                document.body.classList.remove('overflow-hidden');
                toggle.focus();
            };

            const toggleMenu = () => {
                const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                (isOpen ? closeMenu : openMenu)();
            };

            toggle.addEventListener('click', toggleMenu);
            backdrop.addEventListener('click', closeMenu);
            panel.addEventListener('click', (evt) => {
                if (evt.target.closest('[data-close-mobile-nav]')) {
                    closeMenu();
                }
            });

            window.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape') closeMenu();
            });

            window.matchMedia('(min-width: 768px)').addEventListener('change', (evt) => {
                if (evt.matches) closeMenu();
            });
        })();
    </script>
    <script>
        const results = document.getElementById('results');
        const addCollegeBtn = document.getElementById('addCollegeBtn');
        const collegeModal = document.getElementById('collegeModal');
        const collegeModalBackdrop = document.getElementById('collegeModalBackdrop');
        const collegeModalTitle = document.getElementById('collegeModalTitle');
        const collegeForm = document.getElementById('collegeForm');
        const collegeNameInput = document.getElementById('collegeName');
        const collegeModalMessage = document.getElementById('collegeModalMessage');
        const collegeModalCancel = document.getElementById('collegeModalCancel');
        const collegeSubmitBtn = document.getElementById('collegeSubmitBtn');
        const collegeModalClose = document.getElementById('collegeModalClose');
        const collegeDeleteBtn = document.getElementById('collegeDeleteBtn');
        const collegeMetric = document.getElementById('collegeMetric');
        const syncStatusLabel = document.getElementById('syncStatusLabel');

        let collegesCache = [];
        let modalMode = 'add';
        let editingCollegeId = null;
        let currentRole = null;
        let isAdmin = false;

        const deleteBtnDefaultHTML = `<span class="material-symbols-rounded text-base">delete</span>Delete`;

        const apiBase = (window.API_BASE || 'http://localhost:8000').replace(/\/$/, '');

        const updateMetrics = (count, state = 'Live') => {
            if (typeof count === 'number' && collegeMetric) {
                collegeMetric.textContent = String(count);
            }
            if (syncStatusLabel) {
                syncStatusLabel.textContent = state;
            }
        };

        function showLoader() {
            results.innerHTML = `
        <div class="col-span-full flex items-center justify-center py-16">
          <div class="h-12 w-12 animate-spin rounded-full border-2 border-brand-500/50 border-t-transparent"></div>
        </div>`;
            updateMetrics(collegesCache.length || 0, 'Syncing…');
        }

        function showError(message) {
            results.innerHTML = `
        <div class="col-span-full rounded-3xl border border-red-400/35 bg-red-100/70 dark:bg-red-500/10 dark:border-red-400/25 p-8 shadow-soft">
          <h2 class="text-lg font-semibold text-red-700 dark:text-red-200">Unable to load colleges</h2>
          <p class="mt-2 text-sm text-red-600/85 dark:text-red-200/80">${Collage.escapeHtml(message || 'Please try again shortly.')}</p>
        </div>`;
            updateMetrics(collegesCache.length || 0, 'Error');
        }

        function showEmpty() {
            results.innerHTML = `
        <div class="col-span-full rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur p-8 text-sm text-neutral-600 dark:text-white/65">
          <h2 class="text-lg font-semibold text-neutral-900 dark:text-white">No colleges yet</h2>
          <p class="mt-2">Add a college to kickstart your hierarchy, or bulk import data from the admin tooling.</p>
        </div>`;
            updateMetrics(0, 'Awaiting entries');
        }

        function showAccessDenied(message) {
            if (addCollegeBtn) addCollegeBtn.classList.add('hidden');
            results.innerHTML = `
                <div class="col-span-full p-10 text-center space-y-4 rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur-xl shadow-soft">
                    <div class="mx-auto w-14 h-14 rounded-full flex items-center justify-center bg-red-500/10 text-red-600 dark:text-red-400">
                        <span class="material-symbols-rounded">block</span>
                    </div>
                    <h2 class="text-xl font-bold text-neutral-900 dark:text-white">Access denied</h2>
                    <p class="text-sm text-neutral-600 dark:text-white/70 max-w-md mx-auto">${Collage.escapeHtml(message || 'You do not have permission to view this page.')}</p>
                </div>`;
            updateMetrics(0, 'Denied');
        }

        function getAnyToken() {
            const keys = ['token', 'px_token', 'access_token', 'auth_token', 'sb-access-token'];
            for (const k of keys) {
                try {
                    const v = localStorage.getItem(k);
                    if (v) return v;
                } catch (_) { }
            }
            return null;
        }

        async function requireAdminOrEmployee() {
            const token = getAnyToken();
            if (!token) {
                const err = new Error('Missing token');
                err.status = 401;
                throw err;
            }
            const me = await Collage.fetchJson('/api/admin/roles/me', { headers: { 'Authorization': `Bearer ${token}` } });
            const role = String(me?.role || 'student').toLowerCase().trim();
            if (role !== 'admin' && role !== 'employee') {
                const err = new Error('Access denied');
                err.status = 403;
                throw err;
            }
            return role;
        }

        function resetModal() {
            collegeForm.reset();
            collegeModalMessage.textContent = '';
            collegeModalMessage.classList.add('hidden');
            editingCollegeId = null;
            if (collegeDeleteBtn) {
                collegeDeleteBtn.classList.add('hidden');
                collegeDeleteBtn.disabled = false;
                collegeDeleteBtn.innerHTML = deleteBtnDefaultHTML;
            }
        }

        function setModalLoading(isLoading) {
            collegeSubmitBtn.disabled = isLoading;
            collegeSubmitBtn.innerHTML = isLoading
                ? `<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Saving…`
                : (modalMode === 'edit'
                    ? `<span class="material-symbols-rounded text-base">save</span>Save changes`
                    : `<span class="material-symbols-rounded text-base">save</span>Save college`);
        }

        function setCollegeDeleteLoading(isLoading) {
            if (!collegeDeleteBtn) return;
            collegeDeleteBtn.disabled = isLoading;
            collegeModalCancel.disabled = isLoading;
            collegeSubmitBtn.disabled = isLoading;
            collegeDeleteBtn.innerHTML = isLoading
                ? '<span class="material-symbols-rounded animate-spin text-base">progress_activity</span> Deleting…'
                : deleteBtnDefaultHTML;
        }

        function closeCollegeModal() {
            collegeModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            resetModal();
        }

        const collegeLogoInput = document.getElementById('collegeLogo');
        const collegeLogoPreview = document.getElementById('collegeLogoPreview');
        const changeLogoBtn = document.getElementById('changeLogoBtn');
        const uploadLogoNowBtn = document.getElementById('uploadLogoNowBtn');
        let pendingLogoFile = null;
        window.__logoUploadedExplicitly = false;

        function openCollegeModal(mode, college) {
            modalMode = mode;
            resetModal();
            if (mode === 'edit' && college) {
                editingCollegeId = college.id;
                collegeNameInput.value = college.name || '';
                if (college.logo_url) {
                    collegeLogoPreview.src = college.logo_url;
                    collegeLogoPreview.classList.remove('hidden');
                    changeLogoBtn?.classList.remove('hidden');
                    uploadLogoNowBtn?.classList.add('hidden');
                } else {
                    collegeLogoPreview.classList.add('hidden');
                    changeLogoBtn?.classList.add('hidden');
                    uploadLogoNowBtn?.classList.add('hidden');
                }
            }
            collegeModalTitle.textContent = mode === 'edit' ? 'Edit college' : 'Add a new college';
            collegeSubmitBtn.innerHTML = mode === 'edit'
                ? `<span class="material-symbols-rounded text-base">save</span>Save changes`
                : `<span class="material-symbols-rounded text-base">save</span>Save college`;

            if (collegeDeleteBtn) {
                if (mode === 'edit') collegeDeleteBtn.classList.remove('hidden');
                else collegeDeleteBtn.classList.add('hidden');
                collegeDeleteBtn.disabled = false;
                collegeDeleteBtn.innerHTML = deleteBtnDefaultHTML;
            }
            collegeModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                collegeNameInput?.focus();
                if (mode === 'edit') {
                    collegeNameInput?.select();
                }
            }, 80);
        }

        async function handleCollegeDelete() {
            if (!editingCollegeId) return;
            const college = collegesCache.find(c => String(c.id) === String(editingCollegeId));
            const label = college?.name ? `"${college.name}"` : 'this college';
            const ok = window.confirm(`Delete ${label} and all its degrees/departments/batches/subjects? This cannot be undone.`);
            if (!ok) return;

            setCollegeDeleteLoading(true);
            collegeModalMessage.classList.add('hidden');
            try {
                await Collage.fetchJson(`/api/colleges/${editingCollegeId}`, { method: 'DELETE', skipAuth: true });
                closeCollegeModal();
                await loadColleges();
            } catch (error) {
                let message = error?.message ?? 'Unable to delete college. Please try again.';
                if (typeof message !== 'string') {
                    try { message = JSON.stringify(message); } catch (_) { message = 'Unable to delete college. Please try again.'; }
                }
                if (message === '[object Object]') message = 'Unexpected response from server. Please try again.';
                collegeModalMessage.textContent = message;
                collegeModalMessage.classList.remove('hidden');
                console.error(error);
            } finally {
                setCollegeDeleteLoading(false);
            }
        }

        if (collegeLogoInput) {
            collegeLogoInput.addEventListener('change', (ev) => {
                const file = ev.target.files && ev.target.files[0];
                pendingLogoFile = file || null;
                window.__logoUploadedExplicitly = false;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = () => {
                        collegeLogoPreview.src = reader.result;
                        collegeLogoPreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                    if (modalMode === 'edit') {
                        uploadLogoNowBtn?.classList.remove('hidden');
                    }
                } else {
                    collegeLogoPreview.classList.add('hidden');
                    uploadLogoNowBtn?.classList.add('hidden');
                }
            });
        }

        if (uploadLogoNowBtn) {
            uploadLogoNowBtn.addEventListener('click', async () => {
                if (!(editingCollegeId && pendingLogoFile)) {
                    console.debug('[CollegeModal] Upload button clicked but no editingCollegeId or pending file');
                    return;
                }
                const fd = new FormData();
                fd.append('file', pendingLogoFile);
                uploadLogoNowBtn.disabled = true;
                uploadLogoNowBtn.textContent = 'Uploading...';
                try {
                    console.debug('[CollegeModal] Explicit logo upload start');
                    const up = await fetch(`${apiBase}/api/colleges/${editingCollegeId}/logo`, { method: 'POST', body: fd });
                    if (!up.ok) {
                        let msg = 'Upload failed';
                        try { const jd = await up.json(); msg = jd.detail || jd.error || msg; } catch (e) { }
                        alert(msg);
                        console.warn('[CollegeModal] Explicit upload failed', msg);
                        console.debug('[CollegeModal] Response status', up.status);
                    } else {
                        window.__logoUploadedExplicitly = true;
                        uploadLogoNowBtn.textContent = 'Uploaded';
                        console.debug('[CollegeModal] Explicit logo upload success');
                    }
                } catch (e) {
                    console.error('[CollegeModal] Explicit upload error', e);
                } finally {
                    setTimeout(() => { uploadLogoNowBtn.disabled = false; }, 1500);
                }
            });
        }

        function attachCollegeEditHandlers() {
            const editButtons = results.querySelectorAll('[data-college-edit]');
            editButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    const id = button.getAttribute('data-college-edit');
                    const college = collegesCache.find(item => item.id === id);
                    if (college) {
                        openCollegeModal('edit', college);
                    }
                });
            });
            // Make entire card (except edit button) clickable
            const cards = results.querySelectorAll('article.group');
            cards.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Ignore clicks on edit button
                    if (e.target.closest('[data-college-edit]')) return;
                    const link = card.querySelector('[data-college-link]');
                    if (link) {
                        window.location.href = link.getAttribute('href');
                    }
                });
            });
        }

        async function handleCollegeSubmit(event) {
            event.preventDefault();
            const name = (collegeNameInput.value || '').trim();
            if (!name) {
                collegeModalMessage.textContent = 'Please enter the college name.';
                collegeModalMessage.classList.remove('hidden');
                collegeNameInput.focus();
                return;
            }
            collegeModalMessage.classList.add('hidden');
            setModalLoading(true);
            try {
                let createdId = null;
                if (modalMode === 'edit' && editingCollegeId) {
                    await Collage.fetchJson(`/api/colleges/${editingCollegeId}`, { method: 'PUT', body: { name }, skipAuth: true });
                    createdId = editingCollegeId;
                } else {
                    const created = await Collage.fetchJson('/api/colleges/simple', { method: 'POST', body: { name }, skipAuth: true });
                    createdId = created?.id;
                }
                // If user hasn't already uploaded the logo explicitly via the new button, do a final attempt
                if (createdId && pendingLogoFile && !window.__logoUploadedExplicitly) {
                    console.debug('[CollegeModal] Auto-uploading pending logo during save');
                    const fd = new FormData();
                    fd.append('file', pendingLogoFile);
                    try {
                        const up = await fetch(`${apiBase}/api/colleges/${createdId}/logo`, { method: 'POST', body: fd });
                        if (!up.ok) {
                            let msg = 'Logo upload failed';
                            try { const jd = await up.json(); msg = jd.detail || msg; } catch (e) { }
                            console.warn(msg);
                        } else {
                            window.__logoUploadedExplicitly = true;
                        }
                    } catch (e) { console.error(e); }
                }
                closeCollegeModal();
                await loadColleges();
            } catch (error) {
                let message = error?.message ?? 'Unable to save college. Please try again.';
                if (typeof message !== 'string') {
                    try {
                        message = JSON.stringify(message);
                    } catch (_) {
                        message = 'Unable to save college. Please try again.';
                    }
                }
                if (message === '[object Object]') {
                    message = 'Unexpected response from server. Please try again.';
                }
                collegeModalMessage.textContent = message;
                collegeModalMessage.classList.remove('hidden');
                console.error(error);
            } finally {
                setModalLoading(false);
            }
        }

        async function loadColleges() {
            showLoader();
            try {
                const colleges = await Collage.fetchJson('/api/colleges', { skipAuth: true });
                collegesCache = Array.isArray(colleges) ? colleges.slice() : [];
                if (!Array.isArray(colleges) || !colleges.length) {
                    showEmpty();
                    return;
                }
                updateMetrics(colleges.length, 'Live');
                const accentPalette = [
                    'from-brand-500/70 via-brandlt-300/60 to-brand-700/80',
                    'from-[#FF7FD1]/55 via-brand-500/60 to-brand-700/80',
                    'from-brandlt-200/60 via-white/40 to-brand-500/65',
                    'from-[#7F57D1]/55 via-brand-500/60 to-brand-700/80',
                    'from-brand-700/65 via-brandlt-400/55 to-brand-500/70'
                ];
                results.innerHTML = colleges.map((college, index) => {
                    const accentColor = accentPalette[index % accentPalette.length];
                    const target = `degrees.html?collegeId=${encodeURIComponent(college.id)}&collegeName=${encodeURIComponent((college && college.name) || '')}`;
                    const label = Collage.escapeHtml(college.name);
                    // Large logo (fallback if none)
                    const logoTag = college.logo_url
                        ? `<img src="${college.logo_url}" alt="${label} logo" class=\"h-20 w-20 rounded-2xl object-cover ring-2 ring-white/60 dark:ring-white/10 shadow-md\" />`
                        : `<div class=\"h-20 w-20 rounded-2xl bg-gradient-to-br from-brand-500 to-brand-700 text-white grid place-items-center text-[11px] font-semibold ring-2 ring-white/40 dark:ring-white/10 shadow-md\">LOGO</div>`;
                    const editBtn = isAdmin ? `
                                                    <!-- Edit button top-right -->
                                                    <button type="button" data-college-edit="${college.id}" aria-label="Edit ${label}"
                                                        class="absolute top-5 right-5 z-30 inline-flex items-center justify-center rounded-full border border-white/40 bg-white/95 dark:bg-white/10 p-2 text-neutral-500 hover:text-brand-500 hover:border-brand-500/50 transition shadow-sm">
                                                        <span class="material-symbols-rounded text-base">edit</span>
                                                    </button>` : '';
                    return `
                                                <article class="group relative overflow-hidden rounded-3xl border border-black/5 dark:border-white/10 bg-white/75 dark:bg-white/5 backdrop-blur-xl p-6 shadow-soft transition">
                                                    <div class="absolute inset-x-6 top-6 h-32 rounded-3xl bg-gradient-to-r ${accentColor} opacity-25 blur-3xl"></div>
                                                    ${editBtn}
                                                    <!-- Logo centered vertically on right -->
                                                    <div class="absolute top-1/2 -translate-y-1/2 right-4 z-20 pointer-events-none">${logoTag}</div>
                                                    <div class="pr-16 pt-1"> <!-- further reduced gap -->
                                                        <h2 class="text-lg font-semibold text-neutral-900 dark:text-white leading-snug">
                                                            <a href="${target}" data-college-link class="inline-flex items-start gap-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500/60 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-brand-900 group-hover:text-brand-500 transition cursor-pointer relative z-10">
                                                                <span class="whitespace-normal break-words">${label}</span>
                                                                <span class="material-symbols-rounded text-[17px] opacity-0 group-hover:opacity-100 transition flex-shrink-0 mt-[2px]">north_east</span>
                                                            </a>
                                                        </h2>
                                                        <p class="mt-4 text-sm text-neutral-600 dark:text-white/65">
                                                            Dive into its degrees, departments, batches, subjects, and syllabus hierarchy.
                                                        </p>
                                                        <a class="mt-5 inline-flex items-center gap-2 text-sm font-medium text-brand-500 dark:text-white/85" href="${target}">
                                                            Manage hierarchy
                                                            <span class="material-symbols-rounded text-base transition group-hover:translate-x-1">arrow_forward</span>
                                                        </a>
                                                    </div>
                                                </article>`;
                }).join('');
                attachCollegeEditHandlers();
            } catch (err) {
                console.error(err);
                showError(err.message || 'Unexpected error');
            }
        }

        function initCollegeManagement() {
            addCollegeBtn?.addEventListener('click', () => openCollegeModal('add'));
            collegeModalCancel?.addEventListener('click', closeCollegeModal);
            collegeModalClose?.addEventListener('click', closeCollegeModal);
            collegeModalBackdrop?.addEventListener('click', closeCollegeModal);
            collegeForm?.addEventListener('submit', handleCollegeSubmit);
            collegeDeleteBtn?.addEventListener('click', handleCollegeDelete);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !collegeModal.classList.contains('hidden')) {
                    closeCollegeModal();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoader();
                currentRole = await requireAdminOrEmployee();
                isAdmin = String(currentRole || '').toLowerCase() === 'admin';
                if (!isAdmin) {
                    addCollegeBtn?.classList.add('hidden');
                } else {
                    initCollegeManagement();
                }
                await loadColleges();
            } catch (err) {
                console.error(err);
                const status = err?.status;
                if (status === 401 || status === 403) {
                    showAccessDenied('You need an admin or employee account to access the college console.');
                } else {
                    showError(err?.message || 'Unexpected error');
                }
            }
        });
    </script>
</body>

</html>