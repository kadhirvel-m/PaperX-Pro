<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PaperX — YouTube Video Search</title>

    <script>
        (function () {
            try {
                var keys = ['cx-theme', 'theme', 'px-theme'];
                var mode = null;
                for (var i = 0; i < keys.length; i++) {
                    var v = localStorage.getItem(keys[i]);
                    if (v === 'dark' || v === 'light') { mode = v; break; }
                }
                if (!mode && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    mode = 'dark';
                }
                if (mode) {
                    document.documentElement.setAttribute('data-theme', mode);
                    document.documentElement.classList.toggle('dark', mode === 'dark');
                }
            } catch (e) { }
        })();
    </script>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/css/tailwind.css" />
    <script>
        tailwind.config = {
            darkMode: ["class", '[data-theme="dark"]'],
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f7ff', 100: '#e0efff', 200: '#b9dbff', 300: '#8ac4ff', 400: '#59a9ff', 500: '#2b8cff', 600: '#116fe6', 700: '#0a57b4', 800: '#0b4890', 900: '#0d3a73'
                        },
                        night: {
                            900: '#0a0c10', 800: '#0f131a', 700: '#141a22', 600: '#1a2230'
                        },
                        surface: {
                            DEFAULT: 'var(--surface)',
                            dim: 'var(--surface-dim)',
                            contrast: 'var(--surface-contrast)'
                        }
                    },
                    boxShadow: {
                        glow: '0 0 0 1px rgba(59,130,246,.2), 0 8px 40px rgba(59,130,246,.15)',
                        neon: '0 0 25px rgba(43,140,255,.35), 0 0 60px rgba(43,140,255,.25)',
                        'e1': '0 1px 2px rgba(0,0,0,0.06)',
                        'e2': '0 2px 6px rgba(0,0,0,0.08)',
                        'e3': '0 6px 12px rgba(0,0,0,0.10)',
                        'e4': '0 10px 16px rgba(0,0,0,0.12)',
                    },
                    keyframes: {
                        in: {
                            '0%': { opacity: 0, transform: 'translateY(6px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-468px 0' },
                            '100%': { backgroundPosition: '468px 0' }
                        }
                    },
                    animation: {
                        in: 'in .25s ease-out',
                        shimmer: 'shimmer 1.25s linear infinite'
                    }
                }
            }
        }
    </script>

    <!-- Shared config + theme manager -->
    <script src="./config.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />

    <!-- Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />

    <style>
        :root {
            --surface: #ffffff;
            --surface-dim: #f9fbff;
            --surface-contrast: #0f172a;
            --outline: rgba(2, 6, 23, 0.08);
            --muted: #64748b;
            --brand: #2b8cff;
            --brand-strong: #116fe6;
            --brand-soft: #e0efff;
            --chip: #f5f9ff;
        }

        [data-theme="dark"] {
            --surface: #0a0c10;
            --surface-dim: #0f131a;
            --surface-contrast: #e5e7eb;
            --outline: rgba(255, 255, 255, .10);
            --muted: #a3a9c5;
            --brand: #59a9ff;
            --brand-strong: #8ac4ff;
            --brand-soft: #0f1b30;
            --chip: #0f1a2b;
        }

        html,
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .bg-grid-radial {
            background-image: radial-gradient(circle at 20% 10%, rgba(43, 140, 255, .18), transparent 35%),
                radial-gradient(circle at 80% 20%, rgba(168, 85, 247, .12), transparent 35%),
                radial-gradient(circle at 50% 80%, rgba(16, 185, 129, .12), transparent 35%);
        }

        .glass {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.65);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] .glass {
            background: rgba(15, 18, 38, 0.55);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(0, 0, 0, 0.06) 25%, rgba(0, 0, 0, 0.12) 37%, rgba(0, 0, 0, 0.06) 63%);
            background-size: 800px 100%;
            animation: shimmer 1.25s linear infinite;
        }

        .ripple {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        /* Carousel container */
        .carousel {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 1rem 0;
            scrollbar-width: thin;
        }

        .carousel::-webkit-scrollbar {
            height: 8px;
        }

        .carousel::-webkit-scrollbar-thumb {
            background: var(--outline);
            border-radius: 9999px;
        }

        .carousel-item {
            flex: 0 0 320px;
            scroll-snap-align: start;
            width: 320px;
        }

        /* Video card styles */
        .video-card {
            border: 1px solid var(--outline);
            border-radius: 1rem;
            overflow: hidden;
            background: var(--surface);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(43, 140, 255, 0.15);
        }

        .video-thumbnail-wrapper {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 aspect ratio */
            overflow: hidden;
            background: #000;
        }

        .video-thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 64px;
            height: 64px;
            background: rgba(0, 0, 0, 0.75);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .video-card:hover .play-overlay {
            background: rgba(43, 140, 255, 0.9);
        }

        .play-icon {
            width: 0;
            height: 0;
            border-left: 20px solid white;
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            margin-left: 4px;
        }

        .channel-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--outline);
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-[var(--surface-dim)] text-[var(--surface-contrast)] min-h-screen font-sans">
    <!-- Background decorations -->
    <div aria-hidden="true" class="fixed inset-0 -z-10 bg-grid-radial opacity-70"></div>

    <!-- Top App Bar -->
    <header class="sticky top-0 z-40 border-b backdrop-blur supports-[backdrop-filter]:bg-[color:var(--surface)]/70"
        style="border-color: var(--outline);">
        <div class="glass">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center gap-3">
                <div
                    class="h-9 w-9 rounded-xl bg-gradient-to-br from-brand-400 via-brand-500 to-indigo-500 shadow-neon grid place-items-center text-white font-bold tracking-tight">
                    PX</div>
                <div class="min-w-0">
                    <h1 class="text-base sm:text-lg font-semibold tracking-tight leading-tight">
                        <a href="index.html"
                            class="hover:underline focus:outline-none focus:ring-2 focus:ring-brand-500 rounded-sm cursor-pointer">
                            PaperX — YouTube Videos
                        </a>
                    </h1>
                    <p class="text-xs text-[var(--muted)]">Search educational videos • Watch • Learn</p>
                </div>

                <!-- Quick actions -->
                <div class="ml-auto flex items-center gap-2">
                    <button id="themeBtn"
                        class="ripple px-3 py-2 rounded-lg border text-sm hover:bg-[var(--brand-soft)] transition"
                        style="border-color: var(--outline)" title="Toggle theme">Dark</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main layout -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">

        <!-- Search Section -->
        <section class="mb-8">
            <div class="rounded-2xl glass p-6 border shadow-glow animate-in"
                style="border-color: var(--outline); background: color-mix(in oklab, var(--surface) 75%, transparent)">
                <div class="max-w-3xl mx-auto">
                    <label class="block text-sm font-medium mb-3">Search Topic</label>
                    <div class="flex gap-3">
                        <input id="searchInput" type="text"
                            placeholder="e.g., Machine Learning Tutorial, Python Programming"
                            class="flex-1 px-4 py-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-brand-500/60 focus:border-brand-500"
                            style="border-color: var(--outline); background: var(--surface); color: var(--surface-contrast)" />
                        <button id="searchBtn"
                            class="ripple px-6 py-3 rounded-xl bg-gradient-to-r from-brand-500 to-indigo-500 hover:opacity-95 text-white font-medium shadow-neon transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="material-symbols-outlined align-middle">search</span>
                            Search
                        </button>
                    </div>

                    <!-- Quick suggestions -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <span class="text-xs text-[var(--muted)] mr-2">Popular:</span>
                        <button class="suggestion-chip" data-query="Data Structures Tutorial">Data Structures</button>
                        <button class="suggestion-chip" data-query="Web Development Course">Web Dev</button>
                        <button class="suggestion-chip" data-query="Machine Learning Basics">ML Basics</button>
                        <button class="suggestion-chip" data-query="Python Programming">Python</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="hidden">
            <div class="mb-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold">Results for "<span id="searchQuery"></span>"</h2>
                <div class="text-sm text-[var(--muted)]">
                    <span id="resultsCount">0</span> videos found
                </div>
            </div>

            <!-- Video Carousel -->
            <div class="rounded-2xl glass border shadow-glow p-6" style="border-color: var(--outline);">
                <div id="videoCarousel" class="carousel">
                    <!-- Video cards will be inserted here -->
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <section id="loadingSection" class="hidden">
            <div class="rounded-2xl glass border shadow-glow p-6" style="border-color: var(--outline);">
                <div class="flex items-center justify-center gap-3 text-[var(--muted)]">
                    <span class="material-symbols-outlined animate-spin">progress_activity</span>
                    <span>Searching videos...</span>
                </div>
            </div>
        </section>

        <!-- Empty State -->
        <section id="emptySection" class="hidden">
            <div class="rounded-2xl glass border shadow-glow p-12 text-center" style="border-color: var(--outline);">
                <span class="material-symbols-outlined text-6xl text-[var(--muted)] mb-4">video_library</span>
                <h3 class="text-xl font-semibold mb-2">No videos found</h3>
                <p class="text-[var(--muted)]">Try a different search term</p>
            </div>
        </section>

    </main>

    <!-- Snackbar -->
    <div id="snack"
        class="fixed left-1/2 -translate-x-1/2 bottom-4 px-4 py-2 rounded-xl shadow-glow bg-[var(--surface)] border text-sm hidden"
        style="border-color: var(--outline)"></div>

    <script>
        // API base
        let __defaultBase = 'https://paperxapp.onrender.com';
        if (/^https?:/i.test(window.location.origin)) {
            const host = window.location.host;
            if (/localhost:5500|127\.0\.0\.1:5500/.test(host)) {
                __defaultBase = 'https://paperxapp.onrender.com';
            } else {
                __defaultBase = window.location.origin;
            }
        }
        const apiBase = (window.API_BASE || __defaultBase).replace(/\/$/, '');

        // Elements
        const $searchInput = document.getElementById('searchInput');
        const $searchBtn = document.getElementById('searchBtn');
        const $resultsSection = document.getElementById('resultsSection');
        const $loadingSection = document.getElementById('loadingSection');
        const $emptySection = document.getElementById('emptySection');
        const $videoCarousel = document.getElementById('videoCarousel');
        const $searchQuery = document.getElementById('searchQuery');
        const $resultsCount = document.getElementById('resultsCount');
        const $snack = document.getElementById('snack');
        const $themeBtn = document.getElementById('themeBtn');
        const fallbackChannelLogo = 'https://www.youtube.com/s/desktop/94838207/img/favicon_144x144.png';
        const channelLogoCache = new Map();

        function getChannelLogoAsync(channelPage) {
            if (!channelPage || typeof channelPage !== 'string') {
                return Promise.resolve('');
            }

            const cached = channelLogoCache.get(channelPage);
            if (cached !== undefined) {
                return cached instanceof Promise ? cached : Promise.resolve(cached);
            }

            const request = (async () => {
                try {
                    const response = await fetch(`${apiBase}/api/youtube/channel-logo?channel_url=${encodeURIComponent(channelPage)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    const logo = typeof data.logo === 'string' ? data.logo.trim() : '';
                    channelLogoCache.set(channelPage, logo);
                    return logo;
                } catch (error) {
                    console.warn('Channel logo fetch failed', error);
                    channelLogoCache.set(channelPage, '');
                    return '';
                }
            })();

            channelLogoCache.set(channelPage, request);
            return request;
        }

        function hydrateChannelLogo(img, channelPage, shouldAttempt) {
            if (!img || !shouldAttempt) return;
            getChannelLogoAsync(channelPage)
                .then(logo => {
                    if (logo) {
                        img.src = logo;
                        img.dataset.logoLoaded = 'true';
                    }
                })
                .catch(() => { /* already logged in fetch helper */ });
        }

        // Theme toggle
        (function initTheme() {
            try {
                if (window.Theme && typeof window.Theme.init === 'function') window.Theme.init();
                const mode = (window.Theme && window.Theme.get && window.Theme.get()) || (document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                $themeBtn.textContent = mode === 'dark' ? 'Light' : 'Dark';
            } catch { }
            $themeBtn.addEventListener('click', () => {
                try {
                    const mode = (window.Theme && window.Theme.toggle && window.Theme.toggle()) || (document.documentElement.classList.toggle('dark'), document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                    $themeBtn.textContent = mode === 'dark' ? 'Light' : 'Dark';
                } catch { }
            });
        })();

        // Ripple effect
        document.addEventListener('click', (e) => {
            const b = e.target.closest('.ripple');
            if (!b) return;
            const rect = b.getBoundingClientRect();
            const circle = document.createElement('span');
            circle.style.position = 'absolute';
            circle.style.left = `${e.clientX - rect.left}px`;
            circle.style.top = `${e.clientY - rect.top}px`;
            circle.style.width = circle.style.height = '0px';
            circle.style.borderRadius = '9999px';
            circle.style.background = 'currentColor';
            circle.style.opacity = '.12';
            circle.style.transform = 'translate(-50%,-50%)';
            circle.style.transition = 'width .5s ease, height .5s ease, opacity .8s ease';
            b.appendChild(circle);
            requestAnimationFrame(() => {
                circle.style.width = circle.style.height = Math.max(rect.width, rect.height) * 1.8 + 'px';
            });
            setTimeout(() => {
                circle.style.opacity = '0';
                setTimeout(() => circle.remove(), 300);
            }, 250);
        }, true);

        // Snackbar
        function snack(msg) {
            $snack.textContent = msg;
            $snack.classList.remove('hidden');
            setTimeout(() => $snack.classList.add('hidden'), 2000);
        }

        // Suggestion chips
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.className = "suggestion-chip ripple px-3 py-1.5 text-xs rounded-full border hover:bg-[var(--brand-soft)] transition cursor-pointer";
            chip.style.borderColor = "var(--outline)";
            chip.addEventListener('click', () => {
                $searchInput.value = chip.dataset.query;
                performSearch();
            });
        });

        // Create video card
        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'carousel-item';

            // Normalize string fields for layout
            const titleText = typeof video.title === 'string' ? video.title.trim() : '';

            // Use channel logo if provided, otherwise fallback to the YouTube glyph
            const channelPage = typeof video.channel_page === 'string' ? video.channel_page.trim() : '';
            const logoIsDefault = Boolean(video.channel_logo_is_default);
            const channelLogo = (typeof video.channel_logo === 'string' && video.channel_logo.trim()) || fallbackChannelLogo;
            const safeLink = typeof video.link === 'string' ? video.link : '';
            const notesUrl = `./youtube-notes.html?video=${encodeURIComponent(safeLink)}`;

            card.innerHTML = `
        <a href="${notesUrl}" class="video-card block">
          <div class="video-thumbnail-wrapper">
            <img src="${video.thumbnail}" alt="${video.title}" class="video-thumbnail" loading="lazy">
            <div class="play-overlay">
              <div class="play-icon"></div>
            </div>
            ${video.duration ? `<div class="duration-badge">${video.duration}</div>` : ''}
          </div>
          <div class="p-4">
            <h3 class="font-semibold text-sm mb-2" style="display: block; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${titleText}</h3>
            <div class="flex items-center justify-between gap-3 text-xs text-[var(--muted)]">
              <div class="flex items-center gap-2">
                <img src="${channelLogo}" alt="${video.channel}" class="channel-logo" loading="lazy" referrerpolicy="no-referrer">
                <span class="font-medium">${video.channel}</span>
              </div>
              ${video.views ? `
                <span class="flex items-center gap-1 whitespace-nowrap">
                  <span class="material-symbols-outlined text-sm">visibility</span>
                  ${video.views}
                </span>
              ` : ''}
            </div>
          </div>
        </a>
      `;

            const logoImg = card.querySelector('.channel-logo');
            if (logoImg) {
                logoImg.dataset.channelPage = channelPage;
                hydrateChannelLogo(logoImg, channelPage, logoIsDefault && !!channelPage);
            }

            return card;
        }

        // Perform search
        async function performSearch() {
            const query = $searchInput.value.trim();
            if (!query) {
                snack('Please enter a search term');
                return;
            }

            // Show loading state
            $resultsSection.classList.add('hidden');
            $emptySection.classList.add('hidden');
            $loadingSection.classList.remove('hidden');
            $searchBtn.disabled = true;

            try {
                const response = await fetch(`${apiBase}/api/youtube/search?query=${encodeURIComponent(query)}&num=12`);

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const videos = await response.json();

                $loadingSection.classList.add('hidden');

                if (videos.length === 0) {
                    $emptySection.classList.remove('hidden');
                    return;
                }

                // Display results
                $searchQuery.textContent = query;
                $resultsCount.textContent = videos.length;
                $videoCarousel.innerHTML = '';

                videos.forEach(video => {
                    const card = createVideoCard(video);
                    $videoCarousel.appendChild(card);
                });

                $resultsSection.classList.remove('hidden');

                // Scroll to results
                setTimeout(() => {
                    $resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (error) {
                console.error('Search error:', error);
                $loadingSection.classList.add('hidden');
                snack('Search failed. Please try again.');
            } finally {
                $searchBtn.disabled = false;
            }
        }

        // Search button click
        $searchBtn.addEventListener('click', performSearch);

        // Enter key in search input
        $searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Check for query parameter on load
        (function checkQueryParam() {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('q');
            if (query) {
                $searchInput.value = query;
                performSearch();
            }
        })();
    </script>
</body>

</html>